# 仕入粗利管理ツール 大規模改善計画

## 現状分析サマリー

| 項目 | 現状 |
|------|------|
| フレームワーク | React 19 + Vite 7 + TypeScript 5.9 + styled-components 6 |
| アーキテクチャ | 4層分離 (domain / application / infrastructure / presentation) |
| ソースファイル | 214ファイル (ドメイン38, アプリ28, インフラ36, プレゼン107) |
| テスト | 45テストファイル / 467テスト (ドメイン・インフラ中心) |
| ページ数 | 10ページ + 60+ウィジェット + 22+チャート |
| 状態管理 | Context API + useReducer (14アクション) |
| ルーティング | カスタム (ViewType switch, React Router未使用) |
| 永続化 | IndexedDB (年月単位) + localStorage (設定・UI) |
| パフォーマンス | コード分割なし, 遅延ロードなし, 仮想化なし |
| アクセシビリティ | 最小限 (aria-label 4箇所のみ) |
| エラー処理 | Toast通知 + ValidationModal, ErrorBoundaryなし |

---

## Phase 1: 基盤強化 (信頼性・安定性)

### 1.1 React Error Boundary の導入 ✅
**目的**: 未捕捉エラーによる白画面を防止
- ページ単位の ErrorBoundary コンポーネント作成
- エラー時のフォールバックUI (再試行ボタン + エラー詳細)
- チャートコンポーネント個別ラップ (1チャートの失敗が全体に波及しない)
- Sentry等の外部エラー監視サービス連携準備

### 1.2 React Router 導入 ✅
**目的**: ブラウザ履歴・URL ベースのナビゲーション
- 現在のカスタム ViewType switch → React Router v7 へ移行
- URLパス対応: `/dashboard`, `/category`, `/forecast`, etc.
- ブラウザの戻る/進むボタン対応
- ディープリンク対応 (特定ページへの直接アクセス)
- 将来的なルートベース code splitting の基盤

### 1.3 コード分割 & 遅延ロード ✅
**目的**: 初期ロード時間の大幅短縮
- `React.lazy()` + `Suspense` によるページ単位の動的インポート
- チャートコンポーネント群の遅延ロード (recharts が重いため効果大)
- ルートベース分割 (React Router との連携)
- Vite の `manualChunks` 設定 (vendor/recharts/xlsx を別チャンク)
- ローディング中の Skeleton UI 表示

### 1.4 グローバルローディング・Skeleton UI ✅
**目的**: データ処理中のユーザー体験向上
- 共通 `<Skeleton>` コンポーネント作成 (KpiCard, Chart, Table 用)
- ページ遷移時の `<Suspense fallback>` 統一
- インポート中のプログレス UI 強化 (段階表示: 解析 → 検証 → 保存)
- 計算中のインジケーター (useCalculation の実行中状態表示)

---

## Phase 2: 状態管理の進化

### 2.1 Zustand への移行 ✅
**目的**: Context API のパフォーマンス限界を超える
- AppStateContext の巨大な単一 reducer → Zustand ストアへ分割
  - `useDataStore` — ImportedData, StoreResults
  - `useUiStore` — selectedStoreIds, currentView, isImporting
  - `useSettingsStore` — AppSettings, InventoryConfig
- セレクター機能で不要な再レンダリング防止
- ミドルウェア: `persist` (localStorage/IndexedDB 自動同期)
- ミドルウェア: `devtools` (Redux DevTools 連携でデバッグ容易化)
- `immer` ミドルウェアで不変更新を簡潔に記述

### 2.2 計算結果のキャッシュ戦略 ✅
**目的**: 不要な再計算を排除
- StoreResult の計算を入力データのハッシュでキャッシュ
- 部分更新: 設定変更時は影響を受ける店舗のみ再計算
- Web Worker での計算オフロード検討 (メインスレッドのブロッキング回避)

---

## Phase 3: UX/UI の大幅改善

### 3.1 統合通知システム ✅
**目的**: エラー・警告・成功をユーザーに確実に伝達
- 現在の Toast (3秒自動消去) を永続通知に拡張
  - エラー: 手動で閉じるまで残る
  - 警告: 10秒表示
  - 成功/情報: 3秒
- `saveError` (useImport) をUI上にバナー表示
- 通知履歴パネル (直近の操作履歴を確認可能)

### 3.2 データインポート UX の刷新 ✅
**目的**: 初回利用者でも迷わない操作フロー
- ステップウィザード形式のインポートフロー
  1. ファイル選択/ドロップ
  2. 自動検出結果の確認 (データ種別、年月、店舗)
  3. プレビュー表示 (最初の数行を表形式で確認)
  4. 差分サマリー (既存データとの比較)
  5. 確認 → インポート実行
- インポートテンプレートのダウンロード機能
- ドラッグ&ドロップ時のファイル種別ビジュアルフィードバック

### 3.3 ダッシュボード カスタマイズ強化 ✅
**目的**: ユーザー毎の最適レイアウト
- ウィジェットのリサイズ対応 (react-grid-layout 導入)
- ウィジェット内フィルター (期間、店舗、カテゴリの個別設定)
- レイアウトプリセット (「経営者向け」「現場向け」「分析者向け」)
- ウィジェットのエクスポート (画像/PDF/CSV)

### 3.4 高度なテーブル機能 ✅
**目的**: 大量データの効率的な閲覧・操作
- TanStack Table (React Table v8) 導入
  - 列ソート (マルチキー)
  - 列フィルター (テキスト、範囲、選択)
  - 列のリサイズ・並べ替え
  - 行グルーピング (カテゴリ、店舗別)
  - ページネーション or 仮想スクロール
- 共通 `<DataGrid>` コンポーネントとして全ページで再利用
- セル内編集 (在庫設定、予算など)
- コピー&ペースト対応 (Excel との相互運用)

### 3.5 モバイル対応の強化 ✅
**目的**: タブレット/スマートフォンでの実用性向上
- サイドバーをハンバーガーメニュー (ドロワー) 化
- KPI カードのスワイプ対応
- チャートのタッチ操作最適化 (ピンチズーム、パン)
- レスポンシブテーブル: モバイルではカード形式に変換
- Bottom Navigation (モバイル時)

---

## Phase 4: データ分析機能の拡充

### 4.1 高度な予測分析 ✅
**目的**: 現状の異常値検出 → 実用的な売上予測へ
- 線形回帰/移動平均による月末売上着地予測
- 曜日・祝日パターンを考慮した予測モデル
- 信頼区間の可視化 (上限/下限帯)
- 天候データ連携 (気温と売上の相関分析) の将来基盤

### 4.2 アラート・閾値システム ✅
**目的**: 問題を早期検出し、対策を促す
- カスタマイズ可能なアラートルール
  - 「粗利率が目標の -2pt 以下」
  - 「日次売上が前年同曜日の 80% 未満」
  - 「消耗品比率が N% 超過」
- ダッシュボードへのアラートバッジ表示
- アラート履歴の記録

### 4.3 レポート & エクスポートの強化 ✅
**目的**: 社内共有・印刷用途の実用性向上
- PDF エクスポート (jsPDF or html2canvas)
- Excel エクスポート (XLSX ライブラリの書き出し対応)
- 定型レポートテンプレート (日報、週報、月報)
- チャート画像のクリップボードコピー
- 帳票印刷レイアウトの最適化 (@media print 強化)

### 4.4 複数月・トレンド分析 ✅
**目的**: 月単位の単発分析 → 時系列トレンドへ
- IndexedDB 内の過去月データを横断的に分析
- 3ヶ月/6ヶ月/12ヶ月トレンドチャート
- 季節性パターンの自動検出
- 月次比較テーブル (前月比、前年同月比)

---

## Phase 5: パフォーマンス最適化

### 5.1 大規模データ対応 ✅
**目的**: 店舗数・データ量増加への耐性
- react-window による仮想スクロール (大規模テーブル)
- チャートデータのダウンサンプリング (表示解像度に応じて間引き)
- IndexedDB からのストリーミング読み込み (全データ一括ではなく逐次)
- Intersection Observer による遅延レンダリング (画面外ウィジェットは描画しない)

### 5.2 Web Worker による計算オフロード ✅
**目的**: UI スレッドのブロッキング防止
- CalculationOrchestrator を Web Worker に移動
- Comlink ライブラリで Worker との型安全な通信
- 計算進捗のリアルタイムフィードバック
- 大量ファイルインポート時の並列処理

### 5.3 バンドル最適化 ✅
**目的**: 配信サイズの削減
- Tree shaking の最適化 (recharts の部分インポート)
- xlsx ライブラリの軽量代替検討 (read-excel-file)
- フォント最適化 (Noto Sans JP のサブセット化)
- 画像/アセットの最適化

---

## Phase 6: テスト & 品質保証

### 6.1 テストカバレッジの拡充 ✅
**目的**: 現在の 21% → 60% 以上へ
- プレゼンテーション層のコンポーネントテスト追加
  - 各ページの基本レンダリングテスト
  - ユーザーインタラクションテスト (ボタンクリック、フォーム入力)
  - モーダル開閉テスト
- フック単体テストの拡充 (useCalculation, useUndoRedo, useStoreSelection)
- インテグレーションテスト (インポート→計算→表示の一連フロー)

### 6.2 E2E テスト導入 ✅
**目的**: 実際のユーザーフローを自動検証
- Playwright 導入
- 主要フローのE2Eテスト
  1. ファイルインポート → 計算 → ダッシュボード表示
  2. 設定変更 → 再計算 → 結果反映
  3. 前年比較データ読み込み → YoY チャート表示
  4. レポート印刷プレビュー
- CI パイプラインへの統合

### 6.3 Visual Regression テスト ✅
**目的**: UI の意図しない変更を検出
- Storybook 導入 (コンポーネントカタログ)
- Chromatic or Percy による Visual Regression
- 各チャートの見た目の一貫性保証

---

## Phase 7: 将来拡張基盤

### 7.1 PWA 化 ✅
**目的**: オフライン対応 & インストール可能
- Service Worker による静的アセットキャッシュ
- オフラインでのデータ閲覧 (IndexedDB 既存基盤を活用)
- インストールプロンプト
- バックグラウンド同期 (オンライン復帰時のデータ同期)

### 7.2 マルチユーザー・クラウド対応準備 ✅
**目的**: 将来的なサーバーサイド連携の基盤
- データアクセス層の抽象化 (Repository パターン)
  - 現在: IndexedDB 直接アクセス
  - 将来: REST API / GraphQL への差し替え可能
- 認証フレームワークの準備 (Auth コンテキスト)
- データ形式のバージョニング (スキーマ migration)

### 7.3 国際化 (i18n) 基盤 ✅
**目的**: 多言語対応の準備
- react-intl or i18next の導入
- 日本語文字列の外部化 (メッセージカタログ)
- 数値フォーマットのロケール対応
- 日付フォーマットの統一

---

## 実装優先順位

| 優先度 | フェーズ | 項目 | 工数目安 | 効果 |
|--------|----------|------|----------|------|
| **P0** | 1.1 | Error Boundary | 小 | 安定性 |
| **P0** | 1.4 | Skeleton UI | 小 | UX |
| **P1** | 1.2 | React Router | 中 | 基盤 |
| **P1** | 1.3 | コード分割 | 中 | 性能 |
| **P1** | 3.1 | 通知システム強化 | 小 | UX |
| **P1** | 3.2 | インポート UX | 中 | UX |
| **P2** | 2.1 | Zustand 移行 | 大 | 性能・保守性 |
| **P2** | 3.4 | TanStack Table | 中 | UX |
| **P2** | 4.3 | エクスポート強化 | 中 | 機能 |
| **P2** | 6.1 | テストカバレッジ | 大 | 品質 |
| **P3** | 3.3 | ダッシュボード強化 | 大 | UX |
| **P3** | 4.1 | 予測分析 | 大 | 機能 |
| **P3** | 4.2 | アラートシステム | 中 | 機能 |
| **P3** | 4.4 | 複数月トレンド | 中 | 機能 |
| **P3** | 5.1 | 仮想スクロール | 中 | 性能 |
| **P4** | 5.2 | Web Worker | 大 | 性能 |
| **P4** | 3.5 | モバイル強化 | 大 | UX |
| **P4** | 6.2 | E2E テスト | 大 | 品質 |
| **P5** | 7.1 | PWA | 中 | 拡張 |
| **P5** | 7.2 | クラウド準備 | 大 | 拡張 |
| **P5** | 7.3 | i18n | 中 | 拡張 |

---

## 推奨実装順序

**Sprint 1 (安定性 & UX基盤)**: P0 全て + 1.2 React Router + 1.3 コード分割
**Sprint 2 (UX改善)**: 3.1 通知 + 3.2 インポートUX + 3.4 TanStack Table
**Sprint 3 (状態管理 & テスト)**: 2.1 Zustand + 6.1 テストカバレッジ
**Sprint 4 (分析機能)**: 4.1 予測 + 4.2 アラート + 4.3 エクスポート + 4.4 トレンド
**Sprint 5 (パフォーマンス)**: 5.1 仮想化 + 5.2 Worker + 5.3 バンドル ✅
**Sprint 6 (将来基盤)**: 7.1 PWA + 7.2 クラウド準備 + 3.3 ダッシュボード + 3.5 モバイル ✅
**Sprint 7 (残りフェーズ)**: 2.2 キャッシュ戦略 + 6.2 E2Eテスト + 7.3 i18n ✅

---

## 完了状況

全 7 フェーズ (22 サブフェーズ) **全て完了** 🎉

| Sprint | 実装内容 | テスト数 | ステータス |
|--------|----------|----------|------------|
| Sprint 1 | Error Boundary, React Router, Code Splitting, Skeleton UI | 467→534 | ✅ |
| Sprint 2 | Toast強化, Import UX, TanStack Table | 534→534 | ✅ |
| Sprint 3 | Zustand移行, ストアテスト | 534→534 | ✅ |
| Sprint 4 | 予測分析, アラート, CSV Export, トレンド | 534→534 | ✅ |
| Sprint 5 | 仮想スクロール, Web Worker, バンドル最適化 | 534→564 | ✅ |
| Sprint 6 | PWA, クラウド準備, ダッシュボードプリセット, モバイル | 564→587 | ✅ |
| Sprint 7 | 計算キャッシュ, E2Eテスト基盤, i18n | 587→609 | ✅ |
| Sprint 8 | Storybook, Visual Regression テスト | 609→612 | ✅ |
