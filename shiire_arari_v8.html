<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»•å…¥ç²—åˆ©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{--bg:#09090b;--bg2:#0f1117;--bg3:#16181f;--bg4:#1c1f28;--border:rgba(255,255,255,0.06);--primary:#6366f1;--success:#34d399;--warning:#fbbf24;--danger:#f87171;--info:#38bdf8;--purple:#a78bfa;--text:#f4f4f5;--text2:#a1a1aa;--text3:#71717a;--text4:#52525b;--r:10px;--t:0.2s}
        /* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ */
        [data-theme="light"]{--bg:#f8fafc;--bg2:#ffffff;--bg3:#f1f5f9;--bg4:#e2e8f0;--border:rgba(0,0,0,0.08);--text:#0f172a;--text2:#475569;--text3:#64748b;--text4:#94a3b8}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background 0.3s,color 0.3s}
        .app{display:grid;grid-template-columns:56px 260px 1fr;height:100vh;overflow:hidden}
        .nav{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:14px 0;gap:4px}
        .nav-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:20px}
        .nav-item{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text4);transition:all var(--t)}
        .nav-item:hover{background:var(--bg4);color:var(--text2)}
        .nav-item.active{background:rgba(99,102,241,0.15);color:var(--primary)}
        .nav-spacer{flex:1}
        .sidebar{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
        .sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
        .sidebar-title{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text4);margin-bottom:2px}
        .sidebar-heading{font-size:0.9rem;font-weight:700}
        .sidebar-content{flex:1;overflow-y:auto;padding:14px}
        .sidebar-section{margin-bottom:16px}
        .section-label{font-size:0.6rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:8px}
        .upload-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
        .upload-card{background:var(--bg3);border:1.5px dashed rgba(255,255,255,0.08);border-radius:7px;padding:10px 4px 8px;text-align:center;cursor:pointer;transition:all var(--t);position:relative}
        .upload-card:hover{border-color:rgba(99,102,241,0.3);background:var(--bg4)}
        .upload-card.loaded{border-color:rgba(52,211,153,0.4);border-style:solid;background:rgba(52,211,153,0.08)}
        .upload-card.loaded::after{content:'âœ“';position:absolute;top:3px;right:5px;font-size:0.55rem;color:var(--success);font-weight:700}
        .upload-card .icon{font-size:1.1rem;margin-bottom:2px}
        .upload-card .name{font-size:0.6rem;font-weight:600;color:var(--text3)}
        .upload-card.loaded .name{color:var(--success)}
        .upload-card input{display:none}
        .chip-group{display:flex;flex-wrap:wrap;gap:4px}
        .chip{padding:5px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:0.65rem;font-weight:600;cursor:pointer;color:var(--text3);transition:all var(--t)}
        .chip:hover{border-color:rgba(99,102,241,0.3);color:var(--text2)}
        .chip.active{background:var(--primary);border-color:var(--primary);color:white}
        .input-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        .input-field{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 10px}
        .input-field label{display:block;font-size:0.52rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:2px}
        .input-field input{width:100%;background:transparent;border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.78rem;text-align:right}
        .input-field input:focus{outline:none}
        .btn{width:100%;padding:10px 14px;border:none;border-radius:7px;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all var(--t)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#4f46e5);color:white}
        .btn-primary:hover{transform:translateY(-1px)}
        .btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none}
        .btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:white;margin-top:6px}
        .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--text2)}
        .btn-outline:hover{border-color:rgba(99,102,241,0.3);background:var(--bg4)}
        .main{display:flex;flex-direction:column;overflow:hidden}
        .topbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
        .topbar-title{font-size:0.95rem;font-weight:700;display:flex;align-items:center;gap:8px}
        .topbar-badge{padding:2px 8px;background:var(--primary);border-radius:5px;font-size:0.6rem;font-weight:700}
        .topbar-tabs{display:flex;gap:3px;margin-left:auto;background:var(--bg3);border-radius:7px;padding:3px;border:1px solid var(--border)}
        .topbar-tab{padding:5px 12px;background:transparent;border:none;border-radius:5px;font-size:0.7rem;font-weight:600;cursor:pointer;color:var(--text3);font-family:inherit}
        .topbar-tab:hover{color:var(--text2);background:var(--bg4)}
        .topbar-tab.active{background:var(--primary);color:white}
        .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:14px 20px;background:var(--bg2);border-bottom:1px solid var(--border)}
        .stat-card{background:var(--bg3);border-radius:var(--r);padding:12px 14px;border:1px solid var(--border);position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
        .stat-card:nth-child(1)::before{background:linear-gradient(90deg,var(--primary),#818cf8)}
        .stat-card:nth-child(2)::before{background:linear-gradient(90deg,var(--warning),#f59e0b)}
        .stat-card:nth-child(3)::before{background:linear-gradient(90deg,var(--success),#34d399)}
        .stat-card:nth-child(4)::before{background:linear-gradient(90deg,var(--info),#38bdf8)}
        .stat-card .label{font-size:0.58rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:4px}
        .stat-card .value{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600}
        .stat-card .sub{font-size:0.6rem;color:var(--text3);margin-top:3px}
        .content{flex:1;overflow:auto;padding:16px 20px}
        .section{background:var(--bg2);border-radius:var(--r);border:1px solid var(--border);margin-bottom:12px;overflow:hidden}
        .section-header{padding:10px 14px;background:var(--bg3);border-bottom:1px solid transparent;display:flex;align-items:center;gap:10px;cursor:pointer}
        .section.expanded .section-header{border-bottom-color:var(--border)}
        .section-header:hover{background:var(--bg4)}
        .section-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.95rem}
        .section-icon.ti{background:linear-gradient(135deg,#4ade80,#22c55e)}
        .section-icon.to{background:linear-gradient(135deg,#fb7185,#f43f5e)}
        .section-icon.bi{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
        .section-icon.bo{background:linear-gradient(135deg,#c084fc,#a855f7)}
        .section-icon.daily{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
        .section-icon.market{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
        .section-icon.lfc{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
        .section-icon.salad{background:linear-gradient(135deg,#4ade80,#22c55e)}
        .section-icon.kakou{background:linear-gradient(135deg,#c084fc,#a855f7)}
        .section-icon.chokuden{background:linear-gradient(135deg,#22d3ee,#06b6d4)}
        .section-icon.hana{background:linear-gradient(135deg,#f472b6,#ec4899)}
        .section-icon.sanchoku{background:linear-gradient(135deg,#a3e635,#84cc16)}
        .section-icon.consumable{background:linear-gradient(135deg,#f97316,#ea580c)}
        .section-icon.tenkan{background:linear-gradient(135deg,#fb7185,#f43f5e)}
        .section-icon.bumonkan{background:linear-gradient(135deg,#a78bfa,#8b5cf6)}
        .section-icon.other{background:linear-gradient(135deg,#94a3b8,#64748b)}
        .section-info{flex:1}
        .section-name{font-weight:600;font-size:0.82rem}
        .section-meta{font-size:0.62rem;color:var(--text3)}
        .section-stats{display:flex;gap:14px;font-family:'JetBrains Mono',monospace;font-size:0.7rem;font-weight:500}
        .section-stats .sl{color:var(--text4);font-size:0.55rem;font-family:'Noto Sans JP',sans-serif}
        .section-stats .cost{color:var(--warning)}
        .section-stats .price{color:var(--success)}
        .section-toggle{width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:var(--text4);transition:transform var(--t);font-size:0.65rem}
        .section.expanded .section-toggle{transform:rotate(180deg)}
        .section-body{max-height:0;overflow:hidden;transition:max-height 0.35s ease}
        .section.expanded .section-body{max-height:600px;overflow:auto}
        table{width:100%;border-collapse:collapse;font-size:0.68rem}
        th,td{padding:7px 10px;text-align:right;border-bottom:1px solid var(--border);white-space:nowrap}
        th{background:var(--bg3);color:var(--text4);font-weight:700;font-size:0.56rem;text-transform:uppercase;position:sticky;top:0;z-index:5}
        th:first-child,td:first-child{text-align:left;position:sticky;left:0;background:var(--bg2);z-index:3}
        th:first-child{z-index:10;background:var(--bg3)}
        tr:hover td{background:var(--bg4)}
        tr:hover td:first-child{background:var(--bg4)}
        .row-total{background:rgba(99,102,241,0.05)}
        .row-total td{font-weight:700;border-top:1px solid rgba(255,255,255,0.1)}
        td.positive{color:var(--success)}
        td.negative{color:var(--danger)}
        td.highlight{color:var(--info)}
        .col-cost{background:rgba(251,191,36,0.02)}
        .col-price{background:rgba(52,211,153,0.02)}
        .summary-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:14px;border-bottom:1px solid var(--border)}
        .summary-card{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:12px;position:relative;overflow:hidden}
        .summary-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
        .summary-card.ti::before{background:linear-gradient(90deg,#4ade80,#22c55e)}
        .summary-card.to::before{background:linear-gradient(90deg,#fb7185,#f43f5e)}
        .summary-card.bi::before{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
        .summary-card.bo::before{background:linear-gradient(90deg,#c084fc,#a855f7)}
        .summary-card .sc-label{font-size:0.58rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:4px}
        .summary-card .sc-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600}
        .summary-card .sc-sub{font-size:0.6rem;color:var(--text3);margin-top:2px}
        .store-tag{display:inline-flex;align-items:center;gap:2px;padding:2px 8px;border-radius:4px;font-size:0.62rem;font-weight:600;font-family:'JetBrains Mono',monospace;margin:1px}
        .store-tag.from{background:rgba(52,211,153,0.1);color:var(--success);border:1px solid rgba(52,211,153,0.2)}
        .store-tag.to{background:rgba(248,113,113,0.1);color:var(--danger);border:1px solid rgba(248,113,113,0.2)}
        .store-tag.bumon{background:rgba(167,139,250,0.1);color:var(--purple);border:1px solid rgba(167,139,250,0.2)}
        .flow-self{color:var(--purple);font-size:0.65rem;font-style:italic}
        .stores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
        .store-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;cursor:pointer;transition:all var(--t)}
        .store-card:hover{border-color:rgba(99,102,241,0.3);transform:translateY(-3px)}
        .store-card-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
        .store-card-icon{width:38px;height:38px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem}
        .store-card-name{font-weight:700;font-size:0.88rem}
        .store-card-code{font-size:0.65rem;color:var(--text4);font-family:'JetBrains Mono',monospace}
        .store-card-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .store-card-stat .label{font-size:0.55rem;color:var(--text4);font-weight:600;text-transform:uppercase}
        .store-card-stat .value{font-family:'JetBrains Mono',monospace;font-size:0.82rem;font-weight:600;margin-top:1px}
        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px}
        .summary-panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px}
        .summary-panel-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
        .summary-panel-icon{width:34px;height:34px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center}
        .summary-panel-title{font-weight:700;font-size:0.82rem}
        .summary-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.78rem}
        .summary-row:last-child{border-bottom:none}
        .summary-row .lt{color:var(--text2)}
        .summary-row .value{font-family:'JetBrains Mono',monospace;font-weight:500}
        .summary-total{margin-top:10px;padding:10px 12px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.15);border-radius:7px;display:flex;justify-content:space-between;font-weight:700}
        .summary-total .value{color:var(--success);font-family:'JetBrains Mono',monospace}
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 40px;text-align:center}
        .empty-icon{width:72px;height:72px;border-radius:20px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:18px}
        .empty-state h3{font-size:1rem;font-weight:600;margin-bottom:6px;color:var(--text2)}
        .empty-state p{font-size:0.8rem;color:var(--text3);max-width:300px}
        .loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 40px}
        .spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast-container{position:fixed;bottom:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
        .toast{background:var(--bg3);border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:10px 16px;font-size:0.78rem;font-weight:500;display:flex;align-items:center;gap:8px;animation:toastIn 0.3s ease,toastOut 0.3s ease 2.7s forwards}
        @keyframes toastIn{from{opacity:0;transform:translateY(10px)}}
        @keyframes toastOut{to{opacity:0}}
        .toast.success{border-left:3px solid var(--success)}
        .toast.error{border-left:3px solid var(--danger)}
        .toast.info{border-left:3px solid var(--info)}
        .toast.warning{border-left:3px solid var(--warning)}
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone{border:2px dashed rgba(99,102,241,0.3);border-radius:10px;padding:16px;margin-bottom:10px;text-align:center;transition:all 0.3s;background:rgba(99,102,241,0.03)}
        .drop-zone.drag-over{border-color:var(--success);background:rgba(52,211,153,0.1);transform:scale(1.02)}
        .drop-zone-icon{font-size:1.8rem;margin-bottom:6px}
        .drop-zone-text{font-size:0.7rem;color:var(--text2);margin-bottom:2px}
        .drop-zone-hint{font-size:0.6rem;color:var(--text4)}
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        [data-tip]{position:relative;cursor:help}
        [data-tip]::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);padding:6px 10px;background:var(--bg4);border:1px solid var(--border);border-radius:6px;font-size:0.6rem;font-weight:400;color:var(--text2);white-space:pre-line;max-width:220px;text-align:left;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:100;margin-bottom:5px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        [data-tip]:hover::after{opacity:1}
        /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
        .alert-card{padding:12px 14px;border-radius:8px;margin-bottom:10px;display:flex;align-items:flex-start;gap:10px}
        .alert-card.danger{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
        .alert-card.warning{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3)}
        .alert-card.success{background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3)}
        .alert-card.info{background:rgba(56,189,248,0.1);border:1px solid rgba(56,189,248,0.3)}
        .alert-icon{font-size:1.1rem}
        .alert-content{flex:1}
        .alert-title{font-size:0.75rem;font-weight:600;margin-bottom:2px}
        .alert-desc{font-size:0.65rem;color:var(--text3)}
        /* KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
        .kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
        .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
        .kpi-card[data-color="primary"]::before{background:var(--primary)}
        .kpi-card[data-color="success"]::before{background:var(--success)}
        .kpi-card[data-color="warning"]::before{background:var(--warning)}
        .kpi-card[data-color="danger"]::before{background:var(--danger)}
        .kpi-card[data-color="info"]::before{background:var(--info)}
        .kpi-card[data-color="purple"]::before{background:var(--purple)}
        .kpi-card[data-color="cyan"]::before{background:#06b6d4}
        .kpi-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .kpi-label{font-size:0.6rem;font-weight:600;color:var(--text4);text-transform:uppercase}
        .kpi-icon{font-size:1rem}
        .kpi-value{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;margin-bottom:4px}
        .kpi-sub{font-size:0.62rem;color:var(--text3)}
        .kpi-progress{height:4px;background:var(--bg4);border-radius:2px;margin-top:10px;overflow:hidden}
        .kpi-progress-bar{height:100%;border-radius:2px;transition:width 0.5s ease}
        /* é€±é–“äºˆæ¸¬ã‚«ãƒ¼ãƒ‰ */
        .forecast-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:12px}
        .forecast-day{background:var(--bg3);border-radius:8px;padding:10px 6px;text-align:center;border:1px solid var(--border)}
        .forecast-day.today{border-color:var(--primary);background:rgba(99,102,241,0.1)}
        .forecast-day.past{opacity:0.6}
        .forecast-day-name{font-size:0.55rem;font-weight:600;color:var(--text4);margin-bottom:2px}
        .forecast-day-date{font-size:0.6rem;color:var(--text3);margin-bottom:6px}
        .forecast-day-value{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:600}
        .forecast-day-target{font-size:0.5rem;color:var(--text4);margin-top:2px}
        /* ãƒ¬ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
        .report-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all 0.2s}
        .report-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        .report-card-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;margin-bottom:12px}
        .report-card-title{font-weight:600;font-size:0.85rem;margin-bottom:4px}
        .report-card-desc{font-size:0.65rem;color:var(--text3)}
        /* ã‚«ãƒ©ãƒ è¨­å®š */
        .column-config{display:flex;flex-direction:column;gap:6px}
        .column-item{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg3);border-radius:6px;cursor:grab;user-select:none}
        .column-item:active{cursor:grabbing}
        .column-item.dragging{opacity:0.5;background:var(--bg4)}
        .column-item-handle{color:var(--text4);font-size:0.8rem}
        .column-item-name{flex:1;font-size:0.75rem}
        .column-item-toggle{width:36px;height:20px;background:var(--bg4);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s}
        .column-item-toggle.active{background:var(--primary)}
        .column-item-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s}
        .column-item-toggle.active::after{left:18px}
        /* ãƒ—ãƒªãƒ³ãƒˆç”¨ */
        @media print{.app{display:block}.nav,.sidebar{display:none}.main{width:100%}.topbar{display:none}.content{padding:0}.section{break-inside:avoid}}
        ::-webkit-scrollbar{width:5px;height:5px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
    </style>
</head>
<body>
    <div class="app">
        <nav class="nav">
            <div class="nav-logo">ğŸ“Š</div>
            <div class="nav-item active" title="ãƒ‡ãƒ¼ã‚¿ç®¡ç†">ğŸ“</div>
            <div class="nav-item" title="åˆ†æ">ğŸ“ˆ</div>
            <div class="nav-spacer"></div>
            <div class="nav-item" id="theme-toggle" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</div>
            <div class="nav-item" onclick="showSettingsModal()" title="è¨­å®š">âš™ï¸</div>
        </nav>
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ä»•å…¥ç²—åˆ©ç®¡ç†</div>
                <div class="sidebar-heading">å–å¼•å…ˆåˆ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ v8</div>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="section-label">ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«</div>
                    <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-zone-icon">ğŸ“‚</div>
                        <div class="drop-zone-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="drop-zone-hint">ã¾ãŸã¯ä¸‹ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
                    </div>
                    <div class="upload-grid">
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“¦</div><div class="name">ä»•å…¥</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'shiire')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ’°</div><div class="name">å£²ä¸Š</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'uriage')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“‰</div><div class="name">å£²å¤‰</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'baihen')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">âš™ï¸</div><div class="name">åˆæœŸè¨­å®š</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'settings')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“Š</div><div class="name">äºˆç®—</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'budget')"></div>
                        <div class="upload-card" onclick="showConsumableModal()"><div class="icon">ğŸ§¾</div><div class="name">æ¶ˆè€—å“</div><input type="file" id="consumable-input" accept=".xlsx,.xls" multiple style="display:none" onchange="processConsumableFiles(this)"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“¥</div><div class="name">åº—é–“å…¥</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'tenkanIn')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“¤</div><div class="name">åº—é–“å‡º</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'tenkanOut')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ¥¬</div><div class="name">ç”£ç›´</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'sanchoku')"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸŒ¸</div><div class="name">èŠ±</div><input type="file" accept=".xlsx,.xls" onchange="loadFile(this,'hana')"></div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸ¯ ç›®æ¨™è¨­å®š</div>
                    <div class="input-grid">
                        <div class="input-field" style="border-left:3px solid var(--success)">
                            <label>ç›®æ¨™ç²—åˆ©ç‡ (%)</label>
                            <input type="text" id="target-margin" value="25.00">
                        </div>
                        <div class="input-field" style="border-left:3px solid var(--warning)">
                            <label>è­¦å‘Šã—ãã„å€¤ (%)</label>
                            <input type="text" id="warning-margin" value="23.00">
                        </div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸŒ¸ğŸ¥¬ èŠ±ãƒ»ç”£ç›´ æ›ã‘ç‡</div>
                    <div class="input-grid">
                        <div class="input-field" style="border-left:3px solid #f472b6">
                            <label>ğŸŒ¸ èŠ± æ›ã‘ç‡</label>
                            <input type="text" id="hana-rate" value="0.80">
                        </div>
                        <div class="input-field" style="border-left:3px solid #a3e635">
                            <label>ğŸ¥¬ ç”£ç›´ æ›ã‘ç‡</label>
                            <input type="text" id="sanchoku-rate" value="0.85">
                        </div>
                    </div>
                    <div style="margin-top:6px;padding:6px 8px;background:var(--bg4);border-radius:5px;font-size:0.58rem;color:var(--text3)">
                        å£²ä¸Šç´å“ã®ãŸã‚ã€å£²ä¾¡Ã—æ›ã‘ç‡=åŸä¾¡ã¨ã—ã¦è¨ˆç®—
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">âš™ï¸ ä»•å…¥å…ˆãƒ»å¸³åˆè¨­å®š <span style="font-size:0.5rem;color:var(--text4);font-weight:400">(ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã)</span></div>
                    <button onclick="showSupplierSettingsModal()" style="width:100%;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
                        <span>ğŸ­</span> ä»•å…¥å…ˆåˆ¥è¨­å®šãƒ»å¸³åˆåˆ†é¡ã‚’ç·¨é›†
                    </button>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸª åº—èˆ—</div>
                    <div class="chip-group" id="store-chips"><div class="chip active" data-store="all">å…¨åº—èˆ—</div></div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸ“¦ åº—èˆ—åˆ¥ åœ¨åº«è¨­å®š <span style="font-size:0.5rem;color:var(--text4);font-weight:400">(åˆæœŸè¨­å®šã§è‡ªå‹•å…¥åŠ›)</span></div>
                    <div id="store-inventory-container" style="max-height:180px;overflow-y:auto;margin-bottom:8px">
                        <div style="font-size:0.65rem;color:var(--text4);padding:8px;text-align:center">åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤º</div>
                    </div>
                    <div class="input-grid">
                        <div class="input-field"><label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆäºˆç®—</label><input type="text" id="budget" value="6,450,000" oninput="formatInput(this)"></div>
                        <div class="input-field"><label>å€¤å…¥ç‡</label><input type="text" id="margin-rate" value="0.26"></div>
                    </div>
                    <div style="margin-top:4px;font-size:0.55rem;color:var(--text4)">â€»äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼æ™‚ã¯æ—¥åˆ¥äºˆç®—ã‚’ä½¿ç”¨</div>
                </div>
                <div class="sidebar-section">
                    <button class="btn btn-primary" id="btn-generate" onclick="generate()" disabled>ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆ</button>
                    <button class="btn btn-success" id="btn-export" onclick="exportExcel()" style="display:none;">ğŸ“¥ Excelå‡ºåŠ›</button>
                </div>
            </div>
        </aside>
        <main class="main">
            <div class="topbar">
                <div class="topbar-title">
                    <span id="view-title">ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾…ã¡</span>
                    <span class="topbar-badge" id="store-badge" style="display:none;">01</span>
                </div>
                <div class="topbar-tabs" id="view-tabs" style="display:none;">
                    <button class="topbar-tab active" data-view="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                    <button class="topbar-tab" data-view="category">å¸³åˆåˆ¥</button>
                    <button class="topbar-tab" data-view="forecast">ğŸ“… é€±é–“äºˆæ¸¬</button>
                    <button class="topbar-tab" data-view="analysis">äºˆç®—åˆ†æ</button>
                    <button class="topbar-tab" data-view="daily">æ—¥åˆ¥æ¨ç§»</button>
                    <button class="topbar-tab" data-view="summary">è’åˆ©è¨ˆç®—</button>
                    <button class="topbar-tab" data-view="reports">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆ</button>
                </div>
            </div>
            <div class="stats-row" id="stats-row" style="display:none;">
                <div class="stat-card"><div class="label">å£²ä¸Šå®Ÿç¸¾</div><div class="value" id="stat-sales">-</div><div class="sub" id="stat-sales-sub">-</div></div>
                <div class="stat-card"><div class="label">ç·ä»•å…¥é«˜</div><div class="value" style="color:var(--warning)" id="stat-cost">-</div><div class="sub" id="stat-consumable">-</div></div>
                <div class="stat-card"><div class="label">è’åˆ©ç‡(ç¨æŠœå‰)</div><div class="value" style="color:var(--info)" id="stat-rate-before">-</div><div class="sub" id="stat-profit-before">-</div></div>
                <div class="stat-card"><div class="label">è’åˆ©ç‡(ç¨æŠœå¾Œ)</div><div class="value" style="color:var(--success)" id="stat-rate">-</div><div class="sub" id="stat-profit-sub">-</div></div>
            </div>
            <div class="content" id="content">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‚</div>
                    <h3>ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</h3>
                    <p>å·¦ã®ãƒ‘ãƒãƒ«ã‹ã‚‰ã€Œä»•å…¥ã€ã¨ã€Œå£²ä¸Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã€åˆ†æã‚’é–‹å§‹ã§ãã¾ã™</p>
                </div>
            </div>
        </main>
    </div>
    <div class="toast-container" id="toast-container"></div>
    
    <!-- æ¶ˆè€—å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="consumable-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:340px;max-width:90%">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:8px;display:flex;align-items:center;justify-content:center">ğŸ§¾</span>
                æ¶ˆè€—å“ãƒ‡ãƒ¼ã‚¿èª­è¾¼
            </div>
            <div id="consumable-status" style="padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:16px;font-size:0.75rem">
                <div style="color:var(--text3)">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿:</div>
                <div id="consumable-count" style="font-family:'JetBrains Mono',monospace;color:var(--text);margin-top:4px">æœªèª­è¾¼</div>
            </div>
            <div style="font-size:0.7rem;color:var(--text3);margin-bottom:12px">èª­è¾¼æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„:</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">
                <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                    <input type="radio" name="consumable-mode" value="overwrite" checked style="accent-color:var(--primary)">
                    <div>
                        <div style="font-weight:600;font-size:0.8rem">ğŸ”„ ä¸Šæ›¸ã</div>
                        <div style="font-size:0.65rem;color:var(--text3)">æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°è¦èª­è¾¼</div>
                    </div>
                </label>
                <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--success)'" onmouseout="this.style.borderColor='var(--border)'">
                    <input type="radio" name="consumable-mode" value="append" style="accent-color:var(--success)">
                    <div>
                        <div style="font-weight:600;font-size:0.8rem">â• è¿½åŠ </div>
                        <div style="font-size:0.65rem;color:var(--text3)">æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆåŒæ—¥ã¯åˆç®—ï¼‰</div>
                    </div>
                </label>
            </div>
            <div style="display:flex;gap:8px">
                <button onclick="closeConsumableModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="selectConsumableFiles()" style="flex:1;padding:10px;background:linear-gradient(135deg,#f97316,#ea580c);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
            </div>
        </div>
    </div>
    
    <!-- ä»•å…¥å…ˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="supplier-settings-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:600px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:8px;display:flex;align-items:center;justify-content:center">ğŸ­</span>
                ä»•å…¥å…ˆãƒ»å¸³åˆè¨­å®š
            </div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="supplier-settings-content">
                <div style="font-size:0.65rem;color:var(--text4);padding:16px;text-align:center">ä»•å…¥ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeSupplierSettingsModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">é–‰ã˜ã‚‹</button>
                <button onclick="saveSupplierSettings()" style="flex:1;padding:10px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settings-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:500px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:8px;display:flex;align-items:center;justify-content:center">âš™ï¸</span>
                è¨­å®š
            </div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="settings-content">
                <!-- è¨­å®šå†…å®¹ã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeSettingsModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveAllSettings()" style="flex:1;padding:10px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="validation-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:500px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:8px;display:flex;align-items:center;justify-content:center">âš ï¸</span>
                ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ
            </div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="validation-content">
                <!-- æ¤œè¨¼çµæœã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeValidationModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">é–‰ã˜ã‚‹</button>
                <button onclick="proceedWithWarnings()" style="flex:1;padding:10px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">è­¦å‘Šã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="report-preview-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:800px;max-width:95%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
                <span id="report-preview-icon" style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem">ğŸ“‹</span>
                <div style="flex:1">
                    <div id="report-preview-title" style="font-size:1rem;font-weight:700">ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                    <div id="report-preview-sub" style="font-size:0.65rem;color:var(--text3)"></div>
                </div>
                <button onclick="closeReportPreview()" style="width:32px;height:32px;background:var(--bg3);border:none;border-radius:6px;color:var(--text2);cursor:pointer;font-size:1rem">âœ•</button>
            </div>
            <div style="flex:1;overflow-y:auto;padding:20px" id="report-preview-content">
                <!-- ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
                <button onclick="printReport()" style="padding:10px 20px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ–¨ï¸ å°åˆ·</button>
                <button onclick="exportReportExcel()" style="padding:10px 20px;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ“¥ Excelå‡ºåŠ›</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚«ãƒ©ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="column-config-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:400px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#06b6d4,#0891b2);border-radius:8px;display:flex;align-items:center;justify-content:center">ğŸ“Š</span>
                è¡¨ç¤ºåˆ—ã®è¨­å®š
            </div>
            <div style="font-size:0.65rem;color:var(--text3);margin-bottom:12px">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³é †ã‚’å¤‰æ›´ã€ãƒˆã‚°ãƒ«ã§è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ</div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="column-config-content">
                <!-- ã‚«ãƒ©ãƒ è¨­å®šã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeColumnConfig()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">é–‰ã˜ã‚‹</button>
                <button onclick="applyColumnConfig()" style="flex:1;padding:10px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">é©ç”¨</button>
            </div>
        </div>
    </div>
<script>
const DATA={};let STORES={},SUPPLIERS={};let currentStore='all',currentView='dashboard',result=null;
let STORE_INVENTORY={};  // åº—èˆ—åˆ¥åœ¨åº«ãƒ‡ãƒ¼ã‚¿ {storeId: {invStart: number, invEnd: number}}
let STORE_BUDGET={};     // åº—èˆ—åˆ¥æ—¥åˆ¥äºˆç®—ãƒ‡ãƒ¼ã‚¿ {storeId: {day: budget}}
let CONSUMABLES={};      // åŸä¾¡ç®—å…¥æ¯”ãƒ‡ãƒ¼ã‚¿ {storeId: {day: {cost: number, items: []}}}
let SUPPLIER_SETTINGS={};// ä»•å…¥å…ˆåˆ¥è¨­å®š {code: {marginRate: number, usePriceCalc: boolean}}
let CATEGORIES={market:{name:'å¸‚å ´',icon:'ğŸª',order:1},lfc:{name:'LFC',icon:'ğŸšš',order:2},salad:{name:'ã‚µãƒ©ãƒ€ã‚¯ãƒ©ãƒ–',icon:'ğŸ¥—',order:3},kakou:{name:'åŠ å·¥å“',icon:'ğŸ“¦',order:4},chokuden:{name:'ç›´ä¼',icon:'ğŸœ',order:5},hana:{name:'èŠ±',icon:'ğŸŒ¸',order:6},sanchoku:{name:'ç”£ç›´',icon:'ğŸ¥¬',order:7},consumable:{name:'åŸä¾¡ç®—å…¥æ¯”',icon:'ğŸ§¾',order:7.5},tenkan:{name:'åº—é–“ç§»å‹•',icon:'ğŸ”„',order:8},bumonkan:{name:'éƒ¨é–€é–“ç§»å‹•',icon:'ğŸ”€',order:9},other:{name:'ãã®ä»–',icon:'ğŸ“‹',order:99}};
let SUPPLIER_CAT_MAP={'0074721':'market','0012104':'lfc','0012072':'lfc','0017175':'salad','0030627':'kakou','0030344':'kakou','0044121':'kakou','0074017':'kakou','0074088':'chokuden','0076511':'chokuden','0017426':'other','0017663':'other','0074508':'other','0075825':'hana','0076686':'hana','0037923':'hana','0011002':'other'};
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0074721ã¯å£²ä¾¡ãŒä»®ãªã®ã§å€¤å…¥ç‡ã§è¨ˆç®—
SUPPLIER_SETTINGS['0074721']={marginRate:0.26,usePriceCalc:true};

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—å®šç¾©ï¼ˆè‡ªå‹•åˆ¤å®šç”¨ï¼‰
const FILE_TYPES={
    shiire:{name:'ä»•å…¥',patterns:['ä»•å…¥','shiire'],headerPatterns:['å–å¼•å…ˆã‚³ãƒ¼ãƒ‰','åŸä¾¡é‡‘é¡','å£²ä¾¡é‡‘é¡']},
    uriage:{name:'å£²ä¸Š',patterns:['å£²ä¸Š','uriage'],headerPatterns:['è²©å£²é‡‘é¡','å£²ä¸Š']},
    baihen:{name:'å£²å¤‰',patterns:['å£²å¤‰','baihen'],headerPatterns:['å£²å¤‰åˆè¨ˆ','å€¤å¼•']},
    settings:{name:'åˆæœŸè¨­å®š',patterns:['åˆæœŸ','è¨­å®š','setting'],headerPatterns:['æœŸé¦–','æœŸæœ«']},
    budget:{name:'äºˆç®—',patterns:['äºˆç®—','budget'],headerPatterns:['äºˆç®—']},
    tenkanIn:{name:'åº—é–“å…¥',patterns:['åº—é–“å…¥','å…¥åº«'],headerPatterns:['åº—èˆ—ã‚³ãƒ¼ãƒ‰IN']},
    tenkanOut:{name:'åº—é–“å‡º',patterns:['åº—é–“å‡º','å‡ºåº«'],headerPatterns:['åº—èˆ—ã‚³ãƒ¼ãƒ‰OUT']},
    hana:{name:'èŠ±',patterns:['èŠ±','hana'],headerPatterns:['è²©å£²é‡‘é¡']},
    sanchoku:{name:'ç”£ç›´',patterns:['ç”£ç›´','sanchoku'],headerPatterns:['è²©å£²é‡‘é¡']}
};

const parseNum=s=>parseInt(String(s).replace(/[^\d.-]/g,''))||0;
const fmt=n=>n==null||isNaN(n)?'-':Math.round(n).toLocaleString('ja-JP');
const fmtPct=(n,d=2)=>n==null||isNaN(n)?'-':(n*100).toFixed(d)+'%';
function formatInput(el){let v=el.value.replace(/[^\d]/g,'');if(v)el.value=parseInt(v).toLocaleString('ja-JP');}
function parseDate(v){if(!v)return null;if(typeof v==='number')return new Date((v-25569)*86400*1000);const s=String(v);let m=s.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);m=s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);m=s.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);return null;}
function getCatOrder(){return Object.entries(CATEGORIES).sort((a,b)=>a[1].order-b[1].order).map(([k])=>k);}
function showToast(msg,type='info'){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className='toast '+type;t.innerHTML='<span>'+(type==='success'?'âœ“':type==='error'?'âœ•':type==='warning'?'âš ':'â„¹')+'</span> '+msg;c.appendChild(t);setTimeout(()=>t.remove(),3200);}

// ===== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ =====
function initDropZone(){
    const dropZone=document.getElementById('drop-zone');
    if(!dropZone)return;
    
    dropZone.addEventListener('dragover',e=>{
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave',()=>{
        dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop',e=>{
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleDroppedFiles(e.dataTransfer.files);
    });
    dropZone.addEventListener('click',()=>{
        const input=document.createElement('input');
        input.type='file';
        input.multiple=true;
        input.accept='.xlsx,.xls';
        input.onchange=()=>handleDroppedFiles(input.files);
        input.click();
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•åˆ¤å®š
function detectFileType(filename,data){
    const lowerName=filename.toLowerCase();
    // ãƒ•ã‚¡ã‚¤ãƒ«åãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒã‚§ãƒƒã‚¯
    for(const[type,config]of Object.entries(FILE_TYPES)){
        for(const pattern of config.patterns){
            if(lowerName.includes(pattern.toLowerCase()))return type;
        }
    }
    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒã‚§ãƒƒã‚¯
    if(data&&data.length>0){
        const headerStr=data.slice(0,3).flat().map(x=>String(x||'')).join(' ').toLowerCase();
        for(const[type,config]of Object.entries(FILE_TYPES)){
            const matches=config.headerPatterns.filter(p=>headerStr.includes(p.toLowerCase()));
            if(matches.length>=1)return type;
        }
    }
    return null;
}

// ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
async function handleDroppedFiles(files){
    const fileArray=Array.from(files);
    let loadedCount=0;
    
    for(const file of fileArray){
        try{
            const data=await readExcelFile(file);
            const type=detectFileType(file.name,data);
            
            if(type){
                DATA[type]=data;
                const card=document.querySelector(`.upload-card input[onchange*="${type}"]`)?.closest('.upload-card');
                if(card)card.classList.add('loaded');
                
                // ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¾Œå‡¦ç†
                if(type==='shiire')detectStoresAndSuppliers();
                if(type==='hana'||type==='sanchoku')detectStoresFromHanaSanchoku(type);
                if(type==='settings')processSettings();
                if(type==='budget')processBudget();
                
                showToast(`${FILE_TYPES[type].name}: ${file.name}`,'success');
                loadedCount++;
            }else{
                showToast(`${file.name}ã®ç¨®é¡ã‚’åˆ¤å®šã§ãã¾ã›ã‚“`,'warning');
            }
        }catch(err){
            showToast(`${file.name}: ${err.message}`,'error');
        }
    }
    
    if(loadedCount>0){
        showToast(`${loadedCount}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`,'success');
        document.getElementById('btn-generate').disabled=!(DATA.shiire&&DATA.uriage);
    }
}

function readExcelFile(file){
    return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
            try{
                const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
                const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
                resolve(data);
            }catch(err){reject(err);}
        };
        reader.onerror=()=>reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã‚¨ãƒ©ãƒ¼'));
        reader.readAsArrayBuffer(file);
    });
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded',()=>{
    initDropZone();
    loadSavedSettings();
    applyTheme();
});

// ===== ãƒ†ãƒ¼ãƒç®¡ç† =====
let currentTheme='dark';

function toggleTheme(){
    currentTheme=currentTheme==='dark'?'light':'dark';
    applyTheme();
    saveSettingsToStorage();
}

function applyTheme(){
    document.documentElement.setAttribute('data-theme',currentTheme);
    const btn=document.getElementById('theme-toggle');
    if(btn)btn.textContent=currentTheme==='dark'?'ğŸŒ™':'â˜€ï¸';
}

// ===== LocalStorageè¨­å®šä¿å­˜ =====
function saveSettingsToStorage(){
    try{
        const settings={
            theme:currentTheme,
            targetMargin:document.getElementById('target-margin')?.value||'25.00',
            warningMargin:document.getElementById('warning-margin')?.value||'23.00',
            hanaRate:document.getElementById('hana-rate')?.value||'0.80',
            sanchokuRate:document.getElementById('sanchoku-rate')?.value||'0.85',
            marginRate:document.getElementById('margin-rate')?.value||'0.26',
            supplierSettings:SUPPLIER_SETTINGS,
            supplierCatMap:SUPPLIER_CAT_MAP
        };
        localStorage.setItem('shiire_settings_v8',JSON.stringify(settings));
    }catch(e){console.warn('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:',e);}
}

function loadSavedSettings(){
    try{
        const saved=localStorage.getItem('shiire_settings_v8');
        if(saved){
            const s=JSON.parse(saved);
            currentTheme=s.theme||'dark';
            if(s.targetMargin)document.getElementById('target-margin').value=s.targetMargin;
            if(s.warningMargin)document.getElementById('warning-margin').value=s.warningMargin;
            if(s.hanaRate)document.getElementById('hana-rate').value=s.hanaRate;
            if(s.sanchokuRate)document.getElementById('sanchoku-rate').value=s.sanchokuRate;
            if(s.marginRate)document.getElementById('margin-rate').value=s.marginRate;
            if(s.supplierSettings)Object.assign(SUPPLIER_SETTINGS,s.supplierSettings);
            if(s.supplierCatMap)Object.assign(SUPPLIER_CAT_MAP,s.supplierCatMap);
            showToast('ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ','info');
        }
    }catch(e){console.warn('è¨­å®šèª­è¾¼ã‚¨ãƒ©ãƒ¼:',e);}
}

// ===== è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« =====
function showSettingsModal(){
    renderSettingsContent();
    document.getElementById('settings-modal').style.display='flex';
}

function closeSettingsModal(){
    document.getElementById('settings-modal').style.display='none';
}

function renderSettingsContent(){
    const container=document.getElementById('settings-content');
    container.innerHTML=`
        <div style="margin-bottom:20px">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px">ğŸ“Š ç›®æ¨™è¨­å®š</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div style="background:var(--bg3);padding:10px;border-radius:7px">
                    <label style="display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px">ç›®æ¨™ç²—åˆ©ç‡ (%)</label>
                    <input type="number" id="set-target-margin" value="${document.getElementById('target-margin')?.value||'25.00'}" step="0.01" style="width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem">
                </div>
                <div style="background:var(--bg3);padding:10px;border-radius:7px">
                    <label style="display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px">è­¦å‘Šã—ãã„å€¤ (%)</label>
                    <input type="number" id="set-warning-margin" value="${document.getElementById('warning-margin')?.value||'23.00'}" step="0.01" style="width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem">
                </div>
            </div>
        </div>
        <div style="margin-bottom:20px">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px">ğŸŒ¸ å£²ä¸Šç´å“æ›ç‡</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div style="background:var(--bg3);padding:10px;border-radius:7px">
                    <label style="display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px">èŠ± æ›ã‘ç‡</label>
                    <input type="number" id="set-hana-rate" value="${document.getElementById('hana-rate')?.value||'0.80'}" step="0.01" style="width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem">
                </div>
                <div style="background:var(--bg3);padding:10px;border-radius:7px">
                    <label style="display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px">ç”£ç›´ æ›ã‘ç‡</label>
                    <input type="number" id="set-sanchoku-rate" value="${document.getElementById('sanchoku-rate')?.value||'0.85'}" step="0.01" style="width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem">
                </div>
            </div>
        </div>
        <div style="margin-bottom:20px">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px">ğŸ¨ è¡¨ç¤ºè¨­å®š</div>
            <div style="background:var(--bg3);padding:12px;border-radius:7px;display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-size:0.75rem;font-weight:500">ãƒ†ãƒ¼ãƒ</div>
                    <div style="font-size:0.6rem;color:var(--text4)">ãƒ€ãƒ¼ã‚¯ / ãƒ©ã‚¤ãƒˆ</div>
                </div>
                <select id="set-theme" style="padding:6px 12px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:0.75rem">
                    <option value="dark" ${currentTheme==='dark'?'selected':''}>ğŸŒ™ ãƒ€ãƒ¼ã‚¯</option>
                    <option value="light" ${currentTheme==='light'?'selected':''}>â˜€ï¸ ãƒ©ã‚¤ãƒˆ</option>
                </select>
            </div>
        </div>
        <div style="margin-bottom:20px">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button onclick="exportSettings()" style="padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">ğŸ“¤ è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button onclick="document.getElementById('import-settings').click()" style="padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">ğŸ“¥ è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="import-settings" accept=".json" style="display:none" onchange="importSettings(this)">
            </div>
            <button onclick="clearAllSettings()" style="width:100%;margin-top:8px;padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:7px;color:var(--danger);font-size:0.7rem;cursor:pointer">ğŸ—‘ï¸ å…¨è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    `;
}

function saveAllSettings(){
    document.getElementById('target-margin').value=document.getElementById('set-target-margin').value;
    document.getElementById('warning-margin').value=document.getElementById('set-warning-margin').value;
    document.getElementById('hana-rate').value=document.getElementById('set-hana-rate').value;
    document.getElementById('sanchoku-rate').value=document.getElementById('set-sanchoku-rate').value;
    currentTheme=document.getElementById('set-theme').value;
    applyTheme();
    saveSettingsToStorage();
    closeSettingsModal();
    showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ','success');
    if(result)render();
}

function exportSettings(){
    const settings={
        version:'v8',
        exportDate:new Date().toISOString(),
        theme:currentTheme,
        targetMargin:document.getElementById('target-margin')?.value,
        warningMargin:document.getElementById('warning-margin')?.value,
        hanaRate:document.getElementById('hana-rate')?.value,
        sanchokuRate:document.getElementById('sanchoku-rate')?.value,
        marginRate:document.getElementById('margin-rate')?.value,
        supplierSettings:SUPPLIER_SETTINGS,
        supplierCatMap:SUPPLIER_CAT_MAP
    };
    const blob=new Blob([JSON.stringify(settings,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='shiire_settings_'+new Date().toISOString().slice(0,10)+'.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
}

function importSettings(input){
    const file=input.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=e=>{
        try{
            const s=JSON.parse(e.target.result);
            if(s.theme)currentTheme=s.theme;
            if(s.targetMargin)document.getElementById('target-margin').value=s.targetMargin;
            if(s.warningMargin)document.getElementById('warning-margin').value=s.warningMargin;
            if(s.hanaRate)document.getElementById('hana-rate').value=s.hanaRate;
            if(s.sanchokuRate)document.getElementById('sanchoku-rate').value=s.sanchokuRate;
            if(s.marginRate)document.getElementById('margin-rate').value=s.marginRate;
            if(s.supplierSettings)Object.assign(SUPPLIER_SETTINGS,s.supplierSettings);
            if(s.supplierCatMap)Object.assign(SUPPLIER_CAT_MAP,s.supplierCatMap);
            applyTheme();
            saveSettingsToStorage();
            renderSettingsContent();
            showToast('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
        }catch(err){
            showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: '+err.message,'error');
        }
    };
    reader.readAsText(file);
    input.value='';
}

function clearAllSettings(){
    if(!confirm('å…¨ã¦ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ'))return;
    localStorage.removeItem('shiire_settings_v8');
    currentTheme='dark';
    SUPPLIER_SETTINGS={'0074721':{marginRate:0.26,usePriceCalc:true}};
    document.getElementById('target-margin').value='25.00';
    document.getElementById('warning-margin').value='23.00';
    document.getElementById('hana-rate').value='0.80';
    document.getElementById('sanchoku-rate').value='0.85';
    document.getElementById('margin-rate').value='0.26';
    applyTheme();
    renderSettingsContent();
    showToast('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ','info');
}

// ===== ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ =====
let validationWarnings=[];

function validateData(){
    validationWarnings=[];
    
    // å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    if(!DATA.shiire)validationWarnings.push({type:'error',msg:'ä»•å…¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'ä»•å…¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'});
    if(!DATA.uriage)validationWarnings.push({type:'error',msg:'å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'å£²ä¸Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'});
    
    // åº—èˆ—æ•°ãƒã‚§ãƒƒã‚¯
    const storeCount=Object.keys(STORES).length;
    if(storeCount===0)validationWarnings.push({type:'warning',msg:'åº—èˆ—ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“',detail:'ä»•å…¥ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„'});
    
    // åœ¨åº«è¨­å®šãƒã‚§ãƒƒã‚¯
    const invCount=Object.keys(STORE_INVENTORY).length;
    if(invCount===0)validationWarnings.push({type:'warning',msg:'åœ¨åº«è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“',detail:'åˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã‹ã€æ‰‹å‹•ã§è¨­å®šã—ã¦ãã ã•ã„'});
    else if(invCount<storeCount)validationWarnings.push({type:'warning',msg:`ä¸€éƒ¨åº—èˆ—ã®åœ¨åº«è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ (${invCount}/${storeCount})`,detail:'å…¨åº—èˆ—ã®æœŸé¦–ãƒ»æœŸæœ«åœ¨åº«ã‚’è¨­å®šã—ã¦ãã ã•ã„'});
    
    // äºˆç®—ãƒã‚§ãƒƒã‚¯
    const budgetCount=Object.keys(STORE_BUDGET).length;
    if(budgetCount===0)validationWarnings.push({type:'info',msg:'äºˆç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã‚ˆã‚Šè©³ç´°ãªåˆ†æãŒå¯èƒ½ã§ã™'});
    
    // å£²å¤‰ãƒã‚§ãƒƒã‚¯
    if(!DATA.baihen)validationWarnings.push({type:'info',msg:'å£²å¤‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'å£²å¤‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨æ¨å®šç²—åˆ©è¨ˆç®—ãŒå¯èƒ½ã§ã™'});
    
    return validationWarnings.filter(w=>w.type==='error').length===0;
}

function showValidationModal(){
    const container=document.getElementById('validation-content');
    let h='<div style="display:flex;flex-direction:column;gap:8px">';
    
    if(validationWarnings.length===0){
        h+='<div style="text-align:center;padding:24px;color:var(--success)"><div style="font-size:2rem;margin-bottom:8px">âœ…</div><div style="font-weight:600">å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸ</div></div>';
    }else{
        validationWarnings.forEach(w=>{
            const color=w.type==='error'?'var(--danger)':w.type==='warning'?'var(--warning)':'var(--info)';
            const icon=w.type==='error'?'âŒ':w.type==='warning'?'âš ï¸':'â„¹ï¸';
            h+=`<div style="padding:12px;background:var(--bg3);border-radius:8px;border-left:3px solid ${color}">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                    <span>${icon}</span>
                    <span style="font-weight:600;color:${color}">${w.msg}</span>
                </div>
                <div style="font-size:0.7rem;color:var(--text3);margin-left:24px">${w.detail}</div>
            </div>`;
        });
    }
    
    h+='</div>';
    container.innerHTML=h;
    document.getElementById('validation-modal').style.display='flex';
}

function closeValidationModal(){
    document.getElementById('validation-modal').style.display='none';
}

function proceedWithWarnings(){
    closeValidationModal();
    generateWithoutValidation();
}

document.getElementById('view-tabs').addEventListener('click',e=>{const t=e.target.closest('.topbar-tab');if(!t)return;document.querySelectorAll('.topbar-tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');currentView=t.dataset.view;if(result)render();});
document.getElementById('store-chips').addEventListener('click',e=>{const c=e.target.closest('.chip');if(!c)return;document.querySelectorAll('#store-chips .chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');currentStore=c.dataset.store;if(result)render();});

function loadFile(input,key){const file=input.files[0];if(!file)return;const card=input.closest('.upload-card');const reader=new FileReader();reader.onload=e=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});DATA[key]=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});card.classList.add('loaded');showToast(file.name+' ã‚’èª­è¾¼ã¿ã¾ã—ãŸ','success');if(key==='shiire')detectStoresAndSuppliers();if(key==='hana'||key==='sanchoku')detectStoresFromHanaSanchoku(key);if(key==='settings')processSettings();if(key==='budget')processBudget();document.getElementById('btn-generate').disabled=!(DATA.shiire&&DATA.uriage);}catch(err){showToast('èª­è¾¼ã‚¨ãƒ©ãƒ¼: '+err.message,'error');}};reader.readAsArrayBuffer(file);}

// åˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
function processSettings(){
    const data=DATA.settings;if(!data||data.length<2)return;
    for(let row=1;row<data.length;row++){
        const storeCode=data[row][0];
        const invStart=parseFloat(data[row][1])||0;
        const invEnd=parseFloat(data[row][2])||0;
        if(storeCode){
            const sid=String(parseInt(storeCode));
            STORE_INVENTORY[sid]={invStart,invEnd};
        }
    }
    updateStoreInventoryUI();
    showToast('åº—èˆ—åˆ¥åœ¨åº«è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ','success');
}

// æ¶ˆè€—å“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showConsumableModal(){
    updateConsumableStatus();
    document.getElementById('consumable-modal').style.display='flex';
}

function closeConsumableModal(){
    document.getElementById('consumable-modal').style.display='none';
}

// ä»•å…¥å…ˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
function showSupplierSettingsModal(){
    updateSupplierSettingsUI();
    document.getElementById('supplier-settings-modal').style.display='flex';
}

function closeSupplierSettingsModal(){
    document.getElementById('supplier-settings-modal').style.display='none';
}

function updateSupplierSettingsUI(){
    const container=document.getElementById('supplier-settings-content');
    const supCodes=Object.keys(SUPPLIERS).sort();
    if(supCodes.length===0){
        container.innerHTML='<div style="font-size:0.65rem;color:var(--text4);padding:16px;text-align:center">ä»•å…¥ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
        return;
    }
    
    const catOptions=Object.entries(CATEGORIES).map(([k,v])=>'<option value="'+k+'">'+v.icon+' '+v.name+'</option>').join('');
    
    let h='<table style="width:100%;font-size:0.68rem;border-collapse:collapse">';
    h+='<thead><tr style="background:var(--bg4);position:sticky;top:0"><th style="padding:8px;text-align:left">ã‚³ãƒ¼ãƒ‰</th><th style="padding:8px;text-align:left">ä»•å…¥å…ˆå</th><th style="padding:8px;text-align:center">å¸³åˆåˆ†é¡</th><th style="padding:8px;text-align:center">å£²ä¾¡è¨ˆç®—</th><th style="padding:8px;text-align:center">å€¤å…¥ç‡</th></tr></thead><tbody>';
    
    supCodes.forEach(code=>{
        const sup=SUPPLIERS[code];
        const setting=SUPPLIER_SETTINGS[code]||{};
        const currentCat=SUPPLIER_CAT_MAP[code]||'other';
        const usePriceCalc=setting.usePriceCalc||false;
        const marginRate=setting.marginRate||0.26;
        
        h+='<tr style="border-bottom:1px solid var(--border)">';
        h+='<td style="padding:6px;font-family:\'JetBrains Mono\',monospace;color:var(--text3)">'+code+'</td>';
        h+='<td style="padding:6px">'+sup.name+'</td>';
        h+='<td style="padding:6px"><select data-code="'+code+'" data-field="cat" style="width:100%;padding:4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.65rem">';
        Object.entries(CATEGORIES).forEach(([k,v])=>{
            h+='<option value="'+k+'"'+(k===currentCat?' selected':'')+'>'+v.icon+' '+v.name+'</option>';
        });
        h+='</select></td>';
        h+='<td style="padding:6px;text-align:center"><label style="display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer"><input type="checkbox" data-code="'+code+'" data-field="usePriceCalc" '+(usePriceCalc?'checked':'')+' style="accent-color:var(--primary)"> <span style="font-size:0.6rem;color:var(--text3)">å€¤å…¥ç‡ã‹ã‚‰ç®—å‡º</span></label></td>';
        h+='<td style="padding:6px"><input type="text" data-code="'+code+'" data-field="marginRate" value="'+marginRate+'" style="width:60px;padding:4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:0.65rem;text-align:center" '+(usePriceCalc?'':'disabled')+'></td>';
        h+='</tr>';
    });
    h+='</tbody></table>';
    
    h+='<div style="margin-top:12px;padding:10px;background:var(--bg4);border-radius:6px;font-size:0.6rem;color:var(--text3)">';
    h+='<strong>ğŸ’¡ å£²ä¾¡è¨ˆç®—ã«ã¤ã„ã¦:</strong><br>';
    h+='ã€Œå€¤å…¥ç‡ã‹ã‚‰ç®—å‡ºã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€ä»•å…¥ãƒ•ã‚¡ã‚¤ãƒ«ã®å£²ä¾¡ã‚’ç„¡è¦–ã—ã€åŸä¾¡Ã·(1-å€¤å…¥ç‡)ã§å£²ä¾¡ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚<br>';
    h+='ï¼ˆä¾‹: 0074721 ã‚ã•ãã‚‰ã‚»ãƒ³ã‚¿ã®å£²ä¾¡ãŒä»®ã®å ´åˆã«ä½¿ç”¨ï¼‰';
    h+='</div>';
    
    container.innerHTML=h;
    
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«å€¤å…¥ç‡å…¥åŠ›ã‚’æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
    container.querySelectorAll('input[data-field="usePriceCalc"]').forEach(cb=>{
        cb.addEventListener('change',e=>{
            const code=e.target.dataset.code;
            const marginInput=container.querySelector('input[data-code="'+code+'"][data-field="marginRate"]');
            if(marginInput)marginInput.disabled=!e.target.checked;
        });
    });
}

function saveSupplierSettings(){
    const container=document.getElementById('supplier-settings-content');
    
    // å¸³åˆåˆ†é¡ã‚’æ›´æ–°
    container.querySelectorAll('select[data-field="cat"]').forEach(sel=>{
        SUPPLIER_CAT_MAP[sel.dataset.code]=sel.value;
        if(SUPPLIERS[sel.dataset.code])SUPPLIERS[sel.dataset.code].cat=sel.value;
    });
    
    // ä»•å…¥å…ˆè¨­å®šã‚’æ›´æ–°
    container.querySelectorAll('input[data-field="usePriceCalc"]').forEach(cb=>{
        const code=cb.dataset.code;
        const marginInput=container.querySelector('input[data-code="'+code+'"][data-field="marginRate"]');
        if(!SUPPLIER_SETTINGS[code])SUPPLIER_SETTINGS[code]={};
        SUPPLIER_SETTINGS[code].usePriceCalc=cb.checked;
        SUPPLIER_SETTINGS[code].marginRate=parseFloat(marginInput?.value)||0.26;
    });
    
    closeSupplierSettingsModal();
    showToast('ä»•å…¥å…ˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ','success');
}

function updateConsumableStatus(){
    const countEl=document.getElementById('consumable-count');
    const storeCount=Object.keys(CONSUMABLES).length;
    if(storeCount===0){
        countEl.innerHTML='æœªèª­è¾¼';
        return;
    }
    let totalCost=0,totalItems=0;
    Object.values(CONSUMABLES).forEach(storeDays=>{
        Object.values(storeDays).forEach(day=>{
            totalCost+=day.cost;
            totalItems+=day.items.length;
        });
    });
    countEl.innerHTML=storeCount+'åº—èˆ— / '+totalItems+'å“ç›® / <span style="color:#f97316">'+fmt(totalCost)+'å††</span>';
}

function selectConsumableFiles(){
    document.getElementById('consumable-input').click();
}

let consumableMode='overwrite';

function processConsumableFiles(input){
    const files=input.files;if(!files||files.length===0)return;
    consumableMode=document.querySelector('input[name="consumable-mode"]:checked').value;
    closeConsumableModal();
    
    const card=document.querySelector('.upload-card:has(#consumable-input)')||document.querySelectorAll('.upload-card')[4];
    let loadedCount=0,totalCost=0,newItems=0;
    
    // ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¯ãƒªã‚¢
    if(consumableMode==='overwrite'){
        CONSUMABLES={};
    }
    
    Array.from(files).forEach(file=>{
        const reader=new FileReader();
        reader.onload=e=>{
            try{
                const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
                const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆå…ˆé ­2æ¡ï¼‰
                const storeMatch=file.name.match(/^(\d{2})/);
                if(!storeMatch)return;
                const sid=String(parseInt(storeMatch[1]));
                
                // å‹˜å®šã‚³ãƒ¼ãƒ‰81257ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                for(let row=1;row<data.length;row++){
                    const kamokuCode=String(data[row][0]||'');
                    if(kamokuCode!=='81257')continue;
                    
                    const itemCode=String(data[row][1]||'');
                    const itemName=String(data[row][2]||'');
                    const qty=parseFloat(data[row][3])||0;
                    const cost=parseFloat(data[row][4])||0;
                    const dateStr=String(data[row][5]||'');
                    
                    const date=parseDate(dateStr);
                    if(!date)continue;
                    const day=date.getDate();
                    
                    if(!CONSUMABLES[sid])CONSUMABLES[sid]={};
                    if(!CONSUMABLES[sid][day])CONSUMABLES[sid][day]={cost:0,items:[]};
                    CONSUMABLES[sid][day].cost+=cost;
                    CONSUMABLES[sid][day].items.push({itemCode,itemName,qty,cost});
                    totalCost+=cost;
                    newItems++;
                }
                
                loadedCount++;
                if(loadedCount===files.length){
                    card.classList.add('loaded');
                    const modeText=consumableMode==='overwrite'?'ä¸Šæ›¸ã':'è¿½åŠ ';
                    showToast('åŸä¾¡ç®—å…¥æ¯” '+files.length+'ãƒ•ã‚¡ã‚¤ãƒ«'+modeText+' ('+newItems+'å“/'+fmt(totalCost)+')','success');
                    input.value=''; // ãƒªã‚»ãƒƒãƒˆã—ã¦åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«
                }
            }catch(err){
                showToast('æ¶ˆè€—å“èª­è¾¼ã‚¨ãƒ©ãƒ¼: '+err.message,'error');
            }
        };
        reader.readAsArrayBuffer(file);
    });
}

// äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
function processBudget(){
    const data=DATA.budget;if(!data||data.length<2)return;
    STORE_BUDGET={};
    for(let row=1;row<data.length;row++){
        const storeCode=data[row][0];
        const dateStr=String(data[row][1]||'');
        const budgetVal=parseFloat(data[row][2])||0;
        if(!storeCode)continue;
        const sid=String(parseInt(storeCode));
        const date=parseDate(dateStr);
        if(!date)continue;
        const day=date.getDate();
        if(!STORE_BUDGET[sid])STORE_BUDGET[sid]={daily:{},total:0};
        STORE_BUDGET[sid].daily[day]=budgetVal;
        STORE_BUDGET[sid].total+=budgetVal;
    }
    showToast('æ—¥åˆ¥äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ'+Object.keys(STORE_BUDGET).length+'åº—èˆ—ï¼‰','success');
}

// å£²å¤‰ï¼ˆå€¤å¼•ï¼‰ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
function processBaihen(){
    const data=DATA.baihen;if(!data||data.length<3)return {};
    const r={},cols={};
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(row 0)ã‹ã‚‰åº—èˆ—ã‚’æ¤œå‡º
    for(let col=3;col<data[0].length;col+=2){
        const stoStr=String(data[0][col]||'');
        const stoMatch=stoStr.match(/(\d{4}):/);
        if(stoMatch){
            const sid=String(parseInt(stoMatch[1]));
            cols[sid]={sales:col,baihen:col+1};
        }
    }
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†ï¼ˆrow 3ã‹ã‚‰ï¼‰
    for(let row=3;row<data.length;row++){
        const dateStr=String(data[row][0]||'');
        const date=parseDate(dateStr);
        if(!date)continue;
        const day=date.getDate();
        Object.entries(cols).forEach(([sid,colInfo])=>{
            const sales=parseFloat(data[row][colInfo.sales])||0;
            const baihen=parseFloat(data[row][colInfo.baihen])||0; // ãƒã‚¤ãƒŠã‚¹å€¤
            if(sales===0)return;
            if(!r[sid])r[sid]={};
            r[sid][day]={sales,baihen:Math.abs(baihen)}; // çµ¶å¯¾å€¤ã§ä¿å­˜
        });
    }
    return r;
}

// åº—èˆ—åˆ¥åœ¨åº«UIã‚’æ›´æ–°
function updateStoreInventoryUI(){
    const container=document.getElementById('store-inventory-container');
    const storeIds=Object.keys(STORES).sort((a,b)=>+a-+b);
    if(storeIds.length===0){
        container.innerHTML='<div style="font-size:0.65rem;color:var(--text4);padding:8px;text-align:center">åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤º</div>';
        return;
    }
    let h='<table style="width:100%;font-size:0.62rem;border-collapse:collapse"><thead><tr style="background:var(--bg4)"><th style="padding:4px;text-align:left">åº—èˆ—</th><th style="padding:4px;text-align:right">æœŸé¦–åœ¨åº«</th><th style="padding:4px;text-align:right">æœŸæœ«åœ¨åº«</th></tr></thead><tbody>';
    storeIds.forEach(sid=>{
        const st=STORES[sid];
        const inv=STORE_INVENTORY[sid]||{invStart:0,invEnd:0};
        h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:4px;color:var(--text2)">'+sid.padStart(2,'0')+' '+(st?.name||'')+'</td><td style="padding:2px"><input type="text" class="inv-input" data-store="'+sid+'" data-type="start" value="'+fmt(inv.invStart)+'" onchange="updateStoreInv(this)" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:3px 5px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:0.62rem;text-align:right"></td><td style="padding:2px"><input type="text" class="inv-input" data-store="'+sid+'" data-type="end" value="'+fmt(inv.invEnd)+'" onchange="updateStoreInv(this)" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:3px 5px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:0.62rem;text-align:right"></td></tr>';
    });
    h+='</tbody></table>';
    container.innerHTML=h;
}

// åº—èˆ—åœ¨åº«ã‚’æ›´æ–°
function updateStoreInv(el){
    const sid=el.dataset.store;
    const type=el.dataset.type;
    const val=parseNum(el.value);
    if(!STORE_INVENTORY[sid])STORE_INVENTORY[sid]={invStart:0,invEnd:0};
    if(type==='start')STORE_INVENTORY[sid].invStart=val;
    else STORE_INVENTORY[sid].invEnd=val;
    el.value=fmt(val);
}

// èŠ±ãƒ»ç”£ç›´ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åº—èˆ—ã‚’æ¤œå‡º
function detectStoresFromHanaSanchoku(type){const data=DATA[type];if(!data||data.length<2)return;for(let col=3;col<data[0].length;col+=2){const stoStr=String(data[0][col]||'');const stoMatch=stoStr.match(/(\d{4}):(.+)$/);if(stoMatch){const code=stoMatch[1],name=stoMatch[2].replace(/æ¯æ—¥å±‹/g,'').trim(),id=String(parseInt(code));if(!STORES[id])STORES[id]={code,name};}}updateStoreChips();updateStoreInventoryUI();}

function detectStoresAndSuppliers(){const data=DATA.shiire;if(!data||data.length<2)return;STORES={};SUPPLIERS={};for(let col=3;col<data[0].length;col+=2){const supStr=String(data[0][col]||''),stoStr=String(data[1][col]||'');const supMatch=supStr.match(/(\d{7}):?(.*)$/);if(supMatch){const code=supMatch[1],name=supMatch[2]?.trim()||code;if(!SUPPLIERS[code])SUPPLIERS[code]={name,cat:SUPPLIER_CAT_MAP[code]||'other'};}const stoMatch=stoStr.match(/(\d{4}):(.+)$/);if(stoMatch){const code=stoMatch[1],name=stoMatch[2].replace(/æ¯æ—¥å±‹/g,'').trim(),id=String(parseInt(code));if(!STORES[id])STORES[id]={code,name};}}updateStoreChips();updateStoreInventoryUI();}

function updateStoreChips(){const c=document.getElementById('store-chips');let h='<div class="chip active" data-store="all">å…¨åº—èˆ—</div>';Object.entries(STORES).sort((a,b)=>+a[0]-+b[0]).forEach(([id])=>{h+='<div class="chip" data-store="'+id+'">'+id.padStart(2,'0')+'</div>';});c.innerHTML=h;}

function processShiire(){const data=DATA.shiire;if(!data||data.length<4)return {};const r={};for(let col=3;col<data[0].length;col+=2){const supMatch=String(data[0][col]||'').match(/(\d{7})/),stoMatch=String(data[1][col]||'').match(/(\d{4}):/);if(!supMatch||!stoMatch)continue;const sc=supMatch[1],si=SUPPLIERS[sc]||{name:sc,cat:'other'},sid=String(parseInt(stoMatch[1]));if(!STORES[sid])continue;
// ä»•å…¥å…ˆè¨­å®šã‚’å–å¾—
const supSetting=SUPPLIER_SETTINGS[sc]||{};
const usePriceCalc=supSetting.usePriceCalc||false;
const supMarginRate=supSetting.marginRate||0.26;
for(let row=4;row<data.length;row++){const date=parseDate(data[row][0]);if(!date)continue;const day=date.getDate(),cost=parseFloat(data[row][col])||0;let price=parseFloat(data[row][col+1])||0;
// å£²ä¾¡è¨ˆç®—è¨­å®šãŒã‚ã‚‹å ´åˆã¯å€¤å…¥ç‡ã‹ã‚‰å£²ä¾¡ã‚’å†è¨ˆç®—
if(usePriceCalc&&cost>0){price=Math.round(cost/(1-supMarginRate));}
if(cost===0&&price===0)continue;if(!r[sid])r[sid]={};if(!r[sid][day])r[sid][day]={suppliers:{},total:{cost:0,price:0}};if(!r[sid][day].suppliers[sc])r[sid][day].suppliers[sc]={...si,cost:0,price:0,usePriceCalc};r[sid][day].suppliers[sc].cost+=cost;r[sid][day].suppliers[sc].price+=price;r[sid][day].total.cost+=cost;r[sid][day].total.price+=price;}}return r;}

function processUriage(){const data=DATA.uriage;if(!data||data.length<3)return {};const r={},cols={};for(let col=3;col<data[0].length;col+=2){const m=String(data[0][col]||'').match(/(\d{4}):/);if(m){const sid=String(parseInt(m[1]));if(STORES[sid])cols[sid]=col;}}for(let row=3;row<data.length;row++){const date=parseDate(data[row][0]);if(!date)continue;const day=date.getDate();Object.entries(cols).forEach(([sid,col])=>{if(!r[sid])r[sid]={};r[sid][day]={sales:parseFloat(data[row][col])||0};});}return r;}

// åº—é–“éƒ¨é–€é–“å…¥: åº—èˆ—ã‚³ãƒ¼ãƒ‰=åº—ã‚³ãƒ¼ãƒ‰OUTâ†’éƒ¨é–€é–“å…¥, ç•°ãªã‚‹â†’åº—é–“å…¥
function processTenkanIn(){const data=DATA.tenkanIn;if(!data||data.length<2)return {};const r={};for(let row=1;row<data.length;row++){const storeCode=String(data[row][0]||'').trim(),dateVal=data[row][1],storeCodeOut=String(data[row][2]||'').trim(),costIn=parseFloat(data[row][3])||0,priceIn=parseFloat(data[row][4])||0;const date=parseDate(dateVal);if(!date)continue;const day=date.getDate(),sid=String(parseInt(storeCode)||0),sidOut=String(parseInt(storeCodeOut)||0);if(!STORES[sid])continue;const isBumon=(storeCode===storeCodeOut)||(sid===sidOut);if(!r[sid])r[sid]={};if(!r[sid][day])r[sid][day]={tenkanIn:[],bumonIn:[]};if(isBumon){r[sid][day].bumonIn.push({cost:costIn,price:priceIn,fromStore:sidOut});}else{r[sid][day].tenkanIn.push({cost:costIn,price:priceIn,fromStore:sidOut,fromStoreName:STORES[sidOut]?.name||sidOut});}}return r;}

// åº—é–“éƒ¨é–€é–“å‡º: åº—èˆ—ã‚³ãƒ¼ãƒ‰=åº—ã‚³ãƒ¼ãƒ‰INâ†’éƒ¨é–€é–“å‡º, ç•°ãªã‚‹â†’åº—é–“å‡º
function processTenkanOut(){const data=DATA.tenkanOut;if(!data||data.length<2)return {};const r={};for(let row=1;row<data.length;row++){const dateVal=data[row][0],storeCode=String(data[row][1]||'').trim(),storeCodeIn=String(data[row][2]||'').trim(),bumonCodeIn=String(data[row][3]||'').trim(),costOut=parseFloat(data[row][4])||0,priceOut=parseFloat(data[row][5])||0;const date=parseDate(dateVal);if(!date)continue;const day=date.getDate(),sid=String(parseInt(storeCode)||0),sidIn=String(parseInt(storeCodeIn)||0);if(!STORES[sid])continue;const isBumon=(storeCode===storeCodeIn)||(sid===sidIn);if(!r[sid])r[sid]={};if(!r[sid][day])r[sid][day]={tenkanOut:[],bumonOut:[]};if(isBumon){r[sid][day].bumonOut.push({cost:costOut,price:priceOut,toStore:sidIn,bumonCode:bumonCodeIn});}else{r[sid][day].tenkanOut.push({cost:costOut,price:priceOut,toStore:sidIn,toStoreName:STORES[sidIn]?.name||sidIn,bumonCode:bumonCodeIn});}}return r;}

// èŠ±ãƒ»ç”£ç›´ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆæ›ã‘ç‡å¯¾å¿œï¼‰- å£²ä¸Šç´å“å½¢å¼
function processHanaSanchoku(type){
    const data=DATA[type];if(!data||data.length<3)return {};
    const rate=parseFloat(document.getElementById(type+'-rate')?.value)||(type==='hana'?0.80:0.85);
    const r={},cols={};
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(row 0)ã‹ã‚‰åº—èˆ—ã‚’æ¤œå‡º: 0001:åº—èˆ—å å½¢å¼
    for(let col=3;col<data[0].length;col+=2){
        const stoStr=String(data[0][col]||'');
        const stoMatch=stoStr.match(/(\d{4}):/);
        if(stoMatch){const sid=String(parseInt(stoMatch[1]));cols[sid]=col;}
    }
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†ï¼ˆrow 3ã‹ã‚‰ï¼‰
    for(let row=3;row<data.length;row++){
        const dateStr=String(data[row][0]||'');
        const date=parseDate(dateStr);
        if(!date)continue;
        const day=date.getDate();
        Object.entries(cols).forEach(([sid,col])=>{
            const price=parseFloat(data[row][col])||0;
            if(price===0)return;
            const cost=Math.round(price*rate);
            if(!r[sid])r[sid]={};
            if(!r[sid][day])r[sid][day]={price:0,cost:0};
            r[sid][day].price+=price;
            r[sid][day].cost+=cost;
        });
    }
    return r;
}

function generate(){
    // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
    const isValid=validateData();
    if(!isValid){
        showValidationModal();
        return;
    }
    
    // è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    if(validationWarnings.length>0){
        showValidationModal();
        return;
    }
    
    generateWithoutValidation();
}

function generateWithoutValidation(){document.getElementById('content').innerHTML='<div class="loading-state"><div class="spinner"></div><p>ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...</p></div>';setTimeout(()=>{try{
const shiire=processShiire(),uriage=processUriage(),tenkanInData=processTenkanIn(),tenkanOutData=processTenkanOut(),hana=processHanaSanchoku('hana'),sanchoku=processHanaSanchoku('sanchoku'),baihenData=processBaihen();
result={};Object.keys(STORES).forEach(sid=>{
const storeInv=STORE_INVENTORY[sid]||{invStart:0,invEnd:0};
const invStart=storeInv.invStart,invEnd=storeInv.invEnd,budget=parseNum(document.getElementById('budget').value),marginRate=parseFloat(document.getElementById('margin-rate').value)||0.26;
const daily={},catTotals={},supTotals={},transferDetails={tenkanIn:[],tenkanOut:[],bumonIn:[],bumonOut:[]};
let totalConsumable=0,totalBaihen=0,totalCoreSales=0,totalCorePrice=0; // åŸä¾¡ç®—å…¥æ¯”åˆè¨ˆã€å£²å¤‰åˆè¨ˆã€ã‚³ã‚¢å£²ä¸Šã€ã‚³ã‚¢å£²ä¾¡
for(let day=1;day<=31;day++){const s=shiire[sid]?.[day]||{suppliers:{},total:{cost:0,price:0}},u=uriage[sid]?.[day]||{sales:0},ti=tenkanInData[sid]?.[day]||{tenkanIn:[],bumonIn:[]},to=tenkanOutData[sid]?.[day]||{tenkanOut:[],bumonOut:[]},h=hana[sid]?.[day]||{cost:0,price:0},sa=sanchoku[sid]?.[day]||{cost:0,price:0},bh=baihenData[sid]?.[day]||{sales:0,baihen:0};
// åŸä¾¡ç®—å…¥æ¯”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const cons=CONSUMABLES[sid]?.[day]||{cost:0,items:[]};
const tenkanInTotal={cost:0,price:0},tenkanOutTotal={cost:0,price:0},bumonInTotal={cost:0,price:0},bumonOutTotal={cost:0,price:0};
(ti.tenkanIn||[]).forEach(t=>{tenkanInTotal.cost+=t.cost;tenkanInTotal.price+=t.price;});
(ti.bumonIn||[]).forEach(t=>{bumonInTotal.cost+=t.cost;bumonInTotal.price+=t.price;});
(to.tenkanOut||[]).forEach(t=>{tenkanOutTotal.cost+=t.cost;tenkanOutTotal.price+=t.price;});
(to.bumonOut||[]).forEach(t=>{bumonOutTotal.cost+=t.cost;bumonOutTotal.price+=t.price;});
if(u.sales===0&&s.total.cost===0&&tenkanInTotal.cost===0&&tenkanOutTotal.cost===0&&bumonInTotal.cost===0&&bumonOutTotal.cost===0&&h.cost===0&&sa.cost===0&&cons.cost===0)continue;

// å£²å¤‰ç‡è¨ˆç®—ï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹: å€¤å¼•é¡/ï¼ˆå£²ä¸Š+å€¤å¼•é¡ï¼‰ï¼‰
const baihenAmt=bh.baihen||0;
const grossSales=u.sales+baihenAmt; // å€¤å¼•å‰å£²ä¸Šï¼ˆå£²ä¸Š+å€¤å¼•é¡ï¼‰
const baihenRate=grossSales>0?baihenAmt/grossSales:0;

// ã‚³ã‚¢å£²ä¸Šï¼ˆèŠ±ãƒ»ç”£ç›´ã‚’é™¤ã„ãŸå£²ä¸Šï¼‰
const coreSales=u.sales-(h.price||0)-(sa.price||0);
const coreGrossSales=coreSales+baihenAmt;

daily[day]={sales:u.sales,suppliers:s.suppliers,shiire:s.total,tenkanIn:ti.tenkanIn||[],tenkanOut:to.tenkanOut||[],bumonIn:ti.bumonIn||[],bumonOut:to.bumonOut||[],tenkanInTotal,tenkanOutTotal,bumonInTotal,bumonOutTotal,hana:h,sanchoku:sa,consumable:cons,baihen:baihenAmt,baihenRate,grossSales,coreSales,coreGrossSales};
totalConsumable+=cons.cost;
totalBaihen+=baihenAmt;
totalCoreSales+=coreSales;
totalCorePrice+=s.total.price;

(ti.tenkanIn||[]).forEach(t=>transferDetails.tenkanIn.push({...t,day}));
(ti.bumonIn||[]).forEach(t=>transferDetails.bumonIn.push({...t,day}));
(to.tenkanOut||[]).forEach(t=>transferDetails.tenkanOut.push({...t,day}));
(to.bumonOut||[]).forEach(t=>transferDetails.bumonOut.push({...t,day}));
Object.entries(s.suppliers).forEach(([code,data])=>{if(!supTotals[code])supTotals[code]={...data,cost:0,price:0};supTotals[code].cost+=data.cost;supTotals[code].price+=data.price;const cat=SUPPLIERS[code]?.cat||'other';if(!catTotals[cat])catTotals[cat]={cost:0,price:0};catTotals[cat].cost+=data.cost;catTotals[cat].price+=data.price;});
if(tenkanInTotal.cost!==0||tenkanOutTotal.cost!==0){if(!catTotals['tenkan'])catTotals['tenkan']={cost:0,price:0};catTotals['tenkan'].cost+=tenkanInTotal.cost+tenkanOutTotal.cost;catTotals['tenkan'].price+=tenkanInTotal.price+tenkanOutTotal.price;}
if(bumonInTotal.cost!==0||bumonOutTotal.cost!==0){if(!catTotals['bumonkan'])catTotals['bumonkan']={cost:0,price:0};catTotals['bumonkan'].cost+=bumonInTotal.cost+bumonOutTotal.cost;catTotals['bumonkan'].price+=bumonInTotal.price+bumonOutTotal.price;}
if(h.price>0){if(!catTotals['hana'])catTotals['hana']={cost:0,price:0};catTotals['hana'].cost+=h.cost;catTotals['hana'].price+=h.price;}
if(sa.price>0){if(!catTotals['sanchoku'])catTotals['sanchoku']={cost:0,price:0};catTotals['sanchoku'].cost+=sa.cost;catTotals['sanchoku'].price+=sa.price;}
if(cons.cost>0){if(!catTotals['consumable'])catTotals['consumable']={cost:0,price:0};catTotals['consumable'].cost+=cons.cost;catTotals['consumable'].price+=cons.cost;}} // åŸä¾¡ç®—å…¥æ¯”ã¯å£²ä¾¡=åŸä¾¡

const totalSales=Object.values(daily).reduce((s,d)=>s+d.sales,0),totalCost=Object.values(catTotals).reduce((s,c)=>s+c.cost,0),totalPrice=Object.values(catTotals).reduce((s,c)=>s+c.price,0);

// èŠ±ãƒ»ç”£ç›´ã®åˆè¨ˆ
const hanaTotalCost=catTotals['hana']?.cost||0;
const hanaTotalPrice=catTotals['hana']?.price||0;
const sanchokuTotalCost=catTotals['sanchoku']?.cost||0;
const sanchokuTotalPrice=catTotals['sanchoku']?.price||0;
const deliverySalesCost=hanaTotalCost+sanchokuTotalCost; // å£²ä¸Šç´å“åŸä¾¡
const deliverySalesPrice=hanaTotalPrice+sanchokuTotalPrice; // å£²ä¸Šç´å“å£²ä¾¡

// ã‚³ã‚¢ä»•å…¥ï¼ˆèŠ±ãƒ»ç”£ç›´ãƒ»åŸä¾¡ç®—å…¥æ¯”ã‚’é™¤ã„ãŸä»•å…¥ï¼‰
const coreCost=totalCost-deliverySalesCost-totalConsumable;
const corePrice=totalPrice-deliverySalesPrice-totalConsumable;

// === æ¨å®šåœ¨åº«è¨ˆç®—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ•°å¼ï¼‰ ===
// 
// ã€å‰æã€‘
// - d: å€¤å¼•ç‡ï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰= å€¤å¼•é¡ / (å£²ä¸Š + å€¤å¼•é¡)
// - m: å€¤å…¥ç‡ï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰= (å£²ä¾¡ - åŸä¾¡) / å£²ä¾¡
// - S_net: å€¤å¼•å¾Œå£²ä¸Šï¼ˆãƒãƒƒãƒˆå£²ä¸Šï¼‰
// - BI: æœŸé¦–åœ¨åº«
// - P: æœŸä¸­ä»•å…¥ï¼ˆåŸä¾¡ï¼‰
//
// ã€è¨ˆç®—å¼ã€‘
// 1. S_gross = S_net / (1 - d)  â† ã‚°ãƒ­ã‚¹å£²ä¸Š
// 2. COGS_est = S_gross Ã— (1 - m)  â† æ¨å®šå£²ä¸ŠåŸä¾¡
// 3. EI_est = BI + P - COGS_est  â† æ¨å®šæœŸæœ«åœ¨åº«
//
// ã€æ³¨æ„ã€‘å£²ä¸Šç´å“ï¼ˆèŠ±ãƒ»ç”£ç›´ï¼‰ã¯åˆ¥ã®å€¤å…¥ç‡ã‚’é©ç”¨

// å£²ä¾¡ãƒ™ãƒ¼ã‚¹å£²å¤‰ç‡ d = å€¤å¼•é¡ / (å£²ä¸Š + å€¤å¼•é¡)
const totalGrossSales=totalSales+totalBaihen; // S_net + å€¤å¼•é¡
const baihenRateSales=totalGrossSales>0?totalBaihen/totalGrossSales:0; // d

// ã‚³ã‚¢éƒ¨åˆ†ã®å€¤å…¥ç‡ mï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰
const coreMarginRate=corePrice>0?(corePrice-coreCost)/corePrice:marginRate;

// å£²ä¸Šç´å“ï¼ˆèŠ±ãƒ»ç”£ç›´ï¼‰ã®å€¤å…¥ç‡
const deliveryMarginRate=deliverySalesPrice>0?(deliverySalesPrice-deliverySalesCost)/deliverySalesPrice:0;

// === ã‚³ã‚¢éƒ¨åˆ†ã®è¨ˆç®— ===
// ã‚³ã‚¢å£²ä¸Šï¼ˆãƒãƒƒãƒˆï¼‰= ç·å£²ä¸Š - èŠ±å£²ä¾¡ - ç”£ç›´å£²ä¾¡
const coreNetSales=totalCoreSales;

// ã‚³ã‚¢ã®ã‚°ãƒ­ã‚¹å£²ä¸Š = ã‚³ã‚¢ãƒãƒƒãƒˆå£²ä¸Š / (1 - d)
// â€»å€¤å¼•ã¯åœ¨åº«è²©å£²ï¼ˆã‚³ã‚¢ï¼‰ã®ã¿ã«é©ç”¨ã•ã‚Œã‚‹ã¨ä»®å®š
const coreGrossSales=(1-baihenRateSales)>0?coreNetSales/(1-baihenRateSales):coreNetSales;

// ã‚³ã‚¢ã®æ¨å®šå£²ä¸ŠåŸä¾¡ = ã‚³ã‚¢ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1 - m)
const coreEstCogs=coreGrossSales*(1-coreMarginRate);

// === å£²ä¸Šç´å“ï¼ˆèŠ±ãƒ»ç”£ç›´ï¼‰ã®è¨ˆç®— ===
// å£²ä¸Šç´å“ã¯å€¤å¼•ãªã—ã€å£²ä¾¡=å£²ä¸Šã¨ã—ã¦æ‰±ã†
// å£²ä¸Šç´å“ã®å£²ä¸ŠåŸä¾¡ = åŸä¾¡ãã®ã¾ã¾ï¼ˆã¾ãŸã¯å£²ä¾¡Ã—(1-å€¤å…¥ç‡)ï¼‰
const deliveryEstCogs=deliverySalesCost; // åŸä¾¡ã‚’ãã®ã¾ã¾ä½¿ç”¨

// === æ¶ˆè€—å“ï¼ˆåŸä¾¡ç®—å…¥æ¯”ï¼‰===
// æ¶ˆè€—å“ã¯å£²ä¸ŠåŸä¾¡ã¨ã—ã¦ãã®ã¾ã¾åŠ ç®—
const consumableEstCogs=totalConsumable;

// === æ¨å®šå£²ä¸ŠåŸä¾¡åˆè¨ˆ ===
const estimatedCogs=coreEstCogs+deliveryEstCogs+consumableEstCogs;

// === æ¨å®šæœŸæœ«åœ¨åº« ===
// EI_est = BI + P - COGS_est
const estimatedInvEnd=invStart+totalCost-estimatedCogs;

// === æ¨å®šç²—åˆ© ===
const estimatedGrossProfit=totalSales-estimatedCogs;
const estimatedGrossRate=totalSales>0?estimatedGrossProfit/totalSales:0;

// ã‚³ã‚¢æ¨å®šç²—åˆ©ç‡ = (m - d) / (1 - d) â€»å‚è€ƒå€¤
const estimatedCoreGrossRate=(1-baihenRateSales)>0?(coreMarginRate-baihenRateSales)/(1-baihenRateSales):coreMarginRate;

// åŸä¾¡å€¤å¼•ç‡ï¼ˆå‚è€ƒå€¤ï¼‰= d / (1 - m + d)
const baihenRateCost=(1-coreMarginRate+baihenRateSales)>0?baihenRateSales/(1-coreMarginRate+baihenRateSales):0;

// å€¤å¼•ã«ã‚ˆã‚‹åŸä¾¡æå¤± = ã‚°ãƒ­ã‚¹å£²ä¸ŠåŸä¾¡ - ãƒãƒƒãƒˆå£²ä¸ŠåŸä¾¡ï¼ˆç†è«–å€¤ï¼‰
// = coreGrossSales Ã— (1-m) - coreNetSales Ã— (1-m)
// = (1-m) Ã— (coreGrossSales - coreNetSales)
// = (1-m) Ã— coreNetSales Ã— d / (1-d)
const baihenLossCost=(1-coreMarginRate)*coreNetSales*baihenRateSales/(1-baihenRateSales||1);

// æ—¥åˆ¥ã®æ¨å®šåœ¨åº«ã‚’è¨ˆç®—
let dailyInvData=[];
let runningInv=invStart;
let runningCumSales=0,runningCumCost=0,runningCumBaihen=0;
for(let day=1;day<=31;day++){
    const d=daily[day];
    if(d){
        const daySales=d.sales||0;
        const dayShiireCost=d.shiire?.cost||0;
        const dayTenkanIn=d.tenkanInTotal?.cost||0;
        const dayTenkanOut=d.tenkanOutTotal?.cost||0;
        const dayBumonIn=d.bumonInTotal?.cost||0;
        const dayBumonOut=d.bumonOutTotal?.cost||0;
        const dayHanaCost=d.hana?.cost||0;
        const daySanchokuCost=d.sanchoku?.cost||0;
        const dayConsCost=d.consumable?.cost||0;
        const dayBaihen=d.baihen||0;
        const dayHanaPrice=d.hana?.price||0;
        const daySanchokuPrice=d.sanchoku?.price||0;
        
        // æ—¥æ¬¡ä»•å…¥åˆè¨ˆï¼ˆåŸä¾¡ï¼‰
        const dayTotalCost=dayShiireCost+dayTenkanIn+dayTenkanOut+dayBumonIn+dayBumonOut+dayHanaCost+daySanchokuCost+dayConsCost;
        
        // æ—¥æ¬¡ã‚³ã‚¢å£²ä¸Šï¼ˆãƒãƒƒãƒˆï¼‰
        const dayCoreSales=daySales-dayHanaPrice-daySanchokuPrice;
        
        // æ—¥æ¬¡ã‚°ãƒ­ã‚¹å£²ä¸Š = ãƒãƒƒãƒˆå£²ä¸Š / (1 - d)
        const dayGrossSales=(1-baihenRateSales)>0?dayCoreSales/(1-baihenRateSales):dayCoreSales;
        
        // æ—¥æ¬¡ã‚³ã‚¢å£²ä¸ŠåŸä¾¡ = ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1 - m)
        const dayCoreCogs=dayGrossSales*(1-coreMarginRate);
        
        // æ—¥æ¬¡å£²ä¸Šç´å“åŸä¾¡
        const dayDeliveryCogs=dayHanaCost+daySanchokuCost;
        
        // æ—¥æ¬¡æ¨å®šå£²ä¸ŠåŸä¾¡åˆè¨ˆ
        const dayEstCogs=dayCoreCogs+dayDeliveryCogs+dayConsCost;
        
        // æ¨å®šåœ¨åº« = å‰æ—¥åœ¨åº« + å½“æ—¥ä»•å…¥ - å½“æ—¥å£²ä¸ŠåŸä¾¡
        runningInv=runningInv+dayTotalCost-dayEstCogs;
        runningCumSales+=daySales;
        runningCumCost+=dayTotalCost;
        runningCumBaihen+=dayBaihen;
    }
    dailyInvData.push({day,inv:runningInv,cumSales:runningCumSales,cumCost:runningCumCost,cumBaihen:runningCumBaihen,hasData:!!daily[day]});
}

// å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹ã®è’åˆ©è¨ˆç®—ï¼ˆå¾“æ¥é€šã‚Šï¼‰
const costBeforeConsumable=totalCost-totalConsumable;
const grossProfitBeforeConsumable=totalSales-(invStart+costBeforeConsumable-invEnd);
const grossProfitRateBeforeConsumable=totalSales>0?grossProfitBeforeConsumable/totalSales:0;
const grossProfit=totalSales-(invStart+totalCost-invEnd),grossProfitRate=totalSales>0?grossProfit/totalSales:0,avgMargin=totalPrice>0?(totalPrice-totalCost)/totalPrice:marginRate;
const consumableRate=totalSales>0?totalConsumable/totalSales:0;

const hanaRate=parseFloat(document.getElementById('hana-rate')?.value)||0.80;
const sanchokuRate=parseFloat(document.getElementById('sanchoku-rate')?.value)||0.85;
// äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const storeBudget=STORE_BUDGET[sid]||{daily:{},total:parseNum(document.getElementById('budget').value)};
const budgetTotal=storeBudget.total||parseNum(document.getElementById('budget').value);
// æ—¥åˆ¥ã®äºˆç®—æ¶ˆåŒ–ã‚’è¨ˆç®—
let budgetConsumed=0,salesDays=0,lastDay=0;
Object.entries(daily).forEach(([day,d])=>{
    const dayNum=parseInt(day);
    if(d.sales>0){salesDays++;lastDay=Math.max(lastDay,dayNum);}
    const dayBudget=storeBudget.daily[dayNum]||0;
    budgetConsumed+=dayBudget;
});
// çµŒéæ—¥æ•°ã¨æ®‹äºˆç®—
const elapsedDays=lastDay;
const remainingBudget=budgetTotal-totalSales;
const budgetAchievement=budgetTotal>0?totalSales/budgetTotal:0;
const budgetConsumptionRate=budgetTotal>0?budgetConsumed/budgetTotal:0;
const avgDailySales=salesDays>0?totalSales/salesDays:0;
const projectedSales=avgDailySales*31;
const projectedAchievement=budgetTotal>0?projectedSales/budgetTotal:0;
result[sid]={daily,catTotals,supTotals,transferDetails,invStart,invEnd,budget:budgetTotal,budgetDaily:storeBudget.daily,marginRate,totalSales,totalCost,totalPrice,grossProfit,grossProfitRate,avgMargin,hanaRate,sanchokuRate,budgetConsumed,budgetAchievement,budgetConsumptionRate,remainingBudget,avgDailySales,projectedSales,projectedAchievement,salesDays,elapsedDays,totalConsumable,consumableRate,grossProfitBeforeConsumable,grossProfitRateBeforeConsumable,totalBaihen,baihenRateSales,baihenRateCost,coreMarginRate,estimatedCoreGrossRate,estimatedGrossProfit,estimatedGrossRate,estimatedInvEnd,estimatedCogs,baihenLossCost,dailyInvData,deliverySalesCost,deliverySalesPrice,coreCost,corePrice,totalCoreSales};});
document.getElementById('btn-export').style.display='flex';document.getElementById('view-tabs').style.display='flex';document.getElementById('stats-row').style.display='grid';
const hr=parseFloat(document.getElementById('hana-rate')?.value)||0.80;
const sr=parseFloat(document.getElementById('sanchoku-rate')?.value)||0.85;
showToast('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆå®Œäº†ï¼ˆèŠ±:'+hr+'æ›/ç”£ç›´:'+sr+'æ›ï¼‰','success');render();}catch(err){console.error(err);document.getElementById('content').innerHTML='<div class="empty-state"><div class="empty-icon">âš ï¸</div><h3>ã‚¨ãƒ©ãƒ¼</h3><p>'+err.message+'</p></div>';showToast('ã‚¨ãƒ©ãƒ¼: '+err.message,'error');}},150);}

function render(){updateStats();if(currentStore==='all')renderAllStores();else{switch(currentView){case'dashboard':renderDashboard();break;case'category':renderCategory();break;case'forecast':renderForecast();break;case'analysis':renderAnalysis();break;case'supplier':renderSupplier();break;case'daily':renderDaily();break;case'summary':renderSummary();break;case'reports':renderReports();break;default:renderDashboard();}}}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function renderDashboard(){
    const data=result[currentStore];if(!data)return;
    
    // ç›®æ¨™è¨­å®šã‚’å–å¾—
    const targetMargin=parseFloat(document.getElementById('target-margin')?.value)/100||0.25;
    const warningMargin=parseFloat(document.getElementById('warning-margin')?.value)/100||0.23;
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
    const alerts=[];
    if(data.grossProfitRate<warningMargin){
        if(data.grossProfitRate<0.20){
            alerts.push({type:'danger',icon:'ğŸš¨',title:'ç²—åˆ©ç‡ãŒå±é™ºæ°´æº–',desc:`ç¾åœ¨ ${fmtPct(data.grossProfitRate)} ã¯ç›®æ¨™ ${fmtPct(targetMargin)} ã‚’å¤§ããä¸‹å›ã£ã¦ã„ã¾ã™`});
        }else{
            alerts.push({type:'warning',icon:'âš ï¸',title:'ç²—åˆ©ç‡ãŒç›®æ¨™æœªé”',desc:`ç¾åœ¨ ${fmtPct(data.grossProfitRate)} ã¯ç›®æ¨™ ${fmtPct(targetMargin)} ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™`});
        }
    }else{
        alerts.push({type:'success',icon:'âœ…',title:'ç²—åˆ©ç‡ã¯ç›®æ¨™é”æˆ',desc:`ç¾åœ¨ ${fmtPct(data.grossProfitRate)} ã¯è‰¯å¥½ã§ã™`});
    }
    
    // åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ
    const invRatio=data.invStart>0?data.estimatedInvEnd/data.invStart:1;
    if(invRatio<0.5){
        alerts.push({type:'danger',icon:'ğŸ“¦',title:'åœ¨åº«ãŒå±é™ºæ°´æº–',desc:`æ¨å®šåœ¨åº«ãŒæœŸé¦–ã®${fmtPct(invRatio)}ã¾ã§æ¸›å°‘`});
    }else if(invRatio<0.7){
        alerts.push({type:'warning',icon:'ğŸ“¦',title:'åœ¨åº«æ¸›å°‘å‚¾å‘',desc:`æ¨å®šåœ¨åº«ã¯æœŸé¦–ã®${fmtPct(invRatio)}ã§ã™`});
    }
    
    // æœˆæœ«ç€åœ°äºˆæ¸¬
    const projectedSales=data.avgDailySales*31;
    const projectedAchievement=data.budget>0?projectedSales/data.budget:0;
    
    // KPIã‚«ãƒ©ãƒ¼
    const gpColor=data.grossProfitRate>=targetMargin?'success':data.grossProfitRate>=warningMargin?'warning':'danger';
    
    let h='';
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
    if(alerts.length>0){
        h+='<div style="margin-bottom:16px">';
        alerts.forEach(a=>{
            h+=`<div class="alert-card ${a.type}"><div class="alert-icon">${a.icon}</div><div class="alert-content"><div class="alert-title">${a.title}</div><div class="alert-desc">${a.desc}</div></div></div>`;
        });
        h+='</div>';
    }
    
    // KPIã‚«ãƒ¼ãƒ‰
    h+='<div class="kpi-grid">';
    
    // å£²ä¸Š
    h+=`<div class="kpi-card" data-color="primary"><div class="kpi-header"><span class="kpi-label">å£²ä¸Šé«˜</span><span class="kpi-icon">ğŸ’°</span></div><div class="kpi-value">Â¥${fmt(data.totalSales)}</div><div class="kpi-sub">æ—¥å¹³å‡ Â¥${fmt(data.avgDailySales)}</div></div>`;
    
    // è’åˆ©ç‡
    h+=`<div class="kpi-card" data-color="${gpColor}"><div class="kpi-header"><span class="kpi-label" data-tip="å£²ä¸Š-(æœŸé¦–+ä»•å…¥-æœŸæœ«)Ã·å£²ä¸Š">è’åˆ©ç‡(å®Ÿç¸¾)</span><span class="kpi-icon">ğŸ“Š</span></div><div class="kpi-value" style="color:var(--${gpColor})">${fmtPct(data.grossProfitRate)}</div><div class="kpi-sub">è’åˆ© Â¥${fmt(data.grossProfit)}</div><div class="kpi-progress"><div class="kpi-progress-bar" style="width:${Math.min(data.grossProfitRate/targetMargin*100,100)}%;background:var(--${gpColor})"></div></div></div>`;
    
    // æ¨å®šç²—åˆ©ç‡
    h+=`<div class="kpi-card" data-color="purple"><div class="kpi-header"><span class="kpi-label" data-tip="(å€¤å…¥ç‡-å£²å¤‰ç‡)Ã·(1-å£²å¤‰ç‡)">æ¨å®šç²—åˆ©ç‡</span><span class="kpi-icon">ğŸ¯</span></div><div class="kpi-value" style="color:var(--purple)">${fmtPct(data.estimatedGrossRate)}</div><div class="kpi-sub">æ¨å®šè’åˆ© Â¥${fmt(data.estimatedGrossProfit)}</div></div>`;
    
    // å£²å¤‰ç‡
    h+=`<div class="kpi-card" data-color="danger"><div class="kpi-header"><span class="kpi-label" data-tip="å€¤å¼•é¡Ã·(å£²ä¸Š+å€¤å¼•é¡)">å£²å¤‰ç‡</span><span class="kpi-icon">ğŸ“‰</span></div><div class="kpi-value" style="color:var(--danger)">${fmtPct(data.baihenRateSales)}</div><div class="kpi-sub">å€¤å¼•é¡ Â¥${fmt(data.totalBaihen)}</div></div>`;
    
    // æ¨å®šåœ¨åº«
    h+=`<div class="kpi-card" data-color="cyan"><div class="kpi-header"><span class="kpi-label" data-tip="æœŸé¦–+ä»•å…¥-æ¨å®šå£²ä¸ŠåŸä¾¡">æ¨å®šæœŸæœ«åœ¨åº«</span><span class="kpi-icon">ğŸ“¦</span></div><div class="kpi-value" style="color:#06b6d4">Â¥${fmt(data.estimatedInvEnd)}</div><div class="kpi-sub">å®Ÿç¸¾ Â¥${fmt(data.invEnd)} / å·®ç•° Â¥${fmt(data.estimatedInvEnd-data.invEnd)}</div></div>`;
    
    // æœˆæœ«ç€åœ°äºˆæ¸¬
    const projColor=projectedAchievement>=1?'success':projectedAchievement>=0.9?'warning':'danger';
    h+=`<div class="kpi-card" data-color="${projColor}"><div class="kpi-header"><span class="kpi-label">æœˆæœ«ç€åœ°äºˆæ¸¬</span><span class="kpi-icon">ğŸ”®</span></div><div class="kpi-value" style="color:var(--${projColor})">Â¥${fmt(projectedSales)}</div><div class="kpi-sub">äºˆç®—é”æˆç‡ ${fmtPct(projectedAchievement)} (äºˆæ¸¬)</div></div>`;
    
    h+='</div>';
    
    // è©³ç´°è¨ˆç®—ã‚«ãƒ¼ãƒ‰
    h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px">';
    
    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
    h+=`<div class="section expanded" style="margin-bottom:0"><div class="section-header"><div class="section-icon" style="background:linear-gradient(135deg,var(--primary),var(--purple))">ğŸ“Š</div><div class="section-info"><div class="section-name">ã‚µãƒãƒªãƒ¼</div></div></div><div class="section-body" style="padding:14px">
        <div style="display:grid;gap:6px;font-size:0.75rem">
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text3)">æœŸé¦–åœ¨åº«</span><span style="font-family:'JetBrains Mono',monospace">Â¥${fmt(data.invStart)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text3)">ç·ä»•å…¥</span><span style="font-family:'JetBrains Mono',monospace">Â¥${fmt(data.totalCost)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text3)">æœŸæœ«åœ¨åº«</span><span style="font-family:'JetBrains Mono',monospace">Â¥${fmt(data.invEnd)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text3)">å£²ä¸ŠåŸä¾¡</span><span style="font-family:'JetBrains Mono',monospace;color:var(--warning)">Â¥${fmt(data.invStart+data.totalCost-data.invEnd)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text3)">å¹³å‡å€¤å…¥ç‡</span><span style="font-family:'JetBrains Mono',monospace;color:var(--info)">${fmtPct(data.avgMargin)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;font-weight:600"><span>è’åˆ©ç›Š</span><span style="font-family:'JetBrains Mono',monospace;color:var(--success)">Â¥${fmt(data.grossProfit)}</span></div>
        </div>
    </div></div>`;
    
    // æ¨å®šåœ¨åº«è¨ˆç®—ã‚«ãƒ¼ãƒ‰
    const coreGrossSales=(1-data.baihenRateSales)>0?data.totalCoreSales/(1-data.baihenRateSales):data.totalCoreSales;
    h+=`<div class="section expanded" style="margin-bottom:0"><div class="section-header"><div class="section-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸ§®</div><div class="section-info"><div class="section-name">æ¨å®šåœ¨åº«è¨ˆç®—</div></div></div><div class="section-body" style="padding:14px">
        <div style="font-size:0.6rem;color:var(--text4);padding:8px;background:var(--bg4);border-radius:5px;margin-bottom:10px;line-height:1.5">
            <strong>è¨ˆç®—å¼:</strong><br>â‘  ã‚°ãƒ­ã‚¹å£²ä¸Š = ãƒãƒƒãƒˆå£²ä¸Š Ã· (1-d)<br>â‘¡ æ¨å®šåŸä¾¡ = ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1-m)<br>â‘¢ æ¨å®šåœ¨åº« = æœŸé¦– + ä»•å…¥ - åŸä¾¡
        </div>
        <div style="display:grid;gap:4px;font-size:0.7rem">
            <div style="display:flex;justify-content:space-between;padding:4px 0"><span style="color:var(--text4)">ãƒãƒƒãƒˆå£²ä¸Š (S_net)</span><span style="font-family:'JetBrains Mono',monospace">Â¥${fmt(data.totalCoreSales)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0"><span style="color:var(--text4)">Ã· (1-d) â†’ ã‚°ãƒ­ã‚¹å£²ä¸Š</span><span style="font-family:'JetBrains Mono',monospace;color:var(--warning)">Â¥${fmt(coreGrossSales)}</span></div>
            <div style="display:flex;justify-content:space-between;padding:4px 0"><span style="color:var(--text4)">Ã— (1-m) â†’ æ¨å®šåŸä¾¡</span><span style="font-family:'JetBrains Mono',monospace;color:var(--danger)">Â¥${fmt(coreGrossSales*(1-data.avgMargin))}</span></div>
            <div style="display:flex;justify-content:space-between;padding:6px 0;margin-top:4px;border-top:1px solid var(--border);font-weight:600"><span>æ¨å®šæœŸæœ«åœ¨åº«</span><span style="font-family:'JetBrains Mono',monospace;color:#06b6d4">Â¥${fmt(data.estimatedInvEnd)}</span></div>
        </div>
    </div></div>`;
    
    h+='</div>';
    
    document.getElementById('content').innerHTML=h;
}

// ===== é€±é–“äºˆæ¸¬ =====
function renderForecast(){
    const data=result[currentStore];if(!data)return;
    
    // é€±é–‹å§‹æ—¥ï¼ˆæ°´æ›œæ—¥=3ï¼‰
    const weekStartDay=3;
    const today=new Date();
    const currentDayOfWeek=today.getDay();
    const daysFromWeekStart=(currentDayOfWeek-weekStartDay+7)%7;
    
    const weekStart=new Date(today);
    weekStart.setDate(today.getDate()-daysFromWeekStart);
    
    // é€±ã®7æ—¥åˆ†ã‚’ç”Ÿæˆ
    const dayNames=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const weekDays=[];
    for(let i=0;i<7;i++){
        const d=new Date(weekStart);
        d.setDate(weekStart.getDate()+i);
        weekDays.push({
            date:d,
            day:d.getDate(),
            dayName:dayNames[d.getDay()],
            isToday:d.toDateString()===today.toDateString(),
            isPast:d<today&&d.toDateString()!==today.toDateString()
        });
    }
    
    // é€±é–“ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    let weekSales=0,weekBaihen=0,weekCost=0;
    weekDays.forEach(wd=>{
        const dayData=data.daily[wd.day];
        if(dayData){
            weekSales+=dayData.sales;
            weekBaihen+=dayData.baihen||0;
            weekCost+=dayData.shiire?.cost||0;
        }
    });
    
    // é€±é–“ç›®æ¨™
    const targetMargin=parseFloat(document.getElementById('target-margin')?.value)/100||0.25;
    const weeklyTargetSales=data.avgDailySales*7;
    const weekProgress=weeklyTargetSales>0?weekSales/weeklyTargetSales:0;
    
    // æ®‹ã‚Šæ—¥æ•°ã¨å¿…è¦å£²ä¸Š
    const daysWithData=weekDays.filter(wd=>data.daily[wd.day]&&data.daily[wd.day].sales>0).length;
    const daysRemaining=7-daysWithData;
    const requiredDaily=daysRemaining>0?Math.max(0,(weeklyTargetSales-weekSales)/daysRemaining):0;
    
    let h='';
    
    // KPIã‚«ãƒ¼ãƒ‰
    h+='<div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">';
    
    h+=`<div class="kpi-card" data-color="primary"><div class="kpi-header"><span class="kpi-label">é€±é–“å£²ä¸Š</span><span class="kpi-icon">ğŸ“…</span></div><div class="kpi-value">Â¥${fmt(weekSales)}</div><div class="kpi-sub">ç›®æ¨™ Â¥${fmt(weeklyTargetSales)}</div></div>`;
    
    const progressColor=weekProgress>=1?'success':weekProgress>=0.7?'warning':'danger';
    h+=`<div class="kpi-card" data-color="${progressColor}"><div class="kpi-header"><span class="kpi-label">é€±é–“é”æˆç‡</span><span class="kpi-icon">ğŸ¯</span></div><div class="kpi-value" style="color:var(--${progressColor})">${fmtPct(weekProgress)}</div><div class="kpi-progress"><div class="kpi-progress-bar" style="width:${Math.min(weekProgress*100,100)}%;background:var(--${progressColor})"></div></div></div>`;
    
    h+=`<div class="kpi-card" data-color="info"><div class="kpi-header"><span class="kpi-label">æ®‹ã‚Š${daysRemaining}æ—¥ã®ç›®æ¨™</span><span class="kpi-icon">ğŸ“Š</span></div><div class="kpi-value" style="color:var(--info)">Â¥${fmt(requiredDaily)}</div><div class="kpi-sub">/æ—¥ã‚ãŸã‚Šå¿…è¦å£²ä¸Š</div></div>`;
    
    h+=`<div class="kpi-card" data-color="danger"><div class="kpi-header"><span class="kpi-label">é€±é–“å€¤å¼•</span><span class="kpi-icon">ğŸ“‰</span></div><div class="kpi-value" style="color:var(--danger)">Â¥${fmt(weekBaihen)}</div><div class="kpi-sub">å£²å¤‰ç‡ ${fmtPct((weekSales+weekBaihen)>0?weekBaihen/(weekSales+weekBaihen):0)}</div></div>`;
    
    h+='</div>';
    
    // é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    h+=`<div class="section expanded"><div class="section-header"><div class="section-icon" style="background:linear-gradient(135deg,#fbbf24,#f59e0b)">ğŸ“…</div><div class="section-info"><div class="section-name">é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ°´æ›œã€œç«æ›œï¼‰</div><div class="section-meta">${weekStart.getMonth()+1}/${weekStart.getDate()} ã€œ ${weekDays[6].date.getMonth()+1}/${weekDays[6].day}</div></div></div><div class="section-body" style="padding:14px">`;
    
    h+='<div class="forecast-grid">';
    weekDays.forEach(wd=>{
        const dayData=data.daily[wd.day];
        const hasSales=dayData&&dayData.sales>0;
        const classList=['forecast-day'];
        if(wd.isToday)classList.push('today');
        if(wd.isPast&&!hasSales)classList.push('past');
        
        const salesColor=hasSales?'var(--text)':'var(--text4)';
        const achieveRate=hasSales&&data.avgDailySales>0?dayData.sales/data.avgDailySales:0;
        const achieveColor=achieveRate>=1?'var(--success)':achieveRate>=0.8?'var(--warning)':'var(--danger)';
        
        h+=`<div class="${classList.join(' ')}">
            <div class="forecast-day-name">${wd.dayName}</div>
            <div class="forecast-day-date">${wd.date.getMonth()+1}/${wd.day}</div>
            <div class="forecast-day-value" style="color:${salesColor}">${hasSales?'Â¥'+fmt(dayData.sales):'-'}</div>
            <div class="forecast-day-target">${hasSales?fmtPct(achieveRate):'ç›®æ¨™ Â¥'+fmt(data.avgDailySales)}</div>
        </div>`;
    });
    h+='</div>';
    
    h+='</div></div>';
    
    // ç›®æ¨™é”æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    h+=`<div class="section expanded"><div class="section-header"><div class="section-icon" style="background:linear-gradient(135deg,var(--success),#059669)">ğŸ¯</div><div class="section-info"><div class="section-name">ç›®æ¨™é”æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div></div></div><div class="section-body" style="padding:14px">`;
    
    const targetSalesForMargin=data.totalCost/(1-targetMargin);
    const remainingForTarget=Math.max(0,targetSalesForMargin-data.totalSales);
    const remainingDays=31-data.salesDays;
    const requiredDailySales=remainingDays>0?remainingForTarget/remainingDays:0;
    
    h+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
        <div style="background:var(--bg4);padding:14px;border-radius:8px">
            <div style="font-size:0.6rem;color:var(--text4);margin-bottom:4px">ç›®æ¨™ç²—åˆ©ç‡é”æˆã«å¿…è¦ãªå£²ä¸Š</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--warning)">Â¥${fmt(targetSalesForMargin)}</div>
        </div>
        <div style="background:var(--bg4);padding:14px;border-radius:8px">
            <div style="font-size:0.6rem;color:var(--text4);margin-bottom:4px">æ®‹ã‚Šå¿…è¦å£²ä¸Š</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:${remainingForTarget>0?'var(--danger)':'var(--success)'}">Â¥${fmt(remainingForTarget)}</div>
        </div>
        <div style="background:var(--bg4);padding:14px;border-radius:8px">
            <div style="font-size:0.6rem;color:var(--text4);margin-bottom:4px">æ®‹ã‚Š${remainingDays}æ—¥ã®æ—¥å¹³å‡å¿…è¦å£²ä¸Š</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600;color:var(--info)">Â¥${fmt(requiredDailySales)}</div>
        </div>
    </div>`;
    
    h+='</div></div>';
    
    document.getElementById('content').innerHTML=h;
}

function updateStats(){let d;if(currentStore==='all'){d={totalSales:0,totalCost:0,grossProfit:0,budget:0,totalConsumable:0,grossProfitBeforeConsumable:0};Object.values(result).forEach(x=>{d.totalSales+=x.totalSales;d.totalCost+=x.totalCost;d.grossProfit+=x.grossProfit;d.budget+=x.budget;d.totalConsumable+=x.totalConsumable||0;d.grossProfitBeforeConsumable+=x.grossProfitBeforeConsumable||0;});d.grossProfitRate=d.totalSales>0?d.grossProfit/d.totalSales:0;d.grossProfitRateBeforeConsumable=d.totalSales>0?d.grossProfitBeforeConsumable/d.totalSales:0;d.consumableRate=d.totalSales>0?d.totalConsumable/d.totalSales:0;}else d=result[currentStore];if(!d)return;document.getElementById('view-title').textContent=currentStore==='all'?'å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼':STORES[currentStore]?.name||currentStore;const b=document.getElementById('store-badge');b.style.display=currentStore==='all'?'none':'inline';b.textContent=currentStore.padStart(2,'0');document.getElementById('stat-sales').textContent='Â¥'+fmt(d.totalSales);document.getElementById('stat-sales-sub').textContent='äºˆç®—æ¯” '+fmtPct(d.totalSales/d.budget);document.getElementById('stat-cost').textContent='Â¥'+fmt(d.totalCost);document.getElementById('stat-consumable').textContent='åŸä¾¡ç®—å…¥æ¯” '+fmt(d.totalConsumable||0)+' ('+fmtPct(d.consumableRate||0)+')';document.getElementById('stat-rate-before').textContent=fmtPct(d.grossProfitRateBeforeConsumable||0);document.getElementById('stat-profit-before').textContent='è’åˆ© '+fmt(d.grossProfitBeforeConsumable||0);document.getElementById('stat-rate').textContent=fmtPct(d.grossProfitRate);document.getElementById('stat-profit-sub').textContent='è’åˆ© '+fmt(d.grossProfit);}

function renderAllStores(){let h='<div class="stores-grid">';Object.entries(result).sort((a,b)=>+a[0]-+b[0]).forEach(([sid,d])=>{const st=STORES[sid];if(!st)return;const pc=d.grossProfitRate>=0.25?'var(--success)':d.grossProfitRate>=0.2?'var(--warning)':'var(--danger)';h+='<div class="store-card" onclick="selectStore(\''+sid+'\')"><div class="store-card-header"><div class="store-card-icon">ğŸª</div><div><div class="store-card-name">'+st.name+'</div><div class="store-card-code">'+st.code+'</div></div></div><div class="store-card-stats"><div class="store-card-stat"><div class="label">å£²ä¸Š</div><div class="value">'+fmt(d.totalSales)+'</div></div><div class="store-card-stat"><div class="label">è’åˆ©ç›Š</div><div class="value" style="color:var(--success)">'+fmt(d.grossProfit)+'</div></div><div class="store-card-stat"><div class="label">è’åˆ©ç‡</div><div class="value" style="color:'+pc+'">'+fmtPct(d.grossProfitRate)+'</div></div><div class="store-card-stat"><div class="label">å€¤å…¥ç‡</div><div class="value" style="color:var(--info)">'+fmtPct(d.avgMargin)+'</div></div></div></div>';});h+='</div>';document.getElementById('content').innerHTML=h;}

function selectStore(sid){currentStore=sid;document.querySelectorAll('#store-chips .chip').forEach(c=>c.classList.toggle('active',c.dataset.store===sid));render();}

function renderCategory(){const data=result[currentStore];if(!data)return;let h='';getCatOrder().forEach(cat=>{const cd=data.catTotals[cat];if(!cd||(cd.cost===0&&cd.price===0))return;const info=CATEGORIES[cat]||{name:cat,icon:'ğŸ“‹'},mr=cd.price>0?(cd.price-cd.cost)/cd.price:0;const sups=Object.entries(data.supTotals).filter(([code])=>(SUPPLIERS[code]?.cat||'other')===cat).sort((a,b)=>b[1].cost-a[1].cost);h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon '+cat+'">'+info.icon+'</div><div class="section-info"><div class="section-name">'+info.name+'</div><div class="section-meta">'+(sups.length>0?sups.length+'ç¤¾':'')+'</div></div><div class="section-stats"><span><span class="sl">åŸä¾¡</span> <span class="cost">'+fmt(cd.cost)+'</span></span><span><span class="sl">å£²ä¾¡</span> <span class="price">'+fmt(cd.price)+'</span></span><span><span class="sl">å€¤å…¥</span> <span class="highlight">'+fmtPct(mr)+'</span></span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th>';if(cat==='tenkan')h+='<th class="col-cost">å…¥åŸä¾¡</th><th class="col-price">å…¥å£²ä¾¡</th><th>å…¥å…ƒ</th><th class="col-cost">å‡ºåŸä¾¡</th><th class="col-price">å‡ºå£²ä¾¡</th><th>å‡ºå…ˆ</th>';else if(cat==='bumonkan')h+='<th class="col-cost">å…¥åŸä¾¡</th><th class="col-price">å…¥å£²ä¾¡</th><th class="col-cost">å‡ºåŸä¾¡</th><th class="col-price">å‡ºå£²ä¾¡</th><th>éƒ¨é–€</th>';else if(cat==='hana'||cat==='sanchoku')h+='<th class="col-price">å£²ä¾¡(ç´å“)</th><th class="col-cost">åŸä¾¡(æ›ã‘ç‡)</th>';else if(cat==='consumable')h+='<th class="col-cost">åŸä¾¡é‡‘é¡</th><th>å“ç›®æ•°</th>';else{sups.forEach(([,s])=>{h+='<th class="col-cost">'+s.name.substring(0,6)+'<br>åŸä¾¡</th><th class="col-price">å£²ä¾¡</th>';});if(sups.length>1)h+='<th class="col-cost">è¨ˆ</th><th class="col-price">è¨ˆ</th>';}h+='</tr></thead><tbody>';Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{h+='<tr><td>'+day+'æ—¥</td>';if(cat==='tenkan'){const tiS=d.tenkanIn.map(t=>'<span class="store-tag from">'+t.fromStore.padStart(2,'0')+'</span>').join(' ');const toS=d.tenkanOut.map(t=>'<span class="store-tag to">'+t.toStore.padStart(2,'0')+'</span>').join(' ');h+='<td class="col-cost">'+(d.tenkanInTotal.cost?fmt(d.tenkanInTotal.cost):'')+'</td><td class="col-price">'+(d.tenkanInTotal.price?fmt(d.tenkanInTotal.price):'')+'</td><td style="text-align:left">'+(tiS||'')+'</td><td class="col-cost '+(d.tenkanOutTotal.cost<0?'negative':'')+'">'+(d.tenkanOutTotal.cost?fmt(d.tenkanOutTotal.cost):'')+'</td><td class="col-price">'+(d.tenkanOutTotal.price?fmt(d.tenkanOutTotal.price):'')+'</td><td style="text-align:left">'+(toS||'')+'</td>';}else if(cat==='bumonkan'){const buS=d.bumonOut.map(t=>'<span class="store-tag bumon">'+(t.bumonCode||'?')+'</span>').join(' ');h+='<td class="col-cost">'+(d.bumonInTotal.cost?fmt(d.bumonInTotal.cost):'')+'</td><td class="col-price">'+(d.bumonInTotal.price?fmt(d.bumonInTotal.price):'')+'</td><td class="col-cost '+(d.bumonOutTotal.cost<0?'negative':'')+'">'+(d.bumonOutTotal.cost?fmt(d.bumonOutTotal.cost):'')+'</td><td class="col-price">'+(d.bumonOutTotal.price?fmt(d.bumonOutTotal.price):'')+'</td><td style="text-align:left">'+(buS||'')+'</td>';}else if(cat==='hana'){const mr=d.hana?.price>0?(d.hana.price-d.hana.cost)/d.hana.price:0;h+='<td class="col-price" style="color:#f472b6">'+(d.hana?.price?fmt(d.hana.price):'')+'</td><td class="col-cost">'+(d.hana?.cost?fmt(d.hana.cost):'')+'</td>';}else if(cat==='sanchoku'){const mr=d.sanchoku?.price>0?(d.sanchoku.price-d.sanchoku.cost)/d.sanchoku.price:0;h+='<td class="col-price" style="color:#a3e635">'+(d.sanchoku?.price?fmt(d.sanchoku.price):'')+'</td><td class="col-cost">'+(d.sanchoku?.cost?fmt(d.sanchoku.cost):'')+'</td>';}else if(cat==='consumable'){h+='<td class="col-cost" style="color:#f97316">'+(d.consumable?.cost?fmt(d.consumable.cost):'')+'</td><td>'+(d.consumable?.items?.length||'')+'</td>';}else{let sc=0,sp=0;sups.forEach(([code])=>{const s=d.suppliers[code];h+='<td class="col-cost">'+(s?.cost?fmt(s.cost):'')+'</td><td class="col-price">'+(s?.price?fmt(s.price):'')+'</td>';if(s){sc+=s.cost;sp+=s.price;}});if(sups.length>1)h+='<td class="col-cost">'+(sc?fmt(sc):'')+'</td><td class="col-price">'+(sp?fmt(sp):'')+'</td>';}h+='</tr>';});h+='<tr class="row-total"><td>åˆè¨ˆ</td>';if(cat==='tenkan'){const ti=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.tenkanInTotal.cost,price:s.price+d.tenkanInTotal.price}),{cost:0,price:0}),to=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.tenkanOutTotal.cost,price:s.price+d.tenkanOutTotal.price}),{cost:0,price:0});h+='<td class="col-cost">'+fmt(ti.cost)+'</td><td class="col-price">'+fmt(ti.price)+'</td><td></td><td class="col-cost">'+fmt(to.cost)+'</td><td class="col-price">'+fmt(to.price)+'</td><td></td>';}else if(cat==='bumonkan'){const bi=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.bumonInTotal.cost,price:s.price+d.bumonInTotal.price}),{cost:0,price:0}),bo=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.bumonOutTotal.cost,price:s.price+d.bumonOutTotal.price}),{cost:0,price:0});h+='<td class="col-cost">'+fmt(bi.cost)+'</td><td class="col-price">'+fmt(bi.price)+'</td><td class="col-cost">'+fmt(bo.cost)+'</td><td class="col-price">'+fmt(bo.price)+'</td><td></td>';}else if(cat==='hana'||cat==='sanchoku'){h+='<td class="col-price" style="color:'+(cat==='hana'?'#f472b6':'#a3e635')+'">'+fmt(cd.price)+'</td><td class="col-cost">'+fmt(cd.cost)+'</td>';}else if(cat==='consumable'){const itemCount=Object.values(data.daily).reduce((s,d)=>s+(d.consumable?.items?.length||0),0);h+='<td class="col-cost" style="color:#f97316">'+fmt(cd.cost)+'</td><td>'+itemCount+'å“</td>';}else{sups.forEach(([,s])=>h+='<td class="col-cost">'+fmt(s.cost)+'</td><td class="col-price">'+fmt(s.price)+'</td>');if(sups.length>1)h+='<td class="col-cost">'+fmt(cd.cost)+'</td><td class="col-price">'+fmt(cd.price)+'</td>';}h+='</tr></tbody></table></div></div>';});document.getElementById('content').innerHTML=h;}

function renderTransfer(){const data=result[currentStore];if(!data)return;const td=data.transferDetails;const totTiC=td.tenkanIn.reduce((s,t)=>s+t.cost,0),totTiP=td.tenkanIn.reduce((s,t)=>s+t.price,0);const totToC=td.tenkanOut.reduce((s,t)=>s+t.cost,0),totToP=td.tenkanOut.reduce((s,t)=>s+t.price,0);const totBiC=td.bumonIn.reduce((s,t)=>s+t.cost,0),totBiP=td.bumonIn.reduce((s,t)=>s+t.price,0);const totBoC=td.bumonOut.reduce((s,t)=>s+t.cost,0),totBoP=td.bumonOut.reduce((s,t)=>s+t.price,0);
let h='<div class="summary-cards"><div class="summary-card ti"><div class="sc-label">ğŸ“¥ åº—é–“å…¥åº«</div><div class="sc-value" style="color:var(--success)">'+fmt(totTiC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totTiP)+' ï¼ '+td.tenkanIn.length+'ä»¶</div></div><div class="summary-card to"><div class="sc-label">ğŸ“¤ åº—é–“å‡ºåº«</div><div class="sc-value" style="color:var(--danger)">'+fmt(totToC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totToP)+' ï¼ '+td.tenkanOut.length+'ä»¶</div></div><div class="summary-card bi"><div class="sc-label">ğŸ”„ éƒ¨é–€é–“å…¥åº«</div><div class="sc-value" style="color:var(--info)">'+fmt(totBiC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totBiP)+' ï¼ '+td.bumonIn.length+'ä»¶</div></div><div class="summary-card bo"><div class="sc-label">ğŸ”€ éƒ¨é–€é–“å‡ºåº«</div><div class="sc-value" style="color:var(--purple)">'+fmt(totBoC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totBoP)+' ï¼ '+td.bumonOut.length+'ä»¶</div></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon ti">ğŸ“¥</div><div class="section-info"><div class="section-name">åº—é–“å…¥åº«æ˜ç´°</div><div class="section-meta">ä»–åº—èˆ—ã‹ã‚‰ã®å…¥åº« '+td.tenkanIn.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totTiC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>å‡ºåº«å…ƒåº—èˆ—</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.tenkanIn.length===0)h+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px;">åº—é–“å…¥åº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.tenkanIn.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="store-tag from">'+t.fromStore.padStart(2,'0')+'</span> '+(t.fromStoreName||'')+'</td><td class="col-cost positive">'+fmt(t.cost)+'</td><td class="col-price positive">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="2" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost positive"><strong>'+fmt(totTiC)+'</strong></td><td class="col-price positive"><strong>'+fmt(totTiP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon to">ğŸ“¤</div><div class="section-info"><div class="section-name">åº—é–“å‡ºåº«æ˜ç´°</div><div class="section-meta">ä»–åº—èˆ—ã¸ã®å‡ºåº« '+td.tenkanOut.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totToC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>å‡ºåº«å…ˆåº—èˆ—</th><th>éƒ¨é–€</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.tenkanOut.length===0)h+='<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:24px;">åº—é–“å‡ºåº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.tenkanOut.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="store-tag to">'+t.toStore.padStart(2,'0')+'</span> '+(t.toStoreName||'')+'</td><td><span class="store-tag bumon">'+(t.bumonCode||'-')+'</span></td><td class="col-cost negative">'+fmt(t.cost)+'</td><td class="col-price negative">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="3" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost negative"><strong>'+fmt(totToC)+'</strong></td><td class="col-price negative"><strong>'+fmt(totToP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon bi">ğŸ”„</div><div class="section-info"><div class="section-name">éƒ¨é–€é–“å…¥åº«æ˜ç´°</div><div class="section-meta">åŒä¸€åº—èˆ—å†…éƒ¨é–€é–“ç§»å‹•ï¼ˆå…¥ï¼‰ '+td.bumonIn.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totBiC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>ç§»å‹•å…ƒ</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.bumonIn.length===0)h+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px;">éƒ¨é–€é–“å…¥åº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.bumonIn.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="flow-self">åŒä¸€åº—èˆ—å†…ç§»å‹•</span></td><td class="col-cost positive">'+fmt(t.cost)+'</td><td class="col-price positive">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="2" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost positive"><strong>'+fmt(totBiC)+'</strong></td><td class="col-price positive"><strong>'+fmt(totBiP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon bo">ğŸ”€</div><div class="section-info"><div class="section-name">éƒ¨é–€é–“å‡ºåº«æ˜ç´°</div><div class="section-meta">åŒä¸€åº—èˆ—å†…éƒ¨é–€é–“ç§»å‹•ï¼ˆå‡ºï¼‰ '+td.bumonOut.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totBoC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>ç§»å‹•å…ˆéƒ¨é–€</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.bumonOut.length===0)h+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px;">éƒ¨é–€é–“å‡ºåº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.bumonOut.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="store-tag bumon">'+(t.bumonCode||'éƒ¨é–€')+'</span></td><td class="col-cost negative">'+fmt(t.cost)+'</td><td class="col-price negative">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="2" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost negative"><strong>'+fmt(totBoC)+'</strong></td><td class="col-price negative"><strong>'+fmt(totBoP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon daily">ğŸ“…</div><div class="section-info"><div class="section-name">æ—¥åˆ¥ã‚µãƒãƒªãƒ¼</div><div class="section-meta">åº—é–“ãƒ»éƒ¨é–€é–“ã®æ—¥åˆ¥æ¨ç§»</div></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th class="col-cost">åº—é–“å…¥</th><th>å…¥å…ƒ</th><th class="col-cost">åº—é–“å‡º</th><th>å‡ºå…ˆ</th><th class="col-cost">éƒ¨é–€å…¥</th><th class="col-cost">éƒ¨é–€å‡º</th><th>éƒ¨é–€</th><th>å·®å¼•</th></tr></thead><tbody>';
Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{const hasTi=d.tenkanInTotal.cost||d.tenkanInTotal.price,hasTo=d.tenkanOutTotal.cost||d.tenkanOutTotal.price,hasBi=d.bumonInTotal.cost||d.bumonInTotal.price,hasBo=d.bumonOutTotal.cost||d.bumonOutTotal.price;if(!hasTi&&!hasTo&&!hasBi&&!hasBo)return;const tiS=d.tenkanIn.map(t=>'<span class="store-tag from">'+t.fromStore.padStart(2,'0')+'</span>').join(' ');const toS=d.tenkanOut.map(t=>'<span class="store-tag to">'+t.toStore.padStart(2,'0')+'</span>').join(' ');const buS=d.bumonOut.map(t=>'<span class="store-tag bumon">'+(t.bumonCode||'?')+'</span>').join(' ');const net=d.tenkanInTotal.cost+d.tenkanOutTotal.cost+d.bumonInTotal.cost+d.bumonOutTotal.cost;h+='<tr><td><strong>'+day+'æ—¥</strong></td><td class="col-cost '+(d.tenkanInTotal.cost>0?'positive':'')+'">'+(hasTi?fmt(d.tenkanInTotal.cost):'')+'</td><td style="text-align:left">'+(tiS||'')+'</td><td class="col-cost '+(d.tenkanOutTotal.cost<0?'negative':'')+'">'+(hasTo?fmt(d.tenkanOutTotal.cost):'')+'</td><td style="text-align:left">'+(toS||'')+'</td><td class="col-cost '+(d.bumonInTotal.cost>0?'positive':'')+'">'+(hasBi?fmt(d.bumonInTotal.cost):'')+'</td><td class="col-cost '+(d.bumonOutTotal.cost<0?'negative':'')+'">'+(hasBo?fmt(d.bumonOutTotal.cost):'')+'</td><td style="text-align:left">'+(buS||'')+'</td><td class="'+(net<0?'negative':net>0?'positive':'')+'">'+fmt(net)+'</td></tr>';});
const netTotal=totTiC+totToC+totBiC+totBoC;h+='<tr class="row-total"><td><strong>åˆè¨ˆ</strong></td><td class="col-cost positive"><strong>'+fmt(totTiC)+'</strong></td><td></td><td class="col-cost negative"><strong>'+fmt(totToC)+'</strong></td><td></td><td class="col-cost positive"><strong>'+fmt(totBiC)+'</strong></td><td class="col-cost negative"><strong>'+fmt(totBoC)+'</strong></td><td></td><td class="'+(netTotal<0?'negative':'positive')+'"><strong>'+fmt(netTotal)+'</strong></td></tr>';
h+='</tbody></table></div></div>';document.getElementById('content').innerHTML=h;}

function renderSupplier(){const data=result[currentStore];if(!data)return;const sups=Object.entries(data.supTotals).sort((a,b)=>b[1].cost-a[1].cost),tc=sups.reduce((s,[,sup])=>s+sup.cost,0);let h='<div class="section expanded"><div class="section-header"><div class="section-icon other">ğŸ“‹</div><div class="section-info"><div class="section-name">ä»•å…¥å…ˆåˆ¥æ˜ç´°</div><div class="section-meta">'+sups.length+'ç¤¾</div></div></div><div class="section-body"><table><thead><tr><th>ã‚³ãƒ¼ãƒ‰</th><th>ä»•å…¥å…ˆå</th><th>å¸³åˆ</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th><th>æ§‹æˆæ¯”</th></tr></thead><tbody>';sups.forEach(([code,sup])=>{const cat=SUPPLIERS[code]?.cat||'other',ci=CATEGORIES[cat]||{name:'ãã®ä»–'},mr=sup.price>0?(sup.price-sup.cost)/sup.price:0,sh=tc>0?sup.cost/tc:0;h+='<tr><td style="font-family:\'JetBrains Mono\',monospace;font-size:0.65rem;color:var(--text3)">'+code+'</td><td>'+sup.name+'</td><td style="color:var(--text3)">'+ci.name+'</td><td class="col-cost">'+fmt(sup.cost)+'</td><td class="col-price">'+fmt(sup.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td><td>'+fmtPct(sh)+'</td></tr>';});h+='</tbody></table></div></div>';document.getElementById('content').innerHTML=h;}

function renderDaily(){const data=result[currentStore];if(!data)return;let h='<div class="section expanded"><div class="section-header"><div class="section-icon daily">ğŸ“…</div><div class="section-info"><div class="section-name">æ—¥åˆ¥æ¨ç§»</div></div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>å£²ä¸Š</th><th style="color:#ef4444">å£²å¤‰é¡</th><th style="color:#dc2626">å€¤å¼•ç‡(åŸä¾¡)</th><th class="col-cost">ä»•å…¥åŸä¾¡</th><th>åº—é–“å…¥</th><th>åº—é–“å‡º</th><th style="color:#f472b6">èŠ±</th><th style="color:#a3e635">ç”£ç›´</th><th style="color:#f97316">åŸä¾¡ç®—å…¥æ¯”</th><th>ç´¯è¨ˆå£²ä¸Š</th><th>ç´¯è¨ˆä»•å…¥</th></tr></thead><tbody>';let cs=0,cc=0;Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{cs+=d.sales;cc+=d.shiire.cost+d.tenkanInTotal.cost+d.tenkanOutTotal.cost+(d.hana?.cost||0)+(d.sanchoku?.cost||0)+(d.consumable?.cost||0);
// æ—¥åˆ¥ã®åŸä¾¡å€¤å¼•ç‡è¨ˆç®—
const dayCoreMargin=data.coreMarginRate||0.26;
const dayCoreSales=d.coreSales||d.sales;
const dayCoreCost=dayCoreSales*(1-dayCoreMargin);
const dayBaihenCost=dayCoreCost>0?(d.baihen||0)/dayCoreCost:0;
h+='<tr><td>'+day+'æ—¥</td><td>'+fmt(d.sales)+'</td><td style="color:#ef4444">'+(d.baihen?fmt(d.baihen):'')+'</td><td style="color:#dc2626;font-weight:600">'+(d.baihen?fmtPct(dayBaihenCost):'')+'</td><td class="col-cost">'+fmt(d.shiire.cost)+'</td><td>'+(d.tenkanInTotal.cost?fmt(d.tenkanInTotal.cost):'')+'</td><td class="'+(d.tenkanOutTotal.cost<0?'negative':'')+'">'+(d.tenkanOutTotal.cost?fmt(d.tenkanOutTotal.cost):'')+'</td><td style="color:#f472b6">'+(d.hana?.price?fmt(d.hana.price):'')+'</td><td style="color:#a3e635">'+(d.sanchoku?.price?fmt(d.sanchoku.price):'')+'</td><td style="color:#f97316">'+(d.consumable?.cost?fmt(d.consumable.cost):'')+'</td><td class="highlight">'+fmt(cs)+'</td><td class="highlight">'+fmt(cc)+'</td></tr>';});h+='<tr class="row-total"><td>åˆè¨ˆ</td><td>'+fmt(data.totalSales)+'</td><td style="color:#ef4444">'+fmt(data.totalBaihen)+'</td><td style="color:#dc2626;font-weight:600">'+fmtPct(data.baihenRateCost)+'</td><td class="col-cost">'+fmt(data.coreCost+data.deliverySalesCost)+'</td><td colspan="6"></td><td class="highlight">'+fmt(data.totalCost)+'</td></tr>';h+='</tbody></table></div></div>';document.getElementById('content').innerHTML=h;}

function renderAnalysis(){
const data=result[currentStore];if(!data)return;
const progressPct=data.budgetAchievement*100;
const consumePct=data.budgetConsumptionRate*100;
const projPct=data.projectedAchievement*100;
const progressColor=progressPct>=100?'var(--success)':progressPct>=80?'var(--warning)':'var(--danger)';
const projColor=projPct>=100?'var(--success)':projPct>=90?'var(--warning)':'var(--danger)';
const beforeRate=(data.grossProfitRateBeforeConsumable||0)*100;
const afterRate=(data.grossProfitRate||0)*100;

let h='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">';
// KPIã‚«ãƒ¼ãƒ‰
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--primary)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ“Š äºˆç®—é”æˆç‡</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:'+progressColor+'">'+fmtPct(data.budgetAchievement)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(progressPct,100)+'%;background:'+progressColor+';border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">'+fmt(data.totalSales)+' / '+fmt(data.budget)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--info)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ“… äºˆç®—æ¶ˆåŒ–ç‡</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:var(--info)">'+fmtPct(data.budgetConsumptionRate)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(consumePct,100)+'%;background:var(--info);border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">çµŒé '+fmt(data.budgetConsumed)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--purple)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ¯ ç€åœ°äºˆæ¸¬</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:'+projColor+'">'+fmtPct(data.projectedAchievement)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(projPct,100)+'%;background:'+projColor+';border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">äºˆæ¸¬ '+fmt(data.projectedSales)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid #60a5fa"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ“ˆ è’åˆ©ç‡(ç¨æŠœå‰)</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:#60a5fa">'+fmtPct(data.grossProfitRateBeforeConsumable)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+beforeRate+'%;background:#60a5fa;border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">è’åˆ© '+fmt(data.grossProfitBeforeConsumable)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--success)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ’° è’åˆ©ç‡(ç¨æŠœå¾Œ)</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:var(--success)">'+fmtPct(data.grossProfitRate)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+afterRate+'%;background:var(--success);border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">è’åˆ© '+fmt(data.grossProfit)+'</div></div>';
h+='</div>';
h+='</div>';

// ã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ«
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
// å£²ä¸Šåˆ†æ
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px"><div style="font-size:0.75rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ’°</span>å£²ä¸Šåˆ†æ</div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">æœˆé–“äºˆç®—</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+fmt(data.budget)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">å£²ä¸Šå®Ÿç¸¾</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+fmt(data.totalSales)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">äºˆç®—æ®‹</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:'+(data.remainingBudget>0?'var(--warning)':'var(--success)')+'">'+fmt(data.remainingBudget)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.75rem"><span style="color:var(--text2)">æ—¥è²©å¹³å‡</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+fmt(data.avgDailySales)+'</span></div>';
h+='</div>';

// é€²æ—åˆ†æ
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px"><div style="font-size:0.75rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“ˆ</span>é€²æ—åˆ†æ</div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">å–¶æ¥­æ—¥æ•°</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+data.salesDays+'æ—¥</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">æœ€çµ‚æ—¥</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+data.elapsedDays+'æ—¥</span></div>';
const pace=data.budgetConsumptionRate>0?(data.budgetAchievement/data.budgetConsumptionRate):0;
const paceColor=pace>=1?'var(--success)':pace>=0.9?'var(--warning)':'var(--danger)';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ãƒšãƒ¼ã‚¹</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:'+paceColor+'">'+fmtPct(pace)+'</span></div>';
const needDaily=data.remainingBudget>0&&(31-data.elapsedDays)>0?data.remainingBudget/(31-data.elapsedDays):0;
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.75rem"><span style="color:var(--text2)">å¿…è¦æ—¥è²©</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--warning)">'+fmt(needDaily)+'</span></div>';
h+='</div>';

// åˆ©ç›Šåˆ†æ
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px"><div style="font-size:0.75rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“Š</span>åˆ©ç›Šåˆ†æ</div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ“‰ å£²å¤‰ç‡(å£²ä¾¡)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:#ef4444">'+fmtPct(data.baihenRateSales||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ“‰ å€¤å¼•ç‡(åŸä¾¡)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:600;color:#dc2626">'+fmtPct(data.baihenRateCost||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">å€¤å…¥ç‡(ã‚³ã‚¢)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--info)">'+fmtPct(data.coreMarginRate||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ¯ æ¨å®šç²—åˆ©ç‡</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:#8b5cf6">'+fmtPct(data.estimatedGrossRate||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ§¾ åŸä¾¡ç®—å…¥æ¯”</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:#f97316">'+fmt(data.totalConsumable||0)+' ('+fmtPct(data.consumableRate||0)+')</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">è’åˆ©ç‡(å®Ÿç¸¾)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--success)">'+fmtPct(data.grossProfitRate)+'</span></div>';
const lossRate=data.avgMargin-data.grossProfitRate;
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.75rem"><span style="color:var(--text2)">ãƒ­ã‚¹ç‡</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--danger)">'+fmtPct(lossRate)+'</span></div>';
h+='</div></div>';

// æ—¥åˆ¥äºˆç®—vså®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon daily">ğŸ“…</div><div class="section-info"><div class="section-name">æ—¥åˆ¥ äºˆç®— vs å®Ÿç¸¾</div><div class="section-meta">å£²ä¸Šæ¨ç§»ã¨äºˆç®—æ¶ˆåŒ–çŠ¶æ³</div></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>äºˆç®—</th><th>å®Ÿç¸¾</th><th>å·®ç•°</th><th>é”æˆç‡</th><th>ç´¯è¨ˆäºˆç®—</th><th>ç´¯è¨ˆå®Ÿç¸¾</th><th>ç´¯è¨ˆé”æˆ</th><th>è’åˆ©</th></tr></thead><tbody>';
let cumBudget=0,cumSales=0,cumCost=0;
for(let day=1;day<=31;day++){
    const d=data.daily[day];
    const dayBudget=data.budgetDaily?.[day]||0;
    if(!d&&dayBudget===0)continue;
    const daySales=d?.sales||0;
    const dayCost=(d?.shiire?.cost||0)+(d?.tenkanInTotal?.cost||0)+(d?.tenkanOutTotal?.cost||0)+(d?.bumonInTotal?.cost||0)+(d?.bumonOutTotal?.cost||0)+(d?.hana?.cost||0)+(d?.sanchoku?.cost||0)+(d?.consumable?.cost||0);
    cumBudget+=dayBudget;
    cumSales+=daySales;
    cumCost+=dayCost;
    const diff=daySales-dayBudget;
    const dayAch=dayBudget>0?daySales/dayBudget:0;
    const cumAch=cumBudget>0?cumSales/cumBudget:0;
    const dayProfit=daySales-dayCost;
    const achColor=dayAch>=1?'positive':dayAch>=0.9?'':'negative';
    const cumAchColor=cumAch>=1?'positive':cumAch>=0.9?'':'negative';
    h+='<tr><td>'+day+'æ—¥</td><td>'+fmt(dayBudget)+'</td><td>'+fmt(daySales)+'</td><td class="'+(diff>=0?'positive':'negative')+'">'+fmt(diff)+'</td><td class="'+achColor+'">'+fmtPct(dayAch)+'</td><td style="color:var(--text3)">'+fmt(cumBudget)+'</td><td class="highlight">'+fmt(cumSales)+'</td><td class="'+cumAchColor+'">'+fmtPct(cumAch)+'</td><td class="'+(dayProfit>=0?'positive':'negative')+'">'+fmt(dayProfit)+'</td></tr>';
}
h+='<tr class="row-total"><td>åˆè¨ˆ</td><td>'+fmt(data.budget)+'</td><td>'+fmt(data.totalSales)+'</td><td class="'+(data.totalSales-data.budget>=0?'positive':'negative')+'">'+fmt(data.totalSales-data.budget)+'</td><td class="'+(data.budgetAchievement>=1?'positive':'negative')+'">'+fmtPct(data.budgetAchievement)+'</td><td></td><td></td><td></td><td class="positive">'+fmt(data.grossProfit)+'</td></tr>';
h+='</tbody></table></div></div>';
document.getElementById('content').innerHTML=h;
}

function renderSummary(){const data=result[currentStore];if(!data)return;const cogs=data.invStart+data.totalCost-data.invEnd;
let h='<div class="summary-grid">';

// å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹è’åˆ©è¨ˆç®—
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon">ğŸ“Š</div><div class="summary-panel-title">å®Ÿç¸¾è’åˆ©è¨ˆç®—</div></div><div class="summary-row"><span class="lt">æœŸé¦–åœ¨åº«</span><span class="value">'+fmt(data.invStart)+'</span></div><div class="summary-row"><span class="lt">ï¼‹ ç·ä»•å…¥</span><span class="value">'+fmt(data.totalCost)+'</span></div><div class="summary-row"><span class="lt">ï¼ æœŸæœ«åœ¨åº«</span><span class="value">'+fmt(data.invEnd)+'</span></div><div class="summary-row"><span class="lt">ï¼ å£²ä¸ŠåŸä¾¡</span><span class="value" style="color:var(--warning)">'+fmt(cogs)+'</span></div><div class="summary-total"><span>è’åˆ©ç›Š(å®Ÿç¸¾)</span><span class="value">'+fmt(data.grossProfit)+' ('+fmtPct(data.grossProfitRate)+')</span></div></div>';

// æ¨å®šè’åˆ©è¨ˆç®—ï¼ˆå€¤å¼•æå¤±ã®è©³ç´°ã‚’è¿½åŠ ï¼‰
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">ğŸ¯</div><div class="summary-panel-title">æ¨å®šè’åˆ©è¨ˆç®—</div></div>';
h+='<div class="summary-row"><span class="lt">ğŸ“‰ å£²å¤‰é¡åˆè¨ˆ</span><span class="value" style="color:#ef4444">'+fmt(data.totalBaihen)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ“‰ å£²å¤‰ç‡(å£²ä¾¡)</span><span class="value" style="color:#ef4444">'+fmtPct(data.baihenRateSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ“‰ å€¤å¼•ç‡(åŸä¾¡)</span><span class="value" style="color:#dc2626;font-weight:600">'+fmtPct(data.baihenRateCost)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ’¸ å€¤å¼•åŸä¾¡æå¤±</span><span class="value" style="color:#dc2626">'+fmt(data.baihenLossCost||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">å€¤å…¥ç‡(ã‚³ã‚¢)</span><span class="value" style="color:var(--info)">'+fmtPct(data.coreMarginRate)+'</span></div>';
h+='<div class="summary-row"><span class="lt">æ¨å®šç²—åˆ©ç‡(ã‚³ã‚¢)</span><span class="value" style="color:#8b5cf6">'+fmtPct(data.estimatedCoreGrossRate)+'</span></div>';
h+='<div style="font-size:0.55rem;color:var(--text4);padding:4px 0;border-bottom:1px solid var(--border)">(å€¤å…¥ç‡ - å£²å¤‰ç‡) / (1 - å£²å¤‰ç‡)</div>';
h+='<div class="summary-total"><span>æ¨å®šè’åˆ©</span><span class="value" style="color:#8b5cf6">'+fmt(data.estimatedGrossProfit)+' ('+fmtPct(data.estimatedGrossRate)+')</span></div></div>';

// æ¨å®šåœ¨åº«ï¼ˆå€¤å¼•æå¤±ã®å½±éŸ¿ã‚’æ˜ç¤ºï¼‰
const estimatedCogs=data.estimatedCogs||data.totalSales-data.estimatedGrossProfit;
const invDiff=data.estimatedInvEnd-data.invEnd;
// ã‚°ãƒ­ã‚¹å£²ä¸Šï¼ˆã‚³ã‚¢ï¼‰= ãƒãƒƒãƒˆå£²ä¸Š / (1 - d)
const coreGrossSales=(1-data.baihenRateSales)>0?data.totalCoreSales/(1-data.baihenRateSales):data.totalCoreSales;
// å€¤å¼•ãªã—ã®ç†è«–åœ¨åº«ï¼ˆãƒãƒƒãƒˆå£²ä¸Šã«å€¤å…¥ç‡ã‚’é©ç”¨ï¼‰
const theoryCogs=data.totalCoreSales*(1-data.coreMarginRate)+(data.deliverySalesCost||0)+data.totalConsumable;
const theoryInvEnd=data.invStart+data.totalCost-theoryCogs;
const baihenImpact=theoryInvEnd-data.estimatedInvEnd; // å€¤å¼•ãŒåœ¨åº«ã«ä¸ãˆã‚‹å½±éŸ¿

h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸ“¦</div><div class="summary-panel-title">æ¨å®šåœ¨åº«è¨ˆç®—</div></div>';

// è¨ˆç®—å¼ã®èª¬æ˜
h+='<div style="font-size:0.55rem;color:var(--text4);padding:6px 8px;background:var(--bg4);border-radius:4px;margin-bottom:8px;line-height:1.5">';
h+='<div><strong>è¨ˆç®—å¼:</strong></div>';
h+='<div>â‘  ã‚°ãƒ­ã‚¹å£²ä¸Š = ãƒãƒƒãƒˆå£²ä¸Š Ã· (1-d)</div>';
h+='<div>â‘¡ æ¨å®šå£²ä¸ŠåŸä¾¡ = ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1-m)</div>';
h+='<div>â‘¢ æ¨å®šåœ¨åº« = æœŸé¦– + ä»•å…¥ - å£²ä¸ŠåŸä¾¡</div>';
h+='</div>';

h+='<div class="summary-row"><span class="lt">ã‚³ã‚¢ãƒãƒƒãƒˆå£²ä¸Š</span><span class="value">'+fmt(data.totalCoreSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">Ã· (1 - d) â†’ ã‚°ãƒ­ã‚¹å£²ä¸Š</span><span class="value" style="color:#f97316">'+fmt(coreGrossSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">Ã— (1 - m) â†’ ã‚³ã‚¢åŸä¾¡</span><span class="value" style="color:var(--warning)">'+fmt(coreGrossSales*(1-data.coreMarginRate))+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼‹ å£²ä¸Šç´å“åŸä¾¡</span><span class="value">'+fmt(data.deliverySalesCost||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼‹ æ¶ˆè€—å“</span><span class="value">'+fmt(data.totalConsumable||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼ æ¨å®šå£²ä¸ŠåŸä¾¡</span><span class="value" style="color:var(--warning);font-weight:600">'+fmt(estimatedCogs)+'</span></div>';

h+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">';
h+='<div class="summary-row"><span class="lt">æœŸé¦–åœ¨åº« (BI)</span><span class="value">'+fmt(data.invStart)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼‹ ç·ä»•å…¥ (P)</span><span class="value">'+fmt(data.totalCost)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼ æ¨å®šåŸä¾¡ (COGS)</span><span class="value" style="color:var(--warning)">'+fmt(estimatedCogs)+'</span></div>';
h+='<div class="summary-row" style="font-weight:700"><span class="lt">ï¼ æ¨å®šæœŸæœ«åœ¨åº«</span><span class="value" style="color:#06b6d4">'+fmt(data.estimatedInvEnd)+'</span></div>';
h+='</div>';

h+='<div style="margin-top:8px;padding:8px;background:var(--bg4);border-radius:6px;font-size:0.65rem">';
h+='<div style="display:flex;justify-content:space-between"><span style="color:var(--text3)">å€¤å¼•ãªã—ç†è«–åœ¨åº«</span><span style="font-family:\'JetBrains Mono\',monospace">'+fmt(theoryInvEnd)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:3px"><span style="color:#dc2626">ğŸ’¸ å€¤å¼•ã«ã‚ˆã‚‹åœ¨åº«æ¸›</span><span style="font-family:\'JetBrains Mono\',monospace;color:#dc2626">-'+fmt(baihenImpact)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:3px;padding-top:5px;border-top:1px solid var(--border)"><span style="color:var(--text3)">å®Ÿéš›æœŸæœ«åœ¨åº«</span><span style="font-family:\'JetBrains Mono\',monospace">'+fmt(data.invEnd)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:3px"><span style="color:var(--text3)">æ¨å®šã¨ã®å·®ç•°</span><span style="font-family:\'JetBrains Mono\',monospace;color:'+(invDiff>=0?'var(--success)':'var(--danger)')+'">'+fmt(invDiff)+'</span></div>';
h+='</div></div>';

// å£²ä¸Šæ§‹æˆ
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon">ğŸ’°</div><div class="summary-panel-title">å£²ä¸Šæ§‹æˆ</div></div>';
h+='<div class="summary-row"><span class="lt">ç·å£²ä¸Š</span><span class="value">'+fmt(data.totalSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸŒ¸ èŠ± å£²ä¸Š</span><span class="value" style="color:#f472b6">'+fmt(data.deliverySalesPrice-(data.catTotals.sanchoku?.price||0))+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ¥¬ ç”£ç›´ å£²ä¸Š</span><span class="value" style="color:#a3e635">'+fmt(data.catTotals.sanchoku?.price||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ã‚³ã‚¢å£²ä¸Š</span><span class="value">'+fmt(data.totalCoreSales)+'</span></div>';
h+='<div class="summary-total"><span>äºˆç®—é”æˆç‡</span><span class="value">'+fmtPct(data.totalSales/data.budget)+'</span></div></div>';

// å¸³åˆæ§‹æˆ
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon">ğŸ“¦</div><div class="summary-panel-title">å¸³åˆæ§‹æˆ</div></div>';getCatOrder().forEach(cat=>{const c=data.catTotals[cat];if(!c||c.cost===0)return;const sh=data.totalCost>0?c.cost/data.totalCost:0,info=CATEGORIES[cat]||{name:cat,icon:'ğŸ“‹'};h+='<div class="summary-row"><span class="lt">'+info.icon+' '+info.name+'</span><span class="value">'+fmtPct(sh)+'</span></div>';});h+='</div>';

h+='</div>';

// æ—¥åˆ¥åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•
if(data.dailyInvData&&data.dailyInvData.length>0){
    h+=renderInventoryChart(data);
}

document.getElementById('content').innerHTML=h;}

// æ—¥åˆ¥åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’æç”»
function renderInventoryChart(data){
    const invData=data.dailyInvData.filter(d=>d.hasData||d.day===1);
    if(invData.length===0)return '';
    
    // ãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹æœ€çµ‚æ—¥ã‚’å–å¾—
    let lastDataDay=1;
    data.dailyInvData.forEach(d=>{if(d.hasData)lastDataDay=d.day;});
    const chartData=data.dailyInvData.filter(d=>d.day<=lastDataDay);
    
    // æœ€å¤§ãƒ»æœ€å°å€¤ã‚’è¨ˆç®—
    const invValues=chartData.map(d=>d.inv);
    const maxInv=Math.max(data.invStart,...invValues)*1.1;
    const minInv=Math.min(data.invStart,...invValues)*0.9;
    const range=maxInv-minInv;
    
    const chartWidth=100;
    const chartHeight=180;
    const padding={top:20,right:15,bottom:30,left:10};
    const graphWidth=chartWidth-padding.left-padding.right;
    const graphHeight=chartHeight-padding.top-padding.bottom;
    
    // SVGãƒ‘ã‚¹ã‚’ç”Ÿæˆ
    let pathD='';
    let areaD='';
    const points=[];
    
    chartData.forEach((d,i)=>{
        const x=padding.left+(i/(chartData.length-1||1))*graphWidth;
        const y=padding.top+graphHeight-(d.inv-minInv)/range*graphHeight;
        points.push({x,y,day:d.day,inv:d.inv,hasData:d.hasData});
        if(i===0){
            pathD=`M ${x} ${y}`;
            areaD=`M ${x} ${padding.top+graphHeight} L ${x} ${y}`;
        }else{
            pathD+=` L ${x} ${y}`;
            areaD+=` L ${x} ${y}`;
        }
    });
    areaD+=` L ${padding.left+graphWidth} ${padding.top+graphHeight} Z`;
    
    // æœŸé¦–åœ¨åº«ãƒ©ã‚¤ãƒ³
    const startY=padding.top+graphHeight-(data.invStart-minInv)/range*graphHeight;
    // æœŸæœ«åœ¨åº«ãƒ©ã‚¤ãƒ³ï¼ˆå®Ÿç¸¾ï¼‰
    const endY=padding.top+graphHeight-(data.invEnd-minInv)/range*graphHeight;
    // æ¨å®šæœŸæœ«åœ¨åº«ãƒ©ã‚¤ãƒ³
    const estEndY=padding.top+graphHeight-(data.estimatedInvEnd-minInv)/range*graphHeight;
    
    let h='<div class="section expanded" style="margin-top:16px"><div class="section-header"><div class="section-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸ“ˆ</div><div class="section-info"><div class="section-name">æ—¥åˆ¥æ¨å®šåœ¨åº«æ¨ç§»</div><div class="section-meta">æœŸé¦–åœ¨åº«ã‹ã‚‰ã®å¤‰å‹•ï¼ˆå€¤å¼•æå¤±åæ˜ ï¼‰</div></div></div>';
    h+='<div class="section-body" style="padding:16px">';
    
    // SVGã‚°ãƒ©ãƒ•
    h+='<div style="position:relative;width:100%;height:'+chartHeight+'px;background:var(--bg3);border-radius:8px;overflow:hidden">';
    h+='<svg viewBox="0 0 '+chartWidth+' '+chartHeight+'" style="width:100%;height:100%" preserveAspectRatio="none">';
    
    // ã‚°ãƒªãƒƒãƒ‰ç·š
    for(let i=0;i<=4;i++){
        const y=padding.top+graphHeight*i/4;
        const val=maxInv-range*i/4;
        h+='<line x1="'+padding.left+'" y1="'+y+'" x2="'+(chartWidth-padding.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="0.3" stroke-dasharray="2,2"/>';
    }
    
    // æœŸé¦–åœ¨åº«åŸºæº–ç·š
    h+='<line x1="'+padding.left+'" y1="'+startY+'" x2="'+(chartWidth-padding.right)+'" y2="'+startY+'" stroke="#60a5fa" stroke-width="0.5" stroke-dasharray="3,2"/>';
    
    // å®Ÿç¸¾æœŸæœ«åœ¨åº«åŸºæº–ç·š
    h+='<line x1="'+padding.left+'" y1="'+endY+'" x2="'+(chartWidth-padding.right)+'" y2="'+endY+'" stroke="#22c55e" stroke-width="0.5" stroke-dasharray="3,2"/>';
    
    // ã‚¨ãƒªã‚¢å¡—ã‚Šã¤ã¶ã—
    h+='<path d="'+areaD+'" fill="url(#invGradient)" opacity="0.3"/>';
    
    // åœ¨åº«æ¨ç§»ãƒ©ã‚¤ãƒ³
    h+='<path d="'+pathD+'" fill="none" stroke="#06b6d4" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>';
    
    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
    h+='<defs><linearGradient id="invGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#06b6d4" stop-opacity="0.6"/><stop offset="100%" stop-color="#06b6d4" stop-opacity="0.05"/></linearGradient></defs>';
    
    // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ
    points.forEach(p=>{
        if(p.hasData){
            h+='<circle cx="'+p.x+'" cy="'+p.y+'" r="1.5" fill="#06b6d4" stroke="var(--bg2)" stroke-width="0.5"/>';
        }
    });
    
    h+='</svg>';
    
    // å‡¡ä¾‹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
    h+='<div style="position:absolute;top:8px;right:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:0.55rem">';
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px"><span style="width:12px;height:2px;background:#60a5fa;display:inline-block"></span><span style="color:var(--text3)">æœŸé¦– '+fmt(data.invStart)+'</span></div>';
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px"><span style="width:12px;height:2px;background:#06b6d4;display:inline-block"></span><span style="color:#06b6d4">æ¨å®š '+fmt(data.estimatedInvEnd)+'</span></div>';
    h+='<div style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#22c55e;display:inline-block"></span><span style="color:#22c55e">å®Ÿç¸¾ '+fmt(data.invEnd)+'</span></div>';
    h+='</div>';
    
    h+='</div>';
    
    // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
    h+='<div style="margin-top:12px;max-height:200px;overflow-y:auto"><table style="font-size:0.65rem"><thead><tr><th>æ—¥</th><th>æ¨å®šåœ¨åº«</th><th>ç´¯è¨ˆå£²ä¸Š</th><th>ç´¯è¨ˆä»•å…¥</th><th>ç´¯è¨ˆå€¤å¼•</th></tr></thead><tbody>';
    chartData.forEach(d=>{
        if(!d.hasData&&d.day!==1)return;
        const invColor=d.inv<data.invStart*0.7?'#ef4444':d.inv<data.invStart*0.85?'#f97316':'#06b6d4';
        h+='<tr><td>'+(d.day===1?'æœŸé¦–':d.day+'æ—¥')+'</td><td style="font-family:\'JetBrains Mono\',monospace;color:'+invColor+'">'+fmt(d.inv)+'</td><td>'+fmt(d.cumSales)+'</td><td>'+fmt(d.cumCost)+'</td><td style="color:#ef4444">'+(d.cumBaihen?fmt(d.cumBaihen):'-')+'</td></tr>';
    });
    h+='</tbody></table></div>';
    
    h+='</div></div>';
    return h;
}

// ===== ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
let currentReportType=null;
let currentReportData=null;

function renderReports(){
    const data=result[currentStore];if(!data)return;
    
    let h='<div style="margin-bottom:20px"><div style="font-size:1.1rem;font-weight:700;margin-bottom:8px">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›</div><div style="font-size:0.75rem;color:var(--text3)">å„ç¨®å¸³ç¥¨ã‚’ç”Ÿæˆãƒ»å‡ºåŠ›ã—ã¾ã™</div></div>';
    
    h+='<div class="report-grid">';
    
    // æ—¥å ±
    h+=`<div class="report-card" onclick="generateReport('daily')">
        <div class="report-card-icon" style="background:linear-gradient(135deg,#fbbf24,#f59e0b)">ğŸ“…</div>
        <div class="report-card-title">æ—¥å ±</div>
        <div class="report-card-desc">æ—¥åˆ¥ã®å£²ä¸Šãƒ»ä»•å…¥ãƒ»ç²—åˆ©ãƒ‡ãƒ¼ã‚¿</div>
    </div>`;
    
    // é€±å ±
    h+=`<div class="report-card" onclick="generateReport('weekly')">
        <div class="report-card-icon" style="background:linear-gradient(135deg,#6366f1,#4f46e5)">ğŸ“†</div>
        <div class="report-card-title">é€±å ±</div>
        <div class="report-card-desc">é€±é–“é›†è¨ˆï¼ˆæ°´æ›œã€œç«æ›œï¼‰ãƒ¬ãƒãƒ¼ãƒˆ</div>
    </div>`;
    
    // æœˆå ±
    h+=`<div class="report-card" onclick="generateReport('monthly')">
        <div class="report-card-icon" style="background:linear-gradient(135deg,#22c55e,#16a34a)">ğŸ“Š</div>
        <div class="report-card-title">æœˆå ±</div>
        <div class="report-card-desc">æœˆé–“ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ</div>
    </div>`;
    
    // å¸³åˆåˆ¥
    h+=`<div class="report-card" onclick="generateReport('category')">
        <div class="report-card-icon" style="background:linear-gradient(135deg,#a78bfa,#8b5cf6)">ğŸ“¦</div>
        <div class="report-card-title">å¸³åˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</div>
        <div class="report-card-desc">å¸³åˆåˆ†é¡åˆ¥ã®ä»•å…¥é›†è¨ˆ</div>
    </div>`;
    
    // ä»•å…¥å…ˆåˆ¥
    h+=`<div class="report-card" onclick="generateReport('supplier')">
        <div class="report-card-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸ­</div>
        <div class="report-card-title">ä»•å…¥å…ˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</div>
        <div class="report-card-desc">å–å¼•å…ˆåˆ¥ã®è©³ç´°é›†è¨ˆ</div>
    </div>`;
    
    // åœ¨åº«æ¨ç§»
    h+=`<div class="report-card" onclick="generateReport('inventory')">
        <div class="report-card-icon" style="background:linear-gradient(135deg,#ec4899,#be185d)">ğŸ“ˆ</div>
        <div class="report-card-title">åœ¨åº«æ¨ç§»ãƒ¬ãƒãƒ¼ãƒˆ</div>
        <div class="report-card-desc">æ—¥åˆ¥æ¨å®šåœ¨åº«ã®å¤‰å‹•</div>
    </div>`;
    
    h+='</div>';
    
    // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    h+='<div style="margin-top:24px;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:10px">';
    h+='<div style="font-size:0.85rem;font-weight:600;margin-bottom:12px">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>';
    h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
    h+='<button onclick="exportAllReports()" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.75rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ“¥ å…¨ãƒ¬ãƒãƒ¼ãƒˆExcelå‡ºåŠ›</button>';
    h+='<button onclick="window.print()" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.75rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ–¨ï¸ ç¾åœ¨ã®ç”»é¢ã‚’å°åˆ·</button>';
    h+='<button onclick="showColumnConfig()" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.75rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ“Š è¡¨ç¤ºåˆ—è¨­å®š</button>';
    h+='</div></div>';
    
    document.getElementById('content').innerHTML=h;
}

function generateReport(type){
    currentReportType=type;
    const data=result[currentStore];if(!data)return;
    
    const titles={
        daily:{title:'æ—¥å ±',icon:'ğŸ“…',bg:'linear-gradient(135deg,#fbbf24,#f59e0b)'},
        weekly:{title:'é€±å ±',icon:'ğŸ“†',bg:'linear-gradient(135deg,#6366f1,#4f46e5)'},
        monthly:{title:'æœˆå ±',icon:'ğŸ“Š',bg:'linear-gradient(135deg,#22c55e,#16a34a)'},
        category:{title:'å¸³åˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ',icon:'ğŸ“¦',bg:'linear-gradient(135deg,#a78bfa,#8b5cf6)'},
        supplier:{title:'ä»•å…¥å…ˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ',icon:'ğŸ­',bg:'linear-gradient(135deg,#06b6d4,#0891b2)'},
        inventory:{title:'åœ¨åº«æ¨ç§»ãƒ¬ãƒãƒ¼ãƒˆ',icon:'ğŸ“ˆ',bg:'linear-gradient(135deg,#ec4899,#be185d)'}
    };
    
    const info=titles[type]||{title:type,icon:'ğŸ“‹',bg:'linear-gradient(135deg,#6366f1,#4f46e5)'};
    
    document.getElementById('report-preview-icon').style.background=info.bg;
    document.getElementById('report-preview-icon').textContent=info.icon;
    document.getElementById('report-preview-title').textContent=info.title;
    document.getElementById('report-preview-sub').textContent=STORES[currentStore]?.name||'å…¨åº—èˆ—';
    
    let content='';
    
    switch(type){
        case'daily':content=generateDailyReport(data);break;
        case'weekly':content=generateWeeklyReport(data);break;
        case'monthly':content=generateMonthlyReport(data);break;
        case'category':content=generateCategoryReport(data);break;
        case'supplier':content=generateSupplierReport(data);break;
        case'inventory':content=generateInventoryReport(data);break;
    }
    
    document.getElementById('report-preview-content').innerHTML=content;
    document.getElementById('report-preview-modal').style.display='flex';
}

function generateDailyReport(data){
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">æ—¥ä»˜</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¸Š</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ä»•å…¥åŸä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å¼•é¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ç´¯è¨ˆå£²ä¸Š</th></tr></thead><tbody>';
    
    let cumSales=0;
    Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{
        cumSales+=d.sales;
        h+=`<tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px">${day}æ—¥</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(d.sales)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(d.shiire?.cost||0)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--danger)">${d.baihen?'Â¥'+fmt(d.baihen):'-'}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;font-weight:600">Â¥${fmt(cumSales)}</td>
        </tr>`;
    });
    
    h+='<tr style="background:var(--bg3);font-weight:600"><td style="padding:10px">åˆè¨ˆ</td><td style="padding:10px;text-align:right">Â¥'+fmt(data.totalSales)+'</td><td style="padding:10px;text-align:right">Â¥'+fmt(data.totalCost)+'</td><td style="padding:10px;text-align:right;color:var(--danger)">Â¥'+fmt(data.totalBaihen)+'</td><td></td></tr>';
    h+='</tbody></table>';
    return h;
}

function generateWeeklyReport(data){
    // é€±åˆ¥ã«é›†è¨ˆ
    const weeks={};
    const weekStartDay=3; // Wednesday
    
    Object.entries(data.daily).forEach(([day,d])=>{
        const dayNum=parseInt(day);
        const weekNum=Math.floor((dayNum+3)/7); // ç°¡æ˜“çš„ãªé€±ç•ªå·è¨ˆç®—
        if(!weeks[weekNum])weeks[weekNum]={sales:0,cost:0,baihen:0,days:[]};
        weeks[weekNum].sales+=d.sales;
        weeks[weekNum].cost+=d.shiire?.cost||0;
        weeks[weekNum].baihen+=d.baihen||0;
        weeks[weekNum].days.push(dayNum);
    });
    
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">é€±</th><th style="padding:10px;text-align:center;border-bottom:2px solid var(--border)">æœŸé–“</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¸Š</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ä»•å…¥</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å¼•</th></tr></thead><tbody>';
    
    Object.entries(weeks).sort((a,b)=>+a[0]-+b[0]).forEach(([weekNum,w])=>{
        const minDay=Math.min(...w.days);
        const maxDay=Math.max(...w.days);
        h+=`<tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px">ç¬¬${parseInt(weekNum)+1}é€±</td>
            <td style="padding:8px;text-align:center">${minDay}æ—¥ã€œ${maxDay}æ—¥</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(w.sales)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(w.cost)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--danger)">Â¥${fmt(w.baihen)}</td>
        </tr>`;
    });
    
    h+='</tbody></table>';
    return h;
}

function generateMonthlyReport(data){
    let h='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px">';
    
    // KPIã‚µãƒãƒªãƒ¼
    h+=`<div style="background:var(--bg3);padding:16px;border-radius:8px">
        <div style="font-size:0.65rem;color:var(--text4);margin-bottom:4px">å£²ä¸Šé«˜</div>
        <div style="font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace">Â¥${fmt(data.totalSales)}</div>
    </div>`;
    h+=`<div style="background:var(--bg3);padding:16px;border-radius:8px">
        <div style="font-size:0.65rem;color:var(--text4);margin-bottom:4px">è’åˆ©ç›Š</div>
        <div style="font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--success)">Â¥${fmt(data.grossProfit)}</div>
    </div>`;
    h+=`<div style="background:var(--bg3);padding:16px;border-radius:8px">
        <div style="font-size:0.65rem;color:var(--text4);margin-bottom:4px">è’åˆ©ç‡</div>
        <div style="font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--primary)">${fmtPct(data.grossProfitRate)}</div>
    </div>`;
    h+=`<div style="background:var(--bg3);padding:16px;border-radius:8px">
        <div style="font-size:0.65rem;color:var(--text4);margin-bottom:4px">å€¤å…¥ç‡</div>
        <div style="font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--info)">${fmtPct(data.avgMargin)}</div>
    </div>`;
    
    h+='</div>';
    
    // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
    h+='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<tbody>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">æœŸé¦–åœ¨åº«</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.invStart)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">ç·ä»•å…¥é«˜</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.totalCost)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">æœŸæœ«åœ¨åº«</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.invEnd)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å£²ä¸ŠåŸä¾¡</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace;color:var(--warning)">Â¥'+fmt(data.invStart+data.totalCost-data.invEnd)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å€¤å¼•é¡åˆè¨ˆ</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace;color:var(--danger)">Â¥'+fmt(data.totalBaihen)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å£²å¤‰ç‡</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace;color:var(--danger)">'+fmtPct(data.baihenRateSales)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å–¶æ¥­æ—¥æ•°</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">'+data.salesDays+'æ—¥</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">æ—¥å¹³å‡å£²ä¸Š</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.avgDailySales)+'</td></tr>';
    h+='</tbody></table>';
    
    return h;
}

function generateCategoryReport(data){
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">å¸³åˆ</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">åŸä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å…¥ç‡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">æ§‹æˆæ¯”</th></tr></thead><tbody>';
    
    getCatOrder().forEach(cat=>{
        const c=data.catTotals[cat];
        if(!c||c.cost===0)return;
        const mr=c.price>0?(c.price-c.cost)/c.price:0;
        const share=data.totalCost>0?c.cost/data.totalCost:0;
        const info=CATEGORIES[cat]||{name:cat,icon:'ğŸ“‹'};
        
        h+=`<tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px"><span style="margin-right:6px">${info.icon}</span>${info.name}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(c.cost)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(c.price)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--primary)">${fmtPct(mr)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">${fmtPct(share)}</td>
        </tr>`;
    });
    
    h+='</tbody></table>';
    return h;
}

function generateSupplierReport(data){
    const suppliers=Object.entries(data.supTotals).sort((a,b)=>b[1].cost-a[1].cost);
    
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">ä»•å…¥å…ˆ</th><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">å¸³åˆ</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">åŸä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å…¥ç‡</th></tr></thead><tbody>';
    
    suppliers.forEach(([code,sup])=>{
        const cat=SUPPLIERS[code]?.cat||'other';
        const catInfo=CATEGORIES[cat]||{name:'ãã®ä»–',icon:'ğŸ“‹'};
        const mr=sup.price>0?(sup.price-sup.cost)/sup.price:0;
        
        h+=`<tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px"><span style="font-size:0.6rem;color:var(--text4);margin-right:6px">${code}</span>${sup.name}</td>
            <td style="padding:8px">${catInfo.icon} ${catInfo.name}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(sup.cost)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(sup.price)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--primary)">${fmtPct(mr)}</td>
        </tr>`;
    });
    
    h+='</tbody></table>';
    return h;
}

function generateInventoryReport(data){
    // æ—¥åˆ¥æ¨å®šåœ¨åº«ã‚’è¨ˆç®—
    const invData=[];
    let runningInv=data.invStart;
    const avgMargin=data.avgMargin||0.26;
    const baihenRate=data.baihenRateSales||0;
    
    for(let day=1;day<=31;day++){
        const d=data.daily[day];
        if(d){
            const daySales=d.sales||0;
            const dayCost=d.shiire?.cost||0;
            const dayGrossSales=(1-baihenRate)>0?daySales/(1-baihenRate):daySales;
            const dayEstCogs=dayGrossSales*(1-avgMargin);
            runningInv=runningInv+dayCost-dayEstCogs;
            invData.push({day,inv:runningInv,sales:daySales,cost:dayCost});
        }
    }
    
    let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
    h+=`<div style="background:var(--bg3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:0.6rem;color:var(--text4)">æœŸé¦–åœ¨åº«</div><div style="font-size:1.1rem;font-weight:600;font-family:'JetBrains Mono',monospace">Â¥${fmt(data.invStart)}</div></div>`;
    h+=`<div style="background:var(--bg3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:0.6rem;color:var(--text4)">æ¨å®šæœŸæœ«åœ¨åº«</div><div style="font-size:1.1rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:#06b6d4">Â¥${fmt(data.estimatedInvEnd)}</div></div>`;
    h+=`<div style="background:var(--bg3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:0.6rem;color:var(--text4)">å®Ÿç¸¾æœŸæœ«åœ¨åº«</div><div style="font-size:1.1rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--success)">Â¥${fmt(data.invEnd)}</div></div>`;
    h+='</div>';
    
    h+='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">æ—¥</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">æ¨å®šåœ¨åº«</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¸Š</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ä»•å…¥</th></tr></thead><tbody>';
    
    invData.forEach(d=>{
        const invColor=d.inv<data.invStart*0.7?'var(--danger)':d.inv<data.invStart*0.85?'var(--warning)':'#06b6d4';
        h+=`<tr style="border-bottom:1px solid var(--border)">
            <td style="padding:8px">${d.day}æ—¥</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:${invColor};font-weight:600">Â¥${fmt(d.inv)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(d.sales)}</td>
            <td style="padding:8px;text-align:right;font-family:'JetBrains Mono',monospace">Â¥${fmt(d.cost)}</td>
        </tr>`;
    });
    
    h+='</tbody></table>';
    return h;
}

function closeReportPreview(){
    document.getElementById('report-preview-modal').style.display='none';
}

function printReport(){
    const content=document.getElementById('report-preview-content').innerHTML;
    const win=window.open('','','width=800,height=600');
    win.document.write('<html><head><title>ãƒ¬ãƒãƒ¼ãƒˆå°åˆ·</title><style>body{font-family:sans-serif;padding:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px;text-align:left}</style></head><body>'+content+'</body></html>');
    win.document.close();
    win.print();
}

function exportReportExcel(){
    if(!result||!currentReportType)return;
    const data=result[currentStore];
    const wb=XLSX.utils.book_new();
    
    let sheetData=[];
    switch(currentReportType){
        case'daily':
            sheetData=[['æ—¥','å£²ä¸Š','ä»•å…¥åŸä¾¡','å€¤å¼•é¡']];
            Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{
                sheetData.push([day+'æ—¥',d.sales,d.shiire?.cost||0,d.baihen||0]);
            });
            break;
        case'monthly':
            sheetData=[
                ['é …ç›®','å€¤'],
                ['å£²ä¸Šé«˜',data.totalSales],
                ['è’åˆ©ç›Š',data.grossProfit],
                ['è’åˆ©ç‡',data.grossProfitRate],
                ['æœŸé¦–åœ¨åº«',data.invStart],
                ['ç·ä»•å…¥é«˜',data.totalCost],
                ['æœŸæœ«åœ¨åº«',data.invEnd],
                ['å€¤å¼•é¡åˆè¨ˆ',data.totalBaihen]
            ];
            break;
        case'category':
            sheetData=[['å¸³åˆ','åŸä¾¡','å£²ä¾¡','å€¤å…¥ç‡','æ§‹æˆæ¯”']];
            getCatOrder().forEach(cat=>{
                const c=data.catTotals[cat];
                if(!c||c.cost===0)return;
                const mr=c.price>0?(c.price-c.cost)/c.price:0;
                const share=data.totalCost>0?c.cost/data.totalCost:0;
                sheetData.push([CATEGORIES[cat]?.name||cat,c.cost,c.price,mr,share]);
            });
            break;
        default:
            sheetData=[['ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿']];
    }
    
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sheetData),currentReportType);
    XLSX.writeFile(wb,'report_'+currentReportType+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showToast('ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
}

function exportAllReports(){
    if(!result)return;
    const data=result[currentStore];
    const wb=XLSX.utils.book_new();
    
    // æ—¥å ±
    let daily=[['æ—¥','å£²ä¸Š','ä»•å…¥åŸä¾¡','å€¤å¼•é¡']];
    Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{
        daily.push([day+'æ—¥',d.sales,d.shiire?.cost||0,d.baihen||0]);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(daily),'æ—¥å ±');
    
    // æœˆå ±
    let monthly=[
        ['é …ç›®','å€¤'],
        ['å£²ä¸Šé«˜',data.totalSales],
        ['è’åˆ©ç›Š',data.grossProfit],
        ['è’åˆ©ç‡',data.grossProfitRate],
        ['æœŸé¦–åœ¨åº«',data.invStart],
        ['ç·ä»•å…¥é«˜',data.totalCost],
        ['æœŸæœ«åœ¨åº«',data.invEnd]
    ];
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(monthly),'æœˆå ±');
    
    // å¸³åˆåˆ¥
    let category=[['å¸³åˆ','åŸä¾¡','å£²ä¾¡','å€¤å…¥ç‡']];
    getCatOrder().forEach(cat=>{
        const c=data.catTotals[cat];
        if(!c||c.cost===0)return;
        const mr=c.price>0?(c.price-c.cost)/c.price:0;
        category.push([CATEGORIES[cat]?.name||cat,c.cost,c.price,mr]);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(category),'å¸³åˆåˆ¥');
    
    XLSX.writeFile(wb,'å…¨ãƒ¬ãƒãƒ¼ãƒˆ_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showToast('å…¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
}

// ===== ã‚«ãƒ©ãƒ è¨­å®š =====
let columnConfig={
    daily:[
        {id:'day',name:'æ—¥',visible:true},
        {id:'sales',name:'å£²ä¸Š',visible:true},
        {id:'baihen',name:'å€¤å¼•é¡',visible:true},
        {id:'baihenRate',name:'å€¤å¼•ç‡',visible:true},
        {id:'shiireCost',name:'ä»•å…¥åŸä¾¡',visible:true},
        {id:'tenkanIn',name:'åº—é–“å…¥',visible:true},
        {id:'tenkanOut',name:'åº—é–“å‡º',visible:true},
        {id:'hana',name:'èŠ±',visible:true},
        {id:'sanchoku',name:'ç”£ç›´',visible:true},
        {id:'consumable',name:'åŸä¾¡ç®—å…¥æ¯”',visible:true},
        {id:'cumSales',name:'ç´¯è¨ˆå£²ä¸Š',visible:true},
        {id:'cumCost',name:'ç´¯è¨ˆä»•å…¥',visible:true}
    ]
};

function showColumnConfig(){
    renderColumnConfig();
    document.getElementById('column-config-modal').style.display='flex';
}

function closeColumnConfig(){
    document.getElementById('column-config-modal').style.display='none';
}

function renderColumnConfig(){
    const container=document.getElementById('column-config-content');
    let h='<div class="column-config" id="column-config-list">';
    
    columnConfig.daily.forEach((col,i)=>{
        h+=`<div class="column-item" draggable="true" data-index="${i}">
            <div class="column-item-handle">â‰¡</div>
            <div class="column-item-name">${col.name}</div>
            <div class="column-item-toggle ${col.visible?'active':''}" onclick="toggleColumn(${i})"></div>
        </div>`;
    });
    
    h+='</div>';
    container.innerHTML=h;
    
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
    initColumnDragDrop();
}

function toggleColumn(index){
    columnConfig.daily[index].visible=!columnConfig.daily[index].visible;
    renderColumnConfig();
}

function initColumnDragDrop(){
    const list=document.getElementById('column-config-list');
    if(!list)return;
    
    let draggedItem=null;
    
    list.querySelectorAll('.column-item').forEach(item=>{
        item.addEventListener('dragstart',e=>{
            draggedItem=item;
            item.classList.add('dragging');
        });
        
        item.addEventListener('dragend',()=>{
            item.classList.remove('dragging');
            draggedItem=null;
        });
        
        item.addEventListener('dragover',e=>{
            e.preventDefault();
            if(!draggedItem||draggedItem===item)return;
            
            const rect=item.getBoundingClientRect();
            const midY=rect.top+rect.height/2;
            
            if(e.clientY<midY){
                list.insertBefore(draggedItem,item);
            }else{
                list.insertBefore(draggedItem,item.nextSibling);
            }
        });
    });
}

function applyColumnConfig(){
    // ç¾åœ¨ã®ä¸¦ã³é †ã‚’å–å¾—
    const newOrder=[];
    document.querySelectorAll('#column-config-list .column-item').forEach(item=>{
        const index=parseInt(item.dataset.index);
        newOrder.push(columnConfig.daily[index]);
    });
    columnConfig.daily=newOrder;
    
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    columnConfig.daily.forEach((col,i)=>col.index=i);
    
    saveSettingsToStorage();
    closeColumnConfig();
    showToast('ã‚«ãƒ©ãƒ è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ','success');
    if(result)render();
}

function exportExcel(){if(!result)return;const wb=XLSX.utils.book_new(),sids=Object.keys(STORES).sort((a,b)=>+a-+b);const allData=[['æ—¥']];getCatOrder().forEach(cat=>{sids.forEach(sid=>{if(!result[sid]?.catTotals[cat])return;allData[0].push((CATEGORIES[cat]?.name||cat)+'_'+sid.padStart(2,'0')+'_åŸä¾¡','_å£²ä¾¡');});});for(let day=1;day<=31;day++){const row=[day+'æ—¥'];getCatOrder().forEach(cat=>{sids.forEach(sid=>{if(!result[sid]?.catTotals[cat])return;const d=result[sid].daily[day];let c=0,p=0;if(d){if(cat==='tenkan'){c=d.tenkanInTotal.cost+d.tenkanOutTotal.cost;p=d.tenkanInTotal.price+d.tenkanOutTotal.price;}else if(cat==='bumonkan'){c=d.bumonInTotal.cost+d.bumonOutTotal.cost;p=d.bumonInTotal.price+d.bumonOutTotal.price;}else if(cat==='hana'){c=d.hana.cost;p=d.hana.price;}else if(cat==='sanchoku'){c=d.sanchoku.cost;p=d.sanchoku.price;}else Object.entries(d.suppliers).forEach(([code,sup])=>{if((SUPPLIERS[code]?.cat||'other')===cat){c+=sup.cost;p+=sup.price;}});}row.push(c||'',p||'');});});allData.push(row);}XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allData),'å–å¼•å…ˆåˆ¥');sids.forEach(sid=>{const d=result[sid];const ws=[['åº—èˆ—',STORES[sid].name],['æœŸé¦–åœ¨åº«',d.invStart],['ç·ä»•å…¥',d.totalCost],['æœŸæœ«åœ¨åº«',d.invEnd],['å£²ä¸ŠåŸä¾¡',d.invStart+d.totalCost-d.invEnd],['å£²ä¸Šå®Ÿç¸¾',d.totalSales],['è’åˆ©ç›Š',d.grossProfit],['è’åˆ©ç‡',d.grossProfitRate],['å€¤å…¥ç‡',d.avgMargin],[],['å¸³åˆ','åŸä¾¡','å£²ä¾¡','å€¤å…¥ç‡','æ§‹æˆæ¯”']];getCatOrder().forEach(cat=>{const c=d.catTotals[cat];if(!c)return;ws.push([CATEGORIES[cat]?.name||cat,c.cost,c.price,c.price>0?(c.price-c.cost)/c.price:0,d.totalCost>0?c.cost/d.totalCost:0]);});ws.push([],['=== åº—é–“ãƒ»éƒ¨é–€é–“ç§»å‹•è©³ç´° ==='],['æ—¥','ç¨®åˆ¥','ç§»å‹•å…ˆ/å…ƒ','éƒ¨é–€','åŸä¾¡','å£²ä¾¡']);d.transferDetails.tenkanIn.forEach(t=>{ws.push([t.day+'æ—¥','åº—é–“å…¥åº«',t.fromStore,'',t.cost,t.price]);});d.transferDetails.tenkanOut.forEach(t=>{ws.push([t.day+'æ—¥','åº—é–“å‡ºåº«',t.toStore,t.bumonCode||'',t.cost,t.price]);});d.transferDetails.bumonIn.forEach(t=>{ws.push([t.day+'æ—¥','éƒ¨é–€é–“å…¥åº«','','',t.cost,t.price]);});d.transferDetails.bumonOut.forEach(t=>{ws.push([t.day+'æ—¥','éƒ¨é–€é–“å‡ºåº«','',t.bumonCode||'',t.cost,t.price]);});XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ws),'åº—èˆ—'+sid.padStart(2,'0'));});XLSX.writeFile(wb,'ä»•å…¥ç²—åˆ©ç®¡ç†_'+new Date().toISOString().slice(0,10).replace(/-/g,'')+'.xlsx');showToast('Excelã‚’å‡ºåŠ›ã—ã¾ã—ãŸ','success');}
</script>
</body>
</html>
