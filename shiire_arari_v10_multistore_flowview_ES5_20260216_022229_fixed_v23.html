<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
// Apply saved theme ASAP (prevents flash)
(function(){
    try{
        const saved = localStorage.getItem('shiire_settings_v8');
        if(saved){
            const s = JSON.parse(saved);
            const theme = s?.theme || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        }
    }catch(e){}
})();
    </script>
    <title>ä»•å…¥è’åˆ©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v19</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#09090b;--bg2:#0f1117;--bg3:#16181f;--bg4:#1c1f28;--border:rgba(255,255,255,0.06);--primary:#6366f1;--success:#34d399;--warning:#fbbf24;--danger:#f87171;--info:#38bdf8;--purple:#a78bfa;--text:#f4f4f5;--text2:#a1a1aa;--text3:#71717a;--text4:#52525b;--r:10px;--t:0.2s}
        /* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ */
        [data-theme="light"]{--bg:#f8fafc;--bg2:#ffffff;--bg3:#f1f5f9;--bg4:#e2e8f0;--border:rgba(0,0,0,0.08);--text:#0f172a;--text2:#475569;--text3:#64748b;--text4:#94a3b8}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background 0.3s,color 0.3s}
        .app{display:grid;grid-template-columns:56px 260px 1fr;min-height:100vh;height:100vh;overflow:hidden}
        .nav{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:14px 0;gap:4px}
        .nav-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:20px}
        .nav-item{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text4);transition:all var(--t)}
        .nav-item:hover{background:var(--bg4);color:var(--text2)}
        .nav-item.active{background:rgba(99,102,241,0.15);color:var(--primary)}
        .nav-spacer{flex:1}
        .sidebar{background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
        .sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
        .sidebar-title{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text4);margin-bottom:2px}
        .sidebar-heading{font-size:0.9rem;font-weight:700}
        .sidebar-content{flex:1;overflow-y:auto;padding:14px}
        .sidebar-section{margin-bottom:16px}
        .section-label{font-size:0.6rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:8px}
        .upload-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
        .upload-card{background:var(--bg3);border:1.5px dashed rgba(255,255,255,0.08);border-radius:7px;padding:10px 4px 8px;text-align:center;cursor:pointer;transition:all var(--t);position:relative}
        .upload-card:hover{border-color:rgba(99,102,241,0.3);background:var(--bg4)}
        .upload-card.loaded{border-color:rgba(52,211,153,0.4);border-style:solid;background:rgba(52,211,153,0.08)}
        .upload-card.loaded::after{content:'âœ“';position:absolute;top:3px;right:5px;font-size:0.55rem;color:var(--success);font-weight:700}
        .upload-card .icon{font-size:1.1rem;margin-bottom:2px}
        .upload-card .name{font-size:0.6rem;font-weight:600;color:var(--text3)}
        .upload-card.loaded .name{color:var(--success)}
        .upload-card input{display:none}
        .chip-group{display:flex;flex-wrap:wrap;gap:4px}
        .chip{padding:5px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;font-size:0.65rem;font-weight:600;cursor:pointer;color:var(--text3);transition:all var(--t)}
        .chip:hover{border-color:rgba(99,102,241,0.3);color:var(--text2)}
        .chip.active{background:var(--primary);border-color:var(--primary);color:white}
        .input-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        .input-field{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 10px}
        .input-field label{display:block;font-size:0.52rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:2px}
        .input-field input{width:100%;background:transparent;border:none;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.78rem;text-align:right}
        .input-field input:focus{outline:none}
        .btn{width:100%;padding:10px 14px;border:none;border-radius:7px;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all var(--t)}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#4f46e5);color:white}
        .btn-primary:hover{transform:translateY(-1px)}
        .btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none}
        .btn-success{background:linear-gradient(135deg,#22c55e,#16a34a);color:white;margin-top:6px}
        .btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--text2)}
        .btn-outline:hover{border-color:rgba(99,102,241,0.3);background:var(--bg4)}
        .main{display:flex;flex-direction:column;overflow:hidden;min-height:0}
        .topbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
        .topbar-title{font-size:0.95rem;font-weight:700;display:flex;align-items:center;gap:8px}
        .topbar-badge{padding:2px 8px;background:var(--primary);border-radius:5px;font-size:0.6rem;font-weight:700}
        .topbar-tabs{display:flex;gap:3px;margin-left:auto;background:var(--bg3);border-radius:7px;padding:3px;border:1px solid var(--border)}
        .topbar-meta{margin-left:10px;display:flex;align-items:center;gap:8px}
        .meta-pill{display:inline-flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:0.72rem;color:var(--text2);white-space:nowrap}
        .meta-pill #meta-margin-rate{font-family:'JetBrains Mono',monospace;font-weight:700}

        .topbar-tab{padding:5px 12px;background:transparent;border:none;border-radius:5px;font-size:0.7rem;font-weight:600;cursor:pointer;color:var(--text3);font-family:inherit}
        .topbar-tab:hover{color:var(--text2);background:var(--bg4)}
        .topbar-tab.active{background:var(--primary);color:white}
        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px;padding:14px 20px;background:var(--bg2);border-bottom:1px solid var(--border)}
        .stat-card{background:var(--bg3);border-radius:var(--r);padding:12px 14px;border:1px solid var(--border);position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
        .stat-card:nth-child(1)::before{background:linear-gradient(90deg,var(--primary),#818cf8)}
        .stat-card:nth-child(2)::before{background:linear-gradient(90deg,var(--warning),#f59e0b)}
        .stat-card:nth-child(3)::before{background:linear-gradient(90deg,var(--success),#34d399)}
        .stat-card:nth-child(4)::before{background:linear-gradient(90deg,var(--info),#38bdf8)}
        .stat-card .label{font-size:0.58rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:4px}
        .stat-card .value{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:600}
        .stat-card .sub{font-size:0.6rem;color:var(--text3);margin-top:3px}
        .content{flex:1;overflow:auto;padding:16px 20px;min-height:0;padding-bottom:220px;scroll-padding-top:120px}
        .section{background:var(--bg2);border-radius:var(--r);border:1px solid var(--border);margin-bottom:12px;overflow:hidden}
        .section-header{padding:10px 14px;background:var(--bg3);border-bottom:1px solid transparent;display:flex;align-items:center;gap:10px;cursor:pointer}
        .section.expanded .section-header{border-bottom-color:var(--border)}
        .section-header:hover{background:var(--bg4)}
        .section-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.95rem}
        .section-icon.ti{background:linear-gradient(135deg,#4ade80,#22c55e)}
        .section-icon.to{background:linear-gradient(135deg,#fb7185,#f43f5e)}
        .section-icon.bi{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
        .section-icon.bo{background:linear-gradient(135deg,#c084fc,#a855f7)}
        .section-icon.daily{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
        .section-icon.market{background:linear-gradient(135deg,#fbbf24,#f59e0b)}
        .section-icon.lfc{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
        .section-icon.salad{background:linear-gradient(135deg,#4ade80,#22c55e)}
        .section-icon.kakou{background:linear-gradient(135deg,#c084fc,#a855f7)}
        .section-icon.chokuden{background:linear-gradient(135deg,#22d3ee,#06b6d4)}
        .section-icon.hana{background:linear-gradient(135deg,#f472b6,#ec4899)}
        .section-icon.sanchoku{background:linear-gradient(135deg,#a3e635,#84cc16)}
        .section-icon.consumable{background:linear-gradient(135deg,#f97316,#ea580c)}
        .section-icon.tenkan{background:linear-gradient(135deg,#fb7185,#f43f5e)}
        .section-icon.bumonkan{background:linear-gradient(135deg,#a78bfa,#8b5cf6)}
        .section-icon.other{background:linear-gradient(135deg,#94a3b8,#64748b)}
        .section-info{flex:1}
        .section-name{font-weight:600;font-size:0.82rem}
        .section-meta{font-size:0.62rem;color:var(--text3)}
        .section-stats{display:flex;gap:14px;font-family:'JetBrains Mono',monospace;font-size:0.7rem;font-weight:500}
        .section-stats .sl{color:var(--text4);font-size:0.55rem;font-family:'Noto Sans JP',sans-serif}
        .section-stats .cost{color:var(--warning)}
        .section-stats .price{color:var(--success)}
        .section-toggle{width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:var(--text4);transition:transform var(--t);font-size:0.65rem}
        .section.expanded .section-toggle{transform:rotate(180deg)}
        .section-body{max-height:0;overflow:hidden;transition:max-height 0.35s ease}
        .section.expanded .section-body{max-height:600px;overflow:auto}
        table{width:100%;border-collapse:collapse;font-size:0.68rem}
        th,td{padding:7px 10px;text-align:right;border-bottom:1px solid var(--border);white-space:nowrap}
        th{background:var(--bg3);color:var(--text4);font-weight:700;font-size:0.56rem;text-transform:uppercase;position:sticky;top:0;z-index:5}
        th:first-child,td:first-child{text-align:left;position:sticky;left:0;background:var(--bg2);z-index:3}
        th:first-child{z-index:10;background:var(--bg3)}
        tr:hover td{background:var(--bg4)}
        tr:hover td:first-child{background:var(--bg4)}
        .row-total{background:rgba(99,102,241,0.05)}
        .row-total td{font-weight:700;border-top:1px solid rgba(255,255,255,0.1)}
        td.positive{color:var(--success)}
        td.negative{color:var(--danger)}
        td.highlight{color:var(--info)}
        .col-cost{background:rgba(251,191,36,0.02)}
        .col-price{background:rgba(52,211,153,0.02)}
        .summary-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:14px;border-bottom:1px solid var(--border)}
        .summary-card{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:12px;position:relative;overflow:hidden}
        .summary-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
        .summary-card.ti::before{background:linear-gradient(90deg,#4ade80,#22c55e)}
        .summary-card.to::before{background:linear-gradient(90deg,#fb7185,#f43f5e)}
        .summary-card.bi::before{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
        .summary-card.bo::before{background:linear-gradient(90deg,#c084fc,#a855f7)}
        .summary-card .sc-label{font-size:0.58rem;font-weight:700;text-transform:uppercase;color:var(--text4);margin-bottom:4px}
        .summary-card .sc-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600}
        .summary-card .sc-sub{font-size:0.6rem;color:var(--text3);margin-top:2px}
        .store-tag{display:inline-flex;align-items:center;gap:2px;padding:2px 8px;border-radius:4px;font-size:0.62rem;font-weight:600;font-family:'JetBrains Mono',monospace;margin:1px}
        .store-tag.from{background:rgba(52,211,153,0.1);color:var(--success);border:1px solid rgba(52,211,153,0.2)}
        .store-tag.to{background:rgba(248,113,113,0.1);color:var(--danger);border:1px solid rgba(248,113,113,0.2)}
        .store-tag.bumon{background:rgba(167,139,250,0.1);color:var(--purple);border:1px solid rgba(167,139,250,0.2)}
        .flow-self{color:var(--purple);font-size:0.65rem;font-style:italic}
        .stores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
        .store-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px;cursor:pointer;transition:all var(--t)}
        .store-card:hover{border-color:rgba(99,102,241,0.3);transform:translateY(-3px)}
        .store-card-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
        .store-card-icon{width:38px;height:38px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem}
        .store-card-name{font-weight:700;font-size:0.88rem}
        .store-card-code{font-size:0.65rem;color:var(--text4);font-family:'JetBrains Mono',monospace}
        .store-card-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .store-card-stat .label{font-size:0.55rem;color:var(--text4);font-weight:600;text-transform:uppercase}
        .store-card-stat .value{font-family:'JetBrains Mono',monospace;font-size:0.82rem;font-weight:600;margin-top:1px}
        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px}
        .summary-panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px}
        .summary-panel-header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
        .summary-panel-icon{width:34px;height:34px;background:var(--bg3);border:1px solid var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center}
        .summary-panel-title{font-weight:700;font-size:0.82rem}
        .summary-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.78rem}
        .summary-row:last-child{border-bottom:none}
        .summary-row .lt{color:var(--text2)}
        .summary-row .value{font-family:'JetBrains Mono',monospace;font-weight:500}
        .summary-total{margin-top:10px;padding:10px 12px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.15);border-radius:7px;display:flex;justify-content:space-between;font-weight:700}
        .summary-total .value{color:var(--success);font-family:'JetBrains Mono',monospace}
        .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 40px;text-align:center}
        .empty-icon{width:72px;height:72px;border-radius:20px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:18px}
        .empty-state h3{font-size:1rem;font-weight:600;margin-bottom:6px;color:var(--text2)}
        .empty-state p{font-size:0.8rem;color:var(--text3);max-width:300px}
        .loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 40px}
        .spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast-container{position:fixed;bottom:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
        .toast{background:var(--bg3);border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:10px 16px;font-size:0.78rem;font-weight:500;display:flex;align-items:center;gap:8px;animation:toastIn 0.3s ease,toastOut 0.3s ease 2.7s forwards}
        @keyframes toastIn{from{opacity:0;transform:translateY(10px)}}
        @keyframes toastOut{to{opacity:0}}
        .toast.success{border-left:3px solid var(--success)}
        .toast.error{border-left:3px solid var(--danger)}
        .toast.info{border-left:3px solid var(--info)}
        .toast.warning{border-left:3px solid var(--warning)}
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        .drop-zone{border:2px dashed rgba(99,102,241,0.3);border-radius:10px;padding:16px;margin-bottom:10px;text-align:center;transition:all 0.3s;background:rgba(99,102,241,0.03)}
        .drop-zone.drag-over{border-color:var(--success);background:rgba(52,211,153,0.1);transform:scale(1.02)}
        .drop-zone-icon{font-size:1.8rem;margin-bottom:6px}
        .drop-zone-text{font-size:0.7rem;color:var(--text2);margin-bottom:2px}
        .drop-zone-hint{font-size:0.6rem;color:var(--text4)}
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        [data-tip]{position:relative;cursor:help}
        [data-tip]::after{content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);padding:6px 10px;background:var(--bg4);border:1px solid var(--border);border-radius:6px;font-size:0.6rem;font-weight:400;color:var(--text2);white-space:pre-line;max-width:220px;text-align:left;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:100;margin-bottom:5px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        [data-tip]:hover::after{opacity:1}
        /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
        .alert-card{padding:12px 14px;border-radius:8px;margin-bottom:10px;display:flex;align-items:flex-start;gap:10px}
        .alert-card.danger{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
        .alert-card.warning{background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3)}
        .alert-card.success{background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3)}
        .alert-card.info{background:rgba(56,189,248,0.1);border:1px solid rgba(56,189,248,0.3)}
        .alert-icon{font-size:1.1rem}
        .alert-content{flex:1}
        .alert-title{font-size:0.75rem;font-weight:600;margin-bottom:2px}
        .alert-desc{font-size:0.65rem;color:var(--text3)}
        /* KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
        .kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
        .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
        .kpi-card[data-color="primary"]::before{background:var(--primary)}
        .kpi-card[data-color="success"]::before{background:var(--success)}
        .kpi-card[data-color="warning"]::before{background:var(--warning)}
        .kpi-card[data-color="danger"]::before{background:var(--danger)}
        .kpi-card[data-color="info"]::before{background:var(--info)}
        .kpi-card[data-color="purple"]::before{background:var(--purple)}
        .kpi-card[data-color="cyan"]::before{background:#06b6d4}
        .kpi-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .kpi-label{font-size:0.6rem;font-weight:600;color:var(--text4);text-transform:uppercase}
        .kpi-icon{font-size:1rem}
        .kpi-value{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;margin-bottom:4px}
        .kpi-sub{font-size:0.62rem;color:var(--text3)}
        .kpi-progress{height:4px;background:var(--bg4);border-radius:2px;margin-top:10px;overflow:hidden}
        .kpi-progress-bar{height:100%;border-radius:2px;transition:width 0.5s ease}
        /* é€±é–“äºˆæ¸¬ã‚«ãƒ¼ãƒ‰ */
        .forecast-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:12px}
        .forecast-day{background:var(--bg3);border-radius:8px;padding:10px 6px;text-align:center;border:1px solid var(--border)}
        .forecast-day.today{border-color:var(--primary);background:rgba(99,102,241,0.1)}
        .forecast-day.past{opacity:0.6}
        .forecast-day-name{font-size:0.55rem;font-weight:600;color:var(--text4);margin-bottom:2px}
        .forecast-day-date{font-size:0.6rem;color:var(--text3);margin-bottom:6px}
        .forecast-day-value{font-family:'JetBrains Mono',monospace;font-size:0.75rem;font-weight:600}
        .forecast-day-target{font-size:0.5rem;color:var(--text4);margin-top:2px}

        /* v23 é€±é–“äºˆæ¸¬ï¼šæœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæœˆæ›œå§‹ã¾ã‚Šï¼‰ */
        .forecast-layout{display:grid;grid-template-columns:1fr 340px;gap:14px;align-items:start}
        @media (max-width:1100px){.forecast-layout{grid-template-columns:1fr}.forecast-side{order:2}}
        .month-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px}
        .month-weekday{text-align:center;font-size:0.6rem;font-weight:700;color:var(--text3);padding:6px 0;background:var(--bg3);border:1px solid var(--border);border-radius:8px}
        .month-calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
        .month-cell{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:10px 10px 8px 10px;min-height:98px;display:flex;flex-direction:column;gap:4px}
        .month-cell.out{opacity:0.35}
        .month-cell.today{border-color:var(--primary);box-shadow:0 0 0 2px rgba(99,102,241,0.12) inset}
        .mc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
        .mc-date{font-family:'JetBrains Mono',monospace;font-weight:800;font-size:0.9rem}
        .mc-badge{font-size:0.55rem;font-weight:800;color:var(--primary);background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);padding:2px 8px;border-radius:999px}
        .mc-row{display:flex;align-items:center;justify-content:space-between;font-size:0.62rem}
        .mc-k{color:var(--text4);font-weight:700}
        .mc-v{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text2)}
        .forecast-side{position:sticky;top:12px}
        @media (max-width:1100px){.forecast-side{position:static;top:auto}}
        .week-sum-list{display:flex;flex-direction:column;gap:10px}
        .week-sum{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px}
        .ws-head{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}
        .ws-title{font-weight:800;font-size:0.75rem}
        .ws-range{font-size:0.58rem;color:var(--text4)}
        .ws-body{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        .ws-row{display:flex;justify-content:space-between;gap:8px;font-size:0.62rem}
        .ws-row .k{color:var(--text4);font-weight:700}
        .ws-row .v{font-family:'JetBrains Mono',monospace;font-weight:800}
        .dow-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        .dow-card{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px}
        .dow-name{font-weight:900;font-size:0.75rem;margin-bottom:6px}
        .dow-row{display:flex;justify-content:space-between;gap:8px;font-size:0.62rem}
        .dow-row .k{color:var(--text4);font-weight:700}
        .dow-row .v{font-family:'JetBrains Mono',monospace;font-weight:800}
        /* ãƒ¬ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
        .report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
        .report-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:18px;cursor:pointer;transition:all 0.2s}
        .report-card:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
        .report-card-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;margin-bottom:12px}
        .report-card-title{font-weight:600;font-size:0.85rem;margin-bottom:4px}
        .report-card-desc{font-size:0.65rem;color:var(--text3)}
        /* ã‚«ãƒ©ãƒ è¨­å®š */
        .column-config{display:flex;flex-direction:column;gap:6px}
        .column-item{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg3);border-radius:6px;cursor:grab;user-select:none}
        .column-item:active{cursor:grabbing}
        .column-item.dragging{opacity:0.5;background:var(--bg4)}
        .column-item-handle{color:var(--text4);font-size:0.8rem}
        .column-item-name{flex:1;font-size:0.75rem}
        .column-item-toggle{width:36px;height:20px;background:var(--bg4);border-radius:10px;position:relative;cursor:pointer;transition:background 0.2s}
        .column-item-toggle.active{background:var(--primary)}
        .column-item-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:left 0.2s}
        .column-item-toggle.active::after{left:18px}
        /* ãƒ—ãƒªãƒ³ãƒˆç”¨ */
        @media print{.app{display:block}.nav,.sidebar{display:none}.main{width:100%}.topbar{display:none}.content{padding:0}.section{break-inside:avoid}}
        ::-webkit-scrollbar{width:5px;height:5px}
        ::-webkit-scrollbar-track{background:transparent}
        ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
    
        /* Dashboard top sticky summary */
        .dashboard-top{position:static;top:auto;z-index:1;background:var(--bg);padding:14px 0 12px 0;margin-bottom:12px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
        .dashboard-top .kpi-grid{margin-top:8px}
        .delta-badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;margin-left:8px;border:1px solid var(--border);background:rgba(255,255,255,0.04)}
        [data-theme="light"] .delta-badge{background:rgba(0,0,0,0.03)}
        .delta-badge.pos{color:var(--success);border-color:rgba(52,211,153,0.35);background:rgba(52,211,153,0.10)}
        .delta-badge.neg{color:var(--danger);border-color:rgba(248,113,113,0.35);background:rgba(248,113,113,0.10)}
        .kpi-sub .delta-line{margin-top:6px;font-size:12px;color:var(--text2)}
        .kpi-sub .delta-line strong{font-weight:800}

    
        .kpi-anomaly{display:flex;flex-direction:column;gap:4px;margin-top:6px;font-size:0.65rem;color:var(--text2)}
        .kpi-anomaly .item{display:flex;justify-content:space-between;gap:10px}
        .kpi-anomaly .day{font-weight:700;color:var(--text)}
        .kpi-anomaly .delta.pos{color:var(--success);font-weight:700}
        .kpi-anomaly .delta.neg{color:var(--danger);font-weight:700}
        .kpi-anomaly .note{color:var(--text3);font-size:0.6rem}

</style>

<style>

        /* Executive sticky bar (v10) - refined UI */
        .execbar{
            position:static;top:auto;z-index:1;
            background:rgba(255,255,255,0.92);
            border-bottom:1px solid var(--border);
            backdrop-filter:blur(10px);
            padding:12px 0 10px;
            margin:0 0 14px;
        }
        [data-theme="dark"] .execbar{
            background:rgba(15,17,23,0.88);
        }

        .execbar .execbar-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
        .execbar .execbar-title{display:flex;align-items:center;gap:10px}
        .execbar .execbar-badge{
            display:inline-flex;align-items:center;gap:8px;
            padding:6px 10px;border:1px solid var(--border);
            border-radius:999px;background:var(--bg2);
            font-weight:800;color:var(--text);
            box-shadow:0 1px 0 rgba(0,0,0,0.02);
        }
        .execbar .dot{width:8px;height:8px;border-radius:50%;background:var(--success);box-shadow:0 0 0 3px rgba(52,211,153,0.18)}
        .execbar .scope-chip{
            font-family:JetBrains Mono, ui-monospace, SFMono-Regular, Menlo, monospace;
            font-size:12px;padding:4px 8px;border-radius:999px;
            border:1px solid var(--border);background:var(--bg2);color:var(--text2)
        }

        .exec-sections{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
        .exec-section{
            border:1px solid var(--border);
            border-radius:14px;
            background:var(--bg2);
            padding:10px;
            box-shadow:0 1px 0 rgba(0,0,0,0.02);
        }
        .exec-section .sec-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
        .exec-section .sec-title{font-size:12px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text3);font-weight:900}
        .exec-section.plan{grid-column:span 4;border-top:3px solid rgba(99,102,241,0.55)}
        .exec-section.progress{grid-column:span 4;border-top:3px solid rgba(16,185,129,0.55)}
        .exec-section.forecast{grid-column:span 4;border-top:3px solid rgba(245,158,11,0.55)}
        .exec-section.insight{grid-column:span 12;border-top:3px solid rgba(239,68,68,0.45)}

        .exec-cards{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
        .exec-section.insight .exec-cards{grid-template-columns:repeat(4, minmax(0,1fr))}

        .exec-card{
            border:1px solid var(--border);
            border-radius:14px;
            background:var(--bg3);
            padding:10px;
            min-height:76px;
            display:flex;flex-direction:column;gap:6px
        }
        .exec-card .label{display:flex;align-items:center;justify-content:space-between;color:var(--text3);font-size:12px;font-weight:800}
        .exec-card .value{font-size:22px;font-weight:900;letter-spacing:-0.02em;color:var(--text)}
        .exec-card .sub{font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .exec-card .sub .muted{color:var(--text3)}
        .exec-card .sub .mono{font-family:JetBrains Mono, ui-monospace, SFMono-Regular, Menlo, monospace}

        .exec-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
        .bar{height:8px;border-radius:999px;background:rgba(0,0,0,0.06);overflow:hidden;border:1px solid var(--border)}
        [data-theme="dark"] .bar{background:rgba(255,255,255,0.06)}
        .bar > div{height:100%;background:var(--primary)}
        .bar .warn{background:var(--warning)}
        .bar .ok{background:var(--success)}
        .bar .bad{background:var(--danger)}

        .insight-summary{font-size:13px;color:var(--text2);line-height:1.35}
        .insight-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
        .insight-item{
            display:flex;align-items:center;justify-content:space-between;gap:10px;
            padding:8px 10px;border:1px solid var(--border);border-radius:12px;
            background:var(--bg3);cursor:pointer;
        }
        .insight-item:hover{border-color:rgba(99,102,241,0.35)}
        .insight-item .left{display:flex;flex-direction:column;gap:2px}
        .insight-item .day{font-weight:900;color:var(--text)}
        .insight-item .note{font-size:12px;color:var(--text3)}
        .insight-item .delta{font-family:JetBrains Mono, ui-monospace;font-weight:900}
        .insight-item .delta.pos{color:var(--success)}
        .insight-item .delta.neg{color:var(--danger)}


@media (max-width: 1100px){
          .exec-section.plan,.exec-section.progress,.exec-section.forecast{grid-column:span 12}
          .exec-section.insight .exec-cards{grid-template-columns:repeat(2, minmax(0,1fr))}
        }

/* === v9 Dashboard Redesign Additions === */
.v9-wrap{display:flex;flex-direction:column;gap:12px}
.v9-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 1100px){.v9-row{grid-template-columns:1fr}}
.v9-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;scroll-margin-top:120px}
.v9-card-h{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;background:var(--bg3);border-bottom:1px solid var(--border)}
.v9-card-title{font-weight:800;font-size:0.86rem;display:flex;align-items:center;gap:8px}
.v9-card-sub{font-size:0.62rem;color:var(--text3)}
.v9-card-b{padding:12px 14px}
.v9-focus{display:flex;gap:8px;flex-wrap:wrap}
.v9-pill{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:var(--bg3);font-size:0.72rem;color:var(--text2)}
.v9-pill b{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text)}
.v9-pill.danger{border-color:rgba(248,113,113,0.35);background:rgba(248,113,113,0.08)}
.v9-pill.warning{border-color:rgba(251,191,36,0.35);background:rgba(251,191,36,0.08)}
.v9-pill.success{border-color:rgba(52,211,153,0.35);background:rgba(52,211,153,0.08)}
.v9-pill.info{border-color:rgba(56,189,248,0.35);background:rgba(56,189,248,0.08)}
.v9-kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
@media (max-width: 1200px){.v9-kpis{grid-template-columns:repeat(3,1fr)}}
@media (max-width: 700px){.v9-kpis{grid-template-columns:repeat(2,1fr)}}
.v9-kpi{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;position:relative;overflow:hidden}
.v9-kpi::before{content:'';position:absolute;left:0;right:0;top:0;height:3px;background:linear-gradient(90deg,var(--primary),var(--purple))}
.v9-kpi[data-accent="success"]::before{background:linear-gradient(90deg,var(--success),#22c55e)}
.v9-kpi[data-accent="warning"]::before{background:linear-gradient(90deg,var(--warning),#f59e0b)}
.v9-kpi[data-accent="danger"]::before{background:linear-gradient(90deg,var(--danger),#ef4444)}
.v9-kpi[data-accent="info"]::before{background:linear-gradient(90deg,var(--info),#0ea5e9)}
.v9-kpi[data-accent="purple"]::before{background:linear-gradient(90deg,var(--purple),#8b5cf6)}
.v9-kpi-l{font-size:0.62rem;color:var(--text4);font-weight:800;text-transform:uppercase;letter-spacing:.08em}
.v9-kpi-v{margin-top:6px;font-family:'JetBrains Mono',monospace;font-size:1.25rem;font-weight:800}
.v9-kpi-s{margin-top:4px;font-size:0.65rem;color:var(--text3)}
.v9-tabs{display:flex;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:6px}
.v9-tab{flex:0 0 auto;padding:8px 10px;border-radius:8px;border:none;background:transparent;color:var(--text3);font-weight:800;font-size:0.72rem;cursor:pointer;font-family:inherit}
.v9-tab:hover{background:var(--bg4);color:var(--text2)}
.v9-tab.active{background:rgba(99,102,241,0.18);color:var(--primary)}
.v9-canvas{width:100%;height:280px;background:linear-gradient(180deg,rgba(99,102,241,0.05),transparent);border:1px solid var(--border);border-radius:12px}
.v9-table{width:100%;border-collapse:collapse;font-size:0.7rem}
.v9-table th,.v9-table td{padding:8px 10px;border-bottom:1px solid var(--border);white-space:nowrap}
.v9-table th{background:var(--bg3);color:var(--text4);font-weight:900;font-size:0.58rem;text-transform:uppercase;position:sticky;top:0;z-index:2}
.v9-table td:first-child,.v9-table th:first-child{text-align:left;position:sticky;left:0;background:var(--bg2);z-index:1}
.v9-table th:first-child{background:var(--bg3);z-index:3}
.v9-muted{color:var(--text4)}
</style>


<style>
/* === v9.3 Range Simulation === */
.v9-range-grid{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:10px;align-items:end}
@media (max-width: 1100px){.v9-range-grid{grid-template-columns:1fr}}
.v9-field{display:flex;flex-direction:column;gap:6px}
.v9-field label{font-size:0.62rem;color:var(--text4);font-weight:800;letter-spacing:.08em;text-transform:uppercase}
.v9-input{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px 10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.75rem}
.v9-slider{width:100%}
.v9-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.v9-mini{font-size:0.66rem;color:var(--text3)}
.v9-statrow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media (max-width: 900px){.v9-statrow{grid-template-columns:repeat(2,1fr)}}
.v9-stat{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px}
.v9-stat .k{font-size:0.58rem;color:var(--text4);font-weight:900;text-transform:uppercase;letter-spacing:.08em}
.v9-stat .v{margin-top:6px;font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:900}
.v9-stat .s{margin-top:4px;font-size:0.62rem;color:var(--text3)}
</style>


<style>
/* === v9.4 Anchors + Mode Tabs + Range Highlight === */
.v9-mode{display:flex;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:6px}
.v9-mode button{padding:8px 10px;border-radius:8px;border:none;background:transparent;color:var(--text3);font-weight:900;font-size:0.72rem;cursor:pointer}
.v9-mode button.active{background:rgba(99,102,241,0.18);color:var(--primary)}
.v9-anchor-wrap{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.v9-anchor-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
.v9-anchor-table{width:100%;border-collapse:collapse;font-size:0.68rem}
.v9-anchor-table th,.v9-anchor-table td{padding:8px 10px;border-bottom:1px solid var(--border);white-space:nowrap}
.v9-anchor-table th{background:var(--bg3);color:var(--text4);font-weight:900;font-size:0.58rem;text-transform:uppercase}
.v9-anchor-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.v9-smallbtn{width:auto;padding:8px 10px}
.v9-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--border);border-radius:999px;background:var(--bg3);font-size:0.62rem;color:var(--text3)}
</style>



<!-- âœ… ãƒ­ãƒ¼ã‚«ãƒ«é…ç½®æ¨å¥¨ï¼šåŒãƒ•ã‚©ãƒ«ãƒ€ã« xlsx.full.min.js ã‚’ç½®ã -->
<!-- <script src="./xlsx.full.min.js"></script> -->

</head>
<body>
<div id="build-badge" style="position:fixed;left:8px;top:8px;z-index:99999;background:#111;color:#fff;padding:4px 8px;border-radius:6px;font:12px/1.2 system-ui;opacity:0.85">FILE: fixed_v23</div>


<div id="xlsxBanner" style="margin:10px 0;padding:10px 12px;border:1px solid #b45309;background:rgba(245,158,11,0.12);border-radius:10px;display:none">
  <div style="font-weight:700">âš ï¸ Excelèª­è¾¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆxlsx.full.min.jsï¼‰ãŒæœªèª­ã¿è¾¼ã¿ã§ã™</div>

<div style="font-size:12px;opacity:0.9;margin-top:4px">
    ã“ã®HTMLã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« <span style="font-family:ui-monospace,monospace">xlsx.full.min.js</span> ã‚’ç½®ãã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚<br><span data-msg style="display:block;margin-top:6px"></span><br>
    ã‚‚ã—ãã¯å„Excelã‚’CSVã§ä¿å­˜ã—ã¦èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼ˆCSVèª­è¾¼ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ï¼‰ã€‚
  </div>
</div>

<script>
/**
 * âœ… XLSXè‡ªå‹•ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆCDNâ†’ãƒ­ãƒ¼ã‚«ãƒ«ã®é †ã§è©¦è¡Œï¼‰
 * - iOS Safari ã®åˆ¶é™ã§ file:// ã ã¨ <input type="file"> è‡ªä½“ãŒä¸å®‰å®šãªãŸã‚ã€PC/httpsé…ä¿¡æ¨å¥¨
 * - CDNãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã‚‚ã€åŒãƒ•ã‚©ãƒ«ãƒ€é…ç½® ./xlsx.full.min.js ãŒæœ€å¾Œã«åŠ¹ã
 */
(function(){
  const banner = () => document.getElementById('xlsxBanner');
  const showBanner = (msg) => {
    const b = banner();
    if(!b) return;
    b.style.display='block';
    if(msg){
      const p = b.querySelector('[data-msg]');
      if(p) p.textContent = msg;
    }
  };

  async function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src=src;
      s.async=true;
      s.onload=()=>resolve(src);
      s.onerror=()=>reject(new Error('failed: '+src));
      document.head.appendChild(s);
    });
  }

  async function ensureXLSX(){
    if(typeof XLSX!=='undefined') return 'already';
    // 1) SheetJSå…¬å¼CDN
    const candidates = [
      "https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js",
      // 2) jsDelivr
      "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
      // 3) unpkg
      "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js",
      // 4) ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆåŒãƒ•ã‚©ãƒ«ãƒ€ï¼‰
      "./xlsx.full.min.js"
    ];
    for(const url of candidates){
      try{
        showBanner("XLSXãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ä¸­â€¦ ("+url+")");
        await loadScript(url);
        if(typeof XLSX!=='undefined'){
          // èª­ã‚ãŸã‚‰ãƒãƒŠãƒ¼ã‚’æ¶ˆã™
          const b=banner(); if(b) b.style.display='none';
          return url;
        }
      }catch(e){
        // æ¬¡ã¸
      }
    }
    showBanner("Excelèª­è¾¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆXLSXï¼‰ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚CSVã§èª­ã¿è¾¼ã‚€ã‹ã€PC/Chromeã§é–‹ãã‹ã€åŒãƒ•ã‚©ãƒ«ãƒ€ã« xlsx.full.min.js ã‚’ç½®ã„ã¦ãã ã•ã„ã€‚");
    return null;
  }

  // èµ·å‹•æ™‚ã«è©¦è¡Œ
  document.addEventListener('DOMContentLoaded', ()=>{ ensureXLSX(); });

  // ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«
  window.__ensureXLSX__ = ensureXLSX;
})();
</script>

<script src="features/import/importErrors.js"></script>
<script src="features/import/fileReader.js"></script>
<script src="features/import/csvParser.js"></script>
<script src="features/import/xlsxParser.js"></script>
<script src="features/import/fileTypeDetector.js"></script>
<script src="features/import/importService.js"></script>


    <div class="app">
        <nav class="nav">
            <div class="nav-logo">ğŸ“Š</div>
            <div class="nav-item active" title="ãƒ‡ãƒ¼ã‚¿ç®¡ç†">ğŸ“</div>
            <div class="nav-item" title="åˆ†æ">ğŸ“ˆ</div>
            <div class="nav-spacer"></div>
            <div class="nav-item" id="theme-toggle" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</div>
            <div class="nav-item" onclick="showSettingsModal()" title="è¨­å®š">âš™ï¸</div>
        </nav>
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ä»•å…¥ç²—åˆ©ç®¡ç†</div>
                <div class="sidebar-heading">å–å¼•å…ˆåˆ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ v8</div>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="section-label">ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«</div>
                    <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-zone-icon">ğŸ“‚</div>
                        <div class="drop-zone-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
                        <div class="drop-zone-hint">ã¾ãŸã¯ä¸‹ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
                    </div>
                    <div class="upload-grid">
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“¦</div><div class="name">ä»•å…¥</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="shiire"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ’°</div><div class="name">å£²ä¸Š</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="uriage"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“‰</div><div class="name">å£²å¤‰</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="baihen"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">âš™ï¸</div><div class="name">åˆæœŸè¨­å®š</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="settings"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“Š</div><div class="name">äºˆç®—</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="budget"></div>
                        <div class="upload-card" onclick="showConsumableModal()"><div class="icon">ğŸ§¾</div><div class="name">æ¶ˆè€—å“</div><input type="file" id="consumable-input" accept=".xlsx,.xls,.csv" multiple style="display:none" onchange="processConsumableFiles(this)"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“¥</div><div class="name">åº—é–“å…¥</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="tenkanIn"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ“¤</div><div class="name">åº—é–“å‡º</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="tenkanOut"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸ¥¬</div><div class="name">ç”£ç›´</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="sanchoku"></div>
                        <div class="upload-card" onclick="this.querySelector('input').click()"><div class="icon">ğŸŒ¸</div><div class="name">èŠ±</div><input type="file" accept=".xlsx,.xls,.csv" data-load-key="hana"></div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸ¯ ç›®æ¨™è¨­å®š</div>
                    <div class="input-grid">
                        <div class="input-field" style="border-left:3px solid var(--success)">
                            <label>ç›®æ¨™ç²—åˆ©ç‡ (%)</label>
                            <input type="text" id="target-margin" value="25.00">
                        </div>
                        <div class="input-field" style="border-left:3px solid var(--warning)">
                            <label>è­¦å‘Šã—ãã„å€¤ (%)</label>
                            <input type="text" id="warning-margin" value="23.00">
                        </div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸŒ¸ğŸ¥¬ èŠ±ãƒ»ç”£ç›´ æ›ã‘ç‡</div>
                    <div class="input-grid">
                        <div class="input-field" style="border-left:3px solid #f472b6">
                            <label>ğŸŒ¸ èŠ± æ›ã‘ç‡</label>
                            <input type="text" id="hana-rate" value="0.80">
                        </div>
                        <div class="input-field" style="border-left:3px solid #a3e635">
                            <label>ğŸ¥¬ ç”£ç›´ æ›ã‘ç‡</label>
                            <input type="text" id="sanchoku-rate" value="0.85">
                        </div>
                    </div>
                    <div style="margin-top:6px;padding:6px 8px;background:var(--bg4);border-radius:5px;font-size:0.58rem;color:var(--text3)">
                        å£²ä¸Šç´å“ã®ãŸã‚ã€å£²ä¾¡Ã—æ›ã‘ç‡=åŸä¾¡ã¨ã—ã¦è¨ˆç®—
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">âš™ï¸ ä»•å…¥å…ˆãƒ»å¸³åˆè¨­å®š <span style="font-size:0.5rem;color:var(--text4);font-weight:400">(ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã)</span></div>
                    <button onclick="showSupplierSettingsModal()" style="width:100%;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:0.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px">
                        <span>ğŸ­</span> ä»•å…¥å…ˆåˆ¥è¨­å®šãƒ»å¸³åˆåˆ†é¡ã‚’ç·¨é›†
                    </button>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸª åº—èˆ—</div>
                    <div class="chip-group" id="store-chips"><div class="chip active" data-store="all">å…¨åº—èˆ—</div></div>
                </div>
                <div class="sidebar-section">
                    <div class="section-label">ğŸ“¦ åº—èˆ—åˆ¥ åœ¨åº«è¨­å®š <span style="font-size:0.5rem;color:var(--text4);font-weight:400">(åˆæœŸè¨­å®šã§è‡ªå‹•å…¥åŠ›)</span></div>
                    <div id="store-inventory-container" style="max-height:180px;overflow-y:auto;margin-bottom:8px">
                        <div style="font-size:0.65rem;color:var(--text4);padding:8px;text-align:center">åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤º</div>
                    </div>
                    <div class="input-grid">
                        <div class="input-field"><label>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆäºˆç®—</label><input type="text" id="budget" value="6,450,000" oninput="formatInput(this)"></div>
                        <div class="input-field"><label>å€¤å…¥ç‡</label><input type="text" id="margin-rate" value="0.26"></div>
                    </div>
                    <div style="margin-top:4px;font-size:0.55rem;color:var(--text4)">â€»äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼æ™‚ã¯æ—¥åˆ¥äºˆç®—ã‚’ä½¿ç”¨</div>
                </div>
                <div class="sidebar-section">
                    <button class="btn btn-primary" id="btn-generate" onclick="generate()" disabled>ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆ</button>
                    <button class="btn btn-success" id="btn-export" onclick="exportExcel()" style="display:none;">ğŸ“¥ Excelå‡ºåŠ›</button>
                </div>
            </div>
        </aside>
        <main class="main">
            <div class="topbar">
                <div class="topbar-title">
                    <span id="view-title">ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾…ã¡</span>
                    <span class="topbar-badge" id="store-badge" style="display:none;">01</span>
                </div>
                <div class="topbar-tabs" id="view-tabs" style="display:none;">
                    <button class="topbar-tab active" data-view="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
                    <button class="topbar-tab" data-view="category">å¸³åˆåˆ¥</button>
                    <button class="topbar-tab" data-view="forecast">ğŸ“… é€±é–“äºˆæ¸¬</button>
                    <button class="topbar-tab" data-view="analysis">äºˆç®—åˆ†æ</button>
                    <button class="topbar-tab" data-view="daily">æ—¥åˆ¥æ¨ç§»</button>
                    <button class="topbar-tab" data-view="summary">è’åˆ©è¨ˆç®—</button>
                    <button class="topbar-tab" data-view="reports">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆ</button>
                </div>
                <div class="topbar-meta" id="topbar-meta" style="display:none;">
                    <span class="meta-pill">å€¤å…¥ç‡ <span id="meta-margin-rate">-</span></span>
                </div>
            </div>
            <div class="stats-row" id="stats-row" style="display:none;">
                <div class="stat-card"><div class="label">å£²ä¸Šå®Ÿç¸¾</div><div class="value" id="stat-sales">-</div><div class="sub" id="stat-sales-sub">-</div></div>
                <div class="stat-card"><div class="label">ç·ä»•å…¥é«˜</div><div class="value" style="color:var(--warning)" id="stat-cost">-</div><div class="sub" id="stat-consumable">-</div></div>
                <div class="stat-card"><div class="label">å€¤å…¥ç‡</div><div class="value" style="color:var(--purple)" id="stat-markup-rate">-</div><div class="sub" id="stat-markup-amt">-</div></div>
                <div class="stat-card"><div class="label">è’åˆ©ç‡(ç¨æŠœå‰)</div><div class="value" style="color:var(--info)" id="stat-rate-before">-</div><div class="sub" id="stat-profit-before">-</div></div>
                <div class="stat-card"><div class="label">è’åˆ©ç‡(ç¨æŠœå¾Œ)</div><div class="value" style="color:var(--success)" id="stat-rate">-</div><div class="sub" id="stat-profit-sub">-</div></div>
            </div>
            <div class="content" id="content">
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‚</div>
                    <h3>ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</h3>
                    <p>å·¦ã®ãƒ‘ãƒãƒ«ã‹ã‚‰ã€Œä»•å…¥ã€ã¨ã€Œå£²ä¸Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã€åˆ†æã‚’é–‹å§‹ã§ãã¾ã™</p>
                </div>
            </div>
        </main>
    </div>
    <div class="toast-container" id="toast-container"></div>
    
    <!-- æ¶ˆè€—å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="consumable-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:340px;max-width:90%">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#f97316,#ea580c);border-radius:8px;display:flex;align-items:center;justify-content:center">ğŸ§¾</span>
                æ¶ˆè€—å“ãƒ‡ãƒ¼ã‚¿èª­è¾¼
            </div>
            <div id="consumable-status" style="padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:16px;font-size:0.75rem">
                <div style="color:var(--text3)">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿:</div>
                <div id="consumable-count" style="font-family:'JetBrains Mono',monospace;color:var(--text);margin-top:4px">æœªèª­è¾¼</div>
            </div>
            <div style="font-size:0.7rem;color:var(--text3);margin-bottom:12px">èª­è¾¼æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„:</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">
                <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                    <input type="radio" name="consumable-mode" value="overwrite" checked style="accent-color:var(--primary)">
                    <div>
                        <div style="font-weight:600;font-size:0.8rem">ğŸ”„ ä¸Šæ›¸ã</div>
                        <div style="font-size:0.65rem;color:var(--text3)">æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°è¦èª­è¾¼</div>
                    </div>
                </label>
                <label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='var(--success)'" onmouseout="this.style.borderColor='var(--border)'">
                    <input type="radio" name="consumable-mode" value="append" style="accent-color:var(--success)">
                    <div>
                        <div style="font-weight:600;font-size:0.8rem">â• è¿½åŠ </div>
                        <div style="font-size:0.65rem;color:var(--text3)">æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ï¼ˆåŒæ—¥ã¯åˆç®—ï¼‰</div>
                    </div>
                </label>
            </div>
            <div style="display:flex;gap:8px">
                <button onclick="closeConsumableModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="selectConsumableFiles()" style="flex:1;padding:10px;background:linear-gradient(135deg,#f97316,#ea580c);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
            </div>
        </div>
    </div>
    
    <!-- ä»•å…¥å…ˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="supplier-settings-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:600px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:8px;display:flex;align-items:center;justify-content:center">ğŸ­</span>
                ä»•å…¥å…ˆãƒ»å¸³åˆè¨­å®š
            </div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="supplier-settings-content">
                <div style="font-size:0.65rem;color:var(--text4);padding:16px;text-align:center">ä»•å…¥ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeSupplierSettingsModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">é–‰ã˜ã‚‹</button>
                <button onclick="saveSupplierSettings()" style="flex:1;padding:10px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settings-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:500px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#6366f1,#4f46e5);border-radius:8px;display:flex;align-items:center;justify-content:center">âš™ï¸</span>
                è¨­å®š
            </div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="settings-content">
                <!-- è¨­å®šå†…å®¹ã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeSettingsModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveAllSettings()" style="flex:1;padding:10px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="validation-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:500px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:8px;display:flex;align-items:center;justify-content:center">âš ï¸</span>
                ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ
            </div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="validation-content">
                <!-- æ¤œè¨¼çµæœã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeValidationModal()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">é–‰ã˜ã‚‹</button>
                <button onclick="proceedWithWarnings()" style="flex:1;padding:10px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">è­¦å‘Šã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="report-preview-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;width:800px;max-width:95%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="padding:16px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
                <span id="report-preview-icon" style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.1rem">ğŸ“‹</span>
                <div style="flex:1">
                    <div id="report-preview-title" style="font-size:1rem;font-weight:700">ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                    <div id="report-preview-sub" style="font-size:0.65rem;color:var(--text3)"></div>
                </div>
                <button onclick="closeReportPreview()" style="width:32px;height:32px;background:var(--bg3);border:none;border-radius:6px;color:var(--text2);cursor:pointer;font-size:1rem">âœ•</button>
            </div>
            <div style="flex:1;overflow-y:auto;padding:20px" id="report-preview-content">
                <!-- ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end">
                <button onclick="printReport()" style="padding:10px 20px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ–¨ï¸ å°åˆ·</button>
                <button onclick="exportReportExcel()" style="padding:10px 20px;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ“¥ Excelå‡ºåŠ›</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚«ãƒ©ãƒ è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="column-config-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:400px;max-width:95%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
            <div style="font-size:1rem;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px">
                <span style="width:36px;height:36px;background:linear-gradient(135deg,#06b6d4,#0891b2);border-radius:8px;display:flex;align-items:center;justify-content:center">ğŸ“Š</span>
                è¡¨ç¤ºåˆ—ã®è¨­å®š
            </div>
            <div style="font-size:0.65rem;color:var(--text3);margin-bottom:12px">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³é †ã‚’å¤‰æ›´ã€ãƒˆã‚°ãƒ«ã§è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ</div>
            <div style="flex:1;overflow-y:auto;margin-bottom:16px" id="column-config-content">
                <!-- ã‚«ãƒ©ãƒ è¨­å®šã¯JSã§ç”Ÿæˆ -->
            </div>
            <div style="display:flex;gap:8px;border-top:1px solid var(--border);padding-top:16px">
                <button onclick="closeColumnConfig()" style="flex:1;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-family:inherit;font-size:0.78rem;cursor:pointer">é–‰ã˜ã‚‹</button>
                <button onclick="applyColumnConfig()" style="flex:1;padding:10px;background:linear-gradient(135deg,#6366f1,#4f46e5);border:none;border-radius:7px;color:white;font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer">é©ç”¨</button>
            </div>
        </div>
    </div>
<script src="./state/appState.js"></script>
<script>
const appState=createAppState({DATA:{},STORES:{},SUPPLIERS:{},STORE_INVENTORY:{},STORE_BUDGET:{},result:null});
['DATA','STORES','SUPPLIERS','STORE_INVENTORY','STORE_BUDGET','result'].forEach(k=>appState.wireAlias(k,k));
let currentStore='all',currentView='dashboard';
let transferFlowRenderer=null;
// ãƒ‡ãƒ¼ã‚¿æœŸé–“ï¼ˆå¹´æœˆæ¨å®šã§ã¯ãªãã€ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ï¼‰
let BUDGET_RANGE=null; // {min:Date,max:Date}
let BAIHEN_RANGE=null; // {min:Date,max:Date}

function syncViewTabs(){
  const tabs=document.getElementById('view-tabs');
  if(!tabs) return;
  tabs.querySelectorAll('.topbar-tab').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.view===currentView);
  });
}

function updateTopbarMeta(){
  const meta=document.getElementById('topbar-meta');
  const mr=document.getElementById('meta-margin-rate');
  const input=document.getElementById('margin-rate');
  if(!meta||!mr) return;
  // å€¤å…¥ç‡ã¯å·¦ã‚µã‚¤ãƒ‰ã®è¨­å®šå€¤ã‚’è¡¨ç¤º
  const v = input ? String(input.value||'').trim() : '';
  mr.textContent = v || '-';
  meta.style.display = 'flex'; // å¸¸æ™‚è¡¨ç¤º
}


function normalizeStoreId(s){
  if(s==null) return s;
  if(s==='all') return 'all';
  const cand=[String(s), String(parseInt(String(s),10)), String(parseInt(String(s),10)).padStart(2,'0')];
  for(const c of cand){
    if(result && result[c]) return c;
    if(STORES && STORES[c]) return c;
  }
  return String(s);
}


function ensureAllStoreAggregate(){
  if(!result) return;

  const v19Aggregate = (typeof ensureAllAggregateV19==='function')
    ? ensureAllAggregateV19
    : ((typeof window!=='undefined' && typeof window.ensureAllAggregateV19==='function')
      ? window.ensureAllAggregateV19
      : null);

  if(v19Aggregate){
    v19Aggregate();
    return;
  }
  if(typeof v9_ensureAllAggregate==='function'){
    v9_ensureAllAggregate();
    return;
  }
  ensureAllAggregate();
}

function ensureAllAggregate(){
  if(!result) return;
  if(result['all']) return;

  const storeIds = Object.keys(result).filter(k=>k!=='all');
  if(storeIds.length===0) return;

  const allDaily = {};
  const allCatTotals = {};
  const allSupTotals = {};
  const allTransfer = {tenkanIn:[], tenkanOut:[], bumonIn:[], bumonOut:[]};

  let invStart=0, invEnd=0, budget=0, gpBudget=0, gpRateBudget=0;
  let totalConsumable=0, totalBaihen=0, totalCoreSales=0, coreCost=0, corePrice=0;
  let estimatedCogs=0, baihenLossCost=0;

  // Use calendar/day counts from the first store as baseline (they should be identical)
  let elapsedDays=0, salesDays=0, avgDailySales=0;
  let budgetDaily = {};

  // Aggregate monthly totals and daily structures
  for(const sid of storeIds){
    const d = result[sid];
    if(!d) continue;

    invStart += (d.invStart||0);
    invEnd   += (d.invEnd||0);
    budget   += (d.budget||0);
    gpBudget += (d.gpBudget||0);

    totalConsumable += (d.totalConsumable||0);
    totalBaihen     += (d.totalBaihen||0);
    totalCoreSales  += (d.totalCoreSales||0);
    coreCost        += (d.coreCost||0);
    corePrice       += (d.corePrice||0);

    estimatedCogs    += (d.estimatedCogs||0);
    baihenLossCost   += (d.baihenLossCost||0);

    elapsedDays = Math.max(elapsedDays, d.elapsedDays||0);
    salesDays   = Math.max(salesDays, d.salesDays||0);

    // Budget daily: sum by day (å–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ã®å‰²å½“ãŒã‚ã‚‹å‰æ)
    if(d.budgetDaily){
      for(const [day, val] of Object.entries(d.budgetDaily)){
        budgetDaily[day] = (budgetDaily[day]||0) + (val||0);
      }
    }

    // Category totals
    if(d.catTotals){
      for(const [cat, v] of Object.entries(d.catTotals)){
        if(!allCatTotals[cat]) allCatTotals[cat] = {cost:0, price:0};
        allCatTotals[cat].cost += (v.cost||0);
        allCatTotals[cat].price += (v.price||0);
      }
    }

    // Supplier totals
    if(d.supTotals){
      for(const [code, v] of Object.entries(d.supTotals)){
        if(!allSupTotals[code]) allSupTotals[code] = {...v, cost:0, price:0};
        allSupTotals[code].cost += (v.cost||0);
        allSupTotals[code].price += (v.price||0);
      }
    }

    // Transfers (concat)
    if(d.transferDetails){
      (d.transferDetails.tenkanIn||[]).forEach(x=>allTransfer.tenkanIn.push(x));
      (d.transferDetails.tenkanOut||[]).forEach(x=>allTransfer.tenkanOut.push(x));
      (d.transferDetails.bumonIn||[]).forEach(x=>allTransfer.bumonIn.push(x));
      (d.transferDetails.bumonOut||[]).forEach(x=>allTransfer.bumonOut.push(x));
    }

    // Daily aggregation (needed for charts and day view)
    for(let day=1; day<=31; day++){
      const dd = d.daily?.[day];
      if(!dd) continue;
      if(!allDaily[day]){
        allDaily[day] = {
          sales:0,
          suppliers:{},
          shiire:{cost:0, price:0},
          tenkanInTotal:{cost:0, price:0},
          tenkanOutTotal:{cost:0, price:0},
          bumonInTotal:{cost:0, price:0},
          bumonOutTotal:{cost:0, price:0},
          hana:{cost:0, price:0},
          sanchoku:{cost:0, price:0},
          consumable:{cost:0, items:[]},
          baihen:0,
          baihenAbs:0,
          grossSales:0,
          coreSales:0,
          coreGrossSales:0,
          overDelivery:false,
          overDeliveryAmt:0,
          baihenRate:0
        };
      }
      const ad = allDaily[day];

      ad.sales += (dd.sales||0);
      ad.shiire.cost += (dd.shiire?.cost||0);
      ad.shiire.price += (dd.shiire?.price||0);

      ad.tenkanInTotal.cost  += (dd.tenkanInTotal?.cost||0);
      ad.tenkanInTotal.price += (dd.tenkanInTotal?.price||0);
      ad.tenkanOutTotal.cost  += (dd.tenkanOutTotal?.cost||0);
      ad.tenkanOutTotal.price += (dd.tenkanOutTotal?.price||0);
      ad.bumonInTotal.cost  += (dd.bumonInTotal?.cost||0);
      ad.bumonInTotal.price += (dd.bumonInTotal?.price||0);
      ad.bumonOutTotal.cost  += (dd.bumonOutTotal?.cost||0);
      ad.bumonOutTotal.price += (dd.bumonOutTotal?.price||0);

      ad.hana.cost += (dd.hana?.cost||0);
      ad.hana.price += (dd.hana?.price||0);
      ad.sanchoku.cost += (dd.sanchoku?.cost||0);
      ad.sanchoku.price += (dd.sanchoku?.price||0);

      ad.consumable.cost += (dd.consumable?.cost||0);

      // baihen: keep as net negative if present; store-level already keeps raw (can be negative)
      ad.baihen += (dd.baihen||0);
      ad.baihenAbs += (dd.baihenAbs!=null?dd.baihenAbs:Math.abs(dd.baihen||0));

      // suppliers daily
      if(dd.suppliers){
        for(const [code, sv] of Object.entries(dd.suppliers)){
          if(!ad.suppliers[code]) ad.suppliers[code] = {...sv, cost:0, price:0};
          ad.suppliers[code].cost += (sv.cost||0);
          ad.suppliers[code].price += (sv.price||0);
        }
      }
    }
  }

  // Derived monthly totals
  const totalSales = Object.values(allDaily).reduce((s,d)=>s+(d.sales||0),0);
  const totalCost  = Object.values(allCatTotals).reduce((s,c)=>s+(c.cost||0),0);
  const totalPrice = Object.values(allCatTotals).reduce((s,c)=>s+(c.price||0),0);

  const grossProfit = totalSales - (invStart + totalCost - invEnd);
  const grossProfitRate = totalSales>0 ? grossProfit/totalSales : 0;
  const avgMargin = totalPrice>0 ? (totalPrice-totalCost)/totalPrice : 0;

  const totalGrossSales = totalSales + totalBaihen; // net + discountAbs
  const baihenRateSales = totalGrossSales>0 ? (totalBaihen/totalGrossSales) : 0;
  const coreMarginRate = corePrice>0 ? (corePrice-coreCost)/corePrice : avgMargin;

  const estimatedGrossProfit = totalSales - estimatedCogs;
  const estimatedGrossRate   = totalSales>0 ? estimatedGrossProfit/totalSales : 0;
  const estimatedInvEnd      = invStart + totalCost - estimatedCogs;

  avgDailySales = (elapsedDays>0) ? (totalSales/elapsedDays) : 0;

  // gpRateBudget: total gpBudget / total budget if available
  gpRateBudget = (budget>0 && gpBudget>0) ? (gpBudget/budget) : 0;

  result['all'] = {
    daily: allDaily,
    catTotals: allCatTotals,
    supTotals: allSupTotals,
    transferDetails: allTransfer,
    invStart, invEnd,
    budget, gpBudget, gpRateBudget,
    budgetDaily,
    totalSales, totalCost, totalPrice,
    grossProfit, grossProfitRate, avgMargin,
    elapsedDays, salesDays, avgDailySales,
    totalConsumable,
    totalBaihen,
    baihenRateSales,
    coreMarginRate,
    coreCost, corePrice,
    totalCoreSales,
    estimatedCogs,
    estimatedGrossProfit,
    estimatedGrossRate,
    estimatedInvEnd,
    baihenLossCost
  };
}

let overDeliveryWarned=false;
// STORE_INVENTORY / STORE_BUDGET are managed by appState aliases
let STORE_GP_BUDGET={};  // åº—èˆ—åˆ¥ æœˆé–“ç²—åˆ©é¡äºˆç®— {storeId: number}ï¼ˆåˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
let CONSUMABLES={};      // åŸä¾¡ç®—å…¥æ¯”ãƒ‡ãƒ¼ã‚¿ {storeId: {day: {cost: number, items: []}}}
let SUPPLIER_SETTINGS={};// ä»•å…¥å…ˆåˆ¥è¨­å®š {code: {marginRate: number, usePriceCalc: boolean}}
let CATEGORIES={market:{name:'å¸‚å ´',icon:'ğŸª',order:1},lfc:{name:'LFC',icon:'ğŸšš',order:2},salad:{name:'ã‚µãƒ©ãƒ€ã‚¯ãƒ©ãƒ–',icon:'ğŸ¥—',order:3},kakou:{name:'åŠ å·¥å“',icon:'ğŸ“¦',order:4},chokuden:{name:'ç›´ä¼',icon:'ğŸœ',order:5},hana:{name:'èŠ±',icon:'ğŸŒ¸',order:6},sanchoku:{name:'ç”£ç›´',icon:'ğŸ¥¬',order:7},consumable:{name:'åŸä¾¡ç®—å…¥æ¯”',icon:'ğŸ§¾',order:7.5},tenkan:{name:'åº—é–“ç§»å‹•',icon:'ğŸ”„',order:8},bumonkan:{name:'éƒ¨é–€é–“ç§»å‹•',icon:'ğŸ”€',order:9},other:{name:'ãã®ä»–',icon:'ğŸ“‹',order:99}};
let SUPPLIER_CAT_MAP={'0074721':'market','0012104':'lfc','0012072':'lfc','0017175':'salad','0030627':'kakou','0030344':'kakou','0044121':'kakou','0074017':'kakou','0074088':'chokuden','0076511':'chokuden','0017426':'other','0017663':'other','0074508':'other','0075825':'hana','0076686':'hana','0037923':'hana','0011002':'other'};
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0074721ã¯å£²ä¾¡ãŒä»®ãªã®ã§å€¤å…¥ç‡ã§è¨ˆç®—
SUPPLIER_SETTINGS['0074721']={marginRate:0.26,usePriceCalc:true};

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—å®šç¾©ï¼ˆè‡ªå‹•åˆ¤å®šç”¨ï¼‰
const FILE_TYPES={
    shiire:{name:'ä»•å…¥',patterns:['ä»•å…¥','shiire'],headerPatterns:['å–å¼•å…ˆã‚³ãƒ¼ãƒ‰','åŸä¾¡é‡‘é¡','å£²ä¾¡é‡‘é¡']},
    uriage:{name:'å£²ä¸Š',patterns:['å£²ä¸Š','uriage'],headerPatterns:['è²©å£²é‡‘é¡','å£²ä¸Š']},
    baihen:{name:'å£²å¤‰',patterns:['å£²å¤‰','baihen'],headerPatterns:['å£²å¤‰åˆè¨ˆ','å€¤å¼•']},
    settings:{name:'åˆæœŸè¨­å®š',patterns:['åˆæœŸ','è¨­å®š','setting'],headerPatterns:['æœŸé¦–','æœŸæœ«']},
    budget:{name:'äºˆç®—',patterns:['äºˆç®—','budget'],headerPatterns:['äºˆç®—']},
    tenkanIn:{name:'åº—é–“å…¥',patterns:['åº—é–“å…¥','å…¥åº«'],headerPatterns:['åº—èˆ—ã‚³ãƒ¼ãƒ‰IN']},
    tenkanOut:{name:'åº—é–“å‡º',patterns:['åº—é–“å‡º','å‡ºåº«'],headerPatterns:['åº—èˆ—ã‚³ãƒ¼ãƒ‰OUT']},
    hana:{name:'èŠ±',patterns:['èŠ±','hana'],headerPatterns:['è²©å£²é‡‘é¡']},
    sanchoku:{name:'ç”£ç›´',patterns:['ç”£ç›´','sanchoku'],headerPatterns:['è²©å£²é‡‘é¡']}
};

const parseNum=s=>parseInt(String(s).replace(/[^\d.-]/g,''))||0;
const fmt=n=>n==null||isNaN(n)?'-':Math.round(n).toLocaleString('ja-JP');
const fmtPct=(n,d=2)=>n==null||isNaN(n)?'-':(n*100).toFixed(d)+'%';

const fmtManSigned = n => (n==null||isNaN(n))?'-':((n>=0?'+':'âˆ’')+Math.round(Math.abs(n)/10000).toLocaleString('ja-JP')+'ä¸‡å††');
const fmtPtSigned = n => (n==null||isNaN(n))?'-':((n>=0?'+':'âˆ’')+Math.abs(n).toFixed(1)+'pt');

// ===== Executive Sticky Bar (v10) =====
function escapeHtml(s){return String(s==null?'':s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function v10_execBarHTML(opts){
  const scopeLabel = opts.scopeLabel || '';
  const plan = opts.plan || {};
  const prog = opts.prog || {};
  const fc = opts.fc || {};
  const days = opts.days || {elapsedBusinessDays:0,totalBusinessDays:0};
  const insight = opts.insight || {summary:'-', items:[]};

  const stagePct = (days.totalBusinessDays>0)?(days.elapsedBusinessDays/days.totalBusinessDays):0;

  // status helpers
  const clsDelta = (v)=> (v==null||isNaN(v)) ? '' : (v<0?'status-danger':'status-success');
  const clsRate  = (v)=> (v==null||isNaN(v)) ? '' : (v<0?'status-danger':'status-success');
  const clsWarnLag = (ach, stage)=> {
    if(ach==null||isNaN(ach) || stage==null||isNaN(stage)) return '';
    if(ach < stage) return 'status-warning';
    return 'status-success';
  };

  const salesLagCls = clsWarnLag(prog.salesAch, stagePct);

  const barW = Math.max(0, Math.min(1, stagePct))*100;

  const planGpRate = plan.gpRateBudget;
  const progGpRate = prog.gpRate;
  const gpRatePt   = (planGpRate!=null && progGpRate!=null && !isNaN(planGpRate) && !isNaN(progGpRate)) ? ((progGpRate-planGpRate)*100) : null;

  const projSalesDelta = (fc.projSales!=null && plan.salesBudget!=null) 
    ? (fc.projSales - plan.salesBudget) : null;
  const projGPDiff     = (fc.projGP!=null && plan.gpBudget!=null) ? (fc.projGP - plan.gpBudget) : null;

  // build html
  let h = '';
  h += ("<div class=\"execbar\">\n    <div class=\"container\">\n      <div class=\"execbar-head\">\n        <div class=\"execbar-title\">\n          <div class=\"execbar-badge\"><span class=\"dot\"></span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæœ¬éƒ¨/çµŒå–¶è€…å‘ã‘ï¼‰</span></div>\n          <span class=\"scope-chip\">" + (escapeHtml(scopeLabel)) + "</span>\n        </div>\n        <div class=\"exec-row\" style=\"min-width:260px\">\n          <div style=\"flex:1\">\n            <div class=\"exec-row\" style=\"margin-bottom:6px\">\n              <div style=\"font-size:12px;color:var(--text3);font-weight:800\">å–¶æ¥­æ—¥é€²æ—</div>\n              <div style=\"font-size:12px;font-family:JetBrains Mono, ui-monospace;color:var(--text3)\">" + (days.elapsedBusinessDays||0) + "/" + (days.totalBusinessDays||0) + "</div>\n            </div>\n            <div class=\"bar\"><div style=\"width:" + (barW.toFixed(1)) + "%\"></div></div>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"exec-sections\">\n        <div class=\"exec-section plan\">\n          <div class=\"sec-head\"><div class=\"sec-title\">PLANï¼ˆå‰æï¼‰</div><div style=\"font-size:12px;color:var(--text3)\">äºˆç®—ãƒ»åœ¨åº«</div></div>\n          <div class=\"exec-cards\">\n            " + (v10_card('æœˆé–“å£²ä¸Šäºˆç®—','ğŸ—“ï¸', plan.salesBudget!=null?('Â¥'+fmt(plan.salesBudget)):'-', plan.salesBudget!=null?'æ—¥åˆ¥äºˆç®—åˆè¨ˆ':'')) + "\n            " + (v10_card('æœˆé–“ç²—åˆ©é¡äºˆç®—','ğŸ¯', plan.gpBudget!=null?('Â¥'+fmt(plan.gpBudget)):'-', plan.gpBudget!=null?'ï¼ˆåˆæœŸè¨­å®šDåˆ—ï¼‰':'')) + "\n            " + (v10_card('æœˆé–“ç²—åˆ©ç‡äºˆç®—','ğŸ“', (plan.gpRateBudget!=null && plan.salesBudget!=null)?fmtPct(plan.gpRateBudget,2):'-', (plan.gpBudget!=null && plan.salesBudget!=null)?'ç²—åˆ©é¡äºˆç®— Ã· å£²ä¸Šäºˆç®—':'')) + "\n            " + (v10_card('æœŸé¦–åœ¨åº«','ğŸ“¦', plan.invStart!=null?('Â¥'+fmt(plan.invStart)):'-', '')) + "\n            " + (v10_card('æœŸæœ«åœ¨åº«ç›®æ¨™','ğŸ', plan.invEnd!=null?('Â¥'+fmt(plan.invEnd)):'-', '')) + "\n          </div>\n        </div>\n\n        <div class=\"exec-section progress\">\n          <div class=\"sec-head\"><div class=\"sec-title\">ACTUALï¼ˆç¾åœ¨åœ°ï¼‰</div><div style=\"font-size:12px;color:var(--text3)\">æœŸä¸­å®Ÿç¸¾</div></div>\n          <div class=\"exec-cards\">\n            " + (v10_card('æœŸä¸­å£²ä¸Šäºˆç®—','â³', prog.salesBudgetElapsed!=null?('Â¥'+fmt(prog.salesBudgetElapsed)):'-', 'å½“æ—¥ã¾ã§ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰')) + "\n            " + (v10_card('æœŸä¸­å£²ä¸Šå®Ÿç¸¾','ğŸ’´', prog.salesActual!=null?('Â¥'+fmt(prog.salesActual)):'-', 
              (prog.salesDelta!=null?('å·®ç•° <span class=\"' + clsDelta(prog.salesDelta) + '\">' + fmtManSigned(prog.salesDelta) + '</span>'):'')
            )) + "\n            " + (v10_card('å£²ä¸Šé”æˆç‡','âœ…', (prog.salesAch!=null)?fmtPct(prog.salesAch,1):'-', 
              (prog.salesAch!=null && !isNaN(prog.salesAch))?('é€²æ—æ¯” <span class=\"' + salesLagCls + '\">' + fmtPct(prog.salesAch-stagePct,1) + '</span>'):''
            )) + "\n            " + (v10_card('æœŸä¸­ç²—åˆ©é¡å®Ÿç¸¾','ğŸ’°', prog.gpActual!=null?('Â¥'+fmt(prog.gpActual)):'-', 
              (prog.gpDelta!=null?('å·®ç•° <span class=\"' + clsDelta(prog.gpDelta) + '\">' + fmtManSigned(prog.gpDelta) + '</span>'):'')
            )) + "\n            " + (v10_card('æœŸä¸­ç²—åˆ©ç‡å®Ÿç¸¾','ğŸ“ˆ', (prog.gpRate!=null)?fmtPct(prog.gpRate,2):'-', 
              (gpRatePt!=null?('äºˆç®—æ¯” <span class=\"' + clsRate(gpRatePt) + '\">' + fmtPtSigned(gpRatePt) + '</span>'):'')
            )) + "\n          </div>\n        </div>\n\n        <div class=\"exec-section forecast\">\n          <div class=\"sec-head\"><div class=\"sec-title\">FORECASTï¼ˆç€åœ°ï¼‰</div><div style=\"font-size:12px;color:var(--text3)\">å–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹</div></div>\n          <div class=\"exec-cards\">\n            " + (v10_card('æœˆæœ«å£²ä¸Šç€åœ°','ğŸ”®', fc.projSales!=null?('Â¥'+fmt(fc.projSales)):'-', 
              (projSalesDelta!=null?('äºˆç®—å·® <span class=\"' + clsDelta(projSalesDelta) + '\">' + fmtManSigned(projSalesDelta) + '</span>'):'')
            )) + "\n            " + (v10_card('ç€åœ°å£²ä¸Šé”æˆç‡','ğŸ¯', (fc.projSalesAch!=null)?fmtPct(fc.projSalesAch,1):'-', (fc.projSalesAch!=null && fc.projSalesAch<1)?'<span class=\"status-danger\">æœªé”è¦‹è¾¼ã¿</span>':'')) + "\n            " + (v10_card('æœˆæœ«ç²—åˆ©ç€åœ°','ğŸ§®', (fc.projGP!=null && plan.gpBudget!=null)?('Â¥'+fmt(fc.projGP)):(plan.gpBudget!=null?'-':'ï¼ˆç²—åˆ©äºˆç®—æœªè¨­å®šï¼‰'), 
              (projGPDiff!=null?('äºˆç®—å·® <span class=\"' + clsDelta(projGPDiff) + '\">' + fmtManSigned(projGPDiff) + '</span>'):'')
            )) + "\n            " + (v10_card('ç€åœ°ç²—åˆ©é”æˆç‡','ğŸ†', (fc.projGPAch!=null && plan.gpBudget!=null)?fmtPct(fc.projGPAch,1):'-', (fc.projGPAch!=null && fc.projGPAch<1)?'<span class=\"status-danger\">æœªé”è¦‹è¾¼ã¿</span>':'')) + "\n          </div>\n        </div>\n\n        <div class=\"exec-section insight\">\n          <div class=\"sec-head\"><div class=\"sec-title\">INSIGHTï¼ˆç¾çŠ¶åˆ†æï¼‰</div><div style=\"font-size:12px;color:var(--text3)\">æ—¥åˆ¥ç•°å¸¸ TOP3</div></div>\n          <div class=\"exec-cards\">\n            <div class=\"exec-card\" style=\"grid-column:span 2\">\n              <div class=\"label\"><span>è¦ç´„</span><span>ğŸ§­</span></div>\n              <div class=\"sub\" style=\"font-weight:800\">" + (insight.summary || '-') + "</div>\n              <div class=\"sub\">ã‚¯ãƒªãƒƒã‚¯ã§æ—¥åˆ¥ã¸ï¼ˆä»Šå¾Œè¿½åŠ ï¼‰</div>\n            </div>\n            <div class=\"exec-card\" style=\"grid-column:span 2\">\n              <div class=\"label\"><span>ç•°å¸¸æ—¥</span><span>ğŸ“…</span></div>\n              <div class=\"anomaly-list\">" + (insight.itemsHtml || '<div class=\"sub\">è©²å½“ãªã—</div>') + "</div></div>\n            </div>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  </div>");
  return h;
}

function v10_card(label, icon, value, sub){
  return ("<div class=\"exec-card\">\n    <div class=\"label\"><span>" + (label) + "</span><span>" + (icon) + "</span></div>\n    <div class=\"value\">" + (value) + "</div>\n    <div class=\"sub\">" + (sub||'') + "</div>\n  </div>");
}
const deltaClass = n => (n==null||isNaN(n))?'':(n>=0?'pos':'neg');
function formatInput(el){let v=el.value.replace(/[^\d]/g,'');if(v)el.value=parseInt(v).toLocaleString('ja-JP');}
function parseDate(v){if(!v)return null;if(typeof v==='number')return new Date((v-25569)*86400*1000);const s=String(v);let m=s.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);m=s.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);m=s.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);if(m)return new Date(+m[1],+m[2]-1,+m[3]);return null;}
function getCatOrder(){return Object.entries(CATEGORIES).sort((a,b)=>a[1].order-b[1].order).map(([k])=>k);}
function showToast(msg,type='info'){const c=document.getElementById('toast-container');const t=document.createElement('div');t.className='toast '+type;t.innerHTML='<span>'+(type==='success'?'âœ“':type==='error'?'âœ•':type==='warning'?'âš ':'â„¹')+'</span> '+msg;c.appendChild(t);setTimeout(()=>t.remove(),3200);}

// ===== ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ =====
function initDropZone(){
    const dropZone=document.getElementById('drop-zone');
    if(!dropZone)return;
    
    dropZone.addEventListener('dragover',e=>{
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave',()=>{
        dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop',e=>{
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleDroppedFiles(e.dataTransfer.files);
    });
    dropZone.addEventListener('click',()=>{
        const input=document.createElement('input');
        input.type='file';
        input.multiple=true;
        input.accept='.xlsx,.xls,.csv';
        input.onchange=()=>handleDroppedFiles(input.files);
        input.click();
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•åˆ¤å®š
function detectFileType(filename,data){
    return window.ImportFileTypeDetector.detectFileType(filename,data,FILE_TYPES);
}

// ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
async function handleDroppedFiles(files){
    const progressTotal=(files&&files.length)||0;
    if(progressTotal===0)return;
    showToast(("è§£æä¸­: 0/" + progressTotal),'info');

    const summary=await window.ImportService.processDroppedFiles(files,{fileTypes:FILE_TYPES});

    summary.results.forEach((result,index)=>{
        if(result.ok){
            const type=result.type;
            DATA[type]=result.rows;
            const card=document.querySelector((".upload-card input[onchange*=\"" + (type) + "\"]"))?.closest('.upload-card');
            if(card)card.classList.add('loaded');

            if(type==='shiire')detectStoresAndSuppliers();
            if(type==='hana'||type==='sanchoku')detectStoresFromHanaSanchoku(type);
            if(type==='settings')processSettings();
            if(type==='budget')processBudget();

            showToast(("è§£æä¸­: " + (index+1) + "/" + progressTotal),'info');
            showToast(((FILE_TYPES[type].name) + ": " + (result.file.name)),'success');
        }else{
            const message=window.ImportErrors.getImportErrorMessage(result.error);
            showToast(((result.file.name) + ": " + message),'error');
        }
    });

    if(summary.successCount>0){
        showToast(((summary.successCount) + "\u4ef6\u306e\u30d5\u30a1\u30a4\u30eb\u3092\u8aad\u307f\u8fbc\u307f\u307e\u3057\u305f"),'success');
        document.getElementById('btn-generate').disabled=!(DATA.shiire&&DATA.uriage);
    }
}

function readTabularFile(file){
    return window.ImportService.readTabularFile(file);
}

function parseCsvToRows(text){
    return window.ImportCsvParser.parseCsvToRows(text);
}

// Backward compatibility (æ—§ã‚³ãƒ¼ãƒ‰ã¯ readExcelFile ã‚’å‚ç…§ã—ã¦ã„ã‚‹)
function readExcelFile(file){
    return readTabularFile(file);
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded',()=>{
    initDropZone();
    loadSavedSettings();
    applyTheme();
});

// ===== ãƒ†ãƒ¼ãƒç®¡ç† =====
let currentTheme='dark';

function toggleTheme(){
    currentTheme=currentTheme==='dark'?'light':'dark';
    applyTheme();
    saveSettingsToStorage();
}

function applyTheme(){
    // Apply theme on <html> (primary) and <body> (defensive)
    document.documentElement.setAttribute('data-theme', currentTheme);
    if(document.body) document.body.setAttribute('data-theme', currentTheme);

    const btn = document.getElementById('theme-toggle');
    if(btn) btn.textContent = (currentTheme==='dark' ? 'ğŸŒ™' : 'â˜€ï¸');
}

// ===== LocalStorageè¨­å®šä¿å­˜ =====
function saveSettingsToStorage(){
    try{
        const settings={
            theme:currentTheme,
            targetMargin:document.getElementById('target-margin')?.value||'25.00',
            warningMargin:document.getElementById('warning-margin')?.value||'23.00',
            hanaRate:document.getElementById('hana-rate')?.value||'0.80',
            sanchokuRate:document.getElementById('sanchoku-rate')?.value||'0.85',
            marginRate:document.getElementById('margin-rate')?.value||'0.26',
            supplierSettings:SUPPLIER_SETTINGS,
            supplierCatMap:SUPPLIER_CAT_MAP
        };
        localStorage.setItem('shiire_settings_v8',JSON.stringify(settings));
    }catch(e){console.warn('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:',e);}
}

function loadSavedSettings(){
    try{
        const saved=localStorage.getItem('shiire_settings_v8');
        if(saved){
            const s=JSON.parse(saved);
            currentTheme=s.theme||'dark';
            if(s.targetMargin)document.getElementById('target-margin').value=s.targetMargin;
            if(s.warningMargin)document.getElementById('warning-margin').value=s.warningMargin;
            if(s.hanaRate)document.getElementById('hana-rate').value=s.hanaRate;
            if(s.sanchokuRate)document.getElementById('sanchoku-rate').value=s.sanchokuRate;
            if(s.marginRate)document.getElementById('margin-rate').value=s.marginRate;
            if(s.supplierSettings)Object.assign(SUPPLIER_SETTINGS,s.supplierSettings);
            if(s.supplierCatMap)Object.assign(SUPPLIER_CAT_MAP,s.supplierCatMap);
            showToast('ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ','info');
        }
    }catch(e){console.warn('è¨­å®šèª­è¾¼ã‚¨ãƒ©ãƒ¼:',e);}
}

// ===== è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« =====
function showSettingsModal(){
    renderSettingsContent();
    document.getElementById('settings-modal').style.display='flex';
}

function closeSettingsModal(){
    document.getElementById('settings-modal').style.display='none';
}

function renderSettingsContent(){
    const container=document.getElementById('settings-content');
    container.innerHTML=("\n        <div style=\"margin-bottom:20px\">\n            <div style=\"font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px\">\ud83d\udcca \u76ee\u6a19\u8a2d\u5b9a</div>\n            <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:8px\">\n                <div style=\"background:var(--bg3);padding:10px;border-radius:7px\">\n                    <label style=\"display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px\">\u76ee\u6a19\u7c97\u5229\u7387 (%)</label>\n                    <input type=\"number\" id=\"set-target-margin\" value=\"" + (document.getElementById('target-margin')?.value||'25.00') + "\" step=\"0.01\" style=\"width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem\">\n                </div>\n                <div style=\"background:var(--bg3);padding:10px;border-radius:7px\">\n                    <label style=\"display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px\">\u8b66\u544a\u3057\u304d\u3044\u5024 (%)</label>\n                    <input type=\"number\" id=\"set-warning-margin\" value=\"" + (document.getElementById('warning-margin')?.value||'23.00') + "\" step=\"0.01\" style=\"width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem\">\n                </div>\n            </div>\n        </div>\n        <div style=\"margin-bottom:20px\">\n            <div style=\"font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px\">\ud83c\udf38 \u58f2\u4e0a\u7d0d\u54c1\u639b\u7387</div>\n            <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:8px\">\n                <div style=\"background:var(--bg3);padding:10px;border-radius:7px\">\n                    <label style=\"display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px\">\u82b1 \u639b\u3051\u7387</label>\n                    <input type=\"number\" id=\"set-hana-rate\" value=\"" + (document.getElementById('hana-rate')?.value||'0.80') + "\" step=\"0.01\" style=\"width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem\">\n                </div>\n                <div style=\"background:var(--bg3);padding:10px;border-radius:7px\">\n                    <label style=\"display:block;font-size:0.6rem;color:var(--text4);margin-bottom:4px\">\u7523\u76f4 \u639b\u3051\u7387</label>\n                    <input type=\"number\" id=\"set-sanchoku-rate\" value=\"" + (document.getElementById('sanchoku-rate')?.value||'0.85') + "\" step=\"0.01\" style=\"width:100%;padding:6px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.8rem\">\n                </div>\n            </div>\n        </div>\n        <div style=\"margin-bottom:20px\">\n            <div style=\"font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px\">\ud83c\udfa8 \u8868\u793a\u8a2d\u5b9a</div>\n            <div style=\"background:var(--bg3);padding:12px;border-radius:7px;display:flex;justify-content:space-between;align-items:center\">\n                <div>\n                    <div style=\"font-size:0.75rem;font-weight:500\">\u30c6\u30fc\u30de</div>\n                    <div style=\"font-size:0.6rem;color:var(--text4)\">\u30c0\u30fc\u30af / \u30e9\u30a4\u30c8</div>\n                </div>\n                <select id=\"set-theme\" style=\"padding:6px 12px;background:var(--bg4);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:0.75rem\">\n                    <option value=\"dark\" " + (currentTheme==='dark'?'selected':'') + ">\ud83c\udf19 \u30c0\u30fc\u30af</option>\n                    <option value=\"light\" " + (currentTheme==='light'?'selected':'') + ">\u2600\ufe0f \u30e9\u30a4\u30c8</option>\n                </select>\n            </div>\n        </div>\n        <div style=\"margin-bottom:20px\">\n            <div style=\"font-size:0.8rem;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:6px\">\ud83d\udcbe \u30c7\u30fc\u30bf\u7ba1\u7406</div>\n            <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:8px\">\n                <button onclick=\"exportSettings()\" style=\"padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px\">\ud83d\udce4 \u8a2d\u5b9a\u30a8\u30af\u30b9\u30dd\u30fc\u30c8</button>\n                <button onclick=\"document.getElementById('import-settings').click()\" style=\"padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px\">\ud83d\udce5 \u8a2d\u5b9a\u30a4\u30f3\u30dd\u30fc\u30c8</button>\n                <input type=\"file\" id=\"import-settings\" accept=\".json\" style=\"display:none\" onchange=\"importSettings(this)\">\n            </div>\n            <button onclick=\"clearAllSettings()\" style=\"width:100%;margin-top:8px;padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:7px;color:var(--danger);font-size:0.7rem;cursor:pointer\">\ud83d\uddd1\ufe0f \u5168\u8a2d\u5b9a\u3092\u30ea\u30bb\u30c3\u30c8</button>\n        </div>\n    ");
}

function saveAllSettings(){
    document.getElementById('target-margin').value=document.getElementById('set-target-margin').value;
    document.getElementById('warning-margin').value=document.getElementById('set-warning-margin').value;
    document.getElementById('hana-rate').value=document.getElementById('set-hana-rate').value;
    document.getElementById('sanchoku-rate').value=document.getElementById('set-sanchoku-rate').value;
    currentTheme=document.getElementById('set-theme').value;
    applyTheme();
    saveSettingsToStorage();
    closeSettingsModal();
    showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ','success');
    if(result)render();
}

function exportSettings(){
    const settings={
        version:'v8',
        exportDate:new Date().toISOString(),
        theme:currentTheme,
        targetMargin:document.getElementById('target-margin')?.value,
        warningMargin:document.getElementById('warning-margin')?.value,
        hanaRate:document.getElementById('hana-rate')?.value,
        sanchokuRate:document.getElementById('sanchoku-rate')?.value,
        marginRate:document.getElementById('margin-rate')?.value,
        supplierSettings:SUPPLIER_SETTINGS,
        supplierCatMap:SUPPLIER_CAT_MAP
    };
    const blob=new Blob([JSON.stringify(settings,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='shiire_settings_'+new Date().toISOString().slice(0,10)+'.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
}

function importSettings(input){
    const file=input.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=e=>{
        try{
            const s=JSON.parse(e.target.result);
            if(s.theme)currentTheme=s.theme;
            if(s.targetMargin)document.getElementById('target-margin').value=s.targetMargin;
            if(s.warningMargin)document.getElementById('warning-margin').value=s.warningMargin;
            if(s.hanaRate)document.getElementById('hana-rate').value=s.hanaRate;
            if(s.sanchokuRate)document.getElementById('sanchoku-rate').value=s.sanchokuRate;
            if(s.marginRate)document.getElementById('margin-rate').value=s.marginRate;
            if(s.supplierSettings)Object.assign(SUPPLIER_SETTINGS,s.supplierSettings);
            if(s.supplierCatMap)Object.assign(SUPPLIER_CAT_MAP,s.supplierCatMap);
            applyTheme();
            saveSettingsToStorage();
            renderSettingsContent();
            showToast('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
        }catch(err){
            showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: '+err.message,'error');
        }
    };
    reader.readAsText(file);
    input.value='';
}

function clearAllSettings(){
    if(!confirm('å…¨ã¦ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ'))return;
    localStorage.removeItem('shiire_settings_v8');
    currentTheme='dark';
    SUPPLIER_SETTINGS={'0074721':{marginRate:0.26,usePriceCalc:true}};
    document.getElementById('target-margin').value='25.00';
    document.getElementById('warning-margin').value='23.00';
    document.getElementById('hana-rate').value='0.80';
    document.getElementById('sanchoku-rate').value='0.85';
    document.getElementById('margin-rate').value='0.26';
    applyTheme();
    renderSettingsContent();
    showToast('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ','info');
}

// ===== ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ =====
let validationWarnings=[];

function validateData(){
    validationWarnings=[];
    
    // å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    if(!DATA.shiire)validationWarnings.push({type:'error',msg:'ä»•å…¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'ä»•å…¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'});
    if(!DATA.uriage)validationWarnings.push({type:'error',msg:'å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'å£²ä¸Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„'});
    
    // åº—èˆ—æ•°ãƒã‚§ãƒƒã‚¯
    const storeCount=Object.keys(STORES).length;
    if(storeCount===0)validationWarnings.push({type:'warning',msg:'åº—èˆ—ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“',detail:'ä»•å…¥ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„'});
    
    // åœ¨åº«è¨­å®šãƒã‚§ãƒƒã‚¯
    const invCount=Object.keys(STORE_INVENTORY).length;
    if(invCount===0)validationWarnings.push({type:'warning',msg:'åœ¨åº«è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“',detail:'åˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã‹ã€æ‰‹å‹•ã§è¨­å®šã—ã¦ãã ã•ã„'});
    else if(invCount<storeCount)validationWarnings.push({type:'warning',msg:("\u4e00\u90e8\u5e97\u8217\u306e\u5728\u5eab\u8a2d\u5b9a\u304c\u3042\u308a\u307e\u305b\u3093 (" + (invCount) + "/" + (storeCount) + ")"),detail:'å…¨åº—èˆ—ã®æœŸé¦–ãƒ»æœŸæœ«åœ¨åº«ã‚’è¨­å®šã—ã¦ãã ã•ã„'});
    
    // äºˆç®—ãƒã‚§ãƒƒã‚¯
    const budgetCount=Object.keys(STORE_BUDGET).length;
    if(budgetCount===0)validationWarnings.push({type:'info',msg:'äºˆç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ã‚ˆã‚Šè©³ç´°ãªåˆ†æãŒå¯èƒ½ã§ã™'});
    
    // å£²å¤‰ãƒã‚§ãƒƒã‚¯
    if(!DATA.baihen)validationWarnings.push({type:'info',msg:'å£²å¤‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',detail:'å£²å¤‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨æ¨å®šç²—åˆ©è¨ˆç®—ãŒå¯èƒ½ã§ã™'});
    
    return validationWarnings.filter(w=>w.type==='error').length===0;
}

function showValidationModal(){
    const container=document.getElementById('validation-content');
    let h='<div style="display:flex;flex-direction:column;gap:8px">';
    
    if(validationWarnings.length===0){
        h+='<div style="text-align:center;padding:24px;color:var(--success)"><div style="font-size:2rem;margin-bottom:8px">âœ…</div><div style="font-weight:600">å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸ</div></div>';
    }else{
        validationWarnings.forEach(w=>{
            const color=w.type==='error'?'var(--danger)':w.type==='warning'?'var(--warning)':'var(--info)';
            const icon=w.type==='error'?'âŒ':w.type==='warning'?'âš ï¸':'â„¹ï¸';
            h+=("<div style=\"padding:12px;background:var(--bg3);border-radius:8px;border-left:3px solid " + (color) + "\">\n                <div style=\"display:flex;align-items:center;gap:8px;margin-bottom:4px\">\n                    <span>" + (icon) + "</span>\n                    <span style=\"font-weight:600;color:" + (color) + "\">" + (w.msg) + "</span>\n                </div>\n                <div style=\"font-size:0.7rem;color:var(--text3);margin-left:24px\">" + (w.detail) + "</div>\n            </div>");
        });
    }
    
    h+='</div>';
    container.innerHTML=h;
    document.getElementById('validation-modal').style.display='flex';
}

function closeValidationModal(){
    document.getElementById('validation-modal').style.display='none';
}

function proceedWithWarnings(){
    closeValidationModal();
    generateWithoutValidation();
}

document.getElementById('view-tabs').addEventListener('click',e=>{const t=e.target.closest('.topbar-tab');if(!t)return;currentView=t.dataset.view;syncViewTabs();if(result)render();});
bindFileLoaders();
appState.subscribe((next,prev,changed)=>{
  if(changed.indexOf('result')!==-1 && typeof render==='function' && next.result){
    try{ render(); }catch(e){}
  }
});
document.getElementById('store-chips').addEventListener('click', e=>{
  // Multi-select store chips are handled by bindChips() (store selection module).
  // Keep this legacy handler inert to avoid overriding multi-selection behavior.
  if(window.__STORE_SELECTION__ && window.__STORE_SELECTION__.set) return;
  const c = e.target.closest('.chip'); if(!c) return;
  document.querySelectorAll('#store-chips .chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');
  currentStore = normalizeStoreId(c.dataset.store);
  if(result) render();
});

async function loadFile(input, key){
    const file = input?.files?.[0];
    if(!file) return;

    const card = input.closest('.upload-card');

    try{
        const rows = await readTabularFile(file);
        DATA[key] = rows;

        if(card) card.classList.add('loaded');

        const ext = (file.name.split('.').pop()||'').toLowerCase();
        showToast(((file.name) + " \u3092\u8aad\u8fbc\u307f\u307e\u3057\u305f" + (ext==='csv' ? 'ï¼ˆCSVï¼‰' : '')), 'success');

        // ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¾Œå‡¦ç†
        if(key==='shiire') detectStoresAndSuppliers();
        if(key==='hana' || key==='sanchoku') detectStoresFromHanaSanchoku(key);
        if(key==='settings') processSettings();
        if(key==='budget') processBudget();

        const btn = document.getElementById('btn-generate');
        if(btn) btn.disabled = !(DATA.shiire && DATA.uriage);
    }catch(err){
        const message = window.ImportErrors.getImportErrorMessage(err);
        showToast((file.name + ': ' + message), 'error');
    }finally{
        // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«
        try{ input.value=''; }catch(e){}
    }
}

// DI: bind file inputs/events without window.* assignments
function bindFileLoaders(){
  document.querySelectorAll('input[data-load-key]').forEach(input=>{
    if(input.dataset.boundLoad==='1') return;
    input.dataset.boundLoad='1';
    input.addEventListener('change',()=>{
      const key=input.dataset.loadKey;
      if(!key) return;
      document.dispatchEvent(new CustomEvent('app:load-file',{detail:{input,key}}));
    });
  });
}
document.addEventListener('app:load-file',e=>{
  const d=e.detail||{};
  if(d.input && d.key) loadFile(d.input, d.key);
});


// åˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
function processSettings(){
    const data=DATA.settings;
    if(!data||data.length<2)return;

    for(let row=1;row<data.length;row++){
        const storeCode=data[row][0];
        const invStart=parseFloat(data[row][1])||0;
        const invEnd=parseFloat(data[row][2])||0;
        // 4åˆ—ç›®ï¼ˆDåˆ—ï¼‰ã‚’ã€Œæœˆé–“ç²—åˆ©é¡äºˆç®—ã€ã¨ã—ã¦æ‰±ã†ï¼ˆç„¡ã„å ´åˆã¯0ï¼‰
        const gpBudget=parseFloat(data[row][3])||0;

        if(storeCode){
            const sid=String(parseInt(storeCode));
            STORE_INVENTORY[sid]={invStart,invEnd};
            if(gpBudget>0) STORE_GP_BUDGET[sid]=gpBudget;
        }
    }

    updateStoreInventoryUI();
    showToast('åˆæœŸè¨­å®šï¼ˆåœ¨åº«ãƒ»ç²—åˆ©äºˆç®—ï¼‰ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ','success');
}

// æ¶ˆè€—å“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showConsumableModal(){
    updateConsumableStatus();
    document.getElementById('consumable-modal').style.display='flex';
}

function closeConsumableModal(){
    document.getElementById('consumable-modal').style.display='none';
}

// ä»•å…¥å…ˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«
function showSupplierSettingsModal(){
    updateSupplierSettingsUI();
    document.getElementById('supplier-settings-modal').style.display='flex';
}

function closeSupplierSettingsModal(){
    document.getElementById('supplier-settings-modal').style.display='none';
}

function updateSupplierSettingsUI(){
    const container=document.getElementById('supplier-settings-content');
    const supCodes=Object.keys(SUPPLIERS).sort();
    if(supCodes.length===0){
        container.innerHTML='<div style="font-size:0.65rem;color:var(--text4);padding:16px;text-align:center">ä»•å…¥ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
        return;
    }
    
    const catOptions=Object.entries(CATEGORIES).map(([k,v])=>'<option value="'+k+'">'+v.icon+' '+v.name+'</option>').join('');
    
    let h='<table style="width:100%;font-size:0.68rem;border-collapse:collapse">';
    h+='<thead><tr style="background:var(--bg4);position:sticky;top:0"><th style="padding:8px;text-align:left">ã‚³ãƒ¼ãƒ‰</th><th style="padding:8px;text-align:left">ä»•å…¥å…ˆå</th><th style="padding:8px;text-align:center">å¸³åˆåˆ†é¡</th><th style="padding:8px;text-align:center">å£²ä¾¡è¨ˆç®—</th><th style="padding:8px;text-align:center">å€¤å…¥ç‡</th></tr></thead><tbody>';
    
    supCodes.forEach(code=>{
        const sup=SUPPLIERS[code];
        const setting=SUPPLIER_SETTINGS[code]||{};
        const currentCat=SUPPLIER_CAT_MAP[code]||'other';
        const usePriceCalc=setting.usePriceCalc||false;
        const marginRate=setting.marginRate||0.26;
        
        h+='<tr style="border-bottom:1px solid var(--border)">';
        h+='<td style="padding:6px;font-family:\'JetBrains Mono\',monospace;color:var(--text3)">'+code+'</td>';
        h+='<td style="padding:6px">'+sup.name+'</td>';
        h+='<td style="padding:6px"><select data-code="'+code+'" data-field="cat" style="width:100%;padding:4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:0.65rem">';
        Object.entries(CATEGORIES).forEach(([k,v])=>{
            h+='<option value="'+k+'"'+(k===currentCat?' selected':'')+'>'+v.icon+' '+v.name+'</option>';
        });
        h+='</select></td>';
        h+='<td style="padding:6px;text-align:center"><label style="display:flex;align-items:center;justify-content:center;gap:4px;cursor:pointer"><input type="checkbox" data-code="'+code+'" data-field="usePriceCalc" '+(usePriceCalc?'checked':'')+' style="accent-color:var(--primary)"> <span style="font-size:0.6rem;color:var(--text3)">å€¤å…¥ç‡ã‹ã‚‰ç®—å‡º</span></label></td>';
        h+='<td style="padding:6px"><input type="text" data-code="'+code+'" data-field="marginRate" value="'+marginRate+'" style="width:60px;padding:4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:0.65rem;text-align:center" '+(usePriceCalc?'':'disabled')+'></td>';
        h+='</tr>';
    });
    h+='</tbody></table>';
    
    h+='<div style="margin-top:12px;padding:10px;background:var(--bg4);border-radius:6px;font-size:0.6rem;color:var(--text3)">';
    h+='<strong>ğŸ’¡ å£²ä¾¡è¨ˆç®—ã«ã¤ã„ã¦:</strong><br>';
    h+='ã€Œå€¤å…¥ç‡ã‹ã‚‰ç®—å‡ºã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã¨ã€ä»•å…¥ãƒ•ã‚¡ã‚¤ãƒ«ã®å£²ä¾¡ã‚’ç„¡è¦–ã—ã€åŸä¾¡Ã·(1-å€¤å…¥ç‡)ã§å£²ä¾¡ã‚’å†è¨ˆç®—ã—ã¾ã™ã€‚<br>';
    h+='ï¼ˆä¾‹: 0074721 ã‚ã•ãã‚‰ã‚»ãƒ³ã‚¿ã®å£²ä¾¡ãŒä»®ã®å ´åˆã«ä½¿ç”¨ï¼‰';
    h+='</div>';
    
    container.innerHTML=h;
    
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«å€¤å…¥ç‡å…¥åŠ›ã‚’æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
    container.querySelectorAll('input[data-field="usePriceCalc"]').forEach(cb=>{
        cb.addEventListener('change',e=>{
            const code=e.target.dataset.code;
            const marginInput=container.querySelector('input[data-code="'+code+'"][data-field="marginRate"]');
            if(marginInput)marginInput.disabled=!e.target.checked;
        });
    });
}

function saveSupplierSettings(){
    const container=document.getElementById('supplier-settings-content');
    
    // å¸³åˆåˆ†é¡ã‚’æ›´æ–°
    container.querySelectorAll('select[data-field="cat"]').forEach(sel=>{
        SUPPLIER_CAT_MAP[sel.dataset.code]=sel.value;
        if(SUPPLIERS[sel.dataset.code])SUPPLIERS[sel.dataset.code].cat=sel.value;
    });
    
    // ä»•å…¥å…ˆè¨­å®šã‚’æ›´æ–°
    container.querySelectorAll('input[data-field="usePriceCalc"]').forEach(cb=>{
        const code=cb.dataset.code;
        const marginInput=container.querySelector('input[data-code="'+code+'"][data-field="marginRate"]');
        if(!SUPPLIER_SETTINGS[code])SUPPLIER_SETTINGS[code]={};
        SUPPLIER_SETTINGS[code].usePriceCalc=cb.checked;
        SUPPLIER_SETTINGS[code].marginRate=parseFloat(marginInput?.value)||0.26;
    });
    
    closeSupplierSettingsModal();
    showToast('ä»•å…¥å…ˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ','success');
}

function updateConsumableStatus(){
    const countEl=document.getElementById('consumable-count');
    const storeCount=Object.keys(CONSUMABLES).length;
    if(storeCount===0){
        countEl.innerHTML='æœªèª­è¾¼';
        return;
    }
    let totalCost=0,totalItems=0;
    Object.values(CONSUMABLES).forEach(storeDays=>{
        Object.values(storeDays).forEach(day=>{
            totalCost+=day.cost;
            totalItems+=day.items.length;
        });
    });
    countEl.innerHTML=storeCount+'åº—èˆ— / '+totalItems+'å“ç›® / <span style="color:#f97316">'+fmt(totalCost)+'å††</span>';
}

function selectConsumableFiles(){
    document.getElementById('consumable-input').click();
}

let consumableMode='overwrite';

function processConsumableFiles(input){
    const files = input?.files;
    if(!files || files.length===0) return;

    consumableMode = document.querySelector('input[name="consumable-mode"]:checked')?.value || 'overwrite';
    closeConsumableModal();

    // âœ… :has() ã¯ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã«é›£ãŒã‚ã‚‹ãŸã‚ã€å¿…ãšIDã‹ã‚‰è¾¿ã‚‹
    const card = document.getElementById('consumable-input')?.closest('.upload-card');

    // ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¯ãƒªã‚¢
    if(consumableMode==='overwrite'){
        CONSUMABLES = {};
    }

    let finished = 0;
    let success  = 0;
    let totalCost = 0;
    let newItems  = 0;

    const finalize = ()=>{
        if(finished !== files.length) return;
        if(card) card.classList.add('loaded');

        const modeText = consumableMode==='overwrite' ? 'ä¸Šæ›¸ã' : 'è¿½åŠ ';
        showToast(("\u539f\u4fa1\u7b97\u5165\u6bd4 " + (success) + "/" + (files.length) + "\u30d5\u30a1\u30a4\u30eb" + (modeText) + " (" + (newItems) + "\u54c1/" + (fmt(totalCost)) + ")"), success>0 ? 'success' : 'warning');

        // ãƒªã‚»ãƒƒãƒˆã—ã¦åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«
        try{ input.value=''; }catch(e){}
    };

    Array.from(files).forEach(async (file)=>{
        try{
            const data = await readTabularFile(file); // Excel/CSV å…±é€š
            if(!data || data.length<2){
                throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆå…ˆé ­2æ¡ï¼‰
            const storeMatch = file.name.match(/^(\d{2})/);
            if(!storeMatch) throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«åå…ˆé ­2æ¡ã‹ã‚‰åº—èˆ—ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã§ãã¾ã›ã‚“');
            const sid = String(parseInt(storeMatch[1], 10));

            // å‹˜å®šã‚³ãƒ¼ãƒ‰81257ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
            for(let row=1; row<data.length; row++){
                const kamokuCode = String(data[row]?.[0] ?? '');
                if(kamokuCode !== '81257') continue;

                const itemCode = String(data[row]?.[1] ?? '');
                const itemName = String(data[row]?.[2] ?? '');
                const qty  = parseFloat(data[row]?.[3]) || 0;
                const cost = parseFloat(data[row]?.[4]) || 0;
                const dateStr = String(data[row]?.[5] ?? '');

                const date = parseDate(dateStr);
                if(!date) continue;

                const day = date.getDate();

                if(!CONSUMABLES[sid]) CONSUMABLES[sid] = {};
                if(!CONSUMABLES[sid][day]) CONSUMABLES[sid][day] = { cost:0, items:[] };

                CONSUMABLES[sid][day].cost += cost;
                CONSUMABLES[sid][day].items.push({ itemCode, itemName, qty, cost });

                totalCost += cost;
                newItems++;
            }

            success++;
        }catch(err){
            showToast('æ¶ˆè€—å“èª­è¾¼ã‚¨ãƒ©ãƒ¼: ' + (err?.message || err), 'error');
        }finally{
            finished++;
            finalize();
        }
    });
}

// äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
function processBudget(){
    const data=DATA.budget;if(!data||data.length<2)return;
    STORE_BUDGET={};
    BUDGET_RANGE={min:null,max:null};
    for(let row=1;row<data.length;row++){
        const storeCode=data[row][0];
        const dateStr=String(data[row][1]||'');
        let budgetVal=parseFloat(data[row][2]);
        if(isNaN(budgetVal)) budgetVal=0;
        if(!storeCode)continue;
        const sid=String(parseInt(storeCode));
        const date=parseDate(dateStr);
        if(!date)continue;
        // æœŸé–“ãƒ¬ãƒ³ã‚¸æ›´æ–°ï¼ˆ0å††ã®æ—¥ã‚‚ãƒ¬ãƒ³ã‚¸è¨ˆç®—ã«ã¯å«ã‚ã‚‹ï¼‰
        if(!BUDGET_RANGE.min || date < BUDGET_RANGE.min) BUDGET_RANGE.min = date;
        if(!BUDGET_RANGE.max || date > BUDGET_RANGE.max) BUDGET_RANGE.max = date;
        // v9.7: 0ä»¥ä¸‹ã¯ã€Œäºˆç®—ãªã—ã€ã¨ã—ã¦æ‰±ã†ï¼ˆç©ºæ¬„ãƒ»æœªè¨­å®šã®é™¤å¤–ï¼‰
        if(budgetVal<=0) continue;
        const day=date.getDate();
        if(!STORE_BUDGET[sid])STORE_BUDGET[sid]={daily:{},total:0};
        STORE_BUDGET[sid].daily[day]=budgetVal;
        STORE_BUDGET[sid].total+=budgetVal;
    }
    showToast('æ—¥åˆ¥äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ'+Object.keys(STORE_BUDGET).length+'åº—èˆ—ï¼‰','success');
}

// å£²å¤‰ï¼ˆå€¤å¼•ï¼‰ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
function processBaihen(){
    const data=DATA.baihen;if(!data||data.length<3)return {};
    BAIHEN_RANGE={min:null,max:null};
    const r={},cols={};
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(row 0)ã‹ã‚‰åº—èˆ—ã‚’æ¤œå‡º
    for(let col=3;col<data[0].length;col+=2){
        const stoStr=String(data[0][col]||'');
        const stoMatch=stoStr.match(/(\d{4}):/);
        if(stoMatch){
            const sid=String(parseInt(stoMatch[1]));
            cols[sid]={sales:col,baihen:col+1};
        }
    }
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†ï¼ˆrow 2ã‹ã‚‰ï¼šæœŸé–“åˆ¥è¡Œã®æ¬¡ãŒæ—¥æ¬¡è¡Œï¼‰
    for(let row=2;row<data.length;row++){
        const dateStr=String(data[row][0]||'');
        const date=parseDate(dateStr);
        if(!date)continue;
        const day=date.getDate();
        Object.entries(cols).forEach(([sid,colInfo])=>{
            const sales=parseFloat(data[row][colInfo.sales])||0;
            const baihen=parseFloat(data[row][colInfo.baihen])||0; // ãƒã‚¤ãƒŠã‚¹å€¤
            if(sales===0)return;
            if(!r[sid])r[sid]={};
            r[sid][day]={sales,baihen:Math.abs(baihen)}; // çµ¶å¯¾å€¤ã§ä¿å­˜
        });
    }
    return r;
}

// åº—èˆ—åˆ¥åœ¨åº«UIã‚’æ›´æ–°
function updateStoreInventoryUI(){
    const container=document.getElementById('store-inventory-container');
    const storeIds=Object.keys(STORES).sort((a,b)=>+a-+b);
    if(storeIds.length===0){
        container.innerHTML='<div style="font-size:0.65rem;color:var(--text4);padding:8px;text-align:center">åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­è¾¼å¾Œã«è¡¨ç¤º</div>';
        return;
    }
    let h='<table style="width:100%;font-size:0.62rem;border-collapse:collapse"><thead><tr style="background:var(--bg4)"><th style="padding:4px;text-align:left">åº—èˆ—</th><th style="padding:4px;text-align:right">æœŸé¦–åœ¨åº«</th><th style="padding:4px;text-align:right">æœŸæœ«åœ¨åº«</th></tr></thead><tbody>';
    storeIds.forEach(sid=>{
        const st=STORES[sid];
        const inv=STORE_INVENTORY[sid]||{invStart:0,invEnd:0};
        h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:4px;color:var(--text2)">'+sid.padStart(2,'0')+' '+(st?.name||'')+'</td><td style="padding:2px"><input type="text" class="inv-input" data-store="'+sid+'" data-type="start" value="'+fmt(inv.invStart)+'" onchange="updateStoreInv(this)" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:3px 5px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:0.62rem;text-align:right"></td><td style="padding:2px"><input type="text" class="inv-input" data-store="'+sid+'" data-type="end" value="'+fmt(inv.invEnd)+'" onchange="updateStoreInv(this)" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:3px 5px;color:var(--text);font-family:\'JetBrains Mono\',monospace;font-size:0.62rem;text-align:right"></td></tr>';
    });
    h+='</tbody></table>';
    container.innerHTML=h;
}

// åº—èˆ—åœ¨åº«ã‚’æ›´æ–°
function updateStoreInv(el){
    const sid=el.dataset.store;
    const type=el.dataset.type;
    const val=parseNum(el.value);
    if(!STORE_INVENTORY[sid])STORE_INVENTORY[sid]={invStart:0,invEnd:0};
    if(type==='start')STORE_INVENTORY[sid].invStart=val;
    else STORE_INVENTORY[sid].invEnd=val;
    el.value=fmt(val);
}

// èŠ±ãƒ»ç”£ç›´ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åº—èˆ—ã‚’æ¤œå‡º
function detectStoresFromHanaSanchoku(type){const data=DATA[type];if(!data||data.length<2)return;for(let col=3;col<data[0].length;col+=2){const stoStr=String(data[0][col]||'');const stoMatch=stoStr.match(/(\d{4}):(.+)$/);if(stoMatch){const code=stoMatch[1],name=stoMatch[2].replace(/æ¯æ—¥å±‹/g,'').trim(),id=String(parseInt(code));if(!STORES[id])STORES[id]={code,name};}}updateStoreChips();updateStoreInventoryUI();}

function detectStoresAndSuppliers(){const data=DATA.shiire;if(!data||data.length<2)return;STORES={};SUPPLIERS={};for(let col=3;col<data[0].length;col+=2){const supStr=String(data[0][col]||''),stoStr=String(data[1][col]||'');const supMatch=supStr.match(/(\d{7}):?(.*)$/);if(supMatch){const code=supMatch[1],name=supMatch[2]?.trim()||code;if(!SUPPLIERS[code])SUPPLIERS[code]={name,cat:SUPPLIER_CAT_MAP[code]||'other'};}const stoMatch=stoStr.match(/(\d{4}):(.+)$/);if(stoMatch){const code=stoMatch[1],name=stoMatch[2].replace(/æ¯æ—¥å±‹/g,'').trim(),id=String(parseInt(code));if(!STORES[id])STORES[id]={code,name};}}updateStoreChips();updateStoreInventoryUI();}

function updateStoreChips(){const c=document.getElementById('store-chips');let h='<div class="chip active" data-store="all">å…¨åº—èˆ—</div>';Object.entries(STORES).sort((a,b)=>+a[0]-+b[0]).forEach(([id])=>{h+='<div class="chip" data-store="'+id+'">'+id.padStart(2,'0')+'</div>';});c.innerHTML=h;}

function processShiire(){const data=DATA.shiire;if(!data||data.length<4)return {};const r={};for(let col=3;col<data[0].length;col+=2){const supMatch=String(data[0][col]||'').match(/(\d{7})/),stoMatch=String(data[1][col]||'').match(/(\d{4}):/);if(!supMatch||!stoMatch)continue;const sc=supMatch[1],si=SUPPLIERS[sc]||{name:sc,cat:'other'},sid=String(parseInt(stoMatch[1]));if(!STORES[sid])continue;
// ä»•å…¥å…ˆè¨­å®šã‚’å–å¾—
const supSetting=SUPPLIER_SETTINGS[sc]||{};
const usePriceCalc=supSetting.usePriceCalc||false;
const supMarginRate=supSetting.marginRate||0.26;
for(let row=4;row<data.length;row++){const date=parseDate(data[row][0]);if(!date)continue;const day=date.getDate(),cost=parseFloat(data[row][col])||0;let price=parseFloat(data[row][col+1])||0;
// å£²ä¾¡è¨ˆç®—è¨­å®šãŒã‚ã‚‹å ´åˆã¯å€¤å…¥ç‡ã‹ã‚‰å£²ä¾¡ã‚’å†è¨ˆç®—
if(usePriceCalc&&cost>0){price=Math.round(cost/(1-supMarginRate));}
if(cost===0&&price===0)continue;if(!r[sid])r[sid]={};if(!r[sid][day])r[sid][day]={suppliers:{},total:{cost:0,price:0}};if(!r[sid][day].suppliers[sc])r[sid][day].suppliers[sc]={...si,cost:0,price:0,usePriceCalc};r[sid][day].suppliers[sc].cost+=cost;r[sid][day].suppliers[sc].price+=price;r[sid][day].total.cost+=cost;r[sid][day].total.price+=price;}}return r;}

function processUriage(){const data=DATA.uriage;if(!data||data.length<3)return {};const r={},cols={};for(let col=3;col<data[0].length;col+=2){const m=String(data[0][col]||'').match(/(\d{4}):/);if(m){const sid=String(parseInt(m[1]));if(STORES[sid])cols[sid]=col;}}for(let row=3;row<data.length;row++){const date=parseDate(data[row][0]);if(!date)continue;const day=date.getDate();Object.entries(cols).forEach(([sid,col])=>{if(!r[sid])r[sid]={};r[sid][day]={sales:parseFloat(data[row][col])||0};});}return r;}

// åº—é–“éƒ¨é–€é–“å…¥: åº—èˆ—ã‚³ãƒ¼ãƒ‰=åº—ã‚³ãƒ¼ãƒ‰OUTâ†’éƒ¨é–€é–“å…¥, ç•°ãªã‚‹â†’åº—é–“å…¥
function processTenkanIn(){const data=DATA.tenkanIn;if(!data||data.length<2)return {};const r={};for(let row=1;row<data.length;row++){const storeCode=String(data[row][0]||'').trim(),dateVal=data[row][1],storeCodeOut=String(data[row][2]||'').trim(),costIn=Math.abs(parseFloat(data[row][3])||0),priceIn=Math.abs(parseFloat(data[row][4])||0);const date=parseDate(dateVal);if(!date)continue;const day=date.getDate(),sid=String(parseInt(storeCode)||0),sidOut=String(parseInt(storeCodeOut)||0);if(!STORES[sid])continue;const isBumon=(storeCode===storeCodeOut)||(sid===sidOut);if(!r[sid])r[sid]={};if(!r[sid][day])r[sid][day]={tenkanIn:[],bumonIn:[]};if(isBumon){r[sid][day].bumonIn.push({cost:costIn,price:priceIn,fromStore:sidOut});}else{r[sid][day].tenkanIn.push({cost:costIn,price:priceIn,fromStore:sidOut,fromStoreName:STORES[sidOut]?.name||sidOut});}}return r;}

// åº—é–“éƒ¨é–€é–“å‡º: åº—èˆ—ã‚³ãƒ¼ãƒ‰=åº—ã‚³ãƒ¼ãƒ‰INâ†’éƒ¨é–€é–“å‡º, ç•°ãªã‚‹â†’åº—é–“å‡º
function processTenkanOut(){const data=DATA.tenkanOut;if(!data||data.length<2)return {};const r={};for(let row=1;row<data.length;row++){const dateVal=data[row][0],storeCode=String(data[row][1]||'').trim(),storeCodeIn=String(data[row][2]||'').trim(),bumonCodeIn=String(data[row][3]||'').trim(),costOut=-Math.abs(parseFloat(data[row][4])||0),priceOut=-Math.abs(parseFloat(data[row][5])||0);const date=parseDate(dateVal);if(!date)continue;const day=date.getDate(),sid=String(parseInt(storeCode)||0),sidIn=String(parseInt(storeCodeIn)||0);if(!STORES[sid])continue;const isBumon=(storeCode===storeCodeIn)||(sid===sidIn);if(!r[sid])r[sid]={};if(!r[sid][day])r[sid][day]={tenkanOut:[],bumonOut:[]};if(isBumon){r[sid][day].bumonOut.push({cost:costOut,price:priceOut,toStore:sidIn,bumonCode:bumonCodeIn});}else{r[sid][day].tenkanOut.push({cost:costOut,price:priceOut,toStore:sidIn,toStoreName:STORES[sidIn]?.name||sidIn,bumonCode:bumonCodeIn});}}return r;}

// èŠ±ãƒ»ç”£ç›´ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆæ›ã‘ç‡å¯¾å¿œï¼‰- å£²ä¸Šç´å“å½¢å¼
function processHanaSanchoku(type){
    const data=DATA[type];if(!data||data.length<3)return {};
    const rate=parseFloat(document.getElementById(type+'-rate')?.value)||(type==='hana'?0.80:0.85);
    const r={},cols={};
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ(row 0)ã‹ã‚‰åº—èˆ—ã‚’æ¤œå‡º: 0001:åº—èˆ—å å½¢å¼
    for(let col=3;col<data[0].length;col+=2){
        const stoStr=String(data[0][col]||'');
        const stoMatch=stoStr.match(/(\d{4}):/);
        if(stoMatch){const sid=String(parseInt(stoMatch[1]));cols[sid]=col;}
    }
    // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’å‡¦ç†ï¼ˆrow 3ã‹ã‚‰ï¼‰
    for(let row=3;row<data.length;row++){
        const dateStr=String(data[row][0]||'');
        const date=parseDate(dateStr);
        if(!date)continue;
        const day=date.getDate();
        Object.entries(cols).forEach(([sid,col])=>{
            const price=parseFloat(data[row][col])||0;
            if(price===0)return;
            const cost=Math.round(price*rate);
            if(!r[sid])r[sid]={};
            if(!r[sid][day])r[sid][day]={price:0,cost:0};
            r[sid][day].price+=price;
            r[sid][day].cost+=cost;
        });
    }
    return r;
}

function generate(){
    // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
    const isValid=validateData();
    if(!isValid){
        showValidationModal();
        return;
    }
    
    // è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    if(validationWarnings.length>0){
        showValidationModal();
        return;
    }
    
    generateWithoutValidation();
}

function generateWithoutValidation(){document.getElementById('content').innerHTML='<div class="loading-state"><div class="spinner"></div><p>ãƒ‡ãƒ¼ã‚¿å‡¦ç†ä¸­...</p></div>';setTimeout(()=>{try{
const shiire=processShiire(),uriage=processUriage(),tenkanInData=processTenkanIn(),tenkanOutData=processTenkanOut(),hana=processHanaSanchoku('hana'),sanchoku=processHanaSanchoku('sanchoku'),baihenData=processBaihen();
result={};Object.keys(STORES).forEach(sid=>{
const storeInv=STORE_INVENTORY[sid]||{invStart:0,invEnd:0};
const invStart=storeInv.invStart,invEnd=storeInv.invEnd,budget=parseNum(document.getElementById('budget').value),marginRate=parseFloat(document.getElementById('margin-rate').value)||0.26;
const daily={},catTotals={},supTotals={},transferDetails={tenkanIn:[],tenkanOut:[],bumonIn:[],bumonOut:[]};
let totalConsumable=0,totalBaihen=0,totalCoreSales=0,totalCorePrice=0; // åŸä¾¡ç®—å…¥æ¯”åˆè¨ˆã€å£²å¤‰åˆè¨ˆ(çµ¶å¯¾å€¤)ã€ã‚³ã‚¢å£²ä¸Šã€ã‚³ã‚¢å£²ä¾¡
let overDeliveryDays=0, overDeliveryTotal=0; // èŠ±+ç”£ç›´ãŒç·å£²ä¸Šã‚’è¶…ãˆãŸæ—¥ã®è­¦å‘Šç”¨
for(let day=1;day<=31;day++){const s=shiire[sid]?.[day]||{suppliers:{},total:{cost:0,price:0}},u=uriage[sid]?.[day]||{sales:0},ti=tenkanInData[sid]?.[day]||{tenkanIn:[],bumonIn:[]},to=tenkanOutData[sid]?.[day]||{tenkanOut:[],bumonOut:[]},h=hana[sid]?.[day]||{cost:0,price:0},sa=sanchoku[sid]?.[day]||{cost:0,price:0},bh=baihenData[sid]?.[day]||{sales:0,baihen:0};
// åŸä¾¡ç®—å…¥æ¯”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const cons=CONSUMABLES[sid]?.[day]||{cost:0,items:[]};
const tenkanInTotal={cost:0,price:0},tenkanOutTotal={cost:0,price:0},bumonInTotal={cost:0,price:0},bumonOutTotal={cost:0,price:0};
(ti.tenkanIn||[]).forEach(t=>{tenkanInTotal.cost+=t.cost;tenkanInTotal.price+=t.price;});
(ti.bumonIn||[]).forEach(t=>{bumonInTotal.cost+=t.cost;bumonInTotal.price+=t.price;});
(to.tenkanOut||[]).forEach(t=>{tenkanOutTotal.cost+=t.cost;tenkanOutTotal.price+=t.price;});
(to.bumonOut||[]).forEach(t=>{bumonOutTotal.cost+=t.cost;bumonOutTotal.price+=t.price;});
if(u.sales===0&&s.total.cost===0&&tenkanInTotal.cost===0&&tenkanOutTotal.cost===0&&bumonInTotal.cost===0&&bumonOutTotal.cost===0&&h.cost===0&&sa.cost===0&&cons.cost===0)continue;

// å£²å¤‰ï¼ˆå€¤å¼•ãï¼‰ã®æ‰±ã„ï¼šå£²å¤‰ã¯å£²ä¸Šã«å«ã¾ã‚Œã‚‹ï¼ˆå£²ä¸Šã‚’æ¸›ç®—ã—ãªã„ï¼‰
// - ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯å£²å¤‰ãŒ -100 ã®ã‚ˆã†ã«ã€Œè² æ•°ã€ã§å…¥ã‚‹æƒ³å®š
// - å€¤å¼•ãå‰å£²ä¸Šï¼ˆå‚è€ƒï¼‰= å£²ä¸Š - å£²å¤‰ï¼ˆ= å£²ä¸Š + |å£²å¤‰|ï¼‰
const baihenRaw = bh.baihen||0;                 // ä¾‹ï¼š-100
const discountAbs = (baihenRaw<0)? -baihenRaw : baihenRaw; // ä¾‹ï¼š100ï¼ˆåˆ†æç”¨ï¼‰
const grossSales = u.sales + discountAbs;       // å€¤å¼•ãå‰å£²ä¸Šï¼ˆå‚è€ƒï¼‰
const baihenRate = grossSales>0 ? (discountAbs/grossSales) : 0;

// ã‚³ã‚¢å£²ä¸Šï¼ˆèŠ±ãƒ»ç”£ç›´ã‚’é™¤ã„ãŸå£²ä¸Šï¼‰â€»èŠ±/ç”£ç›´ãŒç·å£²ä¸Šã‚’è¶…ãˆã‚‹æ—¥ã¯0ã«ä¸¸ã‚ã¦è­¦å‘Šå¯¾è±¡
const deliveryPrice = (h.price||0) + (sa.price||0);
let coreSales = u.sales - deliveryPrice;
let overDelivery = false;
let overDeliveryAmt = 0;
if(coreSales < 0){
  overDelivery = true;
  overDeliveryAmt = -coreSales; // è¶…éåˆ†
  coreSales = 0;
}
const coreGrossSales = coreSales + discountAbs;

daily[day]={
  sales:u.sales,
  suppliers:s.suppliers,
  shiire:s.total,
  tenkanIn:ti.tenkanIn||[],
  tenkanOut:to.tenkanOut||[],
  bumonIn:ti.bumonIn||[],
  bumonOut:to.bumonOut||[],
  tenkanInTotal,tenkanOutTotal,bumonInTotal,bumonOutTotal,
  hana:h,sanchoku:sa,consumable:cons,
  baihen:baihenRaw,          // è¡¨ç¤ºç”¨ï¼ˆè² æ•°ã®ã¾ã¾ï¼‰
  baihenAbs:discountAbs,     // è¨ˆç®—ç”¨ï¼ˆçµ¶å¯¾å€¤ï¼‰
  baihenRate,
  grossSales,
  coreSales,
  coreGrossSales,
  overDelivery,
  overDeliveryAmt
};
if(overDelivery){ overDeliveryDays++; overDeliveryTotal+=overDeliveryAmt; }
totalConsumable+=cons.cost;
totalBaihen+=discountAbs; // åˆè¨ˆã¯çµ¶å¯¾å€¤ã§ä¿æŒ
totalCoreSales+=coreSales;
totalCorePrice+=s.total.price;

(ti.tenkanIn||[]).forEach(t=>transferDetails.tenkanIn.push({...t,day}));
(ti.bumonIn||[]).forEach(t=>transferDetails.bumonIn.push({...t,day}));
(to.tenkanOut||[]).forEach(t=>transferDetails.tenkanOut.push({...t,day}));
(to.bumonOut||[]).forEach(t=>transferDetails.bumonOut.push({...t,day}));
Object.entries(s.suppliers).forEach(([code,data])=>{if(!supTotals[code])supTotals[code]={...data,cost:0,price:0};supTotals[code].cost+=data.cost;supTotals[code].price+=data.price;const cat=SUPPLIERS[code]?.cat||'other';if(!catTotals[cat])catTotals[cat]={cost:0,price:0};catTotals[cat].cost+=data.cost;catTotals[cat].price+=data.price;});
if(tenkanInTotal.cost!==0||tenkanOutTotal.cost!==0){if(!catTotals['tenkan'])catTotals['tenkan']={cost:0,price:0};catTotals['tenkan'].cost+=tenkanInTotal.cost+tenkanOutTotal.cost;catTotals['tenkan'].price+=tenkanInTotal.price+tenkanOutTotal.price;}
if(bumonInTotal.cost!==0||bumonOutTotal.cost!==0){if(!catTotals['bumonkan'])catTotals['bumonkan']={cost:0,price:0};catTotals['bumonkan'].cost+=bumonInTotal.cost+bumonOutTotal.cost;catTotals['bumonkan'].price+=bumonInTotal.price+bumonOutTotal.price;}
if(h.price>0){if(!catTotals['hana'])catTotals['hana']={cost:0,price:0};catTotals['hana'].cost+=h.cost;catTotals['hana'].price+=h.price;}
if(sa.price>0){if(!catTotals['sanchoku'])catTotals['sanchoku']={cost:0,price:0};catTotals['sanchoku'].cost+=sa.cost;catTotals['sanchoku'].price+=sa.price;}
if(cons.cost>0){if(!catTotals['consumable'])catTotals['consumable']={cost:0,price:0};catTotals['consumable'].cost+=cons.cost;catTotals['consumable'].price+=cons.cost;}} // åŸä¾¡ç®—å…¥æ¯”ã¯å£²ä¾¡=åŸä¾¡

const totalSales=Object.values(daily).reduce((s,d)=>s+d.sales,0),totalCost=Object.values(catTotals).reduce((s,c)=>s+c.cost,0),totalPrice=Object.values(catTotals).reduce((s,c)=>s+c.price,0);

// èŠ±ãƒ»ç”£ç›´ã®åˆè¨ˆ
const hanaTotalCost=catTotals['hana']?.cost||0;
const hanaTotalPrice=catTotals['hana']?.price||0;
const sanchokuTotalCost=catTotals['sanchoku']?.cost||0;
const sanchokuTotalPrice=catTotals['sanchoku']?.price||0;
const deliverySalesCost=hanaTotalCost+sanchokuTotalCost; // å£²ä¸Šç´å“åŸä¾¡
const deliverySalesPrice=hanaTotalPrice+sanchokuTotalPrice; // å£²ä¸Šç´å“å£²ä¾¡

// ã‚³ã‚¢ä»•å…¥ï¼ˆèŠ±ãƒ»ç”£ç›´ãƒ»åŸä¾¡ç®—å…¥æ¯”ã‚’é™¤ã„ãŸä»•å…¥ï¼‰
const coreCost=totalCost-deliverySalesCost-totalConsumable;
const corePrice=totalPrice-deliverySalesPrice-totalConsumable;

// === æ¨å®šåœ¨åº«è¨ˆç®—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ•°å¼ï¼‰ ===
// 
// ã€å‰æã€‘
// - d: å€¤å¼•ç‡ï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰= å€¤å¼•é¡ / (å£²ä¸Š + å€¤å¼•é¡)
// - m: å€¤å…¥ç‡ï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰= (å£²ä¾¡ - åŸä¾¡) / å£²ä¾¡
// - S_net: å€¤å¼•å¾Œå£²ä¸Šï¼ˆãƒãƒƒãƒˆå£²ä¸Šï¼‰
// - BI: æœŸé¦–åœ¨åº«
// - P: æœŸä¸­ä»•å…¥ï¼ˆåŸä¾¡ï¼‰
//
// ã€è¨ˆç®—å¼ã€‘
// 1. S_gross = S_net / (1 - d)  â† ã‚°ãƒ­ã‚¹å£²ä¸Š
// 2. COGS_est = S_gross Ã— (1 - m)  â† æ¨å®šå£²ä¸ŠåŸä¾¡
// 3. EI_est = BI + P - COGS_est  â† æ¨å®šæœŸæœ«åœ¨åº«
//
// ã€æ³¨æ„ã€‘å£²ä¸Šç´å“ï¼ˆèŠ±ãƒ»ç”£ç›´ï¼‰ã¯åˆ¥ã®å€¤å…¥ç‡ã‚’é©ç”¨

// å£²ä¾¡ãƒ™ãƒ¼ã‚¹å£²å¤‰ç‡ d = å€¤å¼•é¡ / (å£²ä¸Š + å€¤å¼•é¡)
const totalGrossSales=totalSales+totalBaihen; // S_net + å€¤å¼•é¡
const baihenRateSales=totalGrossSales>0?totalBaihen/totalGrossSales:0; // d

// ã‚³ã‚¢éƒ¨åˆ†ã®å€¤å…¥ç‡ mï¼ˆå£²ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰
const coreMarginRate=corePrice>0?(corePrice-coreCost)/corePrice:marginRate;

// å£²ä¸Šç´å“ï¼ˆèŠ±ãƒ»ç”£ç›´ï¼‰ã®å€¤å…¥ç‡
const deliveryMarginRate=deliverySalesPrice>0?(deliverySalesPrice-deliverySalesCost)/deliverySalesPrice:0;

// === ã‚³ã‚¢éƒ¨åˆ†ã®è¨ˆç®— ===
// ã‚³ã‚¢å£²ä¸Šï¼ˆãƒãƒƒãƒˆï¼‰= ç·å£²ä¸Š - èŠ±å£²ä¾¡ - ç”£ç›´å£²ä¾¡
const coreNetSales=totalCoreSales;

// ã‚³ã‚¢ã®ã‚°ãƒ­ã‚¹å£²ä¸Š = ã‚³ã‚¢ãƒãƒƒãƒˆå£²ä¸Š / (1 - d)
// â€»å€¤å¼•ã¯åœ¨åº«è²©å£²ï¼ˆã‚³ã‚¢ï¼‰ã®ã¿ã«é©ç”¨ã•ã‚Œã‚‹ã¨ä»®å®š
const coreGrossSales=(1-baihenRateSales)>0?coreNetSales/(1-baihenRateSales):coreNetSales;

// ã‚³ã‚¢ã®æ¨å®šå£²ä¸ŠåŸä¾¡ = ã‚³ã‚¢ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1 - m)
const coreEstCogs=coreGrossSales*(1-coreMarginRate);

// === å£²ä¸Šç´å“ï¼ˆèŠ±ãƒ»ç”£ç›´ï¼‰ã®è¨ˆç®— ===
// å£²ä¸Šç´å“ã¯å€¤å¼•ãªã—ã€å£²ä¾¡=å£²ä¸Šã¨ã—ã¦æ‰±ã†
// å£²ä¸Šç´å“ã®å£²ä¸ŠåŸä¾¡ = åŸä¾¡ãã®ã¾ã¾ï¼ˆã¾ãŸã¯å£²ä¾¡Ã—(1-å€¤å…¥ç‡)ï¼‰
const deliveryEstCogs=deliverySalesCost; // åŸä¾¡ã‚’ãã®ã¾ã¾ä½¿ç”¨

// === æ¶ˆè€—å“ï¼ˆåŸä¾¡ç®—å…¥æ¯”ï¼‰===
// æ¶ˆè€—å“ã¯å£²ä¸ŠåŸä¾¡ã¨ã—ã¦ãã®ã¾ã¾åŠ ç®—
const consumableEstCogs=totalConsumable;

// === æ¨å®šå£²ä¸ŠåŸä¾¡åˆè¨ˆ ===
const estimatedCogs=coreEstCogs+deliveryEstCogs+consumableEstCogs;

// === æ¨å®šæœŸæœ«åœ¨åº« ===
// EI_est = BI + P - COGS_est
const estimatedInvEnd=invStart+totalCost-estimatedCogs;

// === æ¨å®šç²—åˆ© ===
const estimatedGrossProfit=totalSales-estimatedCogs;
const estimatedGrossRate=totalSales>0?estimatedGrossProfit/totalSales:0;

// ã‚³ã‚¢æ¨å®šç²—åˆ©ç‡ = (m - d) / (1 - d) â€»å‚è€ƒå€¤
const estimatedCoreGrossRate=(1-baihenRateSales)>0?(coreMarginRate-baihenRateSales)/(1-baihenRateSales):coreMarginRate;

// åŸä¾¡å€¤å¼•ç‡ï¼ˆå‚è€ƒå€¤ï¼‰= d / (1 - m + d)
const baihenRateCost=(1-coreMarginRate+baihenRateSales)>0?baihenRateSales/(1-coreMarginRate+baihenRateSales):0;

// å€¤å¼•ã«ã‚ˆã‚‹åŸä¾¡æå¤± = ã‚°ãƒ­ã‚¹å£²ä¸ŠåŸä¾¡ - ãƒãƒƒãƒˆå£²ä¸ŠåŸä¾¡ï¼ˆç†è«–å€¤ï¼‰
// = coreGrossSales Ã— (1-m) - coreNetSales Ã— (1-m)
// = (1-m) Ã— (coreGrossSales - coreNetSales)
// = (1-m) Ã— coreNetSales Ã— d / (1-d)
const baihenLossCost=(1-coreMarginRate)*coreNetSales*baihenRateSales/(1-baihenRateSales||1);

// æ—¥åˆ¥ã®æ¨å®šåœ¨åº«ã‚’è¨ˆç®—
let dailyInvData=[];
let runningInv=invStart;
let runningCumSales=0,runningCumCost=0,runningCumBaihen=0;
for(let day=1;day<=31;day++){
    const d=daily[day];
    if(d){
        const daySales=d.sales||0;
        const dayShiireCost=d.shiire?.cost||0;
        const dayTenkanIn=d.tenkanInTotal?.cost||0;
        const dayTenkanOut=d.tenkanOutTotal?.cost||0;
        const dayBumonIn=d.bumonInTotal?.cost||0;
        const dayBumonOut=d.bumonOutTotal?.cost||0;
        const dayHanaCost=d.hana?.cost||0;
        const daySanchokuCost=d.sanchoku?.cost||0;
        const dayConsCost=d.consumable?.cost||0;
        const dayBaihenRaw=d.baihen||0;
        const dayBaihenAbs=(d.baihenAbs!=null)?d.baihenAbs:Math.abs(dayBaihenRaw);
        const dayHanaPrice=d.hana?.price||0;
        const daySanchokuPrice=d.sanchoku?.price||0;
        
        // æ—¥æ¬¡ä»•å…¥åˆè¨ˆï¼ˆåŸä¾¡ï¼‰
        const dayTotalCost=dayShiireCost+dayTenkanIn+dayTenkanOut+dayBumonIn+dayBumonOut+dayHanaCost+daySanchokuCost+dayConsCost;
        
        // æ—¥æ¬¡ã‚³ã‚¢å£²ä¸Šï¼ˆãƒãƒƒãƒˆï¼‰
        const dayCoreSales=Math.max(0,daySales-dayHanaPrice-daySanchokuPrice);
        
        // æ—¥æ¬¡ã‚°ãƒ­ã‚¹å£²ä¸Š = ãƒãƒƒãƒˆå£²ä¸Š / (1 - d)
        const dayGrossSales=(1-baihenRateSales)>0?dayCoreSales/(1-baihenRateSales):dayCoreSales;
        
        // æ—¥æ¬¡ã‚³ã‚¢å£²ä¸ŠåŸä¾¡ = ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1 - m)
        const dayCoreCogs=dayGrossSales*(1-coreMarginRate);
        
        // æ—¥æ¬¡å£²ä¸Šç´å“åŸä¾¡
        const dayDeliveryCogs=dayHanaCost+daySanchokuCost;
        
        // æ—¥æ¬¡æ¨å®šå£²ä¸ŠåŸä¾¡åˆè¨ˆ
        const dayEstCogs=dayCoreCogs+dayDeliveryCogs+dayConsCost;
        
        // æ¨å®šåœ¨åº« = å‰æ—¥åœ¨åº« + å½“æ—¥ä»•å…¥ - å½“æ—¥å£²ä¸ŠåŸä¾¡
        runningInv=runningInv+dayTotalCost-dayEstCogs;
        runningCumSales+=daySales;
        runningCumCost+=dayTotalCost;
        runningCumBaihen+=dayBaihenAbs;
    }
    dailyInvData.push({day,inv:runningInv,cumSales:runningCumSales,cumCost:runningCumCost,cumBaihen:runningCumBaihen,hasData:!!daily[day]});
}

// å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹ã®è’åˆ©è¨ˆç®—ï¼ˆå¾“æ¥é€šã‚Šï¼‰
const costBeforeConsumable=totalCost-totalConsumable;
const grossProfitBeforeConsumable=totalSales-(invStart+costBeforeConsumable-invEnd);
const grossProfitRateBeforeConsumable=totalSales>0?grossProfitBeforeConsumable/totalSales:0;
const grossProfit=totalSales-(invStart+totalCost-invEnd),grossProfitRate=totalSales>0?grossProfit/totalSales:0,avgMargin=totalPrice>0?(totalPrice-totalCost)/totalPrice:marginRate;
const consumableRate=totalSales>0?totalConsumable/totalSales:0;

const hanaRate=parseFloat(document.getElementById('hana-rate')?.value)||0.80;
const sanchokuRate=parseFloat(document.getElementById('sanchoku-rate')?.value)||0.85;
// äºˆç®—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const storeBudget=STORE_BUDGET[sid]||{daily:{},total:parseNum(document.getElementById('budget').value)};
const budgetTotal=storeBudget.total||parseNum(document.getElementById('budget').value);
// æ—¥åˆ¥ã®äºˆç®—æ¶ˆåŒ–ã‚’è¨ˆç®—
let salesDays=0,lastDay=0;
Object.entries(daily).forEach(([day,d])=>{
    const dayNum=parseInt(day);
    if(d.sales>0){salesDays++;lastDay=Math.max(lastDay,dayNum);}
});
// v9.7: äºˆç®—æ¶ˆåŒ–ã¯KPIé–¢æ•°ã§é›†ç´„
// çµŒéæ—¥æ•°ã¨æ®‹äºˆç®—ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰â€» KPIç®—å‡ºã¯ v9_calcKPI ã«é›†ç´„
const _kpi = v9_calcKPI({ daily, budgetDaily: storeBudget.daily, totalSales, budget: budgetTotal });
const _daysInfo = _kpi.daysInfo;

const elapsedDays = _daysInfo.elapsedBusinessDays; // çµŒéå–¶æ¥­æ—¥æ•°
const remainingBudgetDays = _daysInfo.remainingBudgetDays;
const budgetConsumed = _kpi.budgetElapsed;            // äºˆç®—æ¶ˆåŒ–ï¼ˆçµŒéåˆ†ï¼‰
const remainingBudget = _kpi.budgetRemainingDaily;    // æ®‹äºˆç®—ï¼ˆæ—¥å‰²ã‚Šæ®‹ï¼‰

// å‚è€ƒï¼šå£²ä¸Šã§è¦‹ãŸäºˆç®—æ®‹ï¼ˆ=äºˆç®— - å£²ä¸Šï¼‰
const remainingSalesToBudget = _kpi.remainingSalesToBudget;

const budgetAchievement = (_kpi.budgetAch!=null)?_kpi.budgetAch:0;
const budgetConsumptionRate = (_kpi.budgetConsumptionRate!=null)?_kpi.budgetConsumptionRate:0;

// å£²ä¸Š/å–¶æ¥­æ—¥ã§ç€åœ°ã‚’äºˆæ¸¬ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
const avgDailySales = (_kpi.avgPerBizDay!=null)?_kpi.avgPerBizDay:0;
const projectedSales = (_kpi.projSales!=null)?_kpi.projSales:0;
const projectedAchievement = (_kpi.projAch!=null)?_kpi.projAch:0;

// æœˆé–“ç²—åˆ©é¡äºˆç®—ï¼ˆåˆæœŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ï¼‰
const gpBudget = (STORE_GP_BUDGET && STORE_GP_BUDGET[sid]!=null)?(parseFloat(STORE_GP_BUDGET[sid])||0):0;
const gpRateBudget = (budgetTotal>0 && gpBudget>0)?(gpBudget/budgetTotal):0;

result[sid]={daily,catTotals,supTotals,transferDetails,invStart,invEnd,budget:budgetTotal,gpBudget,gpRateBudget,budgetDaily:storeBudget.daily,marginRate,totalSales,totalCost,totalPrice,grossProfit,grossProfitRate,avgMargin,hanaRate,sanchokuRate,budgetConsumed,budgetAchievement,budgetConsumptionRate,remainingBudget,remainingBudgetDays,remainingSalesToBudget,avgDailySales,projectedSales,projectedAchievement,salesDays,elapsedDays,totalConsumable,consumableRate,grossProfitBeforeConsumable,grossProfitRateBeforeConsumable,totalBaihen,baihenRateSales,baihenRateCost,coreMarginRate,totalBaihenAbs:totalBaihen,overDeliveryDays,overDeliveryTotal,estimatedCoreGrossRate,estimatedGrossProfit,estimatedGrossRate,estimatedInvEnd,estimatedCogs,baihenLossCost,dailyInvData,deliverySalesCost,deliverySalesPrice,coreCost,corePrice,totalCoreSales};});
document.getElementById('btn-export').style.display='flex';document.getElementById('view-tabs').style.display='flex';document.getElementById('stats-row').style.display='grid';
let hr=parseFloat(document.getElementById('hana-rate')?.value);
let sr=parseFloat(document.getElementById('sanchoku-rate')?.value);
if(isNaN(hr)) hr=0.80;
if(isNaN(sr)) sr=0.85;
// å…¥åŠ›ãƒŸã‚¹é˜²æ­¢ï¼ˆæ›ã‘ç‡ã¯é€šå¸¸ 0ã€œ1.2 ç¨‹åº¦ï¼‰
const _clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const hr2=_clamp(hr,0,1.2);
const sr2=_clamp(sr,0,1.2);
if(hr!==hr2){ document.getElementById('hana-rate').value=hr2.toFixed(2); showToast('èŠ± æ›ã‘ç‡ã‚’ç¯„å›²å†…ã«è£œæ­£ã—ã¾ã—ãŸï¼ˆ0ã€œ1.2ï¼‰','warning'); }
if(sr!==sr2){ document.getElementById('sanchoku-rate').value=sr2.toFixed(2); showToast('ç”£ç›´ æ›ã‘ç‡ã‚’ç¯„å›²å†…ã«è£œæ­£ã—ã¾ã—ãŸï¼ˆ0ã€œ1.2ï¼‰','warning'); }
hr=hr2; sr=sr2;
showToast('ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä½œæˆå®Œäº†ï¼ˆèŠ±:'+hr+'æ›/ç”£ç›´:'+sr+'æ›ï¼‰','success');
render();}catch(err){console.error(err);document.getElementById('content').innerHTML='<div class="empty-state"><div class="empty-icon">âš ï¸</div><h3>ã‚¨ãƒ©ãƒ¼</h3><p>'+err.message+'</p></div>';showToast('ã‚¨ãƒ©ãƒ¼: '+err.message,'error');}},150);}

function render(){
  if(result) ensureAllStoreAggregate();
  updateTopbarMeta();
  syncViewTabs();
  updateStats();

  // ğŸ” ç§»å‹•ãƒ•ãƒ­ãƒ¼ï¼ˆçµ±ä¸€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰
  if(currentView==='flow'){
    if(typeof transferFlowRenderer==='function'){ transferFlowRenderer(); }
    else{
      const host=document.getElementById('content');
      if(host) host.innerHTML='<div class="card" style="padding:16px;">ç§»å‹•ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆrenderTransferFlowViewæœªå®šç¾©ï¼‰</div>';
    }
    return;
  }

  if(currentView==='dashboard'){ renderDashboardV2(); return; }
  if(currentStore==='all'){ renderAllStores(); return; }
  else{
    switch(currentView){
      case'category':renderCategory();break;
      case'forecast':renderForecast();break;
      case'analysis':renderAnalysis();break;
      case'supplier':renderSupplier();break;
      case'daily':renderDaily();break;
      case'summary':renderSummary();break;
      case'reports':renderReports();break;
      default:renderDashboard();
    }
  }
}


// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====
function renderDashboard(){
    const data=result[currentStore];if(!data)return;
    
    // ç›®æ¨™è¨­å®šã‚’å–å¾—
    const targetMargin=parseFloat(document.getElementById('target-margin')?.value)/100||0.25;
    const warningMargin=parseFloat(document.getElementById('warning-margin')?.value)/100||0.23;
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
    const alerts=[];
    if(data.grossProfitRate<warningMargin){
        if(data.grossProfitRate<0.20){
            alerts.push({type:'danger',icon:'ğŸš¨',title:'ç²—åˆ©ç‡ãŒå±é™ºæ°´æº–',desc:("\u73fe\u5728 " + (fmtPct(data.grossProfitRate)) + " \u306f\u76ee\u6a19 " + (fmtPct(targetMargin)) + " \u3092\u5927\u304d\u304f\u4e0b\u56de\u3063\u3066\u3044\u307e\u3059")});
        }else{
            alerts.push({type:'warning',icon:'âš ï¸',title:'ç²—åˆ©ç‡ãŒç›®æ¨™æœªé”',desc:("\u73fe\u5728 " + (fmtPct(data.grossProfitRate)) + " \u306f\u76ee\u6a19 " + (fmtPct(targetMargin)) + " \u3092\u4e0b\u56de\u3063\u3066\u3044\u307e\u3059")});
        }
    }else{
        alerts.push({type:'success',icon:'âœ…',title:'ç²—åˆ©ç‡ã¯ç›®æ¨™é”æˆ',desc:("\u73fe\u5728 " + (fmtPct(data.grossProfitRate)) + " \u306f\u826f\u597d\u3067\u3059")});
    }
    
    // åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ
    const invRatio=data.invStart>0?data.estimatedInvEnd/data.invStart:1;
    if(invRatio<0.5){
        alerts.push({type:'danger',icon:'ğŸ“¦',title:'åœ¨åº«ãŒå±é™ºæ°´æº–',desc:("\u63a8\u5b9a\u5728\u5eab\u304c\u671f\u9996\u306e" + (fmtPct(invRatio)) + "\u307e\u3067\u6e1b\u5c11")});
    }else if(invRatio<0.7){
        alerts.push({type:'warning',icon:'ğŸ“¦',title:'åœ¨åº«æ¸›å°‘å‚¾å‘',desc:("\u63a8\u5b9a\u5728\u5eab\u306f\u671f\u9996\u306e" + (fmtPct(invRatio)) + "\u3067\u3059")});
    }
    
    // æœˆæœ«ç€åœ°äºˆæ¸¬ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
    const _daysInfo=v9_daysInfo(data);
    const _avgPerBiz=_daysInfo.elapsedBusinessDays>0 ? (data.totalSales/_daysInfo.elapsedBusinessDays) : data.avgDailySales;
    const projectedSales=_avgPerBiz*_daysInfo.totalBusinessDays;
    const projectedAchievement=data.budget>0?projectedSales/data.budget:0;
    
    // KPIã‚«ãƒ©ãƒ¼
    const gpColor=data.grossProfitRate>=targetMargin?'success':data.grossProfitRate>=warningMargin?'warning':'danger';
    
    let h='';
    
    // ===== ä¸Šéƒ¨å›ºå®šï¼ˆæœ¬éƒ¨/çµŒå–¶è€…å‘ã‘ï¼šv10ï¼‰=====
    const daysInfo = v9_daysInfo(data);

    // æœŸä¸­å£²ä¸Šäºˆç®—ï¼ˆçµŒéåˆ†ï¼‰
    const salesBudgetElapsed = (data.budgetConsumed!=null)?data.budgetConsumed:0;
    const salesActual = data.totalSales||0;
    const salesDelta = (salesBudgetElapsed>0)?(salesActual - salesBudgetElapsed):null;
    const salesAch = (salesBudgetElapsed>0)?(salesActual / salesBudgetElapsed):null;

    // ç²—åˆ©ï¼ˆæœŸä¸­ï¼‰ã¨ç²—åˆ©äºˆç®—ï¼ˆæœŸä¸­æ›ç®—ï¼‰
    const gpActual = data.grossProfit||0;
    const gpRate = data.grossProfitRate||0;
    const gpBudget = data.gpBudget||0;
    const gpRateBudget = data.gpRateBudget||0;
    const gpBudgetElapsed = (salesBudgetElapsed>0 && gpRateBudget>0)?(salesBudgetElapsed * gpRateBudget):null;
    const gpDelta = (gpBudgetElapsed!=null && gpBudgetElapsed>0)?(gpActual - gpBudgetElapsed):null;

    // ç€åœ°ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
    const avgSalesPerBizDay = daysInfo.elapsedBusinessDays>0 ? (salesActual/daysInfo.elapsedBusinessDays) : (data.avgDailySales||0);
    const projSales = avgSalesPerBizDay * (daysInfo.totalBusinessDays||0);
    const projSalesAch = (data.budget>0)?(projSales/data.budget):null;

    const avgGPPerBizDay = daysInfo.elapsedBusinessDays>0 ? (gpActual/daysInfo.elapsedBusinessDays) : null;
    const projGP = (avgGPPerBizDay!=null)?(avgGPPerBizDay * (daysInfo.totalBusinessDays||0)) : null;
    const projGPAch = (gpBudget>0 && projGP!=null)?(projGP/gpBudget):null;

    // æ—¥åˆ¥ç•°å¸¸TOP3ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    const anom = v9_topAnomalyDays(currentStore, 3);
    const insight = {
      summary: anom.summary || '-',
      itemsHtml: anom.itemsHtml || ''
    };
    h += v10_execBarHTML({
      scopeLabel: (currentStore==='all'?'ALLï¼ˆå…¨åº—ï¼‰':('åº—èˆ— '+currentStore)),
      plan: {
        salesBudget: data.budget||0,
        gpBudget: gpBudget||0,
        gpRateBudget: gpRateBudget||0,
        invStart: data.invStart||0,
        invEnd: data.invEnd||0
      },
      prog: {
        salesBudgetElapsed,
        salesActual,
        salesDelta,
        salesAch,
        gpActual,
        gpRate,
        gpDelta
      },
      fc: {
        projSales,
        projSalesAch,
        projGP,
        projGPAch
      },
      days: daysInfo,
      insight
    });

// ã‚¢ãƒ©ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
        if(alerts.length>0){
            h+='<div style="margin-bottom:16px">';
            alerts.forEach(a=>{
                h+=("<div class=\"alert-card " + (a.type) + "\"><div class=\"alert-icon\">" + (a.icon) + "</div><div class=\"alert-content\"><div class=\"alert-title\">" + (a.title) + "</div><div class=\"alert-desc\">" + (a.desc) + "</div></div></div>");
            });
            h+='</div>';
        }

    
    // è©³ç´°è¨ˆç®—ã‚«ãƒ¼ãƒ‰
    h+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px">';
    
    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
    h+=("<div class=\"section expanded\" style=\"margin-bottom:0\"><div class=\"section-header\"><div class=\"section-icon\" style=\"background:linear-gradient(135deg,var(--primary),var(--purple))\">\ud83d\udcca</div><div class=\"section-info\"><div class=\"section-name\">\u30b5\u30de\u30ea\u30fc</div></div></div><div class=\"section-body\" style=\"padding:14px\">\n        <div style=\"display:grid;gap:6px;font-size:0.75rem\">\n            <div style=\"display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)\"><span style=\"color:var(--text3)\">\u671f\u9996\u5728\u5eab</span><span style=\"font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(data.invStart)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)\"><span style=\"color:var(--text3)\">\u7dcf\u4ed5\u5165</span><span style=\"font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(data.totalCost)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)\"><span style=\"color:var(--text3)\">\u671f\u672b\u5728\u5eab</span><span style=\"font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(data.invEnd)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)\"><span style=\"color:var(--text3)\">\u58f2\u4e0a\u539f\u4fa1</span><span style=\"font-family:'JetBrains Mono',monospace;color:var(--warning)\">\u00a5" + (fmt(data.invStart+data.totalCost-data.invEnd)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)\"><span style=\"color:var(--text3)\">\u5e73\u5747\u5024\u5165\u7387</span><span style=\"font-family:'JetBrains Mono',monospace;color:var(--info)\">" + (fmtPct(data.avgMargin)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:8px 0;font-weight:600\"><span>\u8352\u5229\u76ca</span><span style=\"font-family:'JetBrains Mono',monospace;color:var(--success)\">\u00a5" + (fmt(data.grossProfit)) + "</span></div>\n        </div>\n    </div></div>");
    
    // æ¨å®šåœ¨åº«è¨ˆç®—ã‚«ãƒ¼ãƒ‰
    const coreGrossSales=(1-data.baihenRateSales)>0?data.totalCoreSales/(1-data.baihenRateSales):data.totalCoreSales;
    h+=("<div class=\"section expanded\" style=\"margin-bottom:0\"><div class=\"section-header\"><div class=\"section-icon\" style=\"background:linear-gradient(135deg,#06b6d4,#0891b2)\">\ud83e\uddee</div><div class=\"section-info\"><div class=\"section-name\">\u63a8\u5b9a\u5728\u5eab\u8a08\u7b97</div></div></div><div class=\"section-body\" style=\"padding:14px\">\n        <div style=\"font-size:0.6rem;color:var(--text4);padding:8px;background:var(--bg4);border-radius:5px;margin-bottom:10px;line-height:1.5\">\n            <strong>\u8a08\u7b97\u5f0f:</strong><br>\u2460 \u30b0\u30ed\u30b9\u58f2\u4e0a = \u30cd\u30c3\u30c8\u58f2\u4e0a \u00f7 (1-d)<br>\u2461 \u63a8\u5b9a\u539f\u4fa1 = \u30b0\u30ed\u30b9\u58f2\u4e0a \u00d7 (1-m)<br>\u2462 \u63a8\u5b9a\u5728\u5eab = \u671f\u9996 + \u4ed5\u5165 - \u539f\u4fa1\n        </div>\n        <div style=\"display:grid;gap:4px;font-size:0.7rem\">\n            <div style=\"display:flex;justify-content:space-between;padding:4px 0\"><span style=\"color:var(--text4)\">\u30cd\u30c3\u30c8\u58f2\u4e0a (S_net)</span><span style=\"font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(data.totalCoreSales)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:4px 0\"><span style=\"color:var(--text4)\">\u00f7 (1-d) \u2192 \u30b0\u30ed\u30b9\u58f2\u4e0a</span><span style=\"font-family:'JetBrains Mono',monospace;color:var(--warning)\">\u00a5" + (fmt(coreGrossSales)) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:4px 0\"><span style=\"color:var(--text4)\">\u00d7 (1-m) \u2192 \u63a8\u5b9a\u539f\u4fa1</span><span style=\"font-family:'JetBrains Mono',monospace;color:var(--danger)\">\u00a5" + (fmt(coreGrossSales*(1-data.avgMargin))) + "</span></div>\n            <div style=\"display:flex;justify-content:space-between;padding:6px 0;margin-top:4px;border-top:1px solid var(--border);font-weight:600\"><span>\u63a8\u5b9a\u671f\u672b\u5728\u5eab</span><span style=\"font-family:'JetBrains Mono',monospace;color:#06b6d4\">\u00a5" + (fmt(data.estimatedInvEnd)) + "</span></div>\n        </div>\n    </div></div>");
    
    h+='</div>'; // kpi-grid
    h+='</div>'; // dashboard-top
    
    document.getElementById('content').innerHTML=h;

  try{ v9_mountRangePanel(currentStore); }catch(e){}
}

// ===== é€±é–“äºˆæ¸¬ =====
function renderForecast(){
    const data = result[currentStore];
    if(!data){ document.getElementById('content').innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“…</div><h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>é›†è¨ˆã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„</p></div>'; return; }

    // ========= æœˆæ›œå§‹ã¾ã‚Šã®æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆé€±é–“äºˆæ¸¬ï¼‰ =========
    // â€»ã€Œé€±é–“äºˆæ¸¬ã€ã‚¿ãƒ–ï¼(1) æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é€±åˆ¥ã®äºˆç®—/å®Ÿç¸¾/é”æˆç‡ã‚’ä¸€è¦§ (2) é€±åˆ¥ã‚µãƒãƒªãƒ¼ (3) æ›œæ—¥å¹³å‡
    const sysToday = new Date();
    // ========= å¯¾è±¡å¹´æœˆæ—¥ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šï¼‰ =========
    // å…¥åŠ›ï¼ˆ#v9-base-dateï¼‰â†’ localStorage(v9_base_date) â†’ ä»Šæ—¥ ã®é †ã§æ±ºå®š
    const pad2 = (n)=> (n<10?('0'+n):(''+n));
    const todayStr = sysToday.getFullYear() + '-' + pad2(sysToday.getMonth()+1) + '-' + pad2(sysToday.getDate());
    const storedBase = (()=>{ try{ return localStorage.getItem('v9_base_date') || ''; }catch(e){ return ''; } })();
    // æŒ‡å®šãŒç„¡ã„å ´åˆã¯ã€Œäºˆç®— or å£²ä¸Šå£²å¤‰ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¯¾è±¡æœˆã‚’æ±ºã‚ã‚‹ï¼ˆå£²ä¸Š1æ—¥/2æ—¥æ¬ æã§ã‚‚æœˆåˆã¯1æ—¥ï¼‰
    const defaultFromFiles = (()=>{
        try{
            const d = (BUDGET_RANGE && BUDGET_RANGE.min) ? BUDGET_RANGE.min
                    : (BAIHEN_RANGE && BAIHEN_RANGE.min) ? BAIHEN_RANGE.min
                    : null;
            if(!d) return '';
            // ãƒ¬ãƒ³ã‚¸æœ€å°æ—¥ãŒæœˆåˆã§ãªãã¦ã‚‚ã€å¯¾è±¡æœˆã¯ã€Œãã®å¹´æœˆã®1æ—¥ã€ã«æ­£è¦åŒ–ï¼ˆå£²ä¸ŠãŒ1æ—¥/2æ—¥ã«ç„¡ãã¦ã‚‚ã‚ºãƒ¬ãªã„ï¼‰
            const d1 = new Date(d.getFullYear(), d.getMonth(), 1);
            return d1.getFullYear() + '-' + pad2(d1.getMonth()+1) + '-' + pad2(d1.getDate());
        }catch(e){ return ''; }
    })();
    const candidate = (storedBase && /^\d{4}-\d{2}-\d{2}$/.test(storedBase)) ? storedBase
                    : (defaultFromFiles && /^\d{4}-\d{2}-\d{2}$/.test(defaultFromFiles)) ? defaultFromFiles
                    : todayStr;
    const baseStr = candidate;
    const baseDate = new Date(baseStr + 'T00:00:00');
    let y = baseDate.getFullYear();
    let m0 = baseDate.getMonth(); // 0-11
    // å‚ç…§æ—¥ï¼ˆé€±KPI/ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ï¼‰ï¼šå¯¾è±¡æœˆ=ä»Šæœˆãªã‚‰ã‚·ã‚¹ãƒ†ãƒ æ—¥ä»˜ã€é•ã†ãªã‚‰ã€Œãã®æœˆã®æœ€çµ‚å£²ä¸Šæ—¥ã€ã‚’å„ªå…ˆ
    let today = sysToday;
    if(!(y===sysToday.getFullYear() && m0===sysToday.getMonth())){
        try{
          const di = (typeof v9_daysInfo==='function') ? v9_daysInfo(data||{}) : null;
          const anchorDay = (di && di.lastSalesDay) ? di.lastSalesDay : (maxDayInData || 1);
          today = new Date(y, m0, Math.max(1, Math.min(anchorDay, daysInMonth(y,m0))));
        }catch(e){ today = new Date(y, m0, 1); }
    }

    const dayNames = ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥']; // æœˆæ›œå§‹ã¾ã‚Š
    const toISO = (d)=> ((d.getFullYear()) + "-" + (String(d.getMonth()+1).padStart(2,'0')) + "-" + (String(d.getDate()).padStart(2,'0')));

    // äºˆç®—ï¼ˆæ—¥åˆ¥ï¼‰ãŒç„¡ã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¹³å‡æ—¥æ¬¡ï¼‰
    // äºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆï¼šæœªè¨­å®šæ—¥ã¯ã€Œ0ï¼ˆäºˆç®—ãªã—ï¼‰ã€ã¨ã—ã¦æ‰±ã†ï¼ˆå¹³å‡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„ï¼‰
    const hasBudgetFile = !!(BUDGET_RANGE && BUDGET_RANGE.min);
    const budgetOfDay = (day)=> {
      if(data.budgetDaily && data.budgetDaily[day]!=null) return Number(data.budgetDaily[day]||0);
      return hasBudgetFile ? 0 : Number(data.avgDailySales||0);
    };

    // æœˆåˆ
    const first = new Date(y, m0, 1);
    // JS: 0=æ—¥..6=åœŸ â†’ æœˆæ›œå§‹ã¾ã‚Šã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    const offset = (first.getDay() + 6) % 7; // æœˆ=0, æ—¥=6
    const gridStart = new Date(y, m0, 1 - offset);

    // æœˆæœ«æ—¥
    const lastDay = new Date(y, m0+1, 0).getDate();

    // 6é€±ï¼ˆ42ã‚»ãƒ«ï¼‰ã§å›ºå®š
    const cells = [];
    for(let i=0;i<42;i++){
        const d = new Date(gridStart);
        d.setDate(gridStart.getDate()+i);
        const inMonth = (d.getMonth()===m0);
        const day = d.getDate();
        const dowMon0 = (d.getDay()+6)%7; // æœˆ=0..æ—¥=6

        const dayData = (inMonth && data.daily) ? data.daily[day] : null;
        const actual = (dayData && dayData.sales) ? Number(dayData.sales||0) : 0;
        const budget = inMonth ? budgetOfDay(day) : 0;
        const diff = actual - budget;
        const ach = budget>0 ? (actual/budget) : (actual>0 ? 1 : 0);

        cells.push({d, inMonth, day, dowMon0, dayData, actual, budget, diff, ach});
    }

    // é€±åˆ¥ã‚µãƒãƒªãƒ¼ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å„è¡Œã”ã¨ï¼‰
    const weeks = [];
    for(let w=0; w<6; w++){
        const slice = cells.slice(w*7, w*7+7);
        const hasThisMonth = slice.some(c=>c.inMonth);
        if(!hasThisMonth) continue;
        const bud = slice.reduce((s,c)=>s+(c.inMonth?c.budget:0),0);
        const act = slice.reduce((s,c)=>s+(c.inMonth?c.actual:0),0);
        const dif = act - bud;
        const ach = bud>0 ? act/bud : 0;
        const start = slice.find(c=>c.inMonth) ? slice.find(c=>c.inMonth).d : slice[0].d;
        const end = [...slice].reverse().find(c=>c.inMonth) ? [...slice].reverse().find(c=>c.inMonth).d : slice[6].d;
        weeks.push({idx: weeks.length+1, bud, act, dif, ach, start, end});
    }

    // æ›œæ—¥å¹³å‡ï¼ˆå®Ÿç¸¾ãƒ»äºˆç®—ãƒ»é”æˆç‡ï¼‰
    const dowAgg = Array.from({length:7},()=>({act:0,bud:0,cnt:0}));
    cells.forEach(c=>{
        if(!c.inMonth) return;
        const has = (c.actual>0 || (c.dayData && (c.dayData.sales!=null)));
        if(!has) return;
        const a = c.actual;
        const b = c.budget;
        const i = c.dowMon0;
        dowAgg[i].act += a;
        dowAgg[i].bud += b;
        dowAgg[i].cnt += 1;
    });

    // KPIï¼ˆä»Šé€±ï¼šæœˆæ›œå§‹ã¾ã‚Šï¼‰
    const weekStartDay = 1; // Monday
    const curDow = today.getDay();
    const daysFromMon = (curDow + 6) % 7;
    const thisWeekStart = new Date(today);
    thisWeekStart.setDate(today.getDate()-daysFromMon);

    let thisWeekSales=0, thisWeekBudget=0, thisWeekBaihen=0;
    for(let i=0;i<7;i++){
        const d = new Date(thisWeekStart); d.setDate(thisWeekStart.getDate()+i);
        if(d.getMonth()!==m0) continue;
        const day = d.getDate();
        const dd = data.daily?.[day];
        if(dd){
            thisWeekSales += Number(dd.sales||0);
            thisWeekBaihen += (dd.baihenAbs!=null ? Number(dd.baihenAbs||0) : Math.abs(Number(dd.baihen||0)));
        }
        thisWeekBudget += budgetOfDay(day);
    }
    const thisWeekAch = thisWeekBudget>0 ? (thisWeekSales/thisWeekBudget) : 0;

    const progressColor = thisWeekAch>=1 ? 'success' : (thisWeekAch>=0.85 ? 'warning' : 'danger');

    let h = '';

    // KPIã‚«ãƒ¼ãƒ‰ï¼ˆä»Šé€±ï¼‰
    h += '<div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">';
    h += ("<div class=\"kpi-card\" data-color=\"primary\"><div class=\"kpi-header\"><span class=\"kpi-label\">\u4eca\u9031\uff08" + (thisWeekStart.getMonth()+1) + "/" + (thisWeekStart.getDate()) + "\u301c\uff09\u58f2\u4e0a</span><span class=\"kpi-icon\">\ud83d\udcc5</span></div><div class=\"kpi-value\">\u00a5" + (fmt(thisWeekSales)) + "</div><div class=\"kpi-sub\">\u4e88\u7b97 \u00a5" + (fmt(thisWeekBudget)) + "</div></div>");
    h += ("<div class=\"kpi-card\" data-color=\"" + (progressColor) + "\"><div class=\"kpi-header\"><span class=\"kpi-label\">\u4eca\u9031\u9054\u6210\u7387</span><span class=\"kpi-icon\">\ud83c\udfaf</span></div><div class=\"kpi-value\" style=\"color:var(--" + (progressColor) + ")\">" + (fmtPct(thisWeekAch)) + "</div><div class=\"kpi-progress\"><div class=\"kpi-progress-bar\" style=\"width:" + (Math.min(thisWeekAch*100,100)) + "%;background:var(--" + (progressColor) + ")\"></div></div></div>");
    h += ("<div class=\"kpi-card\" data-color=\"info\"><div class=\"kpi-header\"><span class=\"kpi-label\">\u4eca\u6708\uff08" + (m0+1) + "\u6708\uff09\u7d2f\u8a08</span><span class=\"kpi-icon\">\ud83d\udcc8</span></div><div class=\"kpi-value\" style=\"color:var(--info)\">\u00a5" + (fmt(data.totalSales||0)) + "</div><div class=\"kpi-sub\">\u4e88\u7b97\u6bd4 " + (fmtPct((data.budgetConsumed||0)>0 ? (data.totalSales/(data.budgetConsumed||1)) : (data.totalSales/(data.budget||1)))) + "</div></div>");
    const baihenRate = (thisWeekSales+thisWeekBaihen)>0 ? thisWeekBaihen/(thisWeekSales+thisWeekBaihen) : 0;
    h += ("<div class=\"kpi-card\" data-color=\"danger\"><div class=\"kpi-header\"><span class=\"kpi-label\">\u4eca\u9031 \u5024\u5f15</span><span class=\"kpi-icon\">\ud83d\udcc9</span></div><div class=\"kpi-value\" style=\"color:var(--danger)\">\u00a5" + (fmt(thisWeekBaihen)) + "</div><div class=\"kpi-sub\">\u58f2\u5909\u7387 " + (fmtPct(baihenRate)) + "</div></div>");
    h += '</div>';

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šå·¦ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰/å³ï¼ˆé€±åˆ¥ãƒ»æ›œæ—¥ï¼‰
    h += ("<div class=\"forecast-layout\">");

    // æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    h += ("<div class=\"section expanded\" style=\"margin-bottom:0\"><div class=\"section-header\"><div class=\"section-icon\" style=\"background:linear-gradient(135deg,#fbbf24,#f59e0b)\">\ud83d\udcc5</div><div class=\"section-info\"><div class=\"section-name\">\u6708\u9593\u30ab\u30ec\u30f3\u30c0\u30fc\uff08\u9031\u9593\u4e88\u6e2c\uff1a\u6708\u66dc\u59cb\u307e\u308a\uff09</div><div class=\"section-meta\">" + y + "\u5e74" + (m0+1) + "\u6708</div></div></div><div class=\"section-body\" style=\"padding:14px\">");

    // å¯¾è±¡å¹´æœˆæ—¥
    h += ("<div style=\"display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-bottom:10px\">"
      + "<label style=\"font-size:12px;color:var(--text4)\">\u5bfe\u8c61\u65e5"
      + "<input type=\"date\" id=\"v9-base-date\" value=\"" + baseStr + "\""
      + " style=\"margin-left:6px;padding:6px 8px;border:1px solid var(--line2);border-radius:10px;background:var(--bg2);color:var(--text1)\">"
      + "</label>"
      + "<button class=\"btn\" id=\"v9-base-date-apply\" style=\"padding:6px 10px\">\u9069\u7528</button>"
      + "</div>");

    // æ›œæ—¥ãƒ˜ãƒƒãƒ€
    h += ("<div class=\"month-weekdays\">") + dayNames.map(n=>("<div class=\"month-weekday\">" + (n) + "</div>")).join('') + ("</div>");

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“
    h += ("<div class=\"month-calendar\">");
    cells.forEach(c=>{
        const isToday = !!today && c.inMonth && c.d.toDateString()===today.toDateString();
        const cls = ['month-cell'];
        if(!c.inMonth) cls.push('out');
        if(isToday) cls.push('today');
        const has = c.inMonth && (c.actual>0 || (c.dayData && c.dayData.sales!=null));
        const achColor = !c.inMonth ? 'var(--text4)' : (c.ach>=1 ? 'var(--success)' : (c.ach>=0.85 ? 'var(--warning)' : 'var(--danger)'));
        const diffSign = c.diff>=0 ? '+' : '';
        const budgetTxt = c.inMonth ? ("\u00a5" + (fmt(c.budget))) : '';
        const actualTxt = (c.inMonth && has) ? ("\u00a5" + (fmt(c.actual))) : (c.inMonth ? 'â€”' : '');
        const diffTxt = (c.inMonth && has) ? ((diffSign) + "\u00a5" + (fmt(Math.abs(c.diff)))) : '';
        const achTxt  = (c.inMonth && has && c.budget>0) ? fmtPct(c.ach) : '';

        h += ("<div class=\"" + (cls.join(' ')) + "\">\n            <div class=\"mc-top\">\n              <div class=\"mc-date\">" + (c.inMonth?c.day:'') + "</div>\n              " + (isToday?'<div class="mc-badge">ä»Šæ—¥</div>':'') + "\n            </div>\n            <div class=\"mc-row\"><span class=\"mc-k\">\u4e88</span><span class=\"mc-v\">" + (budgetTxt) + "</span></div>\n            <div class=\"mc-row\"><span class=\"mc-k\">\u5b9f</span><span class=\"mc-v\">" + (actualTxt) + "</span></div>\n            <div class=\"mc-row\"><span class=\"mc-k\">\u5dee</span><span class=\"mc-v\" style=\"color:" + (c.inMonth && has ? (c.diff>=0?'var(--success)':'var(--danger)') : 'var(--text4)') + "\">" + (diffTxt) + "</span></div>\n            <div class=\"mc-row\"><span class=\"mc-k\">\u9054</span><span class=\"mc-v\" style=\"color:" + (achColor) + "\">" + (achTxt) + "</span></div>\n        </div>");
    });
    h += ("</div>"); // month-calendar
    h += ("</div></div>"); // section

    // å³ã‚«ãƒ©ãƒ 
    h += ("<div class=\"forecast-side\">");

    // é€±åˆ¥ã‚µãƒãƒªãƒ¼ï¼ˆé€±1..ï¼‰
    h += ("<div class=\"section expanded\" style=\"margin-bottom:12px\"><div class=\"section-header\"><div class=\"section-icon\" style=\"background:linear-gradient(135deg,#60a5fa,#2563eb)\">\ud83d\uddd3\ufe0f</div><div class=\"section-info\"><div class=\"section-name\">\u9031\u5225\u30b5\u30de\u30ea\u30fc</div><div class=\"section-meta\">\u6708\u5185\u306e\u9031\uff08\u30ab\u30ec\u30f3\u30c0\u30fc\u884c\uff09</div></div></div><div class=\"section-body\" style=\"padding:14px\">");
    h += ("<div class=\"week-sum-list\">");
    weeks.forEach(w=>{
        const c = (w.ach>=1)?'var(--success)':(w.ach>=0.85?'var(--warning)':'var(--danger)');
        const sign = w.dif>=0?'+':'';
        h += ("<div class=\"week-sum\">\n          <div class=\"ws-head\"><span class=\"ws-title\">\u7b2c" + (w.idx) + "\u9031</span><span class=\"ws-range\">" + (w.start.getMonth()+1) + "/" + (w.start.getDate()) + "\u301c" + (w.end.getMonth()+1) + "/" + (w.end.getDate()) + "</span></div>\n          <div class=\"ws-body\">\n            <div class=\"ws-row\"><span class=\"k\">\u4e88\u7b97</span><span class=\"v\">\u00a5" + (fmt(w.bud)) + "</span></div>\n            <div class=\"ws-row\"><span class=\"k\">\u5b9f\u7e3e</span><span class=\"v\">\u00a5" + (fmt(w.act)) + "</span></div>\n            <div class=\"ws-row\"><span class=\"k\">\u5dee\u7570</span><span class=\"v\" style=\"color:" + (w.dif>=0?'var(--success)':'var(--danger)') + "\">" + (sign) + "\u00a5" + (fmt(Math.abs(w.dif))) + "</span></div>\n            <div class=\"ws-row\"><span class=\"k\">\u9054\u6210</span><span class=\"v\" style=\"color:" + (c) + "\">" + (fmtPct(w.ach)) + "</span></div>\n          </div>\n        </div>");
    });
    h += ("</div></div></div>");

    // æ›œæ—¥å¹³å‡
    h += ("<div class=\"section expanded\" style=\"margin-bottom:0\"><div class=\"section-header\"><div class=\"section-icon\" style=\"background:linear-gradient(135deg,#34d399,#10b981)\">\ud83d\udccc</div><div class=\"section-info\"><div class=\"section-name\">\u66dc\u65e5\u5e73\u5747\uff08\u5b9f\u7e3e/\u4e88\u7b97\uff09</div><div class=\"section-meta\">\u30c7\u30fc\u30bf\u306e\u3042\u308b\u65e5\u306e\u307f</div></div></div><div class=\"section-body\" style=\"padding:14px\">");
    h += ("<div class=\"dow-grid\">");
    dayNames.forEach((n,i)=>{
        const a = dowAgg[i];
        const avgA = a.cnt>0 ? (a.act/a.cnt) : 0;
        const avgB = a.cnt>0 ? (a.bud/a.cnt) : 0;
        const ach = avgB>0 ? avgA/avgB : 0;
        const c = (ach>=1)?'var(--success)':(ach>=0.85?'var(--warning)':'var(--danger)');
        h += ("<div class=\"dow-card\">\n          <div class=\"dow-name\">" + (n) + "</div>\n          <div class=\"dow-row\"><span class=\"k\">\u5b9f</span><span class=\"v\">\u00a5" + (fmt(avgA)) + "</span></div>\n          <div class=\"dow-row\"><span class=\"k\">\u4e88</span><span class=\"v\">\u00a5" + (fmt(avgB)) + "</span></div>\n          <div class=\"dow-row\"><span class=\"k\">\u9054</span><span class=\"v\" style=\"color:" + (c) + "\">" + (a.cnt>0?fmtPct(ach):'') + "</span></div>\n        </div>");
    });
    h += ("</div></div></div>");

    h += ("</div>"); // forecast-side
    h += ("</div>"); // forecast-layout

    document.getElementById('content').innerHTML = h;

    // å¯¾è±¡å¹´æœˆæ—¥ï¼šä¿å­˜ã—ã¦å†æç”»
    try{
      const dateEl = document.getElementById('v9-base-date');
      const btn = document.getElementById('v9-base-date-apply');
      if(btn && dateEl){
        btn.onclick = function(){
          if(dateEl.value){
            try{ localStorage.setItem('v9_base_date', dateEl.value); }catch(e){}
          }
          renderForecast();
        };
        // Enterã‚­ãƒ¼ã§ã‚‚é©ç”¨
        dateEl.onkeydown = function(ev){
          ev = ev || window.event;
          if(ev.key === 'Enter'){
            btn.click();
          }
        };
      }
    }catch(e){}

}

function updateStats(){
  const res = (result && typeof result === 'object') ? result : {};
  let d;
  if(currentStore==='all'){
    d={totalSales:0,totalCost:0,grossProfit:0,budget:0,totalConsumable:0,grossProfitBeforeConsumable:0,totalPrice:0,avgMargin:0};
    Object.values(res).forEach(x=>{
      if(!x) return;
      d.totalSales+=Number(x.totalSales||0);
      d.totalCost+=Number(x.totalCost||0);
      d.grossProfit+=Number(x.grossProfit||0);
      d.budget+=Number(x.budget||0);
      d.totalConsumable+=Number(x.totalConsumable||0);
      d.grossProfitBeforeConsumable+=Number(x.grossProfitBeforeConsumable||0);
      d.totalPrice+=Number(x.totalPrice||0);
    });
    let _od=0,_odAmt=0;
    Object.values(res).forEach(x=>{
      if(!x) return;
      _od+=Number(x.overDeliveryDays||0);
      _odAmt+=Number(x.overDeliveryTotal||0);
    });
    if(_od>0 && !overDeliveryWarned){
      overDeliveryWarned=true;
      showToast('è­¦å‘Šï¼šèŠ±ï¼‹ç”£ç›´ãŒç·å£²ä¸Šã‚’è¶…ãˆã‚‹æ—¥ãŒ '+_od+'æ—¥ã‚ã‚Šã¾ã™ï¼ˆè¶…éåˆè¨ˆ Â¥'+Math.round(_odAmt).toLocaleString('ja-JP')+'ï¼‰ã€‚åœ¨åº«æ¨å®šã¯0ã«ä¸¸ã‚ã¦ã„ã¾ã™ã€‚','warning');
    }
    d.grossProfitRate=d.totalSales>0?d.grossProfit/d.totalSales:0;
    d.grossProfitRateBeforeConsumable=d.totalSales>0?d.grossProfitBeforeConsumable/d.totalSales:0;
    d.consumableRate=d.totalSales>0?d.totalConsumable/d.totalSales:0;
  }else{
    d=res[currentStore];
    if(!d){
      d={totalSales:0,totalCost:0,grossProfit:0,budget:0,totalConsumable:0,grossProfitBeforeConsumable:0,totalPrice:0,avgMargin:0,grossProfitRate:0,grossProfitRateBeforeConsumable:0,consumableRate:0};
    }
  }

  // Title / badge
  const titleEl=document.getElementById('view-title');
  if(titleEl){
    titleEl.textContent=currentStore==='all'?'å…¨åº—èˆ—ã‚µãƒãƒªãƒ¼':(STORES && STORES[currentStore] && STORES[currentStore].name) ? STORES[currentStore].name : (currentStore||'');
  }
  const b=document.getElementById('store-badge');
  if(b){
    b.style.display=currentStore==='all'?'none':'inline';
    b.textContent=(currentStore||'').toString().padStart(2,'0');
  }

  // Core stats
  const salesEl=document.getElementById('stat-sales');
  if(salesEl) salesEl.textContent='Â¥'+fmt(d.totalSales);

  const salesSub=document.getElementById('stat-sales-sub');
  if(salesSub){
    const bud=Number(d.budget||0);
    salesSub.textContent = (bud>0 && isFinite(d.totalSales/bud)) ? ('äºˆç®—æ¯” '+fmtPct(d.totalSales/bud)) : 'äºˆç®—æ¯” -';
  }

  const costEl=document.getElementById('stat-cost');
  if(costEl) costEl.textContent='Â¥'+fmt(d.totalCost);

  const _salesNet=Number(d.totalSales||0), _cost=Number(d.totalCost||0);
  const _price=Number(d.totalPrice||0)||_salesNet;
  const _markupAmt=_price-_cost;
  const _markupRate=(typeof d.avgMargin==='number' && isFinite(d.avgMargin))?d.avgMargin:(_price>0?(_markupAmt/_price):0);

  const mr=document.getElementById('stat-markup-rate');
  if(mr) mr.textContent=fmtPct(_markupRate);

  const ma=document.getElementById('stat-markup-amt');
  if(ma) ma.textContent='å€¤å…¥ '+fmt(_markupAmt);

  const cons=document.getElementById('stat-consumable');
  if(cons) cons.textContent='åŸä¾¡ç®—å…¥æ¯” '+fmt(d.totalConsumable||0)+' ('+fmtPct(d.consumableRate||0)+')';

  const rb=document.getElementById('stat-rate-before');
  if(rb) rb.textContent=fmtPct(d.grossProfitRateBeforeConsumable||0);

  const pb=document.getElementById('stat-profit-before');
  if(pb) pb.textContent='è’åˆ© '+fmt(d.grossProfitBeforeConsumable||0);

  const rr=document.getElementById('stat-rate');
  if(rr) rr.textContent=fmtPct(d.grossProfitRate||0);

  const ps=document.getElementById('stat-profit-sub');
  if(ps) ps.textContent='è’åˆ© '+fmt(d.grossProfit||0);
}

function renderAllStores(){
    // ===== å…¨åº—èˆ—ã‚µãƒãƒªï¼ˆäºˆç®—ãƒ»é€²æ—ï¼‰ =====
    const rows = Object.entries(result||{}).filter(([sid,_])=>sid!=='all');
    if(rows.length===0){
        document.getElementById('content').innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“‚</div><h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>å·¦ã®ãƒ‘ãƒãƒ«ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p></div>';
        return;
    }

    let sumSales=0, sumGP=0;
    let sumBudget=0, sumBudgetElapsed=0;
    let sumGPBudget=0;
    let elapsedMax=0, totalBizMax=0;

    rows.forEach(([sid,d])=>{
        if(!d) return;
        sumSales += (d.totalSales||0);
        sumGP    += (d.grossProfit||0);

        // æœˆé–“å£²ä¸Šäºˆç®—ï¼ˆäºˆç®—ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã‘ã‚Œã°å„åº—èˆ—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆäºˆç®—ãŒå…¥ã‚‹ï¼‰
        sumBudget += (d.budget||0);

        // æœŸä¸­å£²ä¸Šäºˆç®—ï¼ˆçµŒéåˆ†ï¼‰: KPIè¨ˆç®—çµæœã¨ã—ã¦ result ã«å…¥ã‚Œã¦ã„ã‚‹ budgetConsumedï¼ˆ=çµŒéäºˆç®—ï¼‰
        sumBudgetElapsed += (d.budgetConsumed||0);

        // æœˆé–“ç²—åˆ©é¡äºˆç®—ï¼ˆåˆæœŸè¨­å®šDåˆ—ï¼‰
        if(d.gpBudget) sumGPBudget += d.gpBudget;

        const elapsed = (d.elapsedDays||0);
        const totalBiz = (d.elapsedDays||0) + (d.remainingBudgetDays||0);
        if(totalBiz > totalBizMax){ totalBizMax = totalBiz; elapsedMax = elapsed; }
    });

    const stagePct = (totalBizMax>0)?(elapsedMax/totalBizMax):0;

    const budgetAchToElapsed = (sumBudgetElapsed>0)?(sumSales/sumBudgetElapsed):0;
    const gpRate = (sumSales>0)?(sumGP/sumSales):0;

    const gpBudgetRate = (sumBudget>0 && sumGPBudget>0)?(sumGPBudget/sumBudget):null;

    // ç²—åˆ©é¡ äºˆç®—é”æˆç‡ï¼ˆã‚ã‚‹å ´åˆã®ã¿ï¼‰
    const gpAch = (sumGPBudget>0)?(sumGP/sumGPBudget):null;

    
    // ===== ä¸Šéƒ¨å›ºå®šï¼ˆæœ¬éƒ¨/çµŒå–¶è€…å‘ã‘ï¼šv10 / å…¨åº—ï¼‰=====
    // åœ¨åº«ï¼ˆå…¨åº—åˆè¨ˆï¼‰
    let sumInvStart=0, sumInvEnd=0;
    rows.forEach(([sid,d])=>{
      sumInvStart += (d.invStart||0);
      sumInvEnd   += (d.invEnd||0);
    });

    const daysInfo = {elapsedBusinessDays: elapsedMax||0, totalBusinessDays: totalBizMax||0};

    const salesBudgetElapsed = sumBudgetElapsed||0;
    const salesActual = sumSales||0;
    const salesDelta = (salesBudgetElapsed>0)?(salesActual - salesBudgetElapsed):null;
    const salesAch = (salesBudgetElapsed>0)?(salesActual / salesBudgetElapsed):null;

    // ç²—åˆ©ï¼ˆå…¨åº—ï¼‰
    const gpActual = sumGP||0;

    // ç²—åˆ©äºˆç®—ï¼ˆå…¨åº—ï¼‰ã¨ç²—åˆ©ç‡äºˆç®—
    const gpBudget = sumGPBudget||0;
    const gpRateBudget = (sumBudget>0 && gpBudget>0)?(gpBudget/sumBudget):0;
    const gpBudgetElapsed = (salesBudgetElapsed>0 && gpRateBudget>0)?(salesBudgetElapsed * gpRateBudget):null;
    const gpDelta = (gpBudgetElapsed!=null && gpBudgetElapsed>0)?(gpActual - gpBudgetElapsed):null;

    // ç€åœ°ï¼ˆå–¶æ¥­æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰
    const avgSalesPerBizDay = (daysInfo.elapsedBusinessDays>0)?(salesActual/daysInfo.elapsedBusinessDays):0;
    const projSales = avgSalesPerBizDay * (daysInfo.totalBusinessDays||0);
    const projSalesAch = (sumBudget>0)?(projSales/sumBudget):null;

    const avgGPPerBizDay = (daysInfo.elapsedBusinessDays>0)?(gpActual/daysInfo.elapsedBusinessDays):null;
    const projGP = (avgGPPerBizDay!=null)?(avgGPPerBizDay * (daysInfo.totalBusinessDays||0)) : null;
    const projGPAch = (gpBudget>0 && projGP!=null)?(projGP/gpBudget):null;

    // æ—¥åˆ¥ç•°å¸¸TOP3ï¼ˆå…¨åº—ï¼‰
    const anom = v9_topAnomalyDays('all', 3);
    const insight = {
      summary: anom.summary || '-',
      itemsHtml: anom.itemsHtml || ''
    };

    let h='';
    h += v10_execBarHTML({
      scopeLabel: 'ALLï¼ˆå…¨åº—ï¼‰',
      plan: { salesBudget: sumBudget||0, gpBudget: gpBudget||0, gpRateBudget: gpRateBudget||0, invStart: sumInvStart||0, invEnd: sumInvEnd||0 },
      prog: { salesBudgetElapsed, salesActual, salesDelta, salesAch, gpActual, gpRate, gpDelta },
      fc: { projSales, projSalesAch, projGP, projGPAch },
      days: daysInfo,
      insight
    });
    h+='<div class="stores-grid">';
    rows.sort((a,b)=>+a[0]-+b[0]).forEach(([sid,d])=>{
        const st=STORES[sid]; if(!st||!d) return;
        const pc=d.grossProfitRate>=0.25?'var(--success)':d.grossProfitRate>=0.2?'var(--warning)':'var(--danger)';
        h+='<div class="store-card" onclick="selectStore(\''+sid+'\')">'+
           '<div class="store-card-header"><div class="store-card-icon">ğŸª</div><div>'+
           '<div class="store-card-name">'+st.name+'</div><div class="store-card-code">'+st.code+'</div></div></div>'+
           '<div class="store-card-stats">'+
           '<div class="store-card-stat"><div class="label">å£²ä¸Š</div><div class="value">'+fmt(d.totalSales)+'</div></div>'+
           '<div class="store-card-stat"><div class="label">è’åˆ©ç›Š</div><div class="value" style="color:var(--success)">'+fmt(d.grossProfit)+'</div></div>'+
           '<div class="store-card-stat"><div class="label">è’åˆ©ç‡</div><div class="value" style="color:'+pc+'">'+fmtPct(d.grossProfitRate)+'</div></div>'+
           '<div class="store-card-stat"><div class="label">å€¤å…¥ç‡</div><div class="value" style="color:var(--info)">'+fmtPct(d.avgMargin)+'</div></div>'+
           '</div></div>';
    });
    h+='</div>';

    document.getElementById('content').innerHTML=h;
}

function selectStore(sid){
    const norm = (typeof normalizeStoreId==='function') ? normalizeStoreId(sid) : sid;
    currentStore = norm;

    // å…¨åº—ã«åˆ‡æ›¿ãˆãŸã‚‰ã€è¡¨ç¤ºã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã™ï¼ˆå…¨åº—ã‚µãƒãƒªãƒ¼ã®èª¤è¡¨ç¤ºé˜²æ­¢ï¼‰
    if(norm==='all') currentView = 'dashboard';

    document.querySelectorAll('#store-chips .chip').forEach(c=>{
        const cd = (typeof normalizeStoreId==='function') ? normalizeStoreId(c.dataset.store) : c.dataset.store;
        c.classList.toggle('active', cd===norm);
    });

    if(typeof render==='function') render();
}

function renderCategory(){const data=result[currentStore];if(!data)return;let h='';getCatOrder().forEach(cat=>{const cd=data.catTotals[cat];if(!cd||(cd.cost===0&&cd.price===0))return;const info=CATEGORIES[cat]||{name:cat,icon:'ğŸ“‹'},mr=cd.price>0?(cd.price-cd.cost)/cd.price:0;const sups=Object.entries(data.supTotals).filter(([code])=>(SUPPLIERS[code]?.cat||'other')===cat).sort((a,b)=>b[1].cost-a[1].cost);h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon '+cat+'">'+info.icon+'</div><div class="section-info"><div class="section-name">'+info.name+'</div><div class="section-meta">'+(sups.length>0?sups.length+'ç¤¾':'')+'</div></div><div class="section-stats"><span><span class="sl">åŸä¾¡</span> <span class="cost">'+fmt(cd.cost)+'</span></span><span><span class="sl">å£²ä¾¡</span> <span class="price">'+fmt(cd.price)+'</span></span><span><span class="sl">å€¤å…¥</span> <span class="highlight">'+fmtPct(mr)+'</span></span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th>';if(cat==='tenkan')h+='<th class="col-cost">å…¥åŸä¾¡</th><th class="col-price">å…¥å£²ä¾¡</th><th>å…¥å…ƒ</th><th class="col-cost">å‡ºåŸä¾¡</th><th class="col-price">å‡ºå£²ä¾¡</th><th>å‡ºå…ˆ</th>';else if(cat==='bumonkan')h+='<th class="col-cost">å…¥åŸä¾¡</th><th class="col-price">å…¥å£²ä¾¡</th><th class="col-cost">å‡ºåŸä¾¡</th><th class="col-price">å‡ºå£²ä¾¡</th><th>éƒ¨é–€</th>';else if(cat==='hana'||cat==='sanchoku')h+='<th class="col-price">å£²ä¾¡(ç´å“)</th><th class="col-cost">åŸä¾¡(æ›ã‘ç‡)</th>';else if(cat==='consumable')h+='<th class="col-cost">åŸä¾¡é‡‘é¡</th><th>å“ç›®æ•°</th>';else{sups.forEach(([,s])=>{h+='<th class="col-cost">'+s.name.substring(0,6)+'<br>åŸä¾¡</th><th class="col-price">å£²ä¾¡</th>';});if(sups.length>1)h+='<th class="col-cost">è¨ˆ</th><th class="col-price">è¨ˆ</th>';}h+='</tr></thead><tbody>';Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{h+='<tr><td>'+day+'æ—¥</td>';if(cat==='tenkan'){const tiS=d.tenkanIn.map(t=>'<span class="store-tag from">'+t.fromStore.padStart(2,'0')+'</span>').join(' ');const toS=d.tenkanOut.map(t=>'<span class="store-tag to">'+t.toStore.padStart(2,'0')+'</span>').join(' ');h+='<td class="col-cost">'+(d.tenkanInTotal.cost?fmt(d.tenkanInTotal.cost):'')+'</td><td class="col-price">'+(d.tenkanInTotal.price?fmt(d.tenkanInTotal.price):'')+'</td><td style="text-align:left">'+(tiS||'')+'</td><td class="col-cost '+(d.tenkanOutTotal.cost<0?'negative':'')+'">'+(d.tenkanOutTotal.cost?fmt(d.tenkanOutTotal.cost):'')+'</td><td class="col-price">'+(d.tenkanOutTotal.price?fmt(d.tenkanOutTotal.price):'')+'</td><td style="text-align:left">'+(toS||'')+'</td>';}else if(cat==='bumonkan'){const buS=d.bumonOut.map(t=>'<span class="store-tag bumon">'+(t.bumonCode||'?')+'</span>').join(' ');h+='<td class="col-cost">'+(d.bumonInTotal.cost?fmt(d.bumonInTotal.cost):'')+'</td><td class="col-price">'+(d.bumonInTotal.price?fmt(d.bumonInTotal.price):'')+'</td><td class="col-cost '+(d.bumonOutTotal.cost<0?'negative':'')+'">'+(d.bumonOutTotal.cost?fmt(d.bumonOutTotal.cost):'')+'</td><td class="col-price">'+(d.bumonOutTotal.price?fmt(d.bumonOutTotal.price):'')+'</td><td style="text-align:left">'+(buS||'')+'</td>';}else if(cat==='hana'){const mr=d.hana?.price>0?(d.hana.price-d.hana.cost)/d.hana.price:0;h+='<td class="col-price" style="color:#f472b6">'+(d.hana?.price?fmt(d.hana.price):'')+'</td><td class="col-cost">'+(d.hana?.cost?fmt(d.hana.cost):'')+'</td>';}else if(cat==='sanchoku'){const mr=d.sanchoku?.price>0?(d.sanchoku.price-d.sanchoku.cost)/d.sanchoku.price:0;h+='<td class="col-price" style="color:#a3e635">'+(d.sanchoku?.price?fmt(d.sanchoku.price):'')+'</td><td class="col-cost">'+(d.sanchoku?.cost?fmt(d.sanchoku.cost):'')+'</td>';}else if(cat==='consumable'){h+='<td class="col-cost" style="color:#f97316">'+(d.consumable?.cost?fmt(d.consumable.cost):'')+'</td><td>'+(d.consumable?.items?.length||'')+'</td>';}else{let sc=0,sp=0;sups.forEach(([code])=>{const s=d.suppliers[code];h+='<td class="col-cost">'+(s?.cost?fmt(s.cost):'')+'</td><td class="col-price">'+(s?.price?fmt(s.price):'')+'</td>';if(s){sc+=s.cost;sp+=s.price;}});if(sups.length>1)h+='<td class="col-cost">'+(sc?fmt(sc):'')+'</td><td class="col-price">'+(sp?fmt(sp):'')+'</td>';}h+='</tr>';});h+='<tr class="row-total"><td>åˆè¨ˆ</td>';if(cat==='tenkan'){const ti=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.tenkanInTotal.cost,price:s.price+d.tenkanInTotal.price}),{cost:0,price:0}),to=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.tenkanOutTotal.cost,price:s.price+d.tenkanOutTotal.price}),{cost:0,price:0});h+='<td class="col-cost">'+fmt(ti.cost)+'</td><td class="col-price">'+fmt(ti.price)+'</td><td></td><td class="col-cost">'+fmt(to.cost)+'</td><td class="col-price">'+fmt(to.price)+'</td><td></td>';}else if(cat==='bumonkan'){const bi=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.bumonInTotal.cost,price:s.price+d.bumonInTotal.price}),{cost:0,price:0}),bo=Object.values(data.daily).reduce((s,d)=>({cost:s.cost+d.bumonOutTotal.cost,price:s.price+d.bumonOutTotal.price}),{cost:0,price:0});h+='<td class="col-cost">'+fmt(bi.cost)+'</td><td class="col-price">'+fmt(bi.price)+'</td><td class="col-cost">'+fmt(bo.cost)+'</td><td class="col-price">'+fmt(bo.price)+'</td><td></td>';}else if(cat==='hana'||cat==='sanchoku'){h+='<td class="col-price" style="color:'+(cat==='hana'?'#f472b6':'#a3e635')+'">'+fmt(cd.price)+'</td><td class="col-cost">'+fmt(cd.cost)+'</td>';}else if(cat==='consumable'){const itemCount=Object.values(data.daily).reduce((s,d)=>s+(d.consumable?.items?.length||0),0);h+='<td class="col-cost" style="color:#f97316">'+fmt(cd.cost)+'</td><td>'+itemCount+'å“</td>';}else{sups.forEach(([,s])=>h+='<td class="col-cost">'+fmt(s.cost)+'</td><td class="col-price">'+fmt(s.price)+'</td>');if(sups.length>1)h+='<td class="col-cost">'+fmt(cd.cost)+'</td><td class="col-price">'+fmt(cd.price)+'</td>';}h+='</tr></tbody></table></div></div>';});document.getElementById('content').innerHTML=h;}

function renderTransfer(){const data=result[currentStore];if(!data)return;const td=data.transferDetails;const totTiC=td.tenkanIn.reduce((s,t)=>s+t.cost,0),totTiP=td.tenkanIn.reduce((s,t)=>s+t.price,0);const totToC=td.tenkanOut.reduce((s,t)=>s+t.cost,0),totToP=td.tenkanOut.reduce((s,t)=>s+t.price,0);const totBiC=td.bumonIn.reduce((s,t)=>s+t.cost,0),totBiP=td.bumonIn.reduce((s,t)=>s+t.price,0);const totBoC=td.bumonOut.reduce((s,t)=>s+t.cost,0),totBoP=td.bumonOut.reduce((s,t)=>s+t.price,0);
let h='<div class="summary-cards"><div class="summary-card ti"><div class="sc-label">ğŸ“¥ åº—é–“å…¥åº«</div><div class="sc-value" style="color:var(--success)">'+fmt(totTiC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totTiP)+' ï¼ '+td.tenkanIn.length+'ä»¶</div></div><div class="summary-card to"><div class="sc-label">ğŸ“¤ åº—é–“å‡ºåº«</div><div class="sc-value" style="color:var(--danger)">'+fmt(totToC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totToP)+' ï¼ '+td.tenkanOut.length+'ä»¶</div></div><div class="summary-card bi"><div class="sc-label">ğŸ”„ éƒ¨é–€é–“å…¥åº«</div><div class="sc-value" style="color:var(--info)">'+fmt(totBiC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totBiP)+' ï¼ '+td.bumonIn.length+'ä»¶</div></div><div class="summary-card bo"><div class="sc-label">ğŸ”€ éƒ¨é–€é–“å‡ºåº«</div><div class="sc-value" style="color:var(--purple)">'+fmt(totBoC)+'</div><div class="sc-sub">å£²ä¾¡ '+fmt(totBoP)+' ï¼ '+td.bumonOut.length+'ä»¶</div></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon ti">ğŸ“¥</div><div class="section-info"><div class="section-name">åº—é–“å…¥åº«æ˜ç´°</div><div class="section-meta">ä»–åº—èˆ—ã‹ã‚‰ã®å…¥åº« '+td.tenkanIn.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totTiC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>å‡ºåº«å…ƒåº—èˆ—</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.tenkanIn.length===0)h+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px;">åº—é–“å…¥åº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.tenkanIn.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="store-tag from">'+t.fromStore.padStart(2,'0')+'</span> '+(t.fromStoreName||'')+'</td><td class="col-cost positive">'+fmt(t.cost)+'</td><td class="col-price positive">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="2" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost positive"><strong>'+fmt(totTiC)+'</strong></td><td class="col-price positive"><strong>'+fmt(totTiP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon to">ğŸ“¤</div><div class="section-info"><div class="section-name">åº—é–“å‡ºåº«æ˜ç´°</div><div class="section-meta">ä»–åº—èˆ—ã¸ã®å‡ºåº« '+td.tenkanOut.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totToC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>å‡ºåº«å…ˆåº—èˆ—</th><th>éƒ¨é–€</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.tenkanOut.length===0)h+='<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:24px;">åº—é–“å‡ºåº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.tenkanOut.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="store-tag to">'+t.toStore.padStart(2,'0')+'</span> '+(t.toStoreName||'')+'</td><td><span class="store-tag bumon">'+(t.bumonCode||'-')+'</span></td><td class="col-cost negative">'+fmt(t.cost)+'</td><td class="col-price negative">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="3" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost negative"><strong>'+fmt(totToC)+'</strong></td><td class="col-price negative"><strong>'+fmt(totToP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon bi">ğŸ”„</div><div class="section-info"><div class="section-name">éƒ¨é–€é–“å…¥åº«æ˜ç´°</div><div class="section-meta">åŒä¸€åº—èˆ—å†…éƒ¨é–€é–“ç§»å‹•ï¼ˆå…¥ï¼‰ '+td.bumonIn.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totBiC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>ç§»å‹•å…ƒ</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.bumonIn.length===0)h+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px;">éƒ¨é–€é–“å…¥åº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.bumonIn.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="flow-self">åŒä¸€åº—èˆ—å†…ç§»å‹•</span></td><td class="col-cost positive">'+fmt(t.cost)+'</td><td class="col-price positive">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="2" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost positive"><strong>'+fmt(totBiC)+'</strong></td><td class="col-price positive"><strong>'+fmt(totBiP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon bo">ğŸ”€</div><div class="section-info"><div class="section-name">éƒ¨é–€é–“å‡ºåº«æ˜ç´°</div><div class="section-meta">åŒä¸€åº—èˆ—å†…éƒ¨é–€é–“ç§»å‹•ï¼ˆå‡ºï¼‰ '+td.bumonOut.length+'ä»¶</div></div><div class="section-stats"><span class="cost">'+fmt(totBoC)+'</span></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>ç§»å‹•å…ˆéƒ¨é–€</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th></tr></thead><tbody>';
if(td.bumonOut.length===0)h+='<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:24px;">éƒ¨é–€é–“å‡ºåº«ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';else{td.bumonOut.sort((a,b)=>a.day-b.day).forEach(t=>{const mr=t.price?(t.price-t.cost)/t.price:0;h+='<tr><td><strong>'+t.day+'æ—¥</strong></td><td style="text-align:left"><span class="store-tag bumon">'+(t.bumonCode||'éƒ¨é–€')+'</span></td><td class="col-cost negative">'+fmt(t.cost)+'</td><td class="col-price negative">'+fmt(t.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td></tr>';});h+='<tr class="row-total"><td colspan="2" style="text-align:right"><strong>åˆè¨ˆ</strong></td><td class="col-cost negative"><strong>'+fmt(totBoC)+'</strong></td><td class="col-price negative"><strong>'+fmt(totBoP)+'</strong></td><td></td></tr>';}
h+='</tbody></table></div></div>';
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon daily">ğŸ“…</div><div class="section-info"><div class="section-name">æ—¥åˆ¥ã‚µãƒãƒªãƒ¼</div><div class="section-meta">åº—é–“ãƒ»éƒ¨é–€é–“ã®æ—¥åˆ¥æ¨ç§»</div></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th class="col-cost">åº—é–“å…¥</th><th>å…¥å…ƒ</th><th class="col-cost">åº—é–“å‡º</th><th>å‡ºå…ˆ</th><th class="col-cost">éƒ¨é–€å…¥</th><th class="col-cost">éƒ¨é–€å‡º</th><th>éƒ¨é–€</th><th>å·®å¼•</th></tr></thead><tbody>';
Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{const hasTi=d.tenkanInTotal.cost||d.tenkanInTotal.price,hasTo=d.tenkanOutTotal.cost||d.tenkanOutTotal.price,hasBi=d.bumonInTotal.cost||d.bumonInTotal.price,hasBo=d.bumonOutTotal.cost||d.bumonOutTotal.price;if(!hasTi&&!hasTo&&!hasBi&&!hasBo)return;const tiS=d.tenkanIn.map(t=>'<span class="store-tag from">'+t.fromStore.padStart(2,'0')+'</span>').join(' ');const toS=d.tenkanOut.map(t=>'<span class="store-tag to">'+t.toStore.padStart(2,'0')+'</span>').join(' ');const buS=d.bumonOut.map(t=>'<span class="store-tag bumon">'+(t.bumonCode||'?')+'</span>').join(' ');const net=d.tenkanInTotal.cost+d.tenkanOutTotal.cost+d.bumonInTotal.cost+d.bumonOutTotal.cost;h+='<tr><td><strong>'+day+'æ—¥</strong></td><td class="col-cost '+(d.tenkanInTotal.cost>0?'positive':'')+'">'+(hasTi?fmt(d.tenkanInTotal.cost):'')+'</td><td style="text-align:left">'+(tiS||'')+'</td><td class="col-cost '+(d.tenkanOutTotal.cost<0?'negative':'')+'">'+(hasTo?fmt(d.tenkanOutTotal.cost):'')+'</td><td style="text-align:left">'+(toS||'')+'</td><td class="col-cost '+(d.bumonInTotal.cost>0?'positive':'')+'">'+(hasBi?fmt(d.bumonInTotal.cost):'')+'</td><td class="col-cost '+(d.bumonOutTotal.cost<0?'negative':'')+'">'+(hasBo?fmt(d.bumonOutTotal.cost):'')+'</td><td style="text-align:left">'+(buS||'')+'</td><td class="'+(net<0?'negative':net>0?'positive':'')+'">'+fmt(net)+'</td></tr>';});
const netTotal=totTiC+totToC+totBiC+totBoC;h+='<tr class="row-total"><td><strong>åˆè¨ˆ</strong></td><td class="col-cost positive"><strong>'+fmt(totTiC)+'</strong></td><td></td><td class="col-cost negative"><strong>'+fmt(totToC)+'</strong></td><td></td><td class="col-cost positive"><strong>'+fmt(totBiC)+'</strong></td><td class="col-cost negative"><strong>'+fmt(totBoC)+'</strong></td><td></td><td class="'+(netTotal<0?'negative':'positive')+'"><strong>'+fmt(netTotal)+'</strong></td></tr>';
h+='</tbody></table></div></div>';document.getElementById('content').innerHTML=h;}

function renderSupplier(){const data=result[currentStore];if(!data)return;const sups=Object.entries(data.supTotals).sort((a,b)=>b[1].cost-a[1].cost),tc=sups.reduce((s,[,sup])=>s+sup.cost,0);let h='<div class="section expanded"><div class="section-header"><div class="section-icon other">ğŸ“‹</div><div class="section-info"><div class="section-name">ä»•å…¥å…ˆåˆ¥æ˜ç´°</div><div class="section-meta">'+sups.length+'ç¤¾</div></div></div><div class="section-body"><table><thead><tr><th>ã‚³ãƒ¼ãƒ‰</th><th>ä»•å…¥å…ˆå</th><th>å¸³åˆ</th><th class="col-cost">åŸä¾¡</th><th class="col-price">å£²ä¾¡</th><th>å€¤å…¥ç‡</th><th>æ§‹æˆæ¯”</th></tr></thead><tbody>';sups.forEach(([code,sup])=>{const cat=SUPPLIERS[code]?.cat||'other',ci=CATEGORIES[cat]||{name:'ãã®ä»–'},mr=sup.price>0?(sup.price-sup.cost)/sup.price:0,sh=tc>0?sup.cost/tc:0;h+='<tr><td style="font-family:\'JetBrains Mono\',monospace;font-size:0.65rem;color:var(--text3)">'+code+'</td><td>'+sup.name+'</td><td style="color:var(--text3)">'+ci.name+'</td><td class="col-cost">'+fmt(sup.cost)+'</td><td class="col-price">'+fmt(sup.price)+'</td><td class="highlight">'+fmtPct(mr)+'</td><td>'+fmtPct(sh)+'</td></tr>';});h+='</tbody></table></div></div>';document.getElementById('content').innerHTML=h;}

function renderDaily(){const data=result[currentStore];if(!data)return;let h='<div class="section expanded"><div class="section-header"><div class="section-icon daily">ğŸ“…</div><div class="section-info"><div class="section-name">æ—¥åˆ¥æ¨ç§»</div></div></div><div class="section-body">' + 
  '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:12px">' +
  '<div style="font-size:0.75rem;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“Š</span>å£²ä¸ŠÃ—å£²å¤‰ç‡ï¼ˆã‚°ãƒ©ãƒ•ï¼‰</div>' +
  v22_dailySalesSVG(data) +
  '</div>' +
  '<table><thead><tr><th>æ—¥</th><th>å£²ä¸Š</th><th style="color:#ef4444">å£²å¤‰é¡</th><th style="color:#dc2626">å€¤å¼•ç‡(åŸä¾¡)</th><th class="col-cost">ä»•å…¥åŸä¾¡</th><th>åº—é–“å…¥</th><th>åº—é–“å‡º</th><th style="color:#f472b6">èŠ±</th><th style="color:#a3e635">ç”£ç›´</th><th style="color:#f97316">åŸä¾¡ç®—å…¥æ¯”</th><th>ç´¯è¨ˆå£²ä¸Š</th><th>ç´¯è¨ˆä»•å…¥</th></tr></thead><tbody>';let cs=0,cc=0;Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{cs+=d.sales;cc+=d.shiire.cost+d.tenkanInTotal.cost+d.tenkanOutTotal.cost+(d.hana?.cost||0)+(d.sanchoku?.cost||0)+(d.consumable?.cost||0);
// æ—¥åˆ¥ã®åŸä¾¡å€¤å¼•ç‡è¨ˆç®—
const dayCoreMargin=data.coreMarginRate||0.26;
const dayCoreSales=d.coreSales||d.sales;
const dayCoreCost=dayCoreSales*(1-dayCoreMargin);
const dayBaihenCostRate=dayCoreCost>0?((d.baihenAbs!=null?d.baihenAbs:Math.abs(d.baihen||0))/dayCoreCost):0;
h+='<tr><td>'+day+'æ—¥</td><td>'+fmt(d.sales)+'</td><td style="color:#ef4444">'+(d.baihen?fmt(d.baihen):'')+'</td><td style="color:#dc2626;font-weight:600">'+(d.baihen?fmtPct(dayBaihenCostRate):'')+'</td><td class="col-cost">'+fmt(d.shiire.cost)+'</td><td>'+(d.tenkanInTotal.cost?fmt(d.tenkanInTotal.cost):'')+'</td><td class="'+(d.tenkanOutTotal.cost<0?'negative':'')+'">'+(d.tenkanOutTotal.cost?fmt(d.tenkanOutTotal.cost):'')+'</td><td style="color:#f472b6">'+(d.hana?.price?fmt(d.hana.price):'')+'</td><td style="color:#a3e635">'+(d.sanchoku?.price?fmt(d.sanchoku.price):'')+'</td><td style="color:#f97316">'+(d.consumable?.cost?fmt(d.consumable.cost):'')+'</td><td class="highlight">'+fmt(cs)+'</td><td class="highlight">'+fmt(cc)+'</td></tr>';});h+='<tr class="row-total"><td>åˆè¨ˆ</td><td>'+fmt(data.totalSales)+'</td><td style="color:#ef4444">'+fmt(data.totalBaihen)+'</td><td style="color:#dc2626;font-weight:600">'+fmtPct(data.baihenRateCost)+'</td><td class="col-cost">'+fmt(data.coreCost+data.deliverySalesCost)+'</td><td colspan="6"></td><td class="highlight">'+fmt(data.totalCost)+'</td></tr>';h+='</tbody></table></div></div>';document.getElementById('content').innerHTML=h;}


// =============================
// v22: simple SVG charts
// =============================
function v22_budgetVsActualSVG(data){
  try{
    const w=820, h=220, pad=26;
    const days = Array.from({length:31},(_,i)=>i+1);
    let cumB=0, cumA=0;
    const ptsB=[], ptsA=[];
    days.forEach(day=>{
      const b = (data.budgetDaily?.[day]||0);
      const a = (data.daily?.[day]?.sales||0);
      if(!b && !a && day>data.elapsedDays && day>28) return;
      cumB += b; cumA += a;
      ptsB.push({day, v:cumB});
      ptsA.push({day, v:cumA});
    });
    const maxV = Math.max(1, ...ptsB.map(p=>p.v), ...ptsA.map(p=>p.v));
    const minX = ptsB.length? ptsB[0].day : 1;
    const maxX = ptsB.length? ptsB[ptsB.length-1].day : 31;
    const x = (day)=> pad + ( (day-minX) / Math.max(1,(maxX-minX)) ) * (w-2*pad);
    const y = (v)=> (h-pad) - (v/maxV)*(h-2*pad);

    const path = (pts)=> pts.map((p,i)=>((i?'L':'M') + " " + (x(p.day).toFixed(1)) + " " + (y(p.v).toFixed(1)))).join(' ');
    const grid = [0.25,0.5,0.75,1].map(r=>{
      const yy=y(maxV*r);
      return ("<line x1=\"" + (pad) + "\" y1=\"" + (yy) + "\" x2=\"" + (w-pad) + "\" y2=\"" + (yy) + "\" stroke=\"rgba(148,163,184,.35)\" stroke-width=\"1\" />");
    }).join('');

    const lastA = ptsA.length? ptsA[ptsA.length-1].v : 0;
    const lastB = ptsB.length? ptsB[ptsB.length-1].v : 0;

    return ("\n<svg viewBox=\"0 0 " + (w) + " " + (h) + "\" width=\"100%\" height=\"220\" style=\"display:block\">\n  <rect x=\"0\" y=\"0\" width=\"" + (w) + "\" height=\"" + (h) + "\" rx=\"12\" fill=\"var(--bg3)\"></rect>\n  " + (grid) + "\n  <path d=\"" + (path(ptsB)) + "\" fill=\"none\" stroke=\"rgba(59,130,246,.9)\" stroke-width=\"3\" />\n  <path d=\"" + (path(ptsA)) + "\" fill=\"none\" stroke=\"rgba(34,197,94,.9)\" stroke-width=\"3\" />\n  <text x=\"" + (pad) + "\" y=\"" + (pad-8) + "\" fill=\"var(--text3)\" font-size=\"12\" font-weight=\"700\">\u9752: \u4e88\u7b97\uff08\u7d2f\u8a08\uff09 / \u7dd1: \u5b9f\u7e3e\uff08\u7d2f\u8a08\uff09</text>\n  <text x=\"" + (w-pad) + "\" y=\"" + (pad-8) + "\" text-anchor=\"end\" fill=\"var(--text2)\" font-size=\"12\" font-weight=\"700\">" + ((lastB>0)?('é”æˆ '+(lastA/lastB*100).toFixed(1)+'%'):'-') + "</text>\n</svg>");
  }catch(e){
    return '<div class="v9-muted">ã‚°ãƒ©ãƒ•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}

function v22_grossRateSVG(data){
  try{
    const series = Object.keys(data.daily||{}).map(x=>+x).sort((a,b)=>a-b).slice(0,31);
    const w=420, h=220, pad=26;
    const pts = series.map(day=>{
      const sales = data.daily?.[day]?.sales||0;
      const cost = (data.daily?.[day]?.shiire?.cost||0)+(data.daily?.[day]?.tenkanInTotal?.cost||0)+(data.daily?.[day]?.tenkanOutTotal?.cost||0)+(data.daily?.[day]?.bumonInTotal?.cost||0)+(data.daily?.[day]?.bumonOutTotal?.cost||0)+(data.daily?.[day]?.hana?.cost||0)+(data.daily?.[day]?.sanchoku?.cost||0)+(data.daily?.[day]?.consumable?.cost||0);
      const rate = sales>0 ? (sales-cost)/sales : null;
      return {day, rate};
    }).filter(p=>p.rate!=null);
    if(!pts.length) return '<div class="v9-muted">æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    const minX=pts[0].day, maxX=pts[pts.length-1].day;
    const minR=0, maxR=Math.max(0.3, ...pts.map(p=>p.rate));
    const x=(day)=> pad + ((day-minX)/Math.max(1,(maxX-minX)))*(w-2*pad);
    const y=(r)=> (h-pad) - ((r-minR)/Math.max(1e-6,(maxR-minR)))*(h-2*pad);
    const path=pts.map((p,i)=>((i?'L':'M') + " " + (x(p.day).toFixed(1)) + " " + (y(p.rate).toFixed(1)))).join(' ');
    const target = (parseFloat(document.getElementById('target-margin')?.value)||25)/100;
    const warn = (parseFloat(document.getElementById('warning-margin')?.value)||23)/100;
    const yT=y(Math.min(maxR, target));
    const yW=y(Math.min(maxR, warn));
    return ("\n<svg viewBox=\"0 0 " + (w) + " " + (h) + "\" width=\"100%\" height=\"220\" style=\"display:block\">\n  <rect x=\"0\" y=\"0\" width=\"" + (w) + "\" height=\"" + (h) + "\" rx=\"12\" fill=\"var(--bg3)\"></rect>\n  <line x1=\"" + (pad) + "\" y1=\"" + (yT) + "\" x2=\"" + (w-pad) + "\" y2=\"" + (yT) + "\" stroke=\"rgba(34,197,94,.8)\" stroke-width=\"2\" stroke-dasharray=\"6 6\"></line>\n  <line x1=\"" + (pad) + "\" y1=\"" + (yW) + "\" x2=\"" + (w-pad) + "\" y2=\"" + (yW) + "\" stroke=\"rgba(245,158,11,.9)\" stroke-width=\"2\" stroke-dasharray=\"6 6\"></line>\n  <path d=\"" + (path) + "\" fill=\"none\" stroke=\"rgba(99,102,241,.95)\" stroke-width=\"3\"></path>\n  <text x=\"" + (pad) + "\" y=\"" + (pad-8) + "\" fill=\"var(--text3)\" font-size=\"12\" font-weight=\"700\">\u7d2b: \u65e5\u6b21\u7c97\u5229\u7387\uff08\u7c21\u6613\uff09</text>\n  <text x=\"" + (w-pad) + "\" y=\"" + (pad-8) + "\" text-anchor=\"end\" fill=\"var(--text2)\" font-size=\"12\" font-weight=\"700\">\u76ee\u6a19 " + (Math.round(target*100)) + "% / \u8b66\u544a " + (Math.round(warn*100)) + "%</text>\n</svg>");
  }catch(e){
    return '<div class="v9-muted">ã‚°ãƒ©ãƒ•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}



function v22_dailySalesSVG(data){
  try{
    const w=900, h=240, pad=26;
    const days = Object.keys(data.daily||{}).map(x=>+x).sort((a,b)=>a-b).filter(d=>d>=1 && d<=31);
    if(!days.length) return '<div class="v9-muted">æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    const vals = days.map(day=>({day, sales:(data.daily[day]?.sales||0), baihen:(data.daily[day]?.baihen||0)}));
    const maxSales = Math.max(1,...vals.map(v=>v.sales));
    const barW = (w-2*pad)/Math.max(1,vals.length);
    const x = (i)=> pad + i*barW;
    const ySales = (v)=> (h-pad) - (v/maxSales)*(h-2*pad);
    // line: baihen rate vs sales (baihen/sales)
    const pts = vals.map((v,i)=>({x:x(i)+barW/2, y:(h-pad) - (Math.min(0.5,(v.sales>0? (v.baihen/v.sales):0))/0.5)*(h-2*pad)}));
    const path = pts.map((p,i)=>((i?'L':'M') + " " + (p.x.toFixed(1)) + " " + (p.y.toFixed(1)))).join(' ');
    return ("\n<svg viewBox=\"0 0 " + (w) + " " + (h) + "\" width=\"100%\" height=\"240\" style=\"display:block\">\n  <rect x=\"0\" y=\"0\" width=\"" + (w) + "\" height=\"" + (h) + "\" rx=\"12\" fill=\"var(--bg3)\"></rect>\n  " + (vals.map((v,i)=>{
    const bh = (h-pad) - ySales(v.sales);
    return '<rect x="' + (x(i)+2) + '" y="' + (ySales(v.sales)) + '" width="' + (Math.max(2,barW-4)) + '" height="' + (bh) + '" rx="6" fill="rgba(99,102,241,.35)"></rect>';
  }).join('')) + "\n  <path d=\"" + (path) + "\" fill=\"none\" stroke=\"rgba(239,68,68,.95)\" stroke-width=\"3\"></path>\n  <text x=\"" + (pad) + "\" y=\"" + (pad-8) + "\" fill=\"var(--text3)\" font-size=\"12\" font-weight=\"700\">\u68d2: \u58f2\u4e0a / \u8d64\u7dda: \u58f2\u5909\u7387\uff08\u58f2\u4fa1\uff09\u203b0\u301c50%\u30b9\u30b1\u30fc\u30eb</text>\n</svg>");
  }catch(e){
    return '<div class="v9-muted">ã‚°ãƒ©ãƒ•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
  }
}


function renderAnalysis(){
const data=result[currentStore];if(!data)return;
const progressPct=data.budgetAchievement*100;
const consumePct=data.budgetConsumptionRate*100;
const projPct=data.projectedAchievement*100;
const progressColor=progressPct>=100?'var(--success)':progressPct>=80?'var(--warning)':'var(--danger)';
const projColor=projPct>=100?'var(--success)':projPct>=90?'var(--warning)':'var(--danger)';
const beforeRate=(data.grossProfitRateBeforeConsumable||0)*100;
const afterRate=(data.grossProfitRate||0)*100;

let h='<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">';
// KPIã‚«ãƒ¼ãƒ‰
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--primary)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ“Š äºˆç®—é”æˆç‡</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:'+progressColor+'">'+fmtPct(data.budgetAchievement)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(progressPct,100)+'%;background:'+progressColor+';border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">'+fmt(data.totalSales)+' / '+fmt(data.budget)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--info)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ“… äºˆç®—æ¶ˆåŒ–ç‡</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:var(--info)">'+fmtPct(data.budgetConsumptionRate)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(consumePct,100)+'%;background:var(--info);border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">çµŒé '+fmt(data.budgetConsumed)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--purple)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ¯ ç€åœ°äºˆæ¸¬</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:'+projColor+'">'+fmtPct(data.projectedAchievement)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+Math.min(projPct,100)+'%;background:'+projColor+';border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">äºˆæ¸¬ '+fmt(data.projectedSales)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid #60a5fa"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ“ˆ è’åˆ©ç‡(ç¨æŠœå‰)</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:#60a5fa">'+fmtPct(data.grossProfitRateBeforeConsumable)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+beforeRate+'%;background:#60a5fa;border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">è’åˆ© '+fmt(data.grossProfitBeforeConsumable)+'</div></div>';
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px;border-top:3px solid var(--success)"><div style="font-size:0.55rem;color:var(--text4);font-weight:700;text-transform:uppercase;margin-bottom:4px">ğŸ’° è’åˆ©ç‡(ç¨æŠœå¾Œ)</div><div style="font-family:\'JetBrains Mono\',monospace;font-size:1.2rem;font-weight:700;color:var(--success)">'+fmtPct(data.grossProfitRate)+'</div><div style="margin-top:6px;height:5px;background:var(--bg4);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+afterRate+'%;background:var(--success);border-radius:3px"></div></div><div style="font-size:0.55rem;color:var(--text3);margin-top:3px">è’åˆ© '+fmt(data.grossProfit)+'</div></div>';
h+='</div>';
h+='</div>';

// ã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ«
h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px">';
// å£²ä¸Šåˆ†æ
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px"><div style="font-size:0.75rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ’°</span>å£²ä¸Šåˆ†æ</div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">æœˆé–“äºˆç®—</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+fmt(data.budget)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">å£²ä¸Šå®Ÿç¸¾</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+fmt(data.totalSales)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">äºˆç®—æ®‹</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:'+(data.remainingBudget>0?'var(--warning)':'var(--success)')+'">'+fmt(data.remainingBudget)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.75rem"><span style="color:var(--text2)">æ—¥è²©å¹³å‡</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+fmt(data.avgDailySales)+'</span></div>';
h+='</div>';

// é€²æ—åˆ†æ
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px"><div style="font-size:0.75rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“ˆ</span>é€²æ—åˆ†æ</div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">å–¶æ¥­æ—¥æ•°</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+data.salesDays+'æ—¥</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">æœ€çµ‚æ—¥</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500">'+data.elapsedDays+'æ—¥</span></div>';
const pace=data.budgetConsumptionRate>0?(data.budgetAchievement/data.budgetConsumptionRate):0;
const paceColor=pace>=1?'var(--success)':pace>=0.9?'var(--warning)':'var(--danger)';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ãƒšãƒ¼ã‚¹</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:'+paceColor+'">'+fmtPct(pace)+'</span></div>';
const needDaily=data.remainingBudget>0&&data.remainingBudgetDays>0?data.remainingBudget/data.remainingBudgetDays:0;
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.75rem"><span style="color:var(--text2)">å¿…è¦æ—¥è²©</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--warning)">'+fmt(needDaily)+'</span></div>';
h+='</div>';

// åˆ©ç›Šåˆ†æ
h+='<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:16px"><div style="font-size:0.75rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“Š</span>åˆ©ç›Šåˆ†æ</div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ“‰ å£²å¤‰ç‡(å£²ä¾¡)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:#ef4444">'+fmtPct(data.baihenRateSales||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ“‰ å€¤å¼•ç‡(åŸä¾¡)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:600;color:#dc2626">'+fmtPct(data.baihenRateCost||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">å€¤å…¥ç‡(ã‚³ã‚¢)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--info)">'+fmtPct(data.coreMarginRate||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ¯ æ¨å®šç²—åˆ©ç‡</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:#8b5cf6">'+fmtPct(data.estimatedGrossRate||0)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">ğŸ§¾ åŸä¾¡ç®—å…¥æ¯”</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:#f97316">'+fmt(data.totalConsumable||0)+' ('+fmtPct(data.consumableRate||0)+')</span></div>';
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.75rem"><span style="color:var(--text2)">è’åˆ©ç‡(å®Ÿç¸¾)</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--success)">'+fmtPct(data.grossProfitRate)+'</span></div>';
const lossRate=data.avgMargin-data.grossProfitRate;
h+='<div style="display:flex;justify-content:space-between;padding:8px 0;font-size:0.75rem"><span style="color:var(--text2)">ãƒ­ã‚¹ç‡</span><span style="font-family:\'JetBrains Mono\',monospace;font-weight:500;color:var(--danger)">'+fmtPct(lossRate)+'</span></div>';
h+='</div></div>';


// -------- Graphical charts (v22) --------
const budgetChartSVG = v22_budgetVsActualSVG(data);
const gpChartSVG = v22_grossRateSVG(data);
h += '<div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:16px">';
h += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px">';
h += '<div style="font-size:0.75rem;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“Š</span>ç´¯è¨ˆ äºˆç®— vs å®Ÿç¸¾ï¼ˆã‚°ãƒ©ãƒ•ï¼‰</div>';
h += budgetChartSVG;
h += '</div>';
h += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:14px">';
h += '<div style="font-size:0.75rem;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:8px"><span style="width:28px;height:28px;background:var(--bg3);border-radius:7px;display:flex;align-items:center;justify-content:center">ğŸ“ˆ</span>è’åˆ©ç‡æ¨ç§»ï¼ˆå‚è€ƒï¼‰</div>';
h += gpChartSVG;
h += '</div></div>';

// æ—¥åˆ¥äºˆç®—vså®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«
h+='<div class="section expanded"><div class="section-header" onclick="this.parentElement.classList.toggle(\'expanded\')"><div class="section-icon daily">ğŸ“…</div><div class="section-info"><div class="section-name">æ—¥åˆ¥ äºˆç®— vs å®Ÿç¸¾</div><div class="section-meta">å£²ä¸Šæ¨ç§»ã¨äºˆç®—æ¶ˆåŒ–çŠ¶æ³</div></div><div class="section-toggle">â–¼</div></div><div class="section-body"><table><thead><tr><th>æ—¥</th><th>äºˆç®—</th><th>å®Ÿç¸¾</th><th>å·®ç•°</th><th>é”æˆç‡</th><th>ç´¯è¨ˆäºˆç®—</th><th>ç´¯è¨ˆå®Ÿç¸¾</th><th>ç´¯è¨ˆé”æˆ</th><th>è’åˆ©</th></tr></thead><tbody>';
let cumBudget=0,cumSales=0,cumCost=0;
for(let day=1;day<=31;day++){
    const d=data.daily[day];
    const dayBudget=data.budgetDaily?.[day]||0;
    if(!d&&dayBudget===0)continue;
    const daySales=d?.sales||0;
    const dayCost=(d?.shiire?.cost||0)+(d?.tenkanInTotal?.cost||0)+(d?.tenkanOutTotal?.cost||0)+(d?.bumonInTotal?.cost||0)+(d?.bumonOutTotal?.cost||0)+(d?.hana?.cost||0)+(d?.sanchoku?.cost||0)+(d?.consumable?.cost||0);
    cumBudget+=dayBudget;
    cumSales+=daySales;
    cumCost+=dayCost;
    const diff=daySales-dayBudget;
    const dayAch=dayBudget>0?daySales/dayBudget:0;
    const cumAch=cumBudget>0?cumSales/cumBudget:0;
    const dayProfit=daySales-dayCost;
    const achColor=dayAch>=1?'positive':dayAch>=0.9?'':'negative';
    const cumAchColor=cumAch>=1?'positive':cumAch>=0.9?'':'negative';
    h+='<tr><td>'+day+'æ—¥</td><td>'+fmt(dayBudget)+'</td><td>'+fmt(daySales)+'</td><td class="'+(diff>=0?'positive':'negative')+'">'+fmt(diff)+'</td><td class="'+achColor+'">'+fmtPct(dayAch)+'</td><td style="color:var(--text3)">'+fmt(cumBudget)+'</td><td class="highlight">'+fmt(cumSales)+'</td><td class="'+cumAchColor+'">'+fmtPct(cumAch)+'</td><td class="'+(dayProfit>=0?'positive':'negative')+'">'+fmt(dayProfit)+'</td></tr>';
}
h+='<tr class="row-total"><td>åˆè¨ˆ</td><td>'+fmt(data.budget)+'</td><td>'+fmt(data.totalSales)+'</td><td class="'+(data.totalSales-data.budget>=0?'positive':'negative')+'">'+fmt(data.totalSales-data.budget)+'</td><td class="'+(data.budgetAchievement>=1?'positive':'negative')+'">'+fmtPct(data.budgetAchievement)+'</td><td></td><td></td><td></td><td class="positive">'+fmt(data.grossProfit)+'</td></tr>';
h+='</tbody></table></div></div>';
document.getElementById('content').innerHTML=h;
}

function renderSummary(){const data=result[currentStore];if(!data)return;const cogs=data.invStart+data.totalCost-data.invEnd;
let h='<div class="summary-grid">';

// å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹è’åˆ©è¨ˆç®—
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon">ğŸ“Š</div><div class="summary-panel-title">å®Ÿç¸¾è’åˆ©è¨ˆç®—</div></div><div class="summary-row"><span class="lt">æœŸé¦–åœ¨åº«</span><span class="value">'+fmt(data.invStart)+'</span></div><div class="summary-row"><span class="lt">ï¼‹ ç·ä»•å…¥</span><span class="value">'+fmt(data.totalCost)+'</span></div><div class="summary-row"><span class="lt">ï¼ æœŸæœ«åœ¨åº«</span><span class="value">'+fmt(data.invEnd)+'</span></div><div class="summary-row"><span class="lt">ï¼ å£²ä¸ŠåŸä¾¡</span><span class="value" style="color:var(--warning)">'+fmt(cogs)+'</span></div><div class="summary-total"><span>è’åˆ©ç›Š(å®Ÿç¸¾)</span><span class="value">'+fmt(data.grossProfit)+' ('+fmtPct(data.grossProfitRate)+')</span></div></div>';

// æ¨å®šè’åˆ©è¨ˆç®—ï¼ˆå€¤å¼•æå¤±ã®è©³ç´°ã‚’è¿½åŠ ï¼‰
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">ğŸ¯</div><div class="summary-panel-title">æ¨å®šè’åˆ©è¨ˆç®—</div></div>';
h+='<div class="summary-row"><span class="lt">ğŸ“‰ å£²å¤‰é¡åˆè¨ˆ</span><span class="value" style="color:#ef4444">'+fmt(data.totalBaihen)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ“‰ å£²å¤‰ç‡(å£²ä¾¡)</span><span class="value" style="color:#ef4444">'+fmtPct(data.baihenRateSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ“‰ å€¤å¼•ç‡(åŸä¾¡)</span><span class="value" style="color:#dc2626;font-weight:600">'+fmtPct(data.baihenRateCost)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ’¸ å€¤å¼•åŸä¾¡æå¤±</span><span class="value" style="color:#dc2626">'+fmt(data.baihenLossCost||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">å€¤å…¥ç‡(ã‚³ã‚¢)</span><span class="value" style="color:var(--info)">'+fmtPct(data.coreMarginRate)+'</span></div>';
h+='<div class="summary-row"><span class="lt">æ¨å®šç²—åˆ©ç‡(ã‚³ã‚¢)</span><span class="value" style="color:#8b5cf6">'+fmtPct(data.estimatedCoreGrossRate)+'</span></div>';
h+='<div style="font-size:0.55rem;color:var(--text4);padding:4px 0;border-bottom:1px solid var(--border)">(å€¤å…¥ç‡ - å£²å¤‰ç‡) / (1 - å£²å¤‰ç‡)</div>';
h+='<div class="summary-total"><span>æ¨å®šè’åˆ©</span><span class="value" style="color:#8b5cf6">'+fmt(data.estimatedGrossProfit)+' ('+fmtPct(data.estimatedGrossRate)+')</span></div></div>';

// æ¨å®šåœ¨åº«ï¼ˆå€¤å¼•æå¤±ã®å½±éŸ¿ã‚’æ˜ç¤ºï¼‰
const estimatedCogs=data.estimatedCogs||data.totalSales-data.estimatedGrossProfit;
const invDiff=data.estimatedInvEnd-data.invEnd;
// ã‚°ãƒ­ã‚¹å£²ä¸Šï¼ˆã‚³ã‚¢ï¼‰= ãƒãƒƒãƒˆå£²ä¸Š / (1 - d)
const coreGrossSales=(1-data.baihenRateSales)>0?data.totalCoreSales/(1-data.baihenRateSales):data.totalCoreSales;
// å€¤å¼•ãªã—ã®ç†è«–åœ¨åº«ï¼ˆãƒãƒƒãƒˆå£²ä¸Šã«å€¤å…¥ç‡ã‚’é©ç”¨ï¼‰
const theoryCogs=data.totalCoreSales*(1-data.coreMarginRate)+(data.deliverySalesCost||0)+data.totalConsumable;
const theoryInvEnd=data.invStart+data.totalCost-theoryCogs;
const baihenImpact=theoryInvEnd-data.estimatedInvEnd; // å€¤å¼•ãŒåœ¨åº«ã«ä¸ãˆã‚‹å½±éŸ¿

h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸ“¦</div><div class="summary-panel-title">æ¨å®šåœ¨åº«è¨ˆç®—</div></div>';

// è¨ˆç®—å¼ã®èª¬æ˜
h+='<div style="font-size:0.55rem;color:var(--text4);padding:6px 8px;background:var(--bg4);border-radius:4px;margin-bottom:8px;line-height:1.5">';
h+='<div><strong>è¨ˆç®—å¼:</strong></div>';
h+='<div>â‘  ã‚°ãƒ­ã‚¹å£²ä¸Š = ãƒãƒƒãƒˆå£²ä¸Š Ã· (1-d)</div>';
h+='<div>â‘¡ æ¨å®šå£²ä¸ŠåŸä¾¡ = ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1-m)</div>';
h+='<div>â‘¢ æ¨å®šåœ¨åº« = æœŸé¦– + ä»•å…¥ - å£²ä¸ŠåŸä¾¡</div>';
h+='</div>';

h+='<div class="summary-row"><span class="lt">ã‚³ã‚¢ãƒãƒƒãƒˆå£²ä¸Š</span><span class="value">'+fmt(data.totalCoreSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">Ã· (1 - d) â†’ ã‚°ãƒ­ã‚¹å£²ä¸Š</span><span class="value" style="color:#f97316">'+fmt(coreGrossSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">Ã— (1 - m) â†’ ã‚³ã‚¢åŸä¾¡</span><span class="value" style="color:var(--warning)">'+fmt(coreGrossSales*(1-data.coreMarginRate))+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼‹ å£²ä¸Šç´å“åŸä¾¡</span><span class="value">'+fmt(data.deliverySalesCost||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼‹ æ¶ˆè€—å“</span><span class="value">'+fmt(data.totalConsumable||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼ æ¨å®šå£²ä¸ŠåŸä¾¡</span><span class="value" style="color:var(--warning);font-weight:600">'+fmt(estimatedCogs)+'</span></div>';

h+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">';
h+='<div class="summary-row"><span class="lt">æœŸé¦–åœ¨åº« (BI)</span><span class="value">'+fmt(data.invStart)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼‹ ç·ä»•å…¥ (P)</span><span class="value">'+fmt(data.totalCost)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ï¼ æ¨å®šåŸä¾¡ (COGS)</span><span class="value" style="color:var(--warning)">'+fmt(estimatedCogs)+'</span></div>';
h+='<div class="summary-row" style="font-weight:700"><span class="lt">ï¼ æ¨å®šæœŸæœ«åœ¨åº«</span><span class="value" style="color:#06b6d4">'+fmt(data.estimatedInvEnd)+'</span></div>';
h+='</div>';

h+='<div style="margin-top:8px;padding:8px;background:var(--bg4);border-radius:6px;font-size:0.65rem">';
h+='<div style="display:flex;justify-content:space-between"><span style="color:var(--text3)">å€¤å¼•ãªã—ç†è«–åœ¨åº«</span><span style="font-family:\'JetBrains Mono\',monospace">'+fmt(theoryInvEnd)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:3px"><span style="color:#dc2626">ğŸ’¸ å€¤å¼•ã«ã‚ˆã‚‹åœ¨åº«æ¸›</span><span style="font-family:\'JetBrains Mono\',monospace;color:#dc2626">-'+fmt(baihenImpact)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:3px;padding-top:5px;border-top:1px solid var(--border)"><span style="color:var(--text3)">å®Ÿéš›æœŸæœ«åœ¨åº«</span><span style="font-family:\'JetBrains Mono\',monospace">'+fmt(data.invEnd)+'</span></div>';
h+='<div style="display:flex;justify-content:space-between;margin-top:3px"><span style="color:var(--text3)">æ¨å®šã¨ã®å·®ç•°</span><span style="font-family:\'JetBrains Mono\',monospace;color:'+(invDiff>=0?'var(--success)':'var(--danger)')+'">'+fmt(invDiff)+'</span></div>';
h+='</div></div>';

// å£²ä¸Šæ§‹æˆ
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon">ğŸ’°</div><div class="summary-panel-title">å£²ä¸Šæ§‹æˆ</div></div>';
h+='<div class="summary-row"><span class="lt">ç·å£²ä¸Š</span><span class="value">'+fmt(data.totalSales)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸŒ¸ èŠ± å£²ä¸Š</span><span class="value" style="color:#f472b6">'+fmt(data.deliverySalesPrice-(data.catTotals.sanchoku?.price||0))+'</span></div>';
h+='<div class="summary-row"><span class="lt">ğŸ¥¬ ç”£ç›´ å£²ä¸Š</span><span class="value" style="color:#a3e635">'+fmt(data.catTotals.sanchoku?.price||0)+'</span></div>';
h+='<div class="summary-row"><span class="lt">ã‚³ã‚¢å£²ä¸Š</span><span class="value">'+fmt(data.totalCoreSales)+'</span></div>';
h+='<div class="summary-total"><span>äºˆç®—é”æˆç‡</span><span class="value">'+fmtPct(data.totalSales/data.budget)+'</span></div></div>';

// å¸³åˆæ§‹æˆ
h+='<div class="summary-panel"><div class="summary-panel-header"><div class="summary-panel-icon">ğŸ“¦</div><div class="summary-panel-title">å¸³åˆæ§‹æˆ</div></div>';getCatOrder().forEach(cat=>{const c=data.catTotals[cat];if(!c||c.cost===0)return;const sh=data.totalCost>0?c.cost/data.totalCost:0,info=CATEGORIES[cat]||{name:cat,icon:'ğŸ“‹'};h+='<div class="summary-row"><span class="lt">'+info.icon+' '+info.name+'</span><span class="value">'+fmtPct(sh)+'</span></div>';});h+='</div>';

h+='</div>';

// æ—¥åˆ¥åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•
if(data.dailyInvData&&data.dailyInvData.length>0){
    h+=renderInventoryChart(data);
}

document.getElementById('content').innerHTML=h;}

// æ—¥åˆ¥åœ¨åº«æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’æç”»
function renderInventoryChart(data){
    const invData=data.dailyInvData.filter(d=>d.hasData||d.day===1);
    if(invData.length===0)return '';
    
    // ãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹æœ€çµ‚æ—¥ã‚’å–å¾—
    let lastDataDay=1;
    data.dailyInvData.forEach(d=>{if(d.hasData)lastDataDay=d.day;});
    const chartData=data.dailyInvData.filter(d=>d.day<=lastDataDay);
    
    // æœ€å¤§ãƒ»æœ€å°å€¤ã‚’è¨ˆç®—
    const invValues=chartData.map(d=>d.inv);
    const maxInv=Math.max(data.invStart,...invValues)*1.1;
    const minInv=Math.min(data.invStart,...invValues)*0.9;
    const range=maxInv-minInv;
    
    const chartWidth=100;
    const chartHeight=180;
    const padding={top:20,right:15,bottom:30,left:10};
    const graphWidth=chartWidth-padding.left-padding.right;
    const graphHeight=chartHeight-padding.top-padding.bottom;
    
    // SVGãƒ‘ã‚¹ã‚’ç”Ÿæˆ
    let pathD='';
    let areaD='';
    const points=[];
    
    chartData.forEach((d,i)=>{
        const x=padding.left+(i/(chartData.length-1||1))*graphWidth;
        const y=padding.top+graphHeight-(d.inv-minInv)/range*graphHeight;
        points.push({x,y,day:d.day,inv:d.inv,hasData:d.hasData});
        if(i===0){
            pathD=("M " + (x) + " " + (y));
            areaD=("M " + (x) + " " + (padding.top+graphHeight) + " L " + (x) + " " + (y));
        }else{
            pathD+=(" L " + (x) + " " + (y));
            areaD+=(" L " + (x) + " " + (y));
        }
    });
    areaD+=(" L " + (padding.left+graphWidth) + " " + (padding.top+graphHeight) + " Z");
    
    // æœŸé¦–åœ¨åº«ãƒ©ã‚¤ãƒ³
    const startY=padding.top+graphHeight-(data.invStart-minInv)/range*graphHeight;
    // æœŸæœ«åœ¨åº«ãƒ©ã‚¤ãƒ³ï¼ˆå®Ÿç¸¾ï¼‰
    const endY=padding.top+graphHeight-(data.invEnd-minInv)/range*graphHeight;
    // æ¨å®šæœŸæœ«åœ¨åº«ãƒ©ã‚¤ãƒ³
    const estEndY=padding.top+graphHeight-(data.estimatedInvEnd-minInv)/range*graphHeight;
    
    let h='<div class="section expanded" style="margin-top:16px"><div class="section-header"><div class="section-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">ğŸ“ˆ</div><div class="section-info"><div class="section-name">æ—¥åˆ¥æ¨å®šåœ¨åº«æ¨ç§»</div><div class="section-meta">æœŸé¦–åœ¨åº«ã‹ã‚‰ã®å¤‰å‹•ï¼ˆå€¤å¼•æå¤±åæ˜ ï¼‰</div></div></div>';
    h+='<div class="section-body" style="padding:16px">';
    
    // SVGã‚°ãƒ©ãƒ•
    h+='<div style="position:relative;width:100%;height:'+chartHeight+'px;background:var(--bg3);border-radius:8px;overflow:hidden">';
    h+='<svg viewBox="0 0 '+chartWidth+' '+chartHeight+'" style="width:100%;height:100%" preserveAspectRatio="none">';
    
    // ã‚°ãƒªãƒƒãƒ‰ç·š
    for(let i=0;i<=4;i++){
        const y=padding.top+graphHeight*i/4;
        const val=maxInv-range*i/4;
        h+='<line x1="'+padding.left+'" y1="'+y+'" x2="'+(chartWidth-padding.right)+'" y2="'+y+'" stroke="var(--border)" stroke-width="0.3" stroke-dasharray="2,2"/>';
    }
    
    // æœŸé¦–åœ¨åº«åŸºæº–ç·š
    h+='<line x1="'+padding.left+'" y1="'+startY+'" x2="'+(chartWidth-padding.right)+'" y2="'+startY+'" stroke="#60a5fa" stroke-width="0.5" stroke-dasharray="3,2"/>';
    
    // å®Ÿç¸¾æœŸæœ«åœ¨åº«åŸºæº–ç·š
    h+='<line x1="'+padding.left+'" y1="'+endY+'" x2="'+(chartWidth-padding.right)+'" y2="'+endY+'" stroke="#22c55e" stroke-width="0.5" stroke-dasharray="3,2"/>';
    
    // ã‚¨ãƒªã‚¢å¡—ã‚Šã¤ã¶ã—
    h+='<path d="'+areaD+'" fill="url(#invGradient)" opacity="0.3"/>';
    
    // åœ¨åº«æ¨ç§»ãƒ©ã‚¤ãƒ³
    h+='<path d="'+pathD+'" fill="none" stroke="#06b6d4" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>';
    
    // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
    h+='<defs><linearGradient id="invGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#06b6d4" stop-opacity="0.6"/><stop offset="100%" stop-color="#06b6d4" stop-opacity="0.05"/></linearGradient></defs>';
    
    // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ
    points.forEach(p=>{
        if(p.hasData){
            h+='<circle cx="'+p.x+'" cy="'+p.y+'" r="1.5" fill="#06b6d4" stroke="var(--bg2)" stroke-width="0.5"/>';
        }
    });
    
    h+='</svg>';
    
    // å‡¡ä¾‹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
    h+='<div style="position:absolute;top:8px;right:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 8px;font-size:0.55rem">';
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px"><span style="width:12px;height:2px;background:#60a5fa;display:inline-block"></span><span style="color:var(--text3)">æœŸé¦– '+fmt(data.invStart)+'</span></div>';
    h+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:3px"><span style="width:12px;height:2px;background:#06b6d4;display:inline-block"></span><span style="color:#06b6d4">æ¨å®š '+fmt(data.estimatedInvEnd)+'</span></div>';
    h+='<div style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:2px;background:#22c55e;display:inline-block"></span><span style="color:#22c55e">å®Ÿç¸¾ '+fmt(data.invEnd)+'</span></div>';
    h+='</div>';
    
    h+='</div>';
    
    // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
    h+='<div style="margin-top:12px;max-height:200px;overflow-y:auto"><table style="font-size:0.65rem"><thead><tr><th>æ—¥</th><th>æ¨å®šåœ¨åº«</th><th>ç´¯è¨ˆå£²ä¸Š</th><th>ç´¯è¨ˆä»•å…¥</th><th>ç´¯è¨ˆå€¤å¼•</th></tr></thead><tbody>';
    chartData.forEach(d=>{
        if(!d.hasData&&d.day!==1)return;
        const invColor=d.inv<data.invStart*0.7?'#ef4444':d.inv<data.invStart*0.85?'#f97316':'#06b6d4';
        h+='<tr><td>'+(d.day===1?'æœŸé¦–':d.day+'æ—¥')+'</td><td style="font-family:\'JetBrains Mono\',monospace;color:'+invColor+'">'+fmt(d.inv)+'</td><td>'+fmt(d.cumSales)+'</td><td>'+fmt(d.cumCost)+'</td><td style="color:#ef4444">'+(d.cumBaihen?fmt(d.cumBaihen):'-')+'</td></tr>';
    });
    h+='</tbody></table></div>';
    
    h+='</div></div>';
    return h;
}

// ===== ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ =====
let currentReportType=null;
let currentReportData=null;

function renderReports(){
    const data=result[currentStore];if(!data)return;
    
    let h='<div style="margin-bottom:20px"><div style="font-size:1.1rem;font-weight:700;margin-bottom:8px">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›</div><div style="font-size:0.75rem;color:var(--text3)">å„ç¨®å¸³ç¥¨ã‚’ç”Ÿæˆãƒ»å‡ºåŠ›ã—ã¾ã™</div></div>';
    
    h+='<div class="report-grid">';
    
    // æ—¥å ±
    h+=("<div class=\"report-card\" onclick=\"generateReport('daily')\">\n        <div class=\"report-card-icon\" style=\"background:linear-gradient(135deg,#fbbf24,#f59e0b)\">\ud83d\udcc5</div>\n        <div class=\"report-card-title\">\u65e5\u5831</div>\n        <div class=\"report-card-desc\">\u65e5\u5225\u306e\u58f2\u4e0a\u30fb\u4ed5\u5165\u30fb\u7c97\u5229\u30c7\u30fc\u30bf</div>\n    </div>");
    
    // é€±å ±
    h+=("<div class=\"report-card\" onclick=\"generateReport('weekly')\">\n        <div class=\"report-card-icon\" style=\"background:linear-gradient(135deg,#6366f1,#4f46e5)\">\ud83d\udcc6</div>\n        <div class=\"report-card-title\">\u9031\u5831</div>\n        <div class=\"report-card-desc\">\u9031\u9593\u96c6\u8a08\uff08\u6c34\u66dc\u301c\u706b\u66dc\uff09\u30ec\u30dd\u30fc\u30c8</div>\n    </div>");
    
    // æœˆå ±
    h+=("<div class=\"report-card\" onclick=\"generateReport('monthly')\">\n        <div class=\"report-card-icon\" style=\"background:linear-gradient(135deg,#22c55e,#16a34a)\">\ud83d\udcca</div>\n        <div class=\"report-card-title\">\u6708\u5831</div>\n        <div class=\"report-card-desc\">\u6708\u9593\u30b5\u30de\u30ea\u30fc\u30ec\u30dd\u30fc\u30c8</div>\n    </div>");
    
    // å¸³åˆåˆ¥
    h+=("<div class=\"report-card\" onclick=\"generateReport('category')\">\n        <div class=\"report-card-icon\" style=\"background:linear-gradient(135deg,#a78bfa,#8b5cf6)\">\ud83d\udce6</div>\n        <div class=\"report-card-title\">\u5e33\u5408\u5225\u30ec\u30dd\u30fc\u30c8</div>\n        <div class=\"report-card-desc\">\u5e33\u5408\u5206\u985e\u5225\u306e\u4ed5\u5165\u96c6\u8a08</div>\n    </div>");
    
    // ä»•å…¥å…ˆåˆ¥
    h+=("<div class=\"report-card\" onclick=\"generateReport('supplier')\">\n        <div class=\"report-card-icon\" style=\"background:linear-gradient(135deg,#06b6d4,#0891b2)\">\ud83c\udfed</div>\n        <div class=\"report-card-title\">\u4ed5\u5165\u5148\u5225\u30ec\u30dd\u30fc\u30c8</div>\n        <div class=\"report-card-desc\">\u53d6\u5f15\u5148\u5225\u306e\u8a73\u7d30\u96c6\u8a08</div>\n    </div>");
    
    // åœ¨åº«æ¨ç§»
    h+=("<div class=\"report-card\" onclick=\"generateReport('inventory')\">\n        <div class=\"report-card-icon\" style=\"background:linear-gradient(135deg,#ec4899,#be185d)\">\ud83d\udcc8</div>\n        <div class=\"report-card-title\">\u5728\u5eab\u63a8\u79fb\u30ec\u30dd\u30fc\u30c8</div>\n        <div class=\"report-card-desc\">\u65e5\u5225\u63a8\u5b9a\u5728\u5eab\u306e\u5909\u52d5</div>\n    </div>");
    
    h+='</div>';
    
    // ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    h+='<div style="margin-top:24px;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:10px">';
    h+='<div style="font-size:0.85rem;font-weight:600;margin-bottom:12px">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>';
    h+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
    h+='<button onclick="exportAllReports()" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.75rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ“¥ å…¨ãƒ¬ãƒãƒ¼ãƒˆExcelå‡ºåŠ›</button>';
    h+='<button onclick="window.print()" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.75rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ–¨ï¸ ç¾åœ¨ã®ç”»é¢ã‚’å°åˆ·</button>';
    h+='<button onclick="showColumnConfig()" style="padding:10px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text2);font-size:0.75rem;cursor:pointer;display:flex;align-items:center;gap:6px">ğŸ“Š è¡¨ç¤ºåˆ—è¨­å®š</button>';
    h+='</div></div>';
    
    document.getElementById('content').innerHTML=h;
}

function generateReport(type){
    currentReportType=type;
    const data=result[currentStore];if(!data)return;
    
    const titles={
        daily:{title:'æ—¥å ±',icon:'ğŸ“…',bg:'linear-gradient(135deg,#fbbf24,#f59e0b)'},
        weekly:{title:'é€±å ±',icon:'ğŸ“†',bg:'linear-gradient(135deg,#6366f1,#4f46e5)'},
        monthly:{title:'æœˆå ±',icon:'ğŸ“Š',bg:'linear-gradient(135deg,#22c55e,#16a34a)'},
        category:{title:'å¸³åˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ',icon:'ğŸ“¦',bg:'linear-gradient(135deg,#a78bfa,#8b5cf6)'},
        supplier:{title:'ä»•å…¥å…ˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ',icon:'ğŸ­',bg:'linear-gradient(135deg,#06b6d4,#0891b2)'},
        inventory:{title:'åœ¨åº«æ¨ç§»ãƒ¬ãƒãƒ¼ãƒˆ',icon:'ğŸ“ˆ',bg:'linear-gradient(135deg,#ec4899,#be185d)'}
    };
    
    const info=titles[type]||{title:type,icon:'ğŸ“‹',bg:'linear-gradient(135deg,#6366f1,#4f46e5)'};
    
    document.getElementById('report-preview-icon').style.background=info.bg;
    document.getElementById('report-preview-icon').textContent=info.icon;
    document.getElementById('report-preview-title').textContent=info.title;
    document.getElementById('report-preview-sub').textContent=STORES[currentStore]?.name||'å…¨åº—èˆ—';
    
    let content='';
    
    switch(type){
        case'daily':content=generateDailyReport(data);break;
        case'weekly':content=generateWeeklyReport(data);break;
        case'monthly':content=generateMonthlyReport(data);break;
        case'category':content=generateCategoryReport(data);break;
        case'supplier':content=generateSupplierReport(data);break;
        case'inventory':content=generateInventoryReport(data);break;
    }
    
    document.getElementById('report-preview-content').innerHTML=content;
    document.getElementById('report-preview-modal').style.display='flex';
}

function generateDailyReport(data){
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">æ—¥ä»˜</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¸Š</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ä»•å…¥åŸä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å¼•é¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ç´¯è¨ˆå£²ä¸Š</th></tr></thead><tbody>';
    
    let cumSales=0;
    Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{
        cumSales+=d.sales;
        h+=("<tr style=\"border-bottom:1px solid var(--border)\">\n            <td style=\"padding:8px\">" + (day) + "\u65e5</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(d.sales)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(d.shiire?.cost||0)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--danger)\">" + (d.baihen?'Â¥'+fmt(d.baihen):'-') + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;font-weight:600\">\u00a5" + (fmt(cumSales)) + "</td>\n        </tr>");
    });
    
    h+='<tr style="background:var(--bg3);font-weight:600"><td style="padding:10px">åˆè¨ˆ</td><td style="padding:10px;text-align:right">Â¥'+fmt(data.totalSales)+'</td><td style="padding:10px;text-align:right">Â¥'+fmt(data.totalCost)+'</td><td style="padding:10px;text-align:right;color:var(--danger)">Â¥'+fmt(data.totalBaihen)+'</td><td></td></tr>';
    h+='</tbody></table>';
    return h;
}

function generateWeeklyReport(data){
    // é€±åˆ¥ã«é›†è¨ˆ
    const weeks={};
    const weekStartDay=3; // Wednesday
    
    Object.entries(data.daily).forEach(([day,d])=>{
        const dayNum=parseInt(day);
        const weekNum=Math.floor((dayNum+3)/7); // ç°¡æ˜“çš„ãªé€±ç•ªå·è¨ˆç®—
        if(!weeks[weekNum])weeks[weekNum]={sales:0,cost:0,baihen:0,days:[]};
        weeks[weekNum].sales+=d.sales;
        weeks[weekNum].cost+=d.shiire?.cost||0;
        weeks[weekNum].baihen+=d.baihen||0;
        weeks[weekNum].days.push(dayNum);
    });
    
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">é€±</th><th style="padding:10px;text-align:center;border-bottom:2px solid var(--border)">æœŸé–“</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¸Š</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ä»•å…¥</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å¼•</th></tr></thead><tbody>';
    
    Object.entries(weeks).sort((a,b)=>+a[0]-+b[0]).forEach(([weekNum,w])=>{
        const minDay=Math.min(...w.days);
        const maxDay=Math.max(...w.days);
        h+=("<tr style=\"border-bottom:1px solid var(--border)\">\n            <td style=\"padding:8px\">\u7b2c" + (parseInt(weekNum)+1) + "\u9031</td>\n            <td style=\"padding:8px;text-align:center\">" + (minDay) + "\u65e5\u301c" + (maxDay) + "\u65e5</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(w.sales)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(w.cost)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--danger)\">\u00a5" + (fmt(w.baihen)) + "</td>\n        </tr>");
    });
    
    h+='</tbody></table>';
    return h;
}

function generateMonthlyReport(data){
    let h='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px">';
    
    // KPIã‚µãƒãƒªãƒ¼
    h+=("<div style=\"background:var(--bg3);padding:16px;border-radius:8px\">\n        <div style=\"font-size:0.65rem;color:var(--text4);margin-bottom:4px\">\u58f2\u4e0a\u9ad8</div>\n        <div style=\"font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(data.totalSales)) + "</div>\n    </div>");
    h+=("<div style=\"background:var(--bg3);padding:16px;border-radius:8px\">\n        <div style=\"font-size:0.65rem;color:var(--text4);margin-bottom:4px\">\u8352\u5229\u76ca</div>\n        <div style=\"font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--success)\">\u00a5" + (fmt(data.grossProfit)) + "</div>\n    </div>");
    h+=("<div style=\"background:var(--bg3);padding:16px;border-radius:8px\">\n        <div style=\"font-size:0.65rem;color:var(--text4);margin-bottom:4px\">\u8352\u5229\u7387</div>\n        <div style=\"font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--primary)\">" + (fmtPct(data.grossProfitRate)) + "</div>\n    </div>");
    h+=("<div style=\"background:var(--bg3);padding:16px;border-radius:8px\">\n        <div style=\"font-size:0.65rem;color:var(--text4);margin-bottom:4px\">\u5024\u5165\u7387</div>\n        <div style=\"font-size:1.4rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--info)\">" + (fmtPct(data.avgMargin)) + "</div>\n    </div>");
    
    h+='</div>';
    
    // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
    h+='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<tbody>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">æœŸé¦–åœ¨åº«</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.invStart)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">ç·ä»•å…¥é«˜</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.totalCost)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">æœŸæœ«åœ¨åº«</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.invEnd)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å£²ä¸ŠåŸä¾¡</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace;color:var(--warning)">Â¥'+fmt(data.invStart+data.totalCost-data.invEnd)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å€¤å¼•é¡åˆè¨ˆ</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace;color:var(--danger)">Â¥'+fmt(data.totalBaihen)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å£²å¤‰ç‡</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace;color:var(--danger)">'+fmtPct(data.baihenRateSales)+'</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">å–¶æ¥­æ—¥æ•°</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">'+data.salesDays+'æ—¥</td></tr>';
    h+='<tr style="border-bottom:1px solid var(--border)"><td style="padding:10px">æ—¥å¹³å‡å£²ä¸Š</td><td style="padding:10px;text-align:right;font-family:\'JetBrains Mono\',monospace">Â¥'+fmt(data.avgDailySales)+'</td></tr>';
    h+='</tbody></table>';
    
    return h;
}

function generateCategoryReport(data){
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">å¸³åˆ</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">åŸä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å…¥ç‡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">æ§‹æˆæ¯”</th></tr></thead><tbody>';
    
    getCatOrder().forEach(cat=>{
        const c=data.catTotals[cat];
        if(!c||c.cost===0)return;
        const mr=c.price>0?(c.price-c.cost)/c.price:0;
        const share=data.totalCost>0?c.cost/data.totalCost:0;
        const info=CATEGORIES[cat]||{name:cat,icon:'ğŸ“‹'};
        
        h+=("<tr style=\"border-bottom:1px solid var(--border)\">\n            <td style=\"padding:8px\"><span style=\"margin-right:6px\">" + (info.icon) + "</span>" + (info.name) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(c.cost)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(c.price)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--primary)\">" + (fmtPct(mr)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">" + (fmtPct(share)) + "</td>\n        </tr>");
    });
    
    h+='</tbody></table>';
    return h;
}

function generateSupplierReport(data){
    const suppliers=Object.entries(data.supTotals).sort((a,b)=>b[1].cost-a[1].cost);
    
    let h='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">ä»•å…¥å…ˆ</th><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">å¸³åˆ</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">åŸä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¾¡</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å€¤å…¥ç‡</th></tr></thead><tbody>';
    
    suppliers.forEach(([code,sup])=>{
        const cat=SUPPLIERS[code]?.cat||'other';
        const catInfo=CATEGORIES[cat]||{name:'ãã®ä»–',icon:'ğŸ“‹'};
        const mr=sup.price>0?(sup.price-sup.cost)/sup.price:0;
        
        h+=("<tr style=\"border-bottom:1px solid var(--border)\">\n            <td style=\"padding:8px\"><span style=\"font-size:0.6rem;color:var(--text4);margin-right:6px\">" + (code) + "</span>" + (sup.name) + "</td>\n            <td style=\"padding:8px\">" + (catInfo.icon) + " " + (catInfo.name) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(sup.cost)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(sup.price)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:var(--primary)\">" + (fmtPct(mr)) + "</td>\n        </tr>");
    });
    
    h+='</tbody></table>';
    return h;
}

function generateInventoryReport(data){
    // æ—¥åˆ¥æ¨å®šåœ¨åº«ã‚’è¨ˆç®—
    const invData=[];
    let runningInv=data.invStart;
    const avgMargin=data.avgMargin||0.26;
    const baihenRate=data.baihenRateSales||0;
    
    for(let day=1;day<=31;day++){
        const d=data.daily[day];
        if(d){
            const daySales=d.sales||0;
            const dayCost=d.shiire?.cost||0;
            const dayGrossSales=(1-baihenRate)>0?daySales/(1-baihenRate):daySales;
            const dayEstCogs=dayGrossSales*(1-avgMargin);
            runningInv=runningInv+dayCost-dayEstCogs;
            invData.push({day,inv:runningInv,sales:daySales,cost:dayCost});
        }
    }
    
    let h='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px">';
    h+=("<div style=\"background:var(--bg3);padding:12px;border-radius:8px;text-align:center\"><div style=\"font-size:0.6rem;color:var(--text4)\">\u671f\u9996\u5728\u5eab</div><div style=\"font-size:1.1rem;font-weight:600;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(data.invStart)) + "</div></div>");
    h+=("<div style=\"background:var(--bg3);padding:12px;border-radius:8px;text-align:center\"><div style=\"font-size:0.6rem;color:var(--text4)\">\u63a8\u5b9a\u671f\u672b\u5728\u5eab</div><div style=\"font-size:1.1rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:#06b6d4\">\u00a5" + (fmt(data.estimatedInvEnd)) + "</div></div>");
    h+=("<div style=\"background:var(--bg3);padding:12px;border-radius:8px;text-align:center\"><div style=\"font-size:0.6rem;color:var(--text4)\">\u5b9f\u7e3e\u671f\u672b\u5728\u5eab</div><div style=\"font-size:1.1rem;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--success)\">\u00a5" + (fmt(data.invEnd)) + "</div></div>");
    h+='</div>';
    
    h+='<table style="width:100%;border-collapse:collapse;font-size:0.75rem">';
    h+='<thead><tr style="background:var(--bg3)"><th style="padding:10px;text-align:left;border-bottom:2px solid var(--border)">æ—¥</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">æ¨å®šåœ¨åº«</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">å£²ä¸Š</th><th style="padding:10px;text-align:right;border-bottom:2px solid var(--border)">ä»•å…¥</th></tr></thead><tbody>';
    
    invData.forEach(d=>{
        const invColor=d.inv<data.invStart*0.7?'var(--danger)':d.inv<data.invStart*0.85?'var(--warning)':'#06b6d4';
        h+=("<tr style=\"border-bottom:1px solid var(--border)\">\n            <td style=\"padding:8px\">" + (d.day) + "\u65e5</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace;color:" + (invColor) + ";font-weight:600\">\u00a5" + (fmt(d.inv)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(d.sales)) + "</td>\n            <td style=\"padding:8px;text-align:right;font-family:'JetBrains Mono',monospace\">\u00a5" + (fmt(d.cost)) + "</td>\n        </tr>");
    });
    
    h+='</tbody></table>';
    return h;
}

function closeReportPreview(){
    document.getElementById('report-preview-modal').style.display='none';
}

function printReport(){
    const previewEl = document.getElementById('report-preview-content');
    const content = previewEl ? previewEl.innerHTML : '';
    const win = window.open('', '', 'width=900,height=700');
    if(!win){
        try{ if(typeof showToast==='function') showToast('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚','error'); }catch(e){}
        return;
    }
    const html =
      '<!doctype html><html><head><meta charset="utf-8"><title>ãƒ¬ãƒãƒ¼ãƒˆå°åˆ·</title>' +
      '<style>' +
      'body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:20px}' +
      'table{border-collapse:collapse;width:100%}' +
      'th,td{border:1px solid #ddd;padding:8px;text-align:left}' +
      '</style></head><body>' +
      content +
      '</body></html>';
    win.document.open();
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
}

function exportReportExcel(){
  if(!window.XLSX){ showToast('Excelæ©Ÿèƒ½ï¼ˆXLSXï¼‰ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚Safariã®å ´åˆã¯åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« xlsx.full.min.js ã‚’ç½®ãã‹ã€Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚','error'); return; }

    if(!result||!currentReportType)return;
    const data=result[currentStore];
    const wb=XLSX.utils.book_new();
    
    let sheetData=[];
    switch(currentReportType){
        case'daily':
            sheetData=[['æ—¥','å£²ä¸Š','ä»•å…¥åŸä¾¡','å€¤å¼•é¡']];
            Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{
                sheetData.push([day+'æ—¥',d.sales,d.shiire?.cost||0,d.baihen||0]);
            });
            break;
        case'monthly':
            sheetData=[
                ['é …ç›®','å€¤'],
                ['å£²ä¸Šé«˜',data.totalSales],
                ['è’åˆ©ç›Š',data.grossProfit],
                ['è’åˆ©ç‡',data.grossProfitRate],
                ['æœŸé¦–åœ¨åº«',data.invStart],
                ['ç·ä»•å…¥é«˜',data.totalCost],
                ['æœŸæœ«åœ¨åº«',data.invEnd],
                ['å€¤å¼•é¡åˆè¨ˆ',data.totalBaihen]
            ];
            break;
        case'category':
            sheetData=[['å¸³åˆ','åŸä¾¡','å£²ä¾¡','å€¤å…¥ç‡','æ§‹æˆæ¯”']];
            getCatOrder().forEach(cat=>{
                const c=data.catTotals[cat];
                if(!c||c.cost===0)return;
                const mr=c.price>0?(c.price-c.cost)/c.price:0;
                const share=data.totalCost>0?c.cost/data.totalCost:0;
                sheetData.push([CATEGORIES[cat]?.name||cat,c.cost,c.price,mr,share]);
            });
            break;
        default:
            sheetData=[['ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿']];
    }
    
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sheetData),currentReportType);
    XLSX.writeFile(wb,'report_'+currentReportType+'_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showToast('ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
}

function exportAllReports(){
  if(!window.XLSX){ showToast('Excelæ©Ÿèƒ½ï¼ˆXLSXï¼‰ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ã€‚Safariã®å ´åˆã¯åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« xlsx.full.min.js ã‚’ç½®ãã‹ã€Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚','error'); return; }

    if(!result)return;
    const data=result[currentStore];
    const wb=XLSX.utils.book_new();
    
    // æ—¥å ±
    let daily=[['æ—¥','å£²ä¸Š','ä»•å…¥åŸä¾¡','å€¤å¼•é¡']];
    Object.entries(data.daily).sort((a,b)=>+a[0]-+b[0]).forEach(([day,d])=>{
        daily.push([day+'æ—¥',d.sales,d.shiire?.cost||0,d.baihen||0]);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(daily),'æ—¥å ±');
    
    // æœˆå ±
    let monthly=[
        ['é …ç›®','å€¤'],
        ['å£²ä¸Šé«˜',data.totalSales],
        ['è’åˆ©ç›Š',data.grossProfit],
        ['è’åˆ©ç‡',data.grossProfitRate],
        ['æœŸé¦–åœ¨åº«',data.invStart],
        ['ç·ä»•å…¥é«˜',data.totalCost],
        ['æœŸæœ«åœ¨åº«',data.invEnd]
    ];
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(monthly),'æœˆå ±');
    
    // å¸³åˆåˆ¥
    let category=[['å¸³åˆ','åŸä¾¡','å£²ä¾¡','å€¤å…¥ç‡']];
    getCatOrder().forEach(cat=>{
        const c=data.catTotals[cat];
        if(!c||c.cost===0)return;
        const mr=c.price>0?(c.price-c.cost)/c.price:0;
        category.push([CATEGORIES[cat]?.name||cat,c.cost,c.price,mr]);
    });
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(category),'å¸³åˆåˆ¥');
    
    XLSX.writeFile(wb,'å…¨ãƒ¬ãƒãƒ¼ãƒˆ_'+new Date().toISOString().slice(0,10)+'.xlsx');
    showToast('å…¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ','success');
}

// ===== ã‚«ãƒ©ãƒ è¨­å®š =====
let columnConfig={
    daily:[
        {id:'day',name:'æ—¥',visible:true},
        {id:'sales',name:'å£²ä¸Š',visible:true},
        {id:'baihen',name:'å€¤å¼•é¡',visible:true},
        {id:'baihenRate',name:'å€¤å¼•ç‡',visible:true},
        {id:'shiireCost',name:'ä»•å…¥åŸä¾¡',visible:true},
        {id:'tenkanIn',name:'åº—é–“å…¥',visible:true},
        {id:'tenkanOut',name:'åº—é–“å‡º',visible:true},
        {id:'hana',name:'èŠ±',visible:true},
        {id:'sanchoku',name:'ç”£ç›´',visible:true},
        {id:'consumable',name:'åŸä¾¡ç®—å…¥æ¯”',visible:true},
        {id:'cumSales',name:'ç´¯è¨ˆå£²ä¸Š',visible:true},
        {id:'cumCost',name:'ç´¯è¨ˆä»•å…¥',visible:true}
    ]
};

function showColumnConfig(){
    renderColumnConfig();
    document.getElementById('column-config-modal').style.display='flex';
}

function closeColumnConfig(){
    document.getElementById('column-config-modal').style.display='none';
}

function renderColumnConfig(){
    const container=document.getElementById('column-config-content');
    let h='<div class="column-config" id="column-config-list">';
    
    columnConfig.daily.forEach((col,i)=>{
        h+=("<div class=\"column-item\" draggable=\"true\" data-index=\"" + (i) + "\">\n            <div class=\"column-item-handle\">\u2261</div>\n            <div class=\"column-item-name\">" + (col.name) + "</div>\n            <div class=\"column-item-toggle " + (col.visible?'active':'') + "\" onclick=\"toggleColumn(" + (i) + ")\"></div>\n        </div>");
    });
    
    h+='</div>';
    container.innerHTML=h;
    
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
    initColumnDragDrop();
}

function toggleColumn(index){
    columnConfig.daily[index].visible=!columnConfig.daily[index].visible;
    renderColumnConfig();
}

function initColumnDragDrop(){
    const list=document.getElementById('column-config-list');
    if(!list)return;
    
    let draggedItem=null;
    
    list.querySelectorAll('.column-item').forEach(item=>{
        item.addEventListener('dragstart',e=>{
            draggedItem=item;
            item.classList.add('dragging');
        });
        
        item.addEventListener('dragend',()=>{
            item.classList.remove('dragging');
            draggedItem=null;
        });
        
        item.addEventListener('dragover',e=>{
            e.preventDefault();
            if(!draggedItem||draggedItem===item)return;
            
            const rect=item.getBoundingClientRect();
            const midY=rect.top+rect.height/2;
            
            if(e.clientY<midY){
                list.insertBefore(draggedItem,item);
            }else{
                list.insertBefore(draggedItem,item.nextSibling);
            }
        });
    });
}

function applyColumnConfig(){
    // ç¾åœ¨ã®ä¸¦ã³é †ã‚’å–å¾—
    const newOrder=[];
    document.querySelectorAll('#column-config-list .column-item').forEach(item=>{
        const index=parseInt(item.dataset.index);
        newOrder.push(columnConfig.daily[index]);
    });
    columnConfig.daily=newOrder;
    
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
    columnConfig.daily.forEach((col,i)=>col.index=i);
    
    saveSettingsToStorage();
    closeColumnConfig();
    showToast('ã‚«ãƒ©ãƒ è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ','success');
    if(result)render();
}

function exportExcel(){if(!result)return;const wb=XLSX.utils.book_new(),sids=Object.keys(STORES).sort((a,b)=>+a-+b);const allData=[['æ—¥']];getCatOrder().forEach(cat=>{sids.forEach(sid=>{if(!result[sid]?.catTotals[cat])return;allData[0].push((CATEGORIES[cat]?.name||cat)+'_'+sid.padStart(2,'0')+'_åŸä¾¡',(CATEGORIES[cat]?.name||cat)+'_'+sid.padStart(2,'0')+'_å£²ä¾¡');});});for(let day=1;day<=31;day++){const row=[day+'æ—¥'];getCatOrder().forEach(cat=>{sids.forEach(sid=>{if(!result[sid]?.catTotals[cat])return;const d=result[sid].daily[day];let c=0,p=0;if(d){if(cat==='tenkan'){c=d.tenkanInTotal.cost+d.tenkanOutTotal.cost;p=d.tenkanInTotal.price+d.tenkanOutTotal.price;}else if(cat==='bumonkan'){c=d.bumonInTotal.cost+d.bumonOutTotal.cost;p=d.bumonInTotal.price+d.bumonOutTotal.price;}else if(cat==='hana'){c=d.hana.cost;p=d.hana.price;}else if(cat==='sanchoku'){c=d.sanchoku.cost;p=d.sanchoku.price;}else Object.entries(d.suppliers).forEach(([code,sup])=>{if((SUPPLIERS[code]?.cat||'other')===cat){c+=sup.cost;p+=sup.price;}});}row.push(c||'',p||'');});});allData.push(row);}XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allData),'å–å¼•å…ˆåˆ¥');sids.forEach(sid=>{const d=result[sid];const ws=[['åº—èˆ—',STORES[sid].name],['æœŸé¦–åœ¨åº«',d.invStart],['ç·ä»•å…¥',d.totalCost],['æœŸæœ«åœ¨åº«',d.invEnd],['å£²ä¸ŠåŸä¾¡',d.invStart+d.totalCost-d.invEnd],['å£²ä¸Šå®Ÿç¸¾',d.totalSales],['è’åˆ©ç›Š',d.grossProfit],['è’åˆ©ç‡',d.grossProfitRate],['å€¤å…¥ç‡',d.avgMargin],[],['å¸³åˆ','åŸä¾¡','å£²ä¾¡','å€¤å…¥ç‡','æ§‹æˆæ¯”']];getCatOrder().forEach(cat=>{const c=d.catTotals[cat];if(!c)return;ws.push([CATEGORIES[cat]?.name||cat,c.cost,c.price,c.price>0?(c.price-c.cost)/c.price:0,d.totalCost>0?c.cost/d.totalCost:0]);});ws.push([],['=== åº—é–“ãƒ»éƒ¨é–€é–“ç§»å‹•è©³ç´° ==='],['æ—¥','ç¨®åˆ¥','ç§»å‹•å…ˆ/å…ƒ','éƒ¨é–€','åŸä¾¡','å£²ä¾¡']);d.transferDetails.tenkanIn.forEach(t=>{ws.push([t.day+'æ—¥','åº—é–“å…¥åº«',t.fromStore,'',t.cost,t.price]);});d.transferDetails.tenkanOut.forEach(t=>{ws.push([t.day+'æ—¥','åº—é–“å‡ºåº«',t.toStore,t.bumonCode||'',t.cost,t.price]);});d.transferDetails.bumonIn.forEach(t=>{ws.push([t.day+'æ—¥','éƒ¨é–€é–“å…¥åº«','','',t.cost,t.price]);});d.transferDetails.bumonOut.forEach(t=>{ws.push([t.day+'æ—¥','éƒ¨é–€é–“å‡ºåº«','',t.bumonCode||'',t.cost,t.price]);});XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ws),'åº—èˆ—'+sid.padStart(2,'0'));});XLSX.writeFile(wb,'ä»•å…¥ç²—åˆ©ç®¡ç†_'+new Date().toISOString().slice(0,10).replace(/-/g,'')+'.xlsx');showToast('Excelã‚’å‡ºåŠ›ã—ã¾ã—ãŸ','success');}
</script>
<script>
/* === v9 Dashboard Redesign (override renderDashboard) === */

/* === v9.3 Period Range Simulation (gross profit & budget dynamically) === */
const V9_RANGE_STATE = { start: 1, end: 31, invStart: null, invEnd: null };

function v9_sumRange(storeId, startDay, endDay){
  const d = result?.[storeId];
  if(!d) return null;

  let sales=0, purch=0, transfersIn=0, transfersOut=0, deliveryCost=0, consumableCost=0, baihen=0;
  let budget=0;

  for(let day=startDay; day<=endDay; day++){
    const x = d.daily?.[day];
    if(!x) continue;
    sales += v9_safe(x.sales);

    // Purchases: supplier purchase cost only
    purch += v9_safe(x.shiire?.cost);

    // Transfers: treat in/out separately
    transfersIn  += v9_safe(x.tenkanInTotal?.cost)  + v9_safe(x.bumonInTotal?.cost);
    transfersOut += v9_safe(x.tenkanOutTotal?.cost) + v9_safe(x.bumonOutTotal?.cost);

    // Delivery & consumables
    deliveryCost += v9_safe(x.hana?.cost) + v9_safe(x.sanchoku?.cost);
    consumableCost += v9_safe(x.consumable?.cost);

    baihen += v9_safe(x.baihen);

    // Budget
    const b = d.budgetDaily?.[day] || 0;
    budget += v9_safe(b);
  }

  // Period purchases affecting inventory (include transfers and delivery/consumables because they are part of "totalCost" in v8)
  // This aligns with how totalCost is used in gross profit: Sales - (BI + totalCost - EI) îˆ€fileciteîˆ‚turn3file5îˆ‚L18-L20îˆ
  const totalCostForPeriod = purch + transfersIn + transfersOut + deliveryCost + consumableCost;

  return { sales, baihen, budget, totalCostForPeriod, purch, transfersIn, transfersOut, deliveryCost, consumableCost };
}

function v9_calcPeriod(storeId, startDay, endDay, invStartOverride, invEndOverride){
  const d = result?.[storeId];
  const sums = v9_sumRange(storeId, startDay, endDay);
  if(!d || !sums) return null;

  // Default inventory anchors:
  // - Start inventory: use store BI by default, or if startDay>1 use estimated inventory (dailyInvData) at startDay-1
  // - End inventory: use store EI by default, or estimated inventory at endDay
  let invStart = (invStartOverride!=null && !isNaN(invStartOverride)) ? invStartOverride : null;
  let invEnd   = (invEndOverride!=null && !isNaN(invEndOverride)) ? invEndOverride : null;

  const invSeries = (d.dailyInvData||[]); // {day, inv, ...}
  const invAt = (day)=>{
    const item = invSeries.find(x=>x.day===day);
    return item ? v9_safe(item.inv) : null;
  };

  if(invStart==null){
    if(startDay<=1) invStart = v9_safe(d.invStart);
    else{
      const v = invAt(startDay-1);
      invStart = (v!=null) ? v : v9_safe(d.invStart);
    }
  }
  if(invEnd==null){
    if(endDay>=31) invEnd = v9_safe(d.invEnd);
    else{
      const v = invAt(endDay);
      invEnd = (v!=null) ? v : v9_safe(d.invEnd);
    }
  }

  const cogs = invStart + sums.totalCostForPeriod - invEnd;
  const gp = sums.sales - cogs;
  const gpr = sums.sales>0 ? gp/sums.sales : 0;

  const ach = sums.budget>0 ? sums.sales/sums.budget : 0;

  // Cumulative up to endDay (for "ç´¯è¨ˆé”æˆç‡" within month)
  let cumSales=0, cumBudget=0;
  for(let day=1; day<=endDay; day++){
    const x = d.daily?.[day];
    if(x) cumSales += v9_safe(x.sales);
    cumBudget += v9_safe(d.budgetDaily?.[day] || 0);
  }
  const cumAch = cumBudget>0 ? cumSales/cumBudget : 0;

  return { startDay, endDay, invStart, invEnd, sales:sums.sales, cogs, gp, gpr, budget:sums.budget, ach, cumSales, cumBudget, cumAch, breakdown:sums };
}


/* === v9.4 Multi-Anchor Inventory & Estimate Mode === */
const V9_MODE = { kind: 'actual' }; // 'actual' | 'estimate'
const V9_ANCHORS = []; // each: { day: number, inv: number } where inv is end-of-day inventory at 'day'

function v9_sortedAnchors(startDay, endDay){
  return V9_ANCHORS
    .filter(a => a && a.day>=startDay && a.day<=endDay && a.inv!=null && !isNaN(a.inv))
    .slice()
    .sort((a,b)=>a.day-b.day);
}

function v9_calcPeriodAnchored(storeId, startDay, endDay, invStartOverride, invEndOverride){
  // Piecewise segments between anchors.
  const d = result?.[storeId];
  if(!d) return null;

  const anchors = v9_sortedAnchors(startDay, endDay);
  // If user also typed invEndOverride, treat as an anchor at endDay
  if(invEndOverride!=null && !isNaN(invEndOverride)){
    // replace any anchor same day
    for(let i=anchors.length-1;i>=0;i--) if(anchors[i].day===endDay) anchors.splice(i,1);
    anchors.push({day:endDay, inv:invEndOverride});
  }
  anchors.sort((a,b)=>a.day-b.day);

  // Determine BI (invStart)
  let invStart = (invStartOverride!=null && !isNaN(invStartOverride)) ? invStartOverride : null;
  const invSeries = (d.dailyInvData||[]);
  const invAt = (day)=>{
    const item = invSeries.find(x=>x.day===day);
    return item ? v9_safe(item.inv) : null;
  };
  if(invStart==null){
    if(startDay<=1) invStart = v9_safe(d.invStart);
    else{
      const v = invAt(startDay-1);
      invStart = (v!=null) ? v : v9_safe(d.invStart);
    }
  }

  // Determine EI (invEnd) default (used when no anchor at end)
  let invEndDefault = null;
  if(endDay>=31) invEndDefault = v9_safe(d.invEnd);
  else{
    const v = invAt(endDay);
    invEndDefault = (v!=null) ? v : v9_safe(d.invEnd);
  }

  // Build segment boundaries: [start..b1], [b1+1..b2] ... last to endDay
  // We interpret each anchor (day k) as end-of-day inventory at k, i.e., EI for segment ending at k.
  let segStart = startDay;
  let BI = invStart;

  let totalSales=0, totalBudget=0, totalCost=0, totalCogs=0, totalGp=0;
  const segs=[];

  const addSeg = (s,e,EI)=>{
    const sums = v9_sumRange(storeId, s, e);
    if(!sums) return;
    const cogs = BI + sums.totalCostForPeriod - EI;
    const gp = sums.sales - cogs;
    totalSales += sums.sales;
    totalBudget += sums.budget;
    totalCost += sums.totalCostForPeriod;
    totalCogs += cogs;
    totalGp += gp;
    segs.push({s,e,BI,EI,cogs,gp,sales:sums.sales,budget:sums.budget, breakdown:sums});
    // Next segment BI becomes this EI
    BI = EI;
  };

  if(anchors.length){
    anchors.forEach(a=>{
      const EI = v9_safe(a.inv);
      if(a.day < segStart) return;
      addSeg(segStart, a.day, EI);
      segStart = a.day + 1;
    });
  }

  // Final segment to endDay (if any remaining days)
  if(segStart <= endDay){
    const EI = invEndDefault;
    addSeg(segStart, endDay, EI);
  }

  const gpr = totalSales>0 ? totalGp/totalSales : 0;
  const ach = totalBudget>0 ? totalSales/totalBudget : 0;

  // cumulative to endDay
  let cumSales=0, cumBudget=0;
  for(let day=1; day<=endDay; day++){
    const x = d.daily?.[day];
    if(x) cumSales += v9_safe(x.sales);
    cumBudget += v9_safe(d.budgetDaily?.[day] || 0);
  }
  const cumAch = cumBudget>0 ? cumSales/cumBudget : 0;

  // final EI used
  const finalEI = (segs.length ? segs[segs.length-1].EI : invEndDefault);

  return { startDay, endDay, invStart, invEnd:finalEI, sales:totalSales, cogs:totalCogs, gp:totalGp, gpr, budget:totalBudget, ach, cumSales, cumBudget, cumAch, segs };
}

function v9_estimatePeriod(storeId, startDay, endDay, overrideMarginPct, overrideDiscountPct){
  const d = result?.[storeId];
  if(!d) return null;

  // Aggregate within range
  let sales=0, coreNet=0, hanaPrice=0, sanchokuPrice=0, deliveryCost=0, consCost=0, baihenAmt=0, budget=0;

  for(let day=startDay; day<=endDay; day++){
    const x = d.daily?.[day];
    if(!x) continue;
    const s = v9_safe(x.sales);
    sales += s;
    const hp = v9_safe(x.hana?.price);
    const sp = v9_safe(x.sanchoku?.price);
    hanaPrice += hp;
    sanchokuPrice += sp;
    coreNet += Math.max(0, s - hp - sp);
    deliveryCost += v9_safe(x.hana?.cost) + v9_safe(x.sanchoku?.cost);
    consCost += v9_safe(x.consumable?.cost);
    baihenAmt += (x.baihenAbs!=null ? v9_safe(x.baihenAbs) : Math.abs(v9_safe(x.baihen)));
    budget += v9_safe(d.budgetDaily?.[day] || 0);
  }

  // Period discount rate (å£²å¤‰ç‡): d = å€¤å¼•é¡ / (å£²ä¸Š + å€¤å¼•é¡)
  let disc = (sales + baihenAmt) > 0 ? (baihenAmt / (sales + baihenAmt)) : 0;
  if(overrideDiscountPct!=null && !isNaN(overrideDiscountPct)) disc = Math.max(0, Math.min(0.95, overrideDiscountPct/100));

  // Margin rate for core (å€¤å…¥ç‡)
  let m = v9_safe(d.coreMarginRate!=null?d.coreMarginRate:d.avgMargin);
  if(overrideMarginPct!=null && !isNaN(overrideMarginPct)) m = Math.max(0, Math.min(0.95, overrideMarginPct/100));

  const coreGross = (1-disc)>0 ? coreNet/(1-disc) : coreNet;
  const coreCogs = coreGross*(1-m);

  const estCogs = coreCogs + deliveryCost + consCost;
  const estGp = sales - estCogs;
  const estGpr = sales>0 ? estGp/sales : 0;

  const ach = budget>0 ? sales/budget : 0;

  // cumulative to endDay
  let cumSales=0, cumBudget=0;
  for(let day=1; day<=endDay; day++){
    const x = d.daily?.[day];
    if(x) cumSales += v9_safe(x.sales);
    cumBudget += v9_safe(d.budgetDaily?.[day] || 0);
  }
  const cumAch = cumBudget>0 ? cumSales/cumBudget : 0;

  return { startDay, endDay, sales, estCogs, gp:estGp, gpr:estGpr, budget, ach, cumSales, cumBudget, cumAch, disc, margin:m, breakdown:{ coreNet, hanaPrice, sanchokuPrice, deliveryCost, consCost, baihenAmt } };
}


function v9_mountRangePanelAll(){
  // In "all stores" view, add a store selector + mount simulation for the selected store.
  const content = document.getElementById('content');
  if(!content) return;

  // Avoid duplicates
  if(document.getElementById('v9-range-all')) return;

  const storeIds = Object.keys(STORES||{}).sort((a,b)=>a+b);
  if(!storeIds.length) return;

  // Pick first by default
  const defaultId = storeIds[0];

  const host = document.createElement('div');
  host.className = 'v9-card';
  host.id = 'v9-range-all';
  host.style.marginBottom = '12px';
  host.innerHTML = ("\n    <div class=\"v9-card-h\">\n      <div>\n        <div class=\"v9-card-title\">\ud83e\uddea \u671f\u9593\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\uff08\u5e97\u8217\u9078\u629e\uff09</div>\n        <div class=\"v9-card-sub\">\u5168\u5e97\u8217\u8868\u793a\u4e2d\u3067\u3082\u3001\u9078\u629e\u5e97\u8217\u306e\u9031\u9593/\u4efb\u610f\u671f\u9593\u3092\u8a66\u7b97\u3067\u304d\u307e\u3059</div>\n      </div>\n      <div class=\"v9-inline\" style=\"gap:8px\">\n        <span class=\"v9-mini\">\u5bfe\u8c61\u5e97\u8217</span>\n        <select id=\"v9-sim-store\" class=\"v9-input\" style=\"min-width:220px;font-family:inherit\">\n          " + (storeIds.map(id=>'<option value="' + id + '">' + ((STORES && STORES[id] && STORES[id].name) ? STORES[id].name : id) + '</option>').join('')) + "\n        </select>\n      </div>\n    </div>\n    <div class=\"v9-card-b v9-mini\" id=\"v9-range-all-body\">\u5e97\u8217\u3092\u9078\u629e\u3059\u308b\u3068\u4e0b\u306b\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3UI\u3092\u8868\u793a\u3057\u307e\u3059</div>\n  ");

  // Insert at top of content
  content.insertBefore(host, content.firstChild);

  const sel = host.querySelector('#v9-sim-store');
  const body = host.querySelector('#v9-range-all-body');

  const mount = (storeId)=>{
    // Render the real simulation panel by temporarily mounting below this block.
    // Create a wrapper container that mimics dashboard wrap so v9_mountRangePanel can insert safely.
    const wrapId = 'v9-all-wrap';
    let wrap = document.getElementById(wrapId);
    if(!wrap){
      wrap = document.createElement('div');
      wrap.id = wrapId;
      wrap.className = 'v9-wrap';
      // Add a fake KPI row placeholder for insertion position.
      const k = document.createElement('div');
      k.className = 'v9-kpis';
      k.style.display = 'none';
      wrap.appendChild(k);
      body.innerHTML = '';
      body.appendChild(wrap);
    }
    // Clear any existing simulation card
    const old = wrap.querySelector('#v9-range-card');
    if(old) old.remove();

    // Ensure range state updates highlight
    V9_RANGE_STATE.start = 1;
    V9_RANGE_STATE.end = 31;

    // Mount
    v9_mountRangePanel(storeId);

    // Move mounted card into our wrapper (it was inserted into #content .v9-wrap; relocate if needed)
    const mounted = document.getElementById('v9-range-card');
    if(mounted && mounted.parentElement && mounted.parentElement !== wrap){
      mounted.parentElement.removeChild(mounted);
      wrap.appendChild(mounted);
    }
  };

  sel.value = defaultId;
  mount(defaultId);

  sel.addEventListener('change', ()=> mount(sel.value));
}

function v9_mountRangePanel(storeId){
  const wrap = document.querySelector('#content .v9-wrap');
  if(!wrap) return;

  // Avoid duplicates
  if(document.getElementById('v9-range-card')) return;

  const d = result?.[storeId];
  if(!d) return;

  // derive max day from available daily keys
  const days = Object.keys(d.daily||{}).map(n=>parseInt(n)).filter(Boolean);
  const maxDay = days.length? Math.max(...days) : 31;

  // initialize state
  V9_RANGE_STATE.start = Math.min(V9_RANGE_STATE.start, maxDay);
  V9_RANGE_STATE.end = Math.min(Math.max(V9_RANGE_STATE.end, V9_RANGE_STATE.start), maxDay);

  const card = document.createElement('div');
  card.className = 'v9-card';
  card.id = 'v9-range-card';
  card.innerHTML = ("\n    <div class=\"v9-card-h\">\n      <div>\n        <div class=\"v9-card-title\">\ud83e\uddea \u671f\u9593\u30b7\u30df\u30e5\u30ec\u30fc\u30b7\u30e7\u30f3\uff08\u4efb\u610f\u306e\u671f\u9996/\u671f\u672b\u5728\u5eab\u3067\u7c97\u5229\u3092\u8a08\u7b97\uff09</div>\n        <div class=\"v9-card-sub\">\u4f8b\uff1a\u9031\u9593\u7c97\u5229 / \u7279\u58f2\u671f\u9593 / \u6708\u4e2d\u533a\u9593\u306e\u7c97\u5229\u7387\u3068\u4e88\u7b97\u9054\u6210\u7387\u3092\u52d5\u7684\u7b97\u51fa</div>\n      </div>\n      <div class=\"v9-mini\" id=\"v9-range-label\"></div>\n    </div>\n    <div class=\"v9-card-b\">\n      <div class=\"v9-range-grid\">\n        <div class=\"v9-field\">\n          <label>\u671f\u9593\uff08\u958b\u59cb\u65e5 / \u7d42\u4e86\u65e5\uff09</label>\n          <div class=\"v9-inline\">\n            <input id=\"v9-start\" class=\"v9-slider\" type=\"range\" min=\"1\" max=\"" + (maxDay) + "\" step=\"1\" value=\"" + (V9_RANGE_STATE.start) + "\">\n            <input id=\"v9-end\" class=\"v9-slider\" type=\"range\" min=\"1\" max=\"" + (maxDay) + "\" step=\"1\" value=\"" + (V9_RANGE_STATE.end) + "\">\n          </div>\n          <div class=\"v9-mini\">\u958b\u59cb <b id=\"v9-start-v\">" + (V9_RANGE_STATE.start) + "</b>\u65e5 / \u7d42\u4e86 <b id=\"v9-end-v\">" + (V9_RANGE_STATE.end) + "</b>\u65e5\uff08\u30b9\u30e9\u30a4\u30c0\u30fc\u3067\u5909\u66f4\uff09</div>\n        </div>\n\n        <div class=\"v9-field\">\n          <label>\u671f\u9996\u5728\u5eab\uff08\u3053\u306e\u65e5\u306e\u5728\u5eab\u3092\u25cf\u25cf\u5186\u306b\uff09</label>\n          <input id=\"v9-inv-start\" class=\"v9-input\" type=\"text\" placeholder=\"\u7a7a\u6b04\uff1d\u81ea\u52d5\uff08\u63a8\u5b9a\u5728\u5eab or \u5e97\u8217\u671f\u9996\uff09\">\n          <div class=\"v9-mini\">\u7a7a\u6b04\u306e\u5834\u5408\uff1a\u958b\u59cb\u65e5=1\u306f\u5e97\u8217\u671f\u9996\u3001\u958b\u59cb\u65e5>1\u306f\u63a8\u5b9a\u5728\u5eab\uff08\u524d\u65e5\u7d42\u5024\uff09\u3092\u4f7f\u7528</div>\n        </div>\n\n        <div class=\"v9-field\">\n          <label>\u671f\u672b\u5728\u5eab\uff08\u3053\u306e\u6642\u70b9\u306e\u671f\u672b\u5728\u5eab\u3092\u25b2\u25b2\u5186\u306b\uff09</label>\n          <input id=\"v9-inv-end\" class=\"v9-input\" type=\"text\" placeholder=\"\u7a7a\u6b04\uff1d\u81ea\u52d5\uff08\u63a8\u5b9a\u5728\u5eab or \u5e97\u8217\u671f\u672b\uff09\">\n          <div class=\"v9-mini\">\u7a7a\u6b04\u306e\u5834\u5408\uff1a\u7d42\u4e86\u65e5=\u6708\u672b\u306f\u5e97\u8217\u671f\u672b\u3001\u305d\u308c\u4ee5\u5916\u306f\u63a8\u5b9a\u5728\u5eab\uff08\u5f53\u65e5\u7d42\u5024\uff09\u3092\u4f7f\u7528</div>\n        </div>\n      </div>\n\n      <div class=\"v9-inline\" id=\"v9-est-override\" style=\"margin-top:10px;gap:10px;align-items:flex-end;display:none\">\n        <div class=\"v9-field\" style=\"min-width:220px\">\n          <label>\u5024\u5165\u7387\uff08%\uff09\u4e0a\u66f8\u304d\uff08\u63a8\u5b9a\u5f0f\uff09</label>\n          <input id=\"v9-ov-margin\" class=\"v9-input\" type=\"text\" placeholder=\"\u7a7a\u6b04\uff1d\u81ea\u52d5\uff08\u4ed5\u5165\u304b\u3089\u7b97\u51fa\uff09\">\n          <div class=\"v9-mini\">\u4f8b\uff1a28.5\uff08%\uff09</div>\n        </div>\n        <div class=\"v9-field\" style=\"min-width:220px\">\n          <label>\u58f2\u5909\u7387\uff08%\uff09\u4e0a\u66f8\u304d\uff08\u63a8\u5b9a\u5f0f\uff09</label>\n          <input id=\"v9-ov-disc\" class=\"v9-input\" type=\"text\" placeholder=\"\u7a7a\u6b04\uff1d\u81ea\u52d5\uff08\u671f\u9593\u306e\u5024\u5f15\u304b\u3089\u7b97\u51fa\uff09\">\n          <div class=\"v9-mini\">\u4f8b\uff1a3.2\uff08%\uff09</div>\n        </div>\n        <div class=\"v9-chip\">\u63a8\u5b9a\u5f0f\uff1a\u58f2\u4e0a\u7d0d\u54c1/\u6d88\u8017\u54c1\u306f\u539f\u4fa1\u3092\u305d\u306e\u307e\u307e\u52a0\u7b97</div>\n      </div>\n\n      <div style=\"height:10px\"></div>\n\n      <div class=\"v9-statrow\">\n        <div class=\"v9-stat\">\n          <div class=\"k\">\u58f2\u4e0a\uff08\u671f\u9593\uff09</div>\n          <div class=\"v\" id=\"v9-p-sales\">-</div>\n          <div class=\"s\" id=\"v9-p-sales-sub\">-</div>\n        </div>\n        <div class=\"v9-stat\">\n          <div class=\"k\">\u7c97\u5229\uff08\u671f\u9593\uff09</div>\n          <div class=\"v\" id=\"v9-p-gp\">-</div>\n          <div class=\"s\" id=\"v9-p-gpr\">-</div>\n        </div>\n        <div class=\"v9-stat\">\n          <div class=\"k\">\u4e88\u7b97\u9054\u6210\u7387\uff08\u671f\u9593\uff09</div>\n          <div class=\"v\" id=\"v9-p-ach\">-</div>\n          <div class=\"s\" id=\"v9-p-bud\">-</div>\n        </div>\n        <div class=\"v9-stat\">\n          <div class=\"k\">\u7d2f\u8a08\u9054\u6210\u7387\uff08\u301c\u7d42\u4e86\u65e5\uff09</div>\n          <div class=\"v\" id=\"v9-p-cumach\">-</div>\n          <div class=\"s\" id=\"v9-p-cumsub\">-</div>\n        </div>\n      </div>\n\n      <div style=\"height:10px\"></div>\n\n      <div class=\"v9-anchor-wrap\" id=\"v9-anchor-card\">\n  <div class=\"v9-anchor-head\">\n    <div>\n      <div style=\"font-weight:900;font-size:0.72rem\">\ud83d\udccc \u5728\u5eab\u30a2\u30f3\u30ab\u30fc\u70b9\uff08\u671f\u9593\u5185\u306e\u68da\u5378\u3092\u8907\u6570\u5165\u529b\uff09</div>\n      <div class=\"v9-mini\">\u5165\u529b\u3057\u305f\u65e5(\u7d42\u5024)\u3067\u533a\u9593\u3092\u5206\u5272\u3057\u3001\u524d\u5f8c\u3092\u88dc\u6b63\u3057\u3066\u7c97\u5229\u3092\u5408\u7b97\u3057\u307e\u3059</div>\n    </div>\n    <div class=\"v9-anchor-actions\">\n      <button class=\"btn btn-outline v9-smallbtn\" id=\"v9-add-anchor\" style=\"width:auto\">\uff0b \u30a2\u30f3\u30ab\u30fc\u8ffd\u52a0</button>\n      <button class=\"btn btn-outline v9-smallbtn\" id=\"v9-clear-anchor\" style=\"width:auto\">\ud83e\uddf9 \u30af\u30ea\u30a2</button>\n    </div>\n  </div>\n  <div style=\"overflow:auto;max-height:220px\">\n    <table class=\"v9-anchor-table\">\n      <thead><tr><th>\u65e5\uff08\u7d42\u5024\uff09</th><th>\u5728\u5eab\u91d1\u984d\uff08\u5186\uff09</th><th>\u64cd\u4f5c</th></tr></thead>\n      <tbody id=\"v9-anchor-body\"></tbody>\n    </table>\n  </div>\n</div>\n\n<div class=\"v9-mini\" id=\"v9-p-formula\"></div>\n    </div>\n  ");

  // Insert below KPI block (after first child)
  const first = wrap.firstElementChild;
  if(first && first.classList.contains('v9-kpis')){
    wrap.insertBefore(card, first.nextSibling);
  }else{
    wrap.insertBefore(card, wrap.firstChild);
  }

  const startEl = card.querySelector('#v9-start');
  const endEl = card.querySelector('#v9-end');
  const startV = card.querySelector('#v9-start-v');
  const endV = card.querySelector('#v9-end-v');
  const invS = card.querySelector('#v9-inv-start');
  const invE = card.querySelector('#v9-inv-end');

  const label = card.querySelector('#v9-range-label');

  const parseYen = (s)=>{
    if(s==null) return null;
    const t = String(s).replace(/[^\d\-\.]/g,'');
    if(!t) return null;
    const n = parseFloat(t);
    return isNaN(n) ? null : n;
  };

  const update = ()=>{
    // mode
    const modeKind = V9_MODE.kind || 'actual';
    let s = parseInt(startEl.value);
    let e = parseInt(endEl.value);
    if(e < s){ const tmp=e; e=s; s=tmp; }
    startEl.value = s; endEl.value = e;
    V9_RANGE_STATE.start=s; V9_RANGE_STATE.end=e;
    startV.textContent = s; endV.textContent = e;

    const invStartOverride = parseYen(invS.value);
    const invEndOverride = parseYen(invE.value);

    let out;
    if(modeKind==='estimate'){
      const mOv = parseYen(document.getElementById('v9-ov-margin')?.value);
      const dOv = parseYen(document.getElementById('v9-ov-disc')?.value);
      out = v9_estimatePeriod(storeId, s, e, mOv, dOv);
    }else{
      out = v9_calcPeriodAnchored(storeId, s, e, invStartOverride, invEndOverride);
    }
    if(!out) return;

    if(modeKind==='estimate'){
      label.textContent = ((s) + "\u65e5\u301c" + (e) + "\u65e5 / \u63a8\u5b9a\u5f0f\uff08\u5024\u5165 " + (v9_pct(out.margin)) + "\u30fb\u58f2\u5909 " + (v9_pct(out.disc)) + "\uff09");
    }else{
      label.textContent = ((s) + "\u65e5\u301c" + (e) + "\u65e5 / \u671f\u9996 " + (v9_currency(out.invStart)) + " / \u671f\u672b " + (v9_currency(out.invEnd)));
    }

    document.getElementById('v9-p-sales').textContent = v9_currency(out.sales);
    document.getElementById('v9-p-sales-sub').textContent = ("\u5024\u5f15\u984d\u5408\u8a08 " + (v9_currency((modeKind==='estimate' ? (out?.breakdown?.baihenAmt||0) : (out?.segs ? out.segs.reduce((a,s)=>a+v9_safe(s.breakdown?.baihen||0),0) : (out?.breakdown?.baihen||0))))));

    document.getElementById('v9-p-gp').textContent = v9_currency(out.gp);
    document.getElementById('v9-p-gpr').textContent = ("\u7c97\u5229\u7387 " + (v9_pct(out.gpr)));

    document.getElementById('v9-p-ach').textContent = v9_pct(out.ach);
    document.getElementById('v9-p-bud').textContent = ("\u671f\u9593\u4e88\u7b97 " + (v9_currency(out.budget)));

    document.getElementById('v9-p-cumach').textContent = v9_pct(out.cumAch);
    document.getElementById('v9-p-cumsub').textContent = ("\u7d2f\u8a08\u58f2\u4e0a " + (v9_currency(out.cumSales)) + " / \u7d2f\u8a08\u4e88\u7b97 " + (v9_currency(out.cumBudget)));

    // redraw charts with highlight
    try{
      const c1=document.getElementById('v9-chart-sales');
      const c2=document.getElementById('v9-chart-inv');
      const series = v9_dailySeries(storeId);
      if(c1) v9_drawSalesGross(c1, series, s, e);
      if(c2) v9_drawInventory(c2, series, s, e);
    }catch(e){}

    // formula text
    if(modeKind==='estimate'){
      document.getElementById('v9-p-formula').innerHTML =
        ("\u63a8\u5b9a\u7c97\u5229 = \u58f2\u4e0a \u2212 \u63a8\u5b9a\u58f2\u4e0a\u539f\u4fa1 \uff1d " + (v9_currency(out.sales)) + " \u2212 " + (v9_currency(out.estCogs)))
        + ("<br>\u63a8\u5b9a\u58f2\u4e0a\u539f\u4fa1 = \u30b3\u30a2\u63a8\u5b9a\u539f\u4fa1 + \u58f2\u4e0a\u7d0d\u54c1\u539f\u4fa1 + \u6d88\u8017\u54c1\u539f\u4fa1")
        + ("<br>\u30b3\u30a2\u63a8\u5b9a\u539f\u4fa1\uff08\u5024\u5165\u00d7\u58f2\u5909\u88dc\u6b63\uff09: \u30b3\u30a2\u58f2\u4e0a " + (v9_currency(out.breakdown.coreNet)) + " / \u58f2\u5909\u7387 " + (v9_pct(out.disc)) + " / \u5024\u5165\u7387 " + (v9_pct(out.margin)))
        + ("<br>\u58f2\u4e0a\u7d0d\u54c1\u539f\u4fa1 " + (v9_currency(out.breakdown.deliveryCost)) + " / \u6d88\u8017\u54c1\u539f\u4fa1 " + (v9_currency(out.breakdown.consCost)));
    }else{
      document.getElementById('v9-p-formula').innerHTML =
        ("\u7c97\u5229 = \u58f2\u4e0a \u2212 (\u671f\u9996\u5728\u5eab + \u671f\u9593\u4ed5\u5165\u7b49 \u2212 \u671f\u672b\u5728\u5eab) \uff1d " + (v9_currency(out.sales)) + " \u2212 (" + (v9_currency(out.invStart)) + " + " + (v9_currency(out.segs.reduce((a,s)=>a+v9_safe(s.breakdown.totalCostForPeriod),0))) + " \u2212 " + (v9_currency(out.invEnd)) + ")")
        + ("<br>\u203b\u5728\u5eab\u30a2\u30f3\u30ab\u30fc\u3067\u533a\u9593\u5206\u5272\u3057\u3001\u5404\u533a\u9593\u306e\u7c97\u5229\u3092\u5408\u7b97\uff08\u68da\u5378\u53cd\u6620\uff09");
    }
  };

  // Hook events
  ['input','change'].forEach(evt=>{
    startEl.addEventListener(evt, update);
    endEl.addEventListener(evt, update);
    invS.addEventListener(evt, update);
    invE.addEventListener(evt, update);
  });


  const modeBox = card.querySelector('#v9-mode');
  const estBox = card.querySelector('#v9-est-override');

  function renderAnchors(){
    const body = card.querySelector('#v9-anchor-body');
    if(!body) return;
    body.innerHTML = '';
    const items = v9_sortedAnchors(V9_RANGE_STATE.start, V9_RANGE_STATE.end);
    if(items.length===0){
      body.innerHTML = ("<tr><td colspan=\"3\" class=\"v9-muted\">\u30a2\u30f3\u30ab\u30fc\u306a\u3057\uff08\u5fc5\u8981\u306a\u5834\u5408\u306f\u300c\uff0b\u30a2\u30f3\u30ab\u30fc\u8ffd\u52a0\u300d\uff09</td></tr>");
      return;
    }
    items.forEach((a, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = ("\n        <td style=\"min-width:110px\">\n          <input class=\"v9-input\" style=\"width:110px\" type=\"text\" value=\"" + (a.day) + "\">\n        </td>\n        <td style=\"min-width:220px\">\n          <input class=\"v9-input\" style=\"width:220px\" type=\"text\" value=\"" + (Math.round(a.inv).toLocaleString('ja-JP')) + "\">\n        </td>\n        <td>\n          <button class=\"btn btn-outline v9-smallbtn\" style=\"width:auto\" data-act=\"del\">\u524a\u9664</button>\n        </td>\n      ");
      const dayIn = tr.querySelector('td:nth-child(1) input');
      const invIn = tr.querySelector('td:nth-child(2) input');
      const delBtn = tr.querySelector('[data-act="del"]');

      const parseDay = (v)=>{ const n=parseInt(String(v).replace(/[^\d]/g,'')); return isNaN(n)?null:n; };
      const parseY = (v)=>{ const t=String(v).replace(/[^\d\-\.]/g,''); if(!t) return null; const n=parseFloat(t); return isNaN(n)?null:n; };

      const commit = ()=>{
        const dday = parseDay(dayIn.value);
        const dinv = parseY(invIn.value);
        if(dday==null || dinv==null) return;
        // update underlying anchor
        const target = V9_ANCHORS.find(x=>x===a) || a;
        target.day = Math.max(1, Math.min(31, dday));
        target.inv = dinv;
        // ensure stored
        if(!V9_ANCHORS.includes(target)) V9_ANCHORS.push(target);
        // normalize unique by day (keep last)
        const map = {};
        V9_ANCHORS.forEach(x=>{ if(x && x.day!=null) map[x.day]=x; });
        V9_ANCHORS.length=0;
        Object.values(map).forEach(x=>V9_ANCHORS.push(x));
        update();
        renderAnchors();
      };

      dayIn.addEventListener('change', commit);
      invIn.addEventListener('change', commit);
      delBtn.addEventListener('click', ()=>{
        const i = V9_ANCHORS.indexOf(a);
        if(i>=0) V9_ANCHORS.splice(i,1);
        update();
        renderAnchors();
      });

      body.appendChild(tr);
    });
  }

  card.querySelector('#v9-add-anchor')?.addEventListener('click', ()=>{
    const mid = Math.max(V9_RANGE_STATE.start, Math.min(V9_RANGE_STATE.end, Math.floor((V9_RANGE_STATE.start+V9_RANGE_STATE.end)/2)));
    V9_ANCHORS.push({day: mid, inv: v9_safe(result?.[storeId]?.dailyInvData?.find(x=>x.day===mid)?.inv) || 0});
    renderAnchors();
    update();
  });
  card.querySelector('#v9-clear-anchor')?.addEventListener('click', ()=>{
    V9_ANCHORS.length=0;
    renderAnchors();
    update();
  });

  modeBox?.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-kind]');
    if(!b) return;
    modeBox.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    V9_MODE.kind = b.dataset.kind;
    if(estBox) estBox.style.display = (V9_MODE.kind==='estimate') ? 'flex' : 'none';
    update();
  });

  // Initialize mode UI
  if(estBox) estBox.style.display = (V9_MODE.kind==='estimate') ? 'flex' : 'none';
  renderAnchors();

  // initial
  update();
}


function v9_daysInfo(data){
  const daily = data?.daily || {};
  const budgetDaily = data?.budgetDaily || {};

  // "å£²ä¸ŠãŒç«‹ã£ã¦ã„ã‚‹æ—¥"ï¼šå£²ä¸Š > 0 ã®æ—¥ï¼ˆ0ã‚„æ¬ æã¯é™¤å¤–ï¼‰
  const salesDays = Object.entries(daily)
    .map(([k,v])=>({day:parseInt(k), sales:v9_safe(v?.sales)}))
    .filter(x=>!isNaN(x.day) && x.sales>0)
    .sort((a,b)=>a.day-b.day);

  const salesDayNums = salesDays.map(x=>x.day);
  const lastSalesDay = salesDayNums.length ? salesDayNums[salesDayNums.length-1] : 0;

  // "å£²ä¸Šè¡ŒãŒã‚ã‚‹æ—¥"ï¼ˆãƒ‡ãƒ¼ã‚¿è¡ŒãŒå­˜åœ¨ã™ã‚‹æ—¥ï¼‰ã‚‚å‚è€ƒç”¨ã«ä¿æŒ
  const actualDays = Object.keys(daily).map(d=>parseInt(d)).filter(d=>!isNaN(d)).sort((a,b)=>a-b);

  // "äºˆç®—ãŒã‚ã‚‹æ—¥"ï¼šäºˆç®— > 0ï¼ˆ0ã¯ã€Œäºˆç®—ãªã—ã€æ‰±ã„ï¼‰
  const budgetDays = Object.keys(budgetDaily)
    .map(d=>parseInt(d))
    .filter(d=>!isNaN(d) && budgetDaily[d]!=null && !isNaN(budgetDaily[d]) && budgetDaily[d]>0)
    .sort((a,b)=>a-b);

  const budgetTotal = budgetDays.reduce((s,d)=>s+v9_safe(budgetDaily[d]),0);

  // å–¶æ¥­æ—¥å®šç¾©ï¼šåŸºæœ¬ã¯ã€Œäºˆç®—ãŒã‚ã‚‹æ—¥ã€ã€‚äºˆç®—ãŒç„¡ã„å ´åˆã®ã¿ã€Œå£²ä¸ŠãŒç«‹ã£ã¦ã„ã‚‹æ—¥ã€ã‚’å–¶æ¥­æ—¥ã¨ã—ã¦ä»£ç”¨
  const businessDays = budgetDays.length ? budgetDays : salesDayNums;

  const totalBusinessDays = businessDays.length;
  const elapsedBusinessDays = businessDays.filter(d=> d<=lastSalesDay).length;

  const budgetElapsed = businessDays.filter(d=> d<=lastSalesDay).reduce((s,d)=>s+v9_safe(budgetDaily[d]),0);

  const remainingBudgetDays = businessDays.filter(d=> d>lastSalesDay).length;
  const budgetRemaining = (budgetTotal - budgetElapsed);

  return {
    actualDays,
    salesDayNums,
    lastSalesDay,
    businessDays,
    totalBusinessDays,
    elapsedBusinessDays,
    remainingBudgetDays,
    budgetTotal,
    budgetElapsed,
    budgetRemaining
  };
}


function v9_calcKPI(data, opts={}){
  // Centralized KPI calculation module for dashboards/reports
  // opts: { storeId, targetMargin, warningMargin }
  const daysInfo = v9_daysInfo(data||{});
  const totalSales = v9_safe(data?.totalSales);
  const gpRate = v9_safe(data?.grossProfitRate);
  const estRate = v9_safe(data?.estimatedGrossRate);

  // Inventory estimate diff (estimated end vs registered end)
  const storeId = opts.storeId;
  let estInvEnd = v9_safe(data?.estimatedInvEnd);
  try{
    if(storeId!=null){
      const series = v9_dailySeries(storeId)||[];
      const lastPoint = series.filter(x=>x.has).slice(-1)[0];
      if(lastPoint) estInvEnd = v9_safe(lastPoint.estInv);
    }
  }catch(e){ /* optional */ }
  const invEnd = v9_safe(data?.invEnd);
  const invDiff = (estInvEnd!=null && invEnd!=null) ? (estInvEnd - invEnd) : null;

  // Budget numbers: prefer explicit monthly budget, fallback to budgetTotal computed from daily budgets
  const budgetTotal = v9_safe(data?.budget || daysInfo.budgetTotal || 0);
  const budgetAch = budgetTotal>0 ? (totalSales/budgetTotal) : null;

  // Business-day based forecast
  const avgPerBizDay = daysInfo.elapsedBusinessDays>0 ? (totalSales/daysInfo.elapsedBusinessDays) : null;
  const projSales = (avgPerBizDay!=null && daysInfo.totalBusinessDays>0) ? (avgPerBizDay*daysInfo.totalBusinessDays) : null;
  const projAch = (budgetTotal>0 && projSales!=null) ? (projSales/budgetTotal) : null;

  // Remaining budget: two concepts kept separately to avoid mix-ups
  const budgetElapsed = v9_safe(daysInfo.budgetElapsed);
  const budgetRemainingDaily = v9_safe(daysInfo.budgetRemaining); // æ—¥å‰²ã‚Šæ®‹
  const remainingSalesToBudget = budgetTotal - totalSales;        // å£²ä¸Šå·®åˆ†

  const budgetConsumptionRate = budgetTotal>0 ? (budgetElapsed/budgetTotal) : null;

  // Threshold accents
  const targetMargin = (opts.targetMargin!=null && !isNaN(opts.targetMargin)) ? opts.targetMargin : 0.25;
  const warningMargin = (opts.warningMargin!=null && !isNaN(opts.warningMargin)) ? opts.warningMargin : 0.23;

  const gpAccent = (gpRate==null) ? 'info' : (gpRate>=targetMargin ? 'success' : gpRate>=warningMargin ? 'warning' : 'danger');
  const projAccent = (projAch==null) ? 'info' : (projAch>=1 ? 'success' : projAch>=0.9 ? 'warning' : 'danger');

  return {
    daysInfo,
    totalSales,
    gpRate,
    estRate,
    estInvEnd,
    invEnd,
    invDiff,
    budgetTotal,
    budgetAch,
    budgetElapsed,
    budgetRemainingDaily,
    remainingSalesToBudget,
    budgetConsumptionRate,
    avgPerBizDay,
    projSales,
    projAch,
    gpAccent,
    projAccent
  };
}


function v9_currency(n){
  if(n==null||isNaN(n)) return '-';
  return 'Â¥'+Math.round(n).toLocaleString('ja-JP');
}
function v9_pct(x,d=2){
  if(x==null||isNaN(x)) return '-';
  return (x*100).toFixed(d)+'%';
}
function v9_safe(n){ return (n==null||isNaN(n))?0:n; }

function v9_getDataQuality(storeData){
  const items=[];
  // Required files
  if(!DATA.shiire) items.push({type:'danger',label:'ä»•å…¥',value:'æœªèª­è¾¼'});
  if(!DATA.uriage) items.push({type:'danger',label:'å£²ä¸Š',value:'æœªèª­è¾¼'});
  if(!DATA.settings) items.push({type:'warning',label:'åˆæœŸè¨­å®š',value:'ä»»æ„'});
  if(!DATA.baihen) items.push({type:'info',label:'å£²å¤‰',value:'ä»»æ„'});
  if(!DATA.budget) items.push({type:'info',label:'äºˆç®—',value:'ä»»æ„'});
  // Inventory coverage
  const storeCount = Object.keys(STORES||{}).length;
  const invCount = Object.keys(STORE_INVENTORY||{}).length;
  if(storeCount>0 && invCount<storeCount){
    items.push({type:'warning',label:'åœ¨åº«è¨­å®š',value:((invCount) + "/" + (storeCount))});
  }else if(storeCount>0 && invCount===storeCount){
    items.push({type:'success',label:'åœ¨åº«è¨­å®š',value:'OK'});
  }
  // Price-calc suppliers
  if(storeData && storeData.supTotals){
    let useCnt=0;
    Object.values(storeData.supTotals).forEach(s=>{
      if(s && s.usePriceCalc) useCnt++;
    });
    if(useCnt>0) items.push({type:'info',label:'å£²ä¾¡å†è¨ˆç®—',value:((useCnt) + "\u793e")});
  }
  return items;
}

/** Build daily series for charts (day, sales, estGrossRate, estInv) */
function v9_dailySeries(storeId){
  const d = result?.[storeId];
  if(!d) return [];
  const series=[];
  const coreM = v9_safe(d.coreMarginRate!=null?d.coreMarginRate:d.avgMargin);
  const baihenRateSales = v9_safe(d.baihenRateSales); // v8ã¨åŒã˜ï¼ˆæœˆæ¬¡å£²å¤‰ç‡ï¼‰
  let runningInv = v9_safe(d.invStart);

  for(let day=1; day<=31; day++){
    const dayData = d.daily?.[day];
    if(!dayData){
      // still push to keep x-axis stable
      series.push({day, sales:0, estGrossRate:null, estInv:runningInv, has:false});
      continue;
    }
    const daySales = v9_safe(dayData.sales);

    const dayShiireCost = v9_safe(dayData.shiire?.cost);
    const dayTenkanIn   = v9_safe(dayData.tenkanInTotal?.cost);
    const dayTenkanOut  = v9_safe(dayData.tenkanOutTotal?.cost);
    const dayBumonIn    = v9_safe(dayData.bumonInTotal?.cost);
    const dayBumonOut   = v9_safe(dayData.bumonOutTotal?.cost);
    const dayHanaCost   = v9_safe(dayData.hana?.cost);
    const daySanchokuCost = v9_safe(dayData.sanchoku?.cost);
    const dayConsCost   = v9_safe(dayData.consumable?.cost);

    const dayBaihenAbs = (dayData.baihenAbs!=null) ? v9_safe(dayData.baihenAbs) : Math.abs(v9_safe(dayData.baihen));
    const dayHanaPrice = v9_safe(dayData.hana?.price);
    const daySanchokuPrice = v9_safe(dayData.sanchoku?.price);

    // v8: æ—¥æ¬¡ä»•å…¥åˆè¨ˆï¼ˆåŸä¾¡ï¼‰â€»åº—é–“/éƒ¨é–€é–“ã®å‡ºã‚‚åŠ ç®—ï¼ˆå…ƒãƒ­ã‚¸ãƒƒã‚¯ã«åˆã‚ã›ã‚‹ï¼‰
    const dayTotalCost = dayShiireCost + dayTenkanIn + dayTenkanOut + dayBumonIn + dayBumonOut + dayHanaCost + daySanchokuCost + dayConsCost;

    // v8: æ—¥æ¬¡ã‚³ã‚¢å£²ä¸Šï¼ˆãƒãƒƒãƒˆï¼‰
    const dayCoreSales = Math.max(0, daySales - dayHanaPrice - daySanchokuPrice);

    // v8: æ—¥æ¬¡ã‚°ãƒ­ã‚¹å£²ä¸Š = ãƒãƒƒãƒˆå£²ä¸Š / (1-d)
    const dayGrossSales = (1-baihenRateSales)>0 ? dayCoreSales/(1-baihenRateSales) : dayCoreSales;

    // v8: æ—¥æ¬¡ã‚³ã‚¢å£²ä¸ŠåŸä¾¡ = ã‚°ãƒ­ã‚¹å£²ä¸Š Ã— (1-m)
    const dayCoreCogs = dayGrossSales*(1-coreM);

    // v8: æ—¥æ¬¡å£²ä¸Šç´å“åŸä¾¡
    const dayDeliveryCogs = dayHanaCost + daySanchokuCost;

    // v8: æ—¥æ¬¡æ¨å®šå£²ä¸ŠåŸä¾¡åˆè¨ˆ
    const dayEstCogs = dayCoreCogs + dayDeliveryCogs + dayConsCost;

    // v8: æ¨å®šåœ¨åº« = å‰æ—¥åœ¨åº« + å½“æ—¥ä»•å…¥åˆè¨ˆ - å½“æ—¥æ¨å®šå£²ä¸ŠåŸä¾¡
    runningInv = runningInv + dayTotalCost - dayEstCogs;

    const estGP = daySales - dayEstCogs;
    const estRate = daySales>0 ? (estGP/daySales) : null;

    series.push({day, sales:daySales, estGrossRate:estRate, estInv:runningInv, has:true});
  }
  return series;
}


function v9_topAnomalyDays(storeId, topN=3){
  // Returns {summary, itemsHtml, overallColor}
  const d = result?.[storeId];
  if(!d){
    return {summary:'ãƒ‡ãƒ¼ã‚¿ãªã—', itemsHtml:'<div class="note">â€”</div>', overallColor:'info'};
  }
  const daysInfo = v9_daysInfo(d);
  const bizDays = (daysInfo.businessDays||[]).slice().sort((a,b)=>a-b);
  if(!bizDays.length){
    return {summary:'å–¶æ¥­æ—¥ãªã—', itemsHtml:'<div class="note">â€”</div>', overallColor:'info'};
  }

  const daily = d.daily || {};
  const salesArr = bizDays.map(day=>{
    const s = v9_safe(daily?.[day]?.sales);
    return {day, sales:s, has: daily?.[day]!=null};
  });

  const positives = salesArr.map(x=>x.sales).filter(v=>v>0);
  const baseline = positives.length ? v9_median(positives) : v9_avg(salesArr.map(x=>x.sales));
  const mad = positives.length ? v9_mad(positives) : 0;

  function scoreOf(x){
    if(baseline>0){
      const pct = (x - baseline) / baseline;
      // prefer robust z if possible
      if(mad>0){
        const z = (x - baseline) / (1.4826*mad);
        return Math.abs(z) + Math.abs(pct);
      }
      return Math.abs(pct);
    }
    return Math.abs(x);
  }

  const ranked = salesArr
    .map(o=>{
      const pct = baseline>0 ? (o.sales - baseline)/baseline : null;
      return {...o, pct, score: scoreOf(o.sales)};
    })
    .sort((a,b)=>b.score-a.score)
    .slice(0, Math.max(1, topN));

  const itemsHtml = ranked.map(r=>{
    const deltaClass = (r.pct!=null && r.pct>=0) ? 'pos' : 'neg';
    const deltaTxt = (r.pct==null) ? '' : (r.pct>=0 ? ("+" + ((r.pct*100).toFixed(0)) + "%") : (((r.pct*100).toFixed(0)) + "%"));
    const note = (r.sales<=0) ? 'å£²ä¸Š0' : (r.has ? ' ' : 'æ¬ æ');
    return ("<div class=\"item\"><span class=\"day\">" + (r.day) + "\u65e5</span><span style=\"margin-left:auto\">\u00a5" + (fmt(r.sales)) + "</span><span class=\"delta " + (deltaClass) + "\">" + (deltaTxt) + "</span><span class=\"note\">" + (note) + "</span></div>");
  }).join('');

  // overall: if top anomaly is negative big or any zero on biz day -> warning/danger
  let overallColor = 'info';
  const worstNeg = ranked.some(r=>r.pct!=null && r.pct<-0.3);
  const anyZero = ranked.some(r=>r.sales<=0);
  if(anyZero || worstNeg) overallColor = 'warning';
  if(anyZero && worstNeg) overallColor = 'danger';

  const summary = baseline>0
    ? ("\u57fa\u6e96(\u4e2d\u592e\u5024) \u00a5" + (fmt(baseline)) + " \u306b\u5bfe\u3059\u308b\u4e56\u96e2")
    : 'åŸºæº–ç®—å‡ºä¸å¯ï¼ˆå£²ä¸ŠãŒå°‘ãªã„ï¼‰';

  return {summary, itemsHtml, overallColor};
}

function v9_median(arr){
  const a = (arr||[]).filter(v=>Number.isFinite(v)).slice().sort((x,y)=>x-y);
  const n=a.length; if(!n) return 0;
  const mid=Math.floor(n/2);
  return n%2 ? a[mid] : (a[mid-1]+a[mid])/2;
}
function v9_avg(arr){
  const a=(arr||[]).filter(v=>Number.isFinite(v));
  if(!a.length) return 0;
  return a.reduce((s,v)=>s+v,0)/a.length;
}
function v9_mad(arr){
  const med = v9_median(arr);
  const dev = (arr||[]).map(v=>Math.abs(v-med));
  return v9_median(dev);
}

function v9_drawSalesGross(canvas, series, startDay, endDay){
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w*DPR); canvas.height = Math.floor(h*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,w,h);

  const padL=52, padR=44, padT=14, padB=34;
  const plotW = w-padL-padR, plotH = h-padT-padB;

  // Range highlight
  if(startDay!=null && endDay!=null){
    const s = Math.max(1, Math.min(31, startDay));
    const e = Math.max(1, Math.min(31, endDay));
    const step = plotW/31;
    const x1 = padL + (s-1)*step;
    const x2 = padL + (e)*step;
    ctx.fillStyle = 'rgba(251,191,36,0.10)';
    ctx.fillRect(x1, padT, Math.max(0, x2-x1), plotH);
  }

  // Range highlight
  if(startDay!=null && endDay!=null){
    const s = Math.max(1, Math.min(31, startDay));
    const e = Math.max(1, Math.min(31, endDay));
    const barCount = 31;
    const barW = plotW / barCount;
    const x1 = padL + (s-1)*barW;
    const x2 = padL + (e)*barW;
    ctx.fillStyle = 'rgba(251,191,36,0.10)';
    ctx.fillRect(x1, padT, Math.max(0, x2-x1), plotH);
  }

  const days = series.map(p=>p.day);
  const salesMax = Math.max(1, ...series.map(p=>p.sales||0));
  const rateVals = series.map(p=> (p.estGrossRate==null? null : p.estGrossRate)).filter(v=>v!=null);
  const rateMin = rateVals.length? Math.min(...rateVals, 0.0) : 0;
  const rateMax = rateVals.length? Math.max(...rateVals, 0.35) : 0.35;

  // Grid
  ctx.globalAlpha=0.35;
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  for(let i=0;i<=4;i++){
    const y = padT + (plotH*(i/4));
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();
  }
  ctx.globalAlpha=1;

  // Axes labels (minimal)
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text4') || '#777';
  ctx.font = '11px "JetBrains Mono", monospace';
  ctx.textAlign='right'; ctx.textBaseline='middle';
  for(let i=0;i<=4;i++){
    const y = padT + (plotH*(i/4));
    const val = salesMax*(1-i/4);
    ctx.fillText((Math.round(val)).toLocaleString('ja-JP'), padL-8, y);
  }
  ctx.textAlign='left';
  for(let i=0;i<=3;i++){
    const y = padT + (plotH*(i/3));
    const v = rateMax - (rateMax-rateMin)*(i/3);
    ctx.fillText(Math.round(v*100)+'%', padL+plotW+8, y);
  }

  // Bars (sales)
  const barCount = 31;
  const barW = plotW / barCount;
  const barGap = Math.max(1, barW*0.18);
  const actualBarW = barW - barGap;
  const barColor = 'rgba(99,102,241,0.45)';

  for(let i=0;i<series.length;i++){
    const p = series[i];
    const x = padL + i*barW + barGap/2;
    const bh = (p.sales||0)/salesMax * plotH;
    const y = padT + (plotH - bh);
    ctx.fillStyle = barColor;
    ctx.fillRect(x,y,actualBarW,bh);
  }

  // Line (gross rate)
  ctx.strokeStyle = 'rgba(52,211,153,0.95)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  let started=false;
  for(let i=0;i<series.length;i++){
    const p=series[i];
    if(p.estGrossRate==null) continue;
    const x = padL + i*barW + barW/2;
    const t = (p.estGrossRate - rateMin)/(rateMax-rateMin || 1);
    const y = padT + (plotH - t*plotH);
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // X ticks (every 5 days)
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text4') || '#777';
  ctx.font = '11px "Noto Sans JP", sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='top';
  for(let d=5; d<=30; d+=5){
    const i=d-1;
    const x = padL + i*barW + barW/2;
    ctx.fillText(d+'æ—¥', x, padT+plotH+10);
  }
}

function v9_drawInventory(canvas, series, startDay, endDay){
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = Math.floor(w*DPR); canvas.height = Math.floor(h*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,w,h);

  const padL=62, padR=16, padT=14, padB=34;
  const plotW = w-padL-padR, plotH = h-padT-padB;

  const vals = series.map(p=>p.estInv||0);
  const minV = Math.min(...vals);
  const maxV = Math.max(...vals, 1);

  // Grid
  ctx.globalAlpha=0.35;
  ctx.strokeStyle='rgba(255,255,255,0.10)';
  for(let i=0;i<=4;i++){
    const y = padT + (plotH*(i/4));
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();
  }
  ctx.globalAlpha=1;

  // Y labels
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text4') || '#777';
  ctx.font = '11px "JetBrains Mono", monospace';
  ctx.textAlign='right'; ctx.textBaseline='middle';
  for(let i=0;i<=4;i++){
    const y = padT + (plotH*(i/4));
    const v = maxV - (maxV-minV)*(i/4);
    ctx.fillText(Math.round(v).toLocaleString('ja-JP'), padL-8, y);
  }

  // Area + line
  const step = plotW/31;
  const toY = (v)=> padT + (plotH - ((v-minV)/(maxV-minV||1))*plotH);

  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const x = padL + i*step + step/2;
    const y = toY(series[i].estInv||0);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  // Fill area
  ctx.lineTo(padL + plotW, padT + plotH);
  ctx.lineTo(padL, padT + plotH);
  ctx.closePath();
  ctx.fillStyle='rgba(56,189,248,0.14)';
  ctx.fill();

  // Stroke line
  ctx.beginPath();
  for(let i=0;i<series.length;i++){
    const x = padL + i*step + step/2;
    const y = toY(series[i].estInv||0);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.strokeStyle='rgba(56,189,248,0.95)';
  ctx.lineWidth=2;
  ctx.stroke();

  // X ticks
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text4') || '#777';
  ctx.font = '11px "Noto Sans JP", sans-serif';
  ctx.textAlign='center'; ctx.textBaseline='top';
  for(let d=5; d<=30; d+=5){
    const i=d-1;
    const x = padL + i*step + step/2;
    ctx.fillText(d+'æ—¥', x, padT+plotH+10);
  }
}

function v9_renderBreakdown(storeId, tab){
  const d = result?.[storeId];
  const host = document.getElementById('v9-breakdown-body');
  if(!d || !host) return;

  const safe = (x)=> (x==null || isNaN(x)) ? 0 : +x;

  // å…±é€š: å£²ä¾¡åˆè¨ˆï¼ˆæ§‹æˆæ¯”ã®æ¯æ•°ï¼‰
  const totalPriceAll =
    tab==='supplier' ? Object.values(d.supTotals||{}).reduce((s,v)=>s+safe(v.price),0) :
    tab==='category' ? Object.values(d.catTotals||{}).reduce((s,v)=>s+safe(v.price),0) :
    0;

  if(tab==='category'){
    const rows = Object.entries(d.catTotals||{})
      .map(([k,v])=>({k, cost:safe(v.cost), price:safe(v.price)}))
      .sort((a,b)=> (b.cost-a.cost));

    let weightedSum = 0;
    let h = '<div style="overflow:auto;max-height:360px"><table class="v9-table"><thead><tr><th>åˆ†é¡</th><th>åŸä¾¡</th><th>å£²ä¾¡</th><th>æ§‹æˆæ¯”</th><th>å€¤å…¥ç‡</th><th>ç›¸ä¹—ç©å€¤å…¥ç‡</th></tr></thead><tbody>';
    rows.forEach(r=>{
      const meta = CATEGORIES?.[r.k];
      const name = meta ? ((meta.icon) + " " + (meta.name)) : r.k;
      const share = (totalPriceAll>0) ? (r.price/totalPriceAll) : 0;
      const margin = (r.price>0)? (r.price-r.cost)/r.price : 0;
      const weighted = margin * share;
      weightedSum += weighted;
      h += ("<tr>\n        <td>" + (name) + "</td>\n        <td style=\"text-align:right;color:var(--warning)\">" + (v9_currency(r.cost)) + "</td>\n        <td style=\"text-align:right;color:var(--success)\">" + (v9_currency(r.price)) + "</td>\n        <td style=\"text-align:right\">" + (v9_pct(share)) + "</td>\n        <td style=\"text-align:right;color:var(--info)\">" + (v9_pct(margin)) + "</td>\n        <td style=\"text-align:right;font-weight:700;color:var(--purple)\">" + (v9_pct(weighted)) + "</td>\n      </tr>");
    });
    h += ("</tbody>\n      <tfoot>\n        <tr style=\"background:var(--bg3);font-weight:800\">\n          <td>\u5408\u8a08\uff08\u76f8\u4e57\u7a4d\uff09</td>\n          <td style=\"text-align:right;color:var(--warning)\">" + (v9_currency(rows.reduce((s,r)=>s+r.cost,0))) + "</td>\n          <td style=\"text-align:right;color:var(--success)\">" + (v9_currency(rows.reduce((s,r)=>s+r.price,0))) + "</td>\n          <td style=\"text-align:right\">" + (v9_pct(1)) + "</td>\n          <td style=\"text-align:right;color:var(--info)\">" + (v9_pct((rows.reduce((s,r)=>s+r.price,0)>0)?((rows.reduce((s,r)=>s+r.price,0)-rows.reduce((s,r)=>s+r.cost,0))/rows.reduce((s,r)=>s+r.price,0)):0)) + "</td>\n          <td style=\"text-align:right;color:var(--purple)\">" + (v9_pct(weightedSum)) + "</td>\n        </tr>\n      </tfoot></table></div>");
    host.innerHTML = h;
  }

  if(tab==='supplier'){
    const rows = Object.entries(d.supTotals||{})
      .map(([code,v])=>({code, name:v.name||code, cost:safe(v.cost), price:safe(v.price), use:!!v.usePriceCalc}))
      .sort((a,b)=> b.cost-a.cost);

    let weightedSum = 0;
    let h = '<div style="overflow:auto;max-height:360px"><table class="v9-table"><thead><tr><th>ä»•å…¥å…ˆ</th><th>åŸä¾¡</th><th>å£²ä¾¡</th><th>æ§‹æˆæ¯”</th><th>å€¤å…¥ç‡</th><th>ç›¸ä¹—ç©å€¤å…¥ç‡</th><th>å£²ä¾¡å†è¨ˆç®—</th></tr></thead><tbody>';
    rows.forEach(r=>{
      const share = (totalPriceAll>0) ? (r.price/totalPriceAll) : 0;
      const m = (r.price>0)? (r.price-r.cost)/r.price : 0;
      const weighted = m * share;
      weightedSum += weighted;
      h += ("<tr>\n        <td><div style=\"display:flex;gap:8px;align-items:center\"><span class=\"v9-muted\" style=\"font-family:'JetBrains Mono',monospace\">" + (r.code) + "</span><span>" + (r.name) + "</span></div></td>\n        <td style=\"text-align:right;color:var(--warning)\">" + (v9_currency(r.cost)) + "</td>\n        <td style=\"text-align:right;color:var(--success)\">" + (v9_currency(r.price)) + "</td>\n        <td style=\"text-align:right\">" + (v9_pct(share)) + "</td>\n        <td style=\"text-align:right;color:var(--info)\">" + (v9_pct(m)) + "</td>\n        <td style=\"text-align:right;font-weight:700;color:var(--purple)\">" + (v9_pct(weighted)) + "</td>\n        <td style=\"text-align:center\">" + (r.use?'âœ…':'-') + "</td>\n      </tr>");
    });
    h += ("</tbody>\n      <tfoot>\n        <tr style=\"background:var(--bg3);font-weight:800\">\n          <td>\u5408\u8a08\uff08\u76f8\u4e57\u7a4d\uff09</td>\n          <td style=\"text-align:right;color:var(--warning)\">" + (v9_currency(rows.reduce((s,r)=>s+r.cost,0))) + "</td>\n          <td style=\"text-align:right;color:var(--success)\">" + (v9_currency(rows.reduce((s,r)=>s+r.price,0))) + "</td>\n          <td style=\"text-align:right\">" + (v9_pct(1)) + "</td>\n          <td style=\"text-align:right;color:var(--info)\">" + (v9_pct((rows.reduce((s,r)=>s+r.price,0)>0)?((rows.reduce((s,r)=>s+r.price,0)-rows.reduce((s,r)=>s+r.cost,0))/rows.reduce((s,r)=>s+r.price,0)):0)) + "</td>\n          <td style=\"text-align:right;color:var(--purple)\">" + (v9_pct(weightedSum)) + "</td>\n          <td></td>\n        </tr>\n      </tfoot></table></div>");
    host.innerHTML = h;
  }

  if(tab==='daily'){
    const days = Object.keys(d.daily||{}).map(x=>+x).sort((a,b)=>a-b);
    let h = '<div style="overflow:auto;max-height:360px"><table class="v9-table"><thead><tr><th>æ—¥</th><th>å£²ä¸Š</th><th>å€¤å¼•</th><th>æ¨å®šç²—åˆ©ç‡</th><th>æ¨å®šåœ¨åº«</th></tr></thead><tbody>';
    const series = v9_dailySeries(storeId);
    const byDay = {};
    series.forEach(p=>byDay[p.day]=p);
    days.forEach(day=>{
      const dd = d.daily[day];
      const s = byDay[day] || {};
      h += ("<tr>\n        <td>" + (day) + "\u65e5</td>\n        <td style=\"text-align:right\">" + (v9_currency(v9_safe(dd.sales))) + "</td>\n        <td style=\"text-align:right;color:var(--danger)\">" + (v9_currency(v9_safe(dd.baihen))) + "</td>\n        <td style=\"text-align:right;color:var(--info)\">" + (s.estGrossRate==null?'-':v9_pct(s.estGrossRate)) + "</td>\n        <td style=\"text-align:right;color:#06b6d4\">" + (v9_currency(v9_safe(s.estInv))) + "</td>\n      </tr>");
    });
    h += '</tbody></table></div>';
    host.innerHTML = h;
  }
}

function renderDashboardV2(){
  const contentEl = document.getElementById('content');
  if(contentEl) contentEl.innerHTML = '<div class="empty">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ä¸­â€¦</div>';
  const data = result?.[currentStore];
  let projSales = null;
  let projAch = null;
  if(!data){ if(contentEl) contentEl.innerHTML = '<div class="empty">åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆåº—èˆ—åˆ‡æ›¿å¾Œã«ã€Œé›†è¨ˆã€ã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰</div>'; return; }

  // thresholds
  const targetMargin = (parseFloat(document.getElementById('target-margin')?.value)||25)/100;
  const warningMargin = (parseFloat(document.getElementById('warning-margin')?.value)||23)/100;

  const kpi = v9_calcKPI(data, { storeId: currentStore, targetMargin, warningMargin });

  // aliases for readability in template
  const gpRate = kpi.gpRate;
  const estRate = kpi.estRate;
  const estInvEndDash = kpi.estInvEnd;
  const invDiff = kpi.invDiff;

  const daysInfo = kpi.daysInfo;
  const budgetTotal = kpi.budgetTotal;
  const budgetAch = kpi.budgetAch;
  projSales = kpi.projSales;
  projAch = kpi.projAch;

  const gpAccent = kpi.gpAccent;
  const projAccent = kpi.projAccent;

  // Focus pills
  const pills = v9_getDataQuality(data);

  // HTML skeleton
  // Exec dashboard (v10): show on both ALL and store views
  const scopeLabel = (currentStore==='all') ? 'ALLï¼ˆå…¨åº—ï¼‰' : ("\u5e97\u8217 " + ((STORES?.[currentStore]?.name||currentStore)));
  const execHtml = (typeof v10_execBarHTML==='function') ? v10_execBarHTML({
    scopeLabel,
    days: daysInfo,
    plan: {
      salesBudget: v9_safe(data?.budget || kpi.budgetTotal || 0),
      gpBudget:    (data?.gpBudget!=null ? v9_safe(data.gpBudget) : null),
      gpRateBudget:(data?.gpBudget!=null && (data?.budget||kpi.budgetTotal)>0) ? (v9_safe(data.gpBudget)/(v9_safe(data.budget||kpi.budgetTotal))) : null,
      invStart:    (data?.invStart!=null ? v9_safe(data.invStart) : null),
      invEnd:      (data?.invTarget!=null ? v9_safe(data.invTarget) : null)
    },
    prog: {
      salesActual:        v9_safe(data?.totalSales),
      salesBudgetElapsed: (kpi.budgetElapsed!=null ? v9_safe(kpi.budgetElapsed) : v9_safe(data?.budgetConsumed)),
      salesDelta:         (kpi.budgetElapsed>0) ? (v9_safe(data?.totalSales) - v9_safe(kpi.budgetElapsed)) : null,
      salesAch:           (kpi.budgetElapsed>0) ? (v9_safe(data?.totalSales) / v9_safe(kpi.budgetElapsed)) : null,
      gpActual:           v9_safe(data?.grossProfit),
      gpDelta:            (data?.gpBudget>0) ? (v9_safe(data?.grossProfit) - v9_safe(data?.gpBudget)) : null,
      gpRate:             (data?.grossProfitRateAfterConsumable!=null ? v9_safe(data.grossProfitRateAfterConsumable) : gpRate)
    },
    fc: {
      projSales:    projSales,
      projSalesAch: (projSales!=null && (v9_safe(data?.budget||kpi.budgetTotal)>0)) ? (projSales / v9_safe(data?.budget||kpi.budgetTotal)) : null,
      projGP:       (projSales!=null) ? (projSales * (data?.grossProfitRateAfterConsumable!=null ? v9_safe(data.grossProfitRateAfterConsumable) : gpRate)) : null,
      projGPAch:    (projSales!=null && data?.gpBudget>0) ? ((projSales * (data?.grossProfitRateAfterConsumable!=null ? v9_safe(data.grossProfitRateAfterConsumable) : gpRate)) / v9_safe(data.gpBudget)) : null
    }
  }) : '';
  let h = ("\n    " + (execHtml) + "\n    <div class=\"v9-wrap\">\n      <div class=\"v9-mini\" style=\"margin-top:-4px\">\u30b9\u30b3\u30fc\u30d7: <b>" + ((currentStore==='all')?'å…¨åº—':(STORES?.[currentStore]?.name||currentStore)) + "</b>" + ((currentStore==='all')?'':'ï¼ˆID '+currentStore+'ï¼‰') + "</div>\n      " + ("") + "\n      <div class=\"v9-kpis\">\n        <div class=\"v9-kpi\" data-accent=\"primary\">\n          <div class=\"v9-kpi-l\">\u58f2\u4e0a\uff08MTD\uff09</div>\n          <div class=\"v9-kpi-v\">" + (v9_currency(data.totalSales)) + "</div>\n          <div class=\"v9-kpi-s\">\u65e5\u5e73\u5747 " + (v9_currency(data.avgDailySales)) + " / \u7a3c\u50cd " + (daysInfo.elapsedBusinessDays||0) + "\u65e5</div>\n        </div>\n\n        <div class=\"v9-kpi\" data-accent=\"" + (gpAccent) + "\">\n          <div class=\"v9-kpi-l\">\u7c97\u5229\u7387\uff08\u5b9f\u7e3e\uff09</div>\n          <div class=\"v9-kpi-v\" style=\"color:var(--" + (gpAccent) + ")\">" + (v9_pct(gpRate)) + "</div>\n          <div class=\"v9-kpi-s\">\u7c97\u5229 " + (v9_currency(data.grossProfit)) + "\uff08\u5728\u5eab: \u671f\u9996/\u671f\u672b\u53cd\u6620\uff09</div>\n        </div>\n\n        <div class=\"v9-kpi\" data-accent=\"purple\">\n          <div class=\"v9-kpi-l\">\u7c97\u5229\u7387\uff08\u63a8\u5b9a\uff09</div>\n          <div class=\"v9-kpi-v\" style=\"color:var(--purple)\">" + (v9_pct(estRate)) + "</div>\n          <div class=\"v9-kpi-s\">\u63a8\u5b9a\u7c97\u5229 " + (v9_currency(data.estimatedGrossProfit)) + "</div>\n        </div>\n\n        <div class=\"v9-kpi\" data-accent=\"info\">\n          <div class=\"v9-kpi-l\">\u63a8\u5b9a\u671f\u672b\u5728\u5eab</div>\n          <div class=\"v9-kpi-v\" style=\"color:#06b6d4\">" + (v9_currency(estInvEndDash)) + "</div>\n          <div class=\"v9-kpi-s\">\u5b9f\u7e3e " + (v9_currency(data.invEnd)) + " / \u5dee\u7570 " + (v9_currency(invDiff)) + "</div>\n        </div>\n\n        <div class=\"v9-kpi\" data-accent=\"danger\">\n          <div class=\"v9-kpi-l\">\u5024\u5f15\u5f71\u97ff\uff08\u539f\u4fa1\u640d\u5931\uff09</div>\n          <div class=\"v9-kpi-v\" style=\"color:var(--danger)\">" + (v9_currency(data.baihenLossCost||0)) + "</div>\n          <div class=\"v9-kpi-s\">\u58f2\u5909\u7387 " + (v9_pct(data.baihenRateSales||0)) + " / \u5024\u5f15\u984d " + (v9_currency(data.totalBaihen||0)) + "</div>\n        </div>\n\n        <div class=\"v9-kpi\" data-accent=\"" + (projAccent) + "\">\n          <div class=\"v9-kpi-l\">\u6708\u672b\u7740\u5730\uff08\u4e88\u6e2c\uff09</div>\n          <div class=\"v9-kpi-v\" style=\"color:var(--" + (projAccent) + ")\">" + (projSales==null?'-':v9_currency(projSales)) + "</div>\n          <div class=\"v9-kpi-s\">\u4e88\u7b97\u9054\u6210\u7387 " + (budgetAch==null?'-':v9_pct(budgetAch)) + " / \u7740\u5730 " + (projAch==null?'-':(projAch==null?'-':v9_pct(projAch))) + " / \u4e88\u7b97 " + (v9_currency(data.budget||0)) + "</div>\n        </div>\n      </div>\n\n      <div class=\"v9-card\">\n        <div class=\"v9-card-h\">\n          <div>\n            <div class=\"v9-card-title\">\u26a1 Focus\uff08\u30c7\u30fc\u30bf\u54c1\u8cea / \u6ce8\u610f\u70b9\uff09</div>\n            <div class=\"v9-card-sub\">\u4e0d\u8db3\u3084\u5f71\u97ff\u306e\u5927\u304d\u3044\u6761\u4ef6\u3092\u5e38\u6642\u8868\u793a</div>\n          </div>\n          <div style=\"display:flex;gap:6px;align-items:center\">\n            <button class=\"btn btn-outline\" style=\"width:auto;padding:8px 10px\" onclick=\"showSettingsModal()\">\u2699\ufe0f \u8a2d\u5b9a</button>\n            <button class=\"btn btn-outline\" style=\"width:auto;padding:8px 10px\" onclick=\"showValidationModal()\">\ud83e\uddea \u691c\u8a3c</button>\n          </div>\n        </div>\n        <div class=\"v9-card-b\">\n          <div class=\"v9-focus\" id=\"v9-focus\">\n            " + (pills.length ? pills.map(p=>'<div class="v9-pill ' + (p.type||'') + '"><span>' + (p.label||'') + '</span><b>' + (p.value||'') + '</b></div>').join('') : '<div class="v9-pill success"><span>OK</span><b>å•é¡Œãªã—</b></div>') + "\n          </div>\n        </div>\n      </div>\n\n      <div class=\"v9-row\">\n        <div class=\"v9-card\">\n          <div class=\"v9-card-h\">\n            <div>\n              <div class=\"v9-card-title\">\ud83d\udcca \u58f2\u4e0a \u00d7 \u63a8\u5b9a\u7c97\u5229\u7387\uff08\u65e5\u6b21\uff09</div>\n              <div class=\"v9-card-sub\">\u68d2=\u58f2\u4e0a / \u7dda=\u63a8\u5b9a\u7c97\u5229\u7387\uff08\u58f2\u5909\u3092\u512a\u5148\u7684\u306b\u65e5\u6b21\u53cd\u6620\uff09</div>\n            </div>\n            <div class=\"v9-card-sub\">\u76ee\u6a19 " + (v9_pct(targetMargin)) + " / \u8b66\u544a " + (v9_pct(warningMargin)) + "</div>\n          </div>\n          <div class=\"v9-card-b\">\n            <canvas id=\"v9-chart-sales\" class=\"v9-canvas\"></canvas>\n          </div>\n        </div>\n\n        <div class=\"v9-card\">\n          <div class=\"v9-card-h\">\n            <div>\n              <div class=\"v9-card-title\">\ud83d\udce6 \u63a8\u5b9a\u5728\u5eab\u63a8\u79fb\uff08\u65e5\u6b21\uff09</div>\n              <div class=\"v9-card-sub\">\u671f\u9996\u2192\u63a8\u5b9a\u58f2\u4e0a\u539f\u4fa1\u2192\u79fb\u52d5\uff08\u5165/\u51fa\uff09\u3092\u53cd\u6620\u3057\u3066\u63a8\u79fb\u8868\u793a</div>\n            </div>\n            <div class=\"v9-card-sub\">\u5dee\u7570 " + (v9_currency(invDiff)) + "</div>\n          </div>\n          <div class=\"v9-card-b\">\n            <canvas id=\"v9-chart-inv\" class=\"v9-canvas\"></canvas>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"v9-card\">\n        <div class=\"v9-card-h\">\n          <div>\n            <div class=\"v9-card-title\">\ud83d\udd0e Breakdown\uff08\u5206\u89e3\u30d3\u30e5\u30fc\uff09</div>\n            <div class=\"v9-card-sub\">\u30ab\u30c6\u30b4\u30ea / \u4ed5\u5165\u5148 / \u65e5\u5225\u3067\u30c9\u30ea\u30eb\u30c0\u30a6\u30f3</div>\n          </div>\n          <div class=\"v9-tabs\" id=\"v9-breakdown-tabs\">\n            <button class=\"v9-tab active\" data-tab=\"category\">\u5e33\u5408\u30fb\u30ab\u30c6\u30b4\u30ea</button>\n            <button class=\"v9-tab\" data-tab=\"supplier\">\u4ed5\u5165\u5148</button>\n            <button class=\"v9-tab\" data-tab=\"daily\">\u65e5\u5225</button>\n          </div>\n        </div>\n        <div class=\"v9-card-b\" id=\"v9-breakdown-body\"></div>\n      </div>\n    </div>\n  ");

  document.getElementById('content').innerHTML = h;

    // å¯¾è±¡å¹´æœˆæ—¥ï¼šä¿å­˜ã—ã¦å†æç”»
    try{
      const dateEl = document.getElementById('v9-base-date');
      const btn = document.getElementById('v9-base-date-apply');
      if(btn && dateEl){
        btn.onclick = function(){
          if(dateEl.value){
            try{ localStorage.setItem('v9_base_date', dateEl.value); }catch(e){}
          }
          renderForecast();
        };
        // Enterã‚­ãƒ¼ã§ã‚‚é©ç”¨
        dateEl.onkeydown = function(ev){
          ev = ev || window.event;
          if(ev.key === 'Enter'){
            btn.click();
          }
        };
      }
    }catch(e){}



  // Period simulation: mount for current scope (ALL or store)
  try{ v9_mountRangePanel(currentStore); }catch(e){}
  // Render charts
  const series = v9_dailySeries(currentStore);
  const c1 = document.getElementById('v9-chart-sales');
  const c2 = document.getElementById('v9-chart-inv');

  const draw = ()=>{
    if(c1) v9_drawSalesGross(c1, series, V9_RANGE_STATE?.start, V9_RANGE_STATE?.end);
    if(c2) v9_drawInventory(c2, series, V9_RANGE_STATE?.start, V9_RANGE_STATE?.end);
  };
  draw();
  window.addEventListener('resize', draw, { once:true });

  // Breakdown default
  v9_renderBreakdown(currentStore, 'category');
  const tabs = document.getElementById('v9-breakdown-tabs');
  tabs?.addEventListener('click', (e)=>{
    const b = e.target.closest('.v9-tab');
    if(!b) return;
    tabs.querySelectorAll('.v9-tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    v9_renderBreakdown(currentStore, b.dataset.tab);
  });
}

// Override original dashboard renderer
try{ renderDashboard = renderDashboardV2; }catch(e){ /* ignore */ }

// Ensure re-render uses v2 if currently on dashboard
if(typeof render==='function'){
// Build an aggregated "all" store so ALL view can reuse the same UI/UX as store dashboards
function v9_ensureAllAggregate(){
  try{
    if(!result) return;
    if(result.all && result.all.__isAllAggregate) return;
    const ids = Object.keys(result||{}).filter(id=>id!=='all');
    if(!ids.length) return;

    const agg = {__isAllAggregate:true, daily:{}, budgetDaily:{}, catTotals:{}, supTotals:{}, dailyTotals:{}};

    let sumSales=0, sumGP=0, sumInvStart=0, sumInvEnd=0, sumBudget=0, sumBudgetConsumed=0, sumGPBudget=0;
    let wSales=0, wMargin=0, wBaihen=0;

    const sumMap = (src, dst)=>{
      if(!src) return;
      Object.entries(src).forEach(([k,v])=>{
        const o = dst[k] || (dst[k]={});
        o.cost  = (o.cost||0)  + (v?.cost||0);
        o.price = (o.price||0) + (v?.price||0);
      });
    };

    ids.forEach(id=>{
      const d = result[id];
      if(!d) return;

      const s = (d.totalSales||0);
      sumSales += s;
      sumGP    += (d.grossProfit||0);
      sumInvStart += (d.invStart||0);
      sumInvEnd   += (d.invEnd||0);
      sumBudget   += (d.budget||0);
      sumBudgetConsumed += (d.budgetConsumed||0);
      if(d.gpBudget) sumGPBudget += d.gpBudget;

      // Weighted params used for estimation
      wSales += s;
      const m = (d.coreMarginRate!=null ? d.coreMarginRate : d.avgMargin);
      if(m!=null) wMargin += s*(m||0);
      if(d.baihenRateSales!=null) wBaihen += s*(d.baihenRateSales||0);

      // Daily aggregation (1..31)
      for(let day=1; day<=31; day++){
        const dd = d.daily?.[day];
        if(!dd) continue;
        const tgt = agg.daily[day] || (agg.daily[day]={});

        tgt.sales  = (tgt.sales||0)  + (dd.sales||0);
        tgt.baihen = (tgt.baihen||0) + (dd.baihen||0);

        const sumObj = (key)=>{
          const src = dd[key] || {};
          const dst = tgt[key] || (tgt[key]={});
          if(src.cost!=null)  dst.cost  = (dst.cost||0)  + (src.cost||0);
          if(src.price!=null) dst.price = (dst.price||0) + (src.price||0);
        };

        ['shiire','hana','sanchoku','consumable','tenkanInTotal','tenkanOutTotal','bumonInTotal','bumonOutTotal'].forEach(sumObj);
      }

      // Budget daily
      if(d.budgetDaily){
        Object.entries(d.budgetDaily).forEach(([k,v])=>{
          agg.budgetDaily[k] = (agg.budgetDaily[k]||0) + (v||0);
        });
      }

      // Breakdown aggregates
      sumMap(d.catTotals,  agg.catTotals);
      sumMap(d.supTotals,  agg.supTotals);
      sumMap(d.dailyTotals, agg.dailyTotals);
    });

    agg.totalSales = sumSales;
    agg.grossProfit = sumGP;
    agg.grossProfitRate = sumSales>0 ? (sumGP/sumSales) : 0;
    agg.estimatedGrossRate = agg.grossProfitRate;

    agg.invStart = sumInvStart;
    agg.invEnd   = sumInvEnd;
    agg.estimatedInvEnd = sumInvEnd;

    agg.budget = sumBudget;
    agg.budgetConsumed = sumBudgetConsumed;
    agg.gpBudget = sumGPBudget>0 ? sumGPBudget : null;

    agg.coreMarginRate = (wSales>0) ? (wMargin/wSales) : null;
    agg.baihenRateSales = (wSales>0) ? (wBaihen/wSales) : null;

    result.all = agg;
  }catch(e){ /* ignore */ }
}

const _v9_oldRender = render;
render = function(){
  updateStats();
  ensureAllStoreAggregate();
  // ğŸ” ç§»å‹•ãƒ•ãƒ­ãƒ¼ï¼ˆçµ±ä¸€KPIï¼‰
  if(currentView==='flow'){
    if(typeof transferFlowRenderer==='function'){ transferFlowRenderer(); }
    else{
      const host=document.getElementById('content');
      if(host) host.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ”</div><h3>ç§»å‹•ãƒ•ãƒ­ãƒ¼</h3><p>ç§»å‹•ãƒ•ãƒ­ãƒ¼è¡¨ç¤ºãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆrenderTransferFlowViewæœªå®šç¾©ï¼‰ã€‚</p></div>';
    }
    return;
  }


  // Unified dashboard: ALL and store use the same renderer (v10 + v9 charts + breakdown + simulation)
  if(currentView==='dashboard'){
    renderDashboardV2();
    return;
  }

  // Non-dashboard views: keep original behavior as much as possible
  if(currentStore==='all'){
    renderAllStores();
    return;
  }

  // fall back to original switch behavior
  switch(currentView){
    case'category':renderCategory();break;
    case'forecast':renderForecast();break;
    case'analysis':renderAnalysis();break;
    case'supplier':renderSupplier();break;
    case'daily':renderDaily();break;
    case'summary':renderSummary();break;
    case'reports':renderReports();break;
    default:renderDashboardV2();
  }
};
}

// Kick a re-render once after overrides are installed
try{ setTimeout(()=>{ try{ render(); }catch(e){} }, 0); }catch(e){}


/* =========================
   v19 PATCH: ALL dashboard + margin pill + view reset
   ========================= */
(function(){
  // 1) robust ALL aggregate builder (no silent fail)
  function ensureAllAggregateV19(){
    try{
      if(!result) return;
      if(result['all'] && result['all'].__isAllAggregate) return;

      const ids = Object.keys(result||{}).filter(id=>id!=='all');
      if(!ids.length) return;

      const agg = {__isAllAggregate:true, daily:{}, budgetDaily:{}, catTotals:{}, supTotals:{}, dailyTotals:{}};

      let sumSales=0, sumGP=0, sumInvStart=0, sumInvEnd=0, sumBudget=0, sumBudgetConsumed=0, sumGPBudget=0;
      let wSales=0, wMargin=0, wBaihen=0;

      const sumMap = (src, dst)=>{
        if(!src) return;
        Object.entries(src).forEach(([k,v])=>{
          const o = dst[k] || (dst[k]={});
          o.cost  = (o.cost||0)  + ((v&&v.cost)||0);
          o.price = (o.price||0) + ((v&&v.price)||0);
        });
      };

      ids.forEach(id=>{
        const d = result[id];
        if(!d) return;

        const s = (d.totalSales||0);
        sumSales += s;
        sumGP    += (d.grossProfit||0);
        sumInvStart += (d.invStart||0);
        sumInvEnd   += (d.invEnd||0);
        sumBudget   += (d.budget||0);
        sumBudgetConsumed += (d.budgetConsumed||0);
        if(d.gpBudget) sumGPBudget += d.gpBudget;

        wSales += s;
        const m = (d.coreMarginRate!=null ? d.coreMarginRate : d.avgMargin);
        if(m!=null) wMargin += s*(m||0);
        if(d.baihenRateSales!=null) wBaihen += s*(d.baihenRateSales||0);

        for(let day=1; day<=31; day++){
          const dd = d.daily && d.daily[day];
          if(!dd) continue;
          const tgt = agg.daily[day] || (agg.daily[day]={});

          tgt.sales  = (tgt.sales||0)  + (dd.sales||0);
          tgt.baihen = (tgt.baihen||0) + (dd.baihen||0);

          const sumObj = (key)=>{
            const src = dd[key] || {};
            const dst = tgt[key] || (tgt[key]={});
            if(src.cost!=null)  dst.cost  = (dst.cost||0)  + (src.cost||0);
            if(src.price!=null) dst.price = (dst.price||0) + (src.price||0);
          };
          ['shiire','hana','sanchoku','consumable','tenkanInTotal','tenkanOutTotal','bumonInTotal','bumonOutTotal'].forEach(sumObj);
        }

        if(d.budgetDaily){
          Object.entries(d.budgetDaily).forEach(([k,v])=>{
            agg.budgetDaily[k] = (agg.budgetDaily[k]||0) + (v||0);
          });
        }

        sumMap(d.catTotals,  agg.catTotals);
        sumMap(d.supTotals,  agg.supTotals);
        sumMap(d.dailyTotals, agg.dailyTotals);
      });

      agg.totalSales = sumSales;
      agg.grossProfit = sumGP;
      agg.grossProfitRate = sumSales>0 ? (sumGP/sumSales) : 0;
      agg.estimatedGrossRate = agg.grossProfitRate;
      agg.invStart = sumInvStart;
      agg.invEnd   = sumInvEnd;
      agg.estimatedInvEnd = sumInvEnd;
      agg.budget = sumBudget;
      agg.budgetConsumed = sumBudgetConsumed;
      agg.gpBudget = sumGPBudget>0 ? sumGPBudget : null;
      agg.coreMarginRate = (wSales>0) ? (wMargin/wSales) : null;
      agg.baihenRateSales = (wSales>0) ? (wBaihen/wSales) : null;

      result['all'] = agg;
    }catch(e){
      console.error('[v19] ensureAllAggregate failed', e);
    }
  }

  try{ window.ensureAllAggregateV19 = ensureAllAggregateV19; }catch(e){}


  // 2) margin-rate pill UI injection
  function ensureMarginPill(){
    const tabs = document.getElementById('view-tabs');
    if(!tabs) return;
    if(document.getElementById('margin-pill')) return;

    const pill = document.createElement('div');
    pill.id='margin-pill';
    pill.style.cssText="margin-left:auto;display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--bg2);font-size:12px;color:var(--text);box-shadow:0 1px 2px rgba(16,24,40,.06);";
    pill.innerHTML = '<span style="opacity:.7">å€¤å…¥ç‡</span><strong id="margin-pill-val" style="font-weight:700"></strong>';
    tabs.appendChild(pill);
  }
  function updateMarginPill(){
    ensureMarginPill();
    const el = document.getElementById('margin-pill-val');
    const mr = parseFloat(document.getElementById('margin-rate')?.value);
    if(el) el.textContent = isFinite(mr) ? (mr*100).toFixed(1)+'%' : '-';
  }

  // 3) override selectStore: when switching to ALL -> force dashboard view
  const _oldSelectStore = window.selectStore;
  window.selectStore = function(sid){
    try{
      const norm = (typeof normalizeStoreId==='function') ? normalizeStoreId(sid) : sid;
      currentStore = norm;
      if(norm==='all'){
        currentView='dashboard';
      }
      // update chip active (compare normalized)
      document.querySelectorAll('#store-chips .chip').forEach(c=>{
        const cd = (typeof normalizeStoreId==='function') ? normalizeStoreId(c.dataset.store) : c.dataset.store;
        c.classList.toggle('active', cd===norm);
      });
    }catch(e){}
    if(typeof render==='function') render();
  };

  // 4) patch renderDashboardV2 to always have all aggregate + pill
  const _oldRenderDashboardV2 = renderDashboardV2;
  renderDashboardV2 = function(){
    if(result) ensureAllAggregateV19();
    updateMarginPill();
    return _oldRenderDashboardV2 ? _oldRenderDashboardV2() : undefined;
  };

  // 5) patch render() to call ensureAllAggregate + pill consistently
  const _oldRender = render;
  render = function(){
    try{
      if(result) ensureAllAggregateV19();
      updateMarginPill();
    }catch(e){}
    return _oldRender ? _oldRender() : undefined;
  };

  // 6) loadFile is bound via event listeners (DI)

  // initial
  try{ ensureMarginPill(); updateMarginPill(); }catch(e){}
})();




/* (refactor) v22 FINAL EXTENSION PATCH was removed: it targeted non-existent functions and could break return values.
   If you need those features, implement them in the core render functions instead. */


/* =====================================================
   2026-02-16 PATCH: Multi-store selection (å˜åº—/å…¨åº—â†’è¤‡æ•°é¸æŠçµ±åˆ)
   - åº—èˆ—ãƒãƒƒãƒ—: å…¨åº—èˆ—(=å…¨é¸æŠ) + å„åº—ãƒˆã‚°ãƒ«
   - è¤‡æ•°é¸æŠæ™‚: result['__sel__'] ã‚’ä½œã£ã¦ currentStore='__sel__'
   - é›†è¨ˆã¯ã€Œç›¸æ®ºã—ãªã„ã€(æœªç®¡ç†åº—èˆ—ãŒæ··ã–ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚)
   - å£²å¤‰: processBaihen ã®çµ¶å¯¾å€¤ä¿å­˜ã‚’æ˜¯æ­£ï¼ˆè² æ•°ã§ä¿æŒ + baihenAbs ã¯åˆ¥ï¼‰
   ===================================================== */
(function(){
  const SEL_KEY = '__sel__';
  window.__STORE_SELECTION__ = window.__STORE_SELECTION__ || { set:new Set(), lastSingle:null };

  function _allStoreIds(){
    return Object.keys(window.STORES||{}).sort((a,b)=>+a-+b);
  }

  function _setEqualsAll(sel){
    const all=_allStoreIds();
    if(sel.size!==all.length) return false;
    for(const id of all){ if(!sel.has(id)) return false; }
    return true;
  }

  function _first(sel){
    for(const v of sel) return v;
    return null;
  }

  // ---- Aggregate for arbitrary store set (NO internal netting/cancel)
  function buildAggregateForStoreSet(storeSet){
    const agg = {
      daily:{},
      catTotals:{},
      supTotals:{},
      dailyTotals:{},
      budgetDaily:{},
      transferDetails:{tenkanIn:[],tenkanOut:[],bumonIn:[],bumonOut:[]},
    };

    let sumSales=0,sumGP=0,sumInvStart=0,sumInvEnd=0,sumBudget=0,sumBudgetConsumed=0,sumGPBudget=0;
    let wSales=0,wMargin=0,wBaihen=0;

    const sumMap = (src, dst)=>{
      if(!src) return;
      Object.entries(src).forEach(([k,v])=>{
        if(!dst[k]){
          // shallow clone then normalize numbers
          dst[k] = (v && typeof v==='object') ? {...v} : v;
          if(dst[k] && typeof dst[k]==='object'){
            if(typeof dst[k].cost==='number') dst[k].cost = 0;
            if(typeof dst[k].price==='number') dst[k].price = 0;
            if(typeof dst[k].sales==='number') dst[k].sales = 0;
          }
        }
        if(v && typeof v==='object' && dst[k] && typeof dst[k]==='object'){
          if(typeof v.cost==='number')  dst[k].cost  = (dst[k].cost||0)  + v.cost;
          if(typeof v.price==='number') dst[k].price = (dst[k].price||0) + v.price;
          if(typeof v.sales==='number') dst[k].sales = (dst[k].sales||0) + v.sales;
          // carry flags
          if(v.usePriceCalc) dst[k].usePriceCalc = true;
          if(v.name && !dst[k].name) dst[k].name = v.name;
        }else if(typeof v==='number'){
          dst[k] = (dst[k]||0) + v;
        }
      });
    };

    const addDaily = (srcDaily)=>{
      if(!srcDaily) return;
      Object.entries(srcDaily).forEach(([day, d])=>{
        const k = String(day);
        if(!agg.daily[k]){
          agg.daily[k] = {
            sales:0,
            shiire:{cost:0,price:0},
            suppliers:{},
            tenkanIn:[],tenkanOut:[],bumonIn:[],bumonOut:[],
            tenkanInTotal:{cost:0,price:0},tenkanOutTotal:{cost:0,price:0},
            bumonInTotal:{cost:0,price:0},bumonOutTotal:{cost:0,price:0},
            hana:{cost:0,price:0},sanchoku:{cost:0,price:0},
            consumable:{cost:0,items:[]},
            baihen:0,baihenAbs:0,baihenRate:0,grossSales:0,
            coreSales:0,coreGrossSales:0,
            overDelivery:false, overDeliveryAmt:0
          };
        }
        const dst = agg.daily[k];
        dst.sales += (d.sales||0);
        // totals
        if(d.shiire){ dst.shiire.cost += (d.shiire.cost||0); dst.shiire.price += (d.shiire.price||0); }
        // suppliers sum
        if(d.suppliers){
          Object.entries(d.suppliers).forEach(([sc,sv])=>{
            if(!dst.suppliers[sc]) dst.suppliers[sc] = {...sv, cost:0, price:0};
            dst.suppliers[sc].cost += (sv.cost||0);
            dst.suppliers[sc].price += (sv.price||0);
            if(sv.usePriceCalc) dst.suppliers[sc].usePriceCalc = true;
          });
        }
        // transfers (keep full detail; do not net/cancel)
        const pushArr = (key)=>{
          (d[key]||[]).forEach(x=>dst[key].push({...x}));
        };
        pushArr('tenkanIn'); pushArr('tenkanOut'); pushArr('bumonIn'); pushArr('bumonOut');

        const addTot = (tkey)=>{
          if(d[tkey]){
            dst[tkey].cost += (d[tkey].cost||0);
            dst[tkey].price += (d[tkey].price||0);
          }
        };
        addTot('tenkanInTotal'); addTot('tenkanOutTotal'); addTot('bumonInTotal'); addTot('bumonOutTotal');

        if(d.hana){ dst.hana.cost += (d.hana.cost||0); dst.hana.price += (d.hana.price||0); }
        if(d.sanchoku){ dst.sanchoku.cost += (d.sanchoku.cost||0); dst.sanchoku.price += (d.sanchoku.price||0); }
        if(d.consumable){
          dst.consumable.cost += (d.consumable.cost||0);
          // items are noisy; keep empty to avoid huge agg (optional)
        }

        // baihen
        const raw = (d.baihen||0);
        const abs = (d.baihenAbs!=null)? d.baihenAbs : Math.abs(raw);
        dst.baihen += raw;
        dst.baihenAbs += abs;

        // core sales (already computed per-store; sum)
        dst.coreSales += (d.coreSales||0);
        dst.coreGrossSales += (d.coreGrossSales||0);

        // delivery over
        if(d.overDelivery){ dst.overDelivery = true; dst.overDeliveryAmt += (d.overDeliveryAmt||0); }
      });
    };

    // loop stores
    storeSet.forEach(sid=>{
      const d = result?.[sid];
      if(!d) return;

      sumInvStart += (d.invStart||0);
      sumInvEnd   += (d.invEnd||0);

      // budgets
      if(d.budget!=null) sumBudget += (d.budget||0);
      if(d.budgetConsumed!=null) sumBudgetConsumed += (d.budgetConsumed||0);
      if(d.gpBudget!=null) sumGPBudget += (d.gpBudget||0);

      // daily & maps
      addDaily(d.daily);

      sumMap(d.catTotals, agg.catTotals);
      sumMap(d.supTotals, agg.supTotals);
      sumMap(d.dailyTotals, agg.dailyTotals);

      if(d.budgetDaily){
        Object.entries(d.budgetDaily).forEach(([k,v])=>{
          agg.budgetDaily[k] = (agg.budgetDaily[k]||0) + (v||0);
        });
      }

      // transfers detail concatenate
      const td = d.transferDetails;
      if(td){
        ['tenkanIn','tenkanOut','bumonIn','bumonOut'].forEach(k=>{
          (td[k]||[]).forEach(t=>agg.transferDetails[k].push({...t, _store:sid}));
        });
      }

      // KPIs
      sumSales += (d.totalSales||0);
      sumGP    += (d.grossProfit||0);
      // weighted stats for estimation
      wSales  += (d.totalCoreSales||0);
      wMargin += (d.coreMarginRate!=null ? (d.coreMarginRate*(d.totalCoreSales||0)) : 0);
      wBaihen += (d.totalBaihen||0);
    });

    // derived
    agg.totalSales = sumSales;
    agg.grossProfit = sumGP;
    agg.grossProfitRate = sumSales>0 ? (sumGP/sumSales) : 0;
    agg.estimatedGrossRate = agg.grossProfitRate;

    agg.invStart = sumInvStart;
    agg.invEnd   = sumInvEnd;
    agg.estimatedInvEnd = sumInvEnd;

    agg.budget = sumBudget;
    agg.budgetConsumed = sumBudgetConsumed;
    agg.gpBudget = sumGPBudget>0 ? sumGPBudget : null;

    // re-summarize totals that are commonly referenced
    // totalCost/totalPrice etc exist in store object; build from catTotals for consistency
    agg.totalCost = Object.values(agg.catTotals||{}).reduce((s,c)=>s+((c&&c.cost)||0),0);
    agg.totalPrice= Object.values(agg.catTotals||{}).reduce((s,c)=>s+((c&&c.price)||0),0);

    // delivery totals
    const hanaCost = agg.catTotals?.hana?.cost||0;
    const hanaPrice= agg.catTotals?.hana?.price||0;
    const saCost   = agg.catTotals?.sanchoku?.cost||0;
    const saPrice  = agg.catTotals?.sanchoku?.price||0;
    agg.deliverySalesCost  = hanaCost + saCost;
    agg.deliverySalesPrice = hanaPrice + saPrice;

    // consumable
    agg.totalConsumable = agg.catTotals?.consumable?.cost||0;

    // core
    agg.coreCost  = agg.totalCost - agg.deliverySalesCost - agg.totalConsumable;
    agg.corePrice = agg.totalPrice - agg.deliverySalesPrice - agg.totalConsumable;
    agg.totalCoreSales = Object.values(agg.daily||{}).reduce((s,d)=>s+((d&&d.coreSales)||0),0);
    agg.totalBaihen = Object.values(agg.daily||{}).reduce((s,d)=>s+((d&&d.baihenAbs)||0),0);

    const totalGrossSales = agg.totalSales + agg.totalBaihen;
    agg.baihenRateSales = totalGrossSales>0 ? (agg.totalBaihen/totalGrossSales) : 0;

    agg.coreMarginRate = (agg.corePrice>0) ? ((agg.corePrice-agg.coreCost)/agg.corePrice) : null;
    // if per-store coreMarginRate missing, fall back to weighted margin
    if(agg.coreMarginRate==null && wSales>0){
      agg.coreMarginRate = wMargin / wSales;
    }
    if(agg.coreMarginRate==null){
      const mr = parseFloat(document.getElementById('margin-rate')?.value);
      agg.coreMarginRate = isFinite(mr) ? mr : 0.26;
    }

    // keep compat fields used elsewhere
    agg.avgMargin = agg.totalPrice>0 ? ((agg.totalPrice-agg.totalCost)/agg.totalPrice) : agg.coreMarginRate;

    return agg;
  }

  function _applySelectionRender(){
    const sel = window.__STORE_SELECTION__.set;
    const all = _allStoreIds();
    if(sel.size===0){
      // default: all
      all.forEach(id=>sel.add(id));
    }
    const isAll = _setEqualsAll(sel);

    if(isAll){
      currentStore = 'all';
      // for backwards compat: ensureAllAggregate if present
      if(typeof window.ensureAllAggregateV19==='function' && result){
        try{ window.ensureAllAggregateV19(); }catch(e){}
      }
    }else if(sel.size===1){
      const only = _first(sel);
      currentStore = only;
    }else{
      // multi selection
      if(result){
        result[SEL_KEY] = buildAggregateForStoreSet(sel);
      }
      currentStore = SEL_KEY;
    }

    // store badge label
    try{
      const badge = document.getElementById('store-badge');
      if(badge){
        badge.style.display='inline-flex';
        if(isAll) badge.textContent='ALL';
        else if(sel.size===1) badge.textContent=String(_first(sel)).padStart(2,'0');
        else badge.textContent = ((sel.size) + "\u5e97");
      }
    }catch(e){}

    // chips active
    try{
      document.querySelectorAll('#store-chips .chip').forEach(c=>{
        const id = c.dataset.store;
        if(id==='all'){
          c.classList.toggle('active', isAll);
        }else{
          c.classList.toggle('active', sel.has(id));
        }
      });
    }catch(e){}
  }

  // ---- Override selectStore: store cards => single-select, chips => toggle-select
  const _oldSelectStore = window.selectStore;
  window.selectStore = function(sid){
    // default behavior: selecting store card should make it single store selection
    const norm = (typeof window.normalizeStoreId==='function') ? window.normalizeStoreId(sid) : sid;
    const sel = window.__STORE_SELECTION__.set;
    sel.clear();
    if(norm==='all'){
      _allStoreIds().forEach(id=>sel.add(id));
    }else{
      sel.add(norm);
      window.__STORE_SELECTION__.lastSingle = norm;
    }
    _applySelectionRender();
    if(typeof render==='function') render();
  };

  // chips: toggle / all
  function bindChips(){
    const host = document.getElementById('store-chips');
    if(!host || host.__boundMulti) return;
    host.__boundMulti = true;

    host.addEventListener('click', (ev)=>{
      const el = ev.target.closest('.chip');
      if(!el) return;
      const sid = el.dataset.store;
      const sel = window.__STORE_SELECTION__.set;

      if(sid==='all'){
        sel.clear();
        _allStoreIds().forEach(id=>sel.add(id));
      }else{
        // toggle
        if(sel.has(sid)) sel.delete(sid);
        else sel.add(sid);

        // if empty, revert to all
        if(sel.size===0){
          _allStoreIds().forEach(id=>sel.add(id));
        }
      }
      _applySelectionRender();
      if(typeof render==='function') render();
    }, true);
  }

  // updateStoreChips: keep markup but allow multi-select UX
  const _oldUpdateStoreChips = window.updateStoreChips;
  window.updateStoreChips = function(){
    if(typeof _oldUpdateStoreChips==='function') _oldUpdateStoreChips();
    bindChips();
    // keep selection consistent when stores list updates
    const sel = window.__STORE_SELECTION__.set;
    const all = _allStoreIds();
    if(sel.size===0) all.forEach(id=>sel.add(id));
    // drop selections that no longer exist
    [...sel].forEach(id=>{ if(id!==SEL_KEY && id!=='all' && !window.STORES?.[id]) sel.delete(id); });
    if(sel.size===0) all.forEach(id=>sel.add(id));
    _applySelectionRender();
  };

  // patch renderDashboardV2 scope label for multi-select
  if(typeof renderDashboardV2==='function'){
    const _oldDash = renderDashboardV2;
    renderDashboardV2 = function(){
      try{
        // ensure aggregate for selection key if needed
        _applySelectionRender();
        // scope label override (renderDashboardV2 reads currentStore; we add helper)
        window.__SCOPE_LABEL__ = (function(){
          const sel = window.__STORE_SELECTION__.set;
          const isAll = _setEqualsAll(sel);
          if(isAll) return 'ALLï¼ˆå…¨åº—ï¼‰';
          if(sel.size===1){
            const id=_first(sel);
            return ("\u5e97\u8217 " + ((window.STORES?.[id]?.name||id)));
          }
          return ("\u5e97\u8217 " + (sel.size) + "\u5e97\u9078\u629e");
        })();
      }catch(e){}
      return _oldDash.apply(this, arguments);
    };
  }

  // patch: if renderDashboardV2 uses its own scopeLabel (local var), we can't inject easily.
  // Instead, patch v10_execBarHTML hook if exists to accept scopeLabel override.
  if(typeof window.v10_execBarHTML==='function' && !window.v10_execBarHTML.__patchedScope){
    const _oldExec = window.v10_execBarHTML;
    window.v10_execBarHTML = function(opts){
      if(window.__SCOPE_LABEL__){
        opts = {...(opts||{}), scopeLabel: window.__SCOPE_LABEL__};
      }
      return _oldExec(opts);
    };
    window.v10_execBarHTML.__patchedScope = true;
  }

  // ---- Fix baihen sign definition: keep negative for display, keep abs separately
  if(typeof window.processBaihen==='function' && !window.processBaihen.__patchedSign){
    const _oldPB = window.processBaihen;
    window.processBaihen = function(){
      const r = _oldPB.apply(this, arguments) || {};
      try{
        Object.keys(r).forEach(sid=>{
          Object.keys(r[sid]||{}).forEach(day=>{
            const o = r[sid][day];
            if(!o) return;
            const v = (o.baihen||0);
            // normalize to negative (å€¤å¼•) while keeping magnitude
            const abs = Math.abs(v);
            o.baihen = -abs;
            o.baihenAbs = abs;
          });
        });
      }catch(e){}
      return r;
    };
    window.processBaihen.__patchedSign = true;
  }

  // initial bind
  window.addEventListener('load', ()=>{
    try{
      bindChips();
      // initialize selection to all on first load
      const sel = window.__STORE_SELECTION__.set;
      if(sel.size===0) _allStoreIds().forEach(id=>sel.add(id));
      _applySelectionRender();
    }catch(e){}
  });
})();

</script>

<!-- =====================================================
     2026-02-16 ADD-ON: åº—é–“ç§»å‹•ãƒ•ãƒ­ãƒ¼å°‚ç”¨ãƒ“ãƒ¥ãƒ¼
     - å˜åº—/è¤‡æ•°é¸æŠ å…±é€šUI
     - tenkan/bumon ã® fromâ†’to ã‚’æ˜ç¤º
     - æœªç®¡ç†åº—èˆ—ãŒæ··ã–ã£ã¦ã‚‚ç›¸æ®ºã—ãªã„ï¼ˆSå†…/å¤–ã¯ view å´ã§ãƒ©ãƒ™ãƒ«ï¼‰
     ===================================================== -->
<script>
(function(){
  // ---------- utilities ----------
  const yen = (v)=> (typeof fmtYen==='function') ? fmtYen(v) : ('Â¥' + (Number(v)||0).toLocaleString('ja-JP'));
  const pct = (v)=> (typeof fmtPct==='function') ? fmtPct(v) : ((Number(v)||0)*100).toFixed(1)+'%';
  const esc = (s)=> String(s??'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  const storeName = (sid)=>{
    try{ return (window.STORES && window.STORES[sid] && window.STORES[sid].name) ? window.STORES[sid].name : String(sid); }
    catch(e){ return String(sid); }
  };

  // Enrich transferDetails items with from/to store context when missing.
  function normalizeTransferDetailsForAllStores(){
    if(!result) return;
    Object.keys(result).forEach((sid)=>{
      if(sid==='__sel__') return;
      const d = result[sid];
      if(!d || !d.transferDetails) return;
      const td = d.transferDetails;
      const toName = storeName(sid);
      (td.tenkanIn||[]).forEach(x=>{
        if(x.toStore==null || x.toStore===''){ x.toStore = sid; }
        if(!x.toStoreName){ x.toStoreName = toName; }
      });
      (td.bumonIn||[]).forEach(x=>{
        if(x.toStore==null || x.toStore===''){ x.toStore = sid; }
        if(!x.toStoreName){ x.toStoreName = toName; }
      });
      (td.tenkanOut||[]).forEach(x=>{
        if(x.fromStore==null || x.fromStore===''){ x.fromStore = sid; }
        if(!x.fromStoreName){ x.fromStoreName = toName; }
      });
      (td.bumonOut||[]).forEach(x=>{
        if(x.fromStore==null || x.fromStore===''){ x.fromStore = sid; }
        if(!x.fromStoreName){ x.fromStoreName = toName; }
      });
    });
  }

  // Apply normalization after generate/render hooks
  const _oldGenerate = window.generate;
  if(typeof _oldGenerate==='function'){
    window.generate = function(){
      const r = _oldGenerate.apply(this, arguments);
      try{ normalizeTransferDetailsForAllStores(); }catch(e){}
      return r;
    };
  }
  // Also run once on load (in case result already present)
  try{ normalizeTransferDetailsForAllStores(); }catch(e){}

  // ---------- Add tab button ----------
  function ensureFlowTab(){
    const tabs = document.querySelector('.topbar-tabs');
    if(!tabs) return;
    if(tabs.querySelector('[data-view="flow"]')) return;
    const btn = document.createElement('button');
    btn.className = 'topbar-tab';
    btn.dataset.view = 'flow';
    btn.textContent = 'ğŸ” ç§»å‹•ãƒ•ãƒ­ãƒ¼';
    // Insert before reports if exists, else append
    const reports = tabs.querySelector('[data-view="reports"]');
    if(reports) tabs.insertBefore(btn, reports);
    else tabs.appendChild(btn);
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ensureFlowTab, {once:true});
  }else{
    ensureFlowTab();
  }

  // ---------- Flow View Renderer ----------
  function getSelectedStoreSet(){
    // Multi-store patch keeps selection in __STORE_SELECTION__.set
    const s = window.__STORE_SELECTION__?.set;
    if(s && s.size) return new Set(Array.from(s));
    // fallback: currentStore only
    if(currentStore && currentStore!=='all') return new Set([currentStore]);
    return new Set();
  }

  function classifyEdge(from, to, setS){
    const inFrom = setS.has(String(from));
    const inTo   = setS.has(String(to));
    if(inFrom && inTo) return 'INTERNAL';
    if(!inFrom && inTo) return 'INFLOW';
    if(inFrom && !inTo) return 'OUTFLOW';
    return 'OUTSIDE';
  }

  function buildRows(data, storeSet){
    const td = data?.transferDetails || {};
    const rows = [];
    const push = (obj)=>{ if(obj && (obj.cost||obj.price)) rows.push(obj); };

    (td.tenkanIn||[]).forEach(t=>{
      push({day:t.day, kind:'åº—é–“', side:'å…¥', from:t.fromStore, to:t.toStore, cost:+t.cost||0, price:+t.price||0, bumonCode:t.bumonCode||'', note:t.fromStoreName||'', raw:t});
    });
    (td.tenkanOut||[]).forEach(t=>{
      push({day:t.day, kind:'åº—é–“', side:'å‡º', from:t.fromStore, to:t.toStore, cost:+t.cost||0, price:+t.price||0, bumonCode:t.bumonCode||'', note:t.toStoreName||'', raw:t});
    });
    (td.bumonIn||[]).forEach(t=>{
      push({day:t.day, kind:'éƒ¨é–€', side:'å…¥', from:t.fromStore, to:t.toStore, cost:+t.cost||0, price:+t.price||0, bumonCode:t.bumonCode||'', note:t.fromStoreName||'', raw:t});
    });
    (td.bumonOut||[]).forEach(t=>{
      push({day:t.day, kind:'éƒ¨é–€', side:'å‡º', from:t.fromStore, to:t.toStore, cost:+t.cost||0, price:+t.price||0, bumonCode:t.bumonCode||'', note:t.toStoreName||'', raw:t});
    });

    // Add class labels vs selection set (S)
    rows.forEach(r=>{ r.class = classifyEdge(r.from, r.to, storeSet); });

    return rows;
  }

  function aggregateEdges(rows){
    const byPair = new Map();
    const sum = (m, key, row)=>{
      if(!m.has(key)){
        m.set(key, {kind:row.kind, from:String(row.from), to:String(row.to), class:row.class, cost:0, price:0, count:0});
      }
      const o = m.get(key);
      o.cost += row.cost;
      o.price += row.price;
      o.count += 1;
    };
    rows.forEach(r=>{
      const key = String(r.kind) + '|' + String(r.from) + '|' + String(r.to) + '|' + String(r.class);
      sum(byPair, key, r);
    });
    return Array.from(byPair.values()).sort((a,b)=>Math.abs(b.price)-Math.abs(a.price));
  }

  function renderTransferFlowView(){
    const host = document.getElementById('content');
    if(!host) return;

    // Ensure meta + tabs/stats are consistent (keep UX unified)
    try{ if(typeof updateTopbarMeta==='function') updateTopbarMeta(); }catch(e){}
    try{ if(typeof syncViewTabs==='function') syncViewTabs(); }catch(e){}
    try{ if(typeof updateStats==='function') updateStats(); }catch(e){}

    const hasData = !!(result && currentStore && result[currentStore]);
    // If no transfer data loaded yet, still render the unified dashboard with zeros,
    // and show an empty-state message below. This prevents "not displayed" confusion.
    if(!hasData){
      const storeSet = getSelectedStoreSet();
      const storeSetLabel = storeSet.size ? Array.from(storeSet).sort().map(s=>((esc(s)) + ":" + (esc(storeName(s))))).join(' / ') : '(æœªé¸æŠ)';
      const netPrice = 0, inflowPrice = 0, outflowPrice = 0, internalPrice = 0, outsidePrice = 0;
      host.innerHTML = (
        "<div class=\"card\" style=\"padding:16px;\">" +
          "<div class=\"card-header\" style=\"display:flex;align-items:center;gap:10px;\">" +
            "<div class=\"card-icon\" style=\"width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f59e0b,#f97316);color:#fff;font-size:22px;\">ğŸ”</div>" +
            "<div>" +
              "<div class=\"card-title\">ğŸ” åº—é–“ç§»å‹•ãƒ•ãƒ­ãƒ¼ï¼ˆå°‚ç”¨ãƒ“ãƒ¥ãƒ¼ï¼‰</div>" +
              "<div class=\"card-subtitle\">é¸æŠåº—èˆ–é›†åˆ S ã«å¯¾ã—ã¦ã€Så†…â†’Så†… / Så¤–â†’Så†… / Så†…â†’Så¤– ã‚’åŒºåˆ†ã—ã¦è¡¨ç¤ºã—ã¾ã™ï¼ˆç›¸æ®ºã—ã¾ã›ã‚“ï¼‰ã€‚</div>" +
            "</div>" +
          "</div>" +
          "<div class=\"kpi-grid\" style=\"margin-top:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));\">" +
            "<div class=\"kpi-card\" data-color=\"info\">" +
              "<div class=\"kpi-header\"><div class=\"kpi-label\">é¸æŠç¯„å›²ï¼ˆSï¼‰</div><div class=\"kpi-icon\">ğŸ¬</div></div>" +
              "<div class=\"kpi-value\">" + (storeSet.size) + "åº—èˆ—</div>" +
              "<div class=\"kpi-sub\" style=\"line-height:1.35;word-break:break-word;\">" + (storeSetLabel) + "</div>" +
            "</div>" +
            "<div class=\"kpi-card\" data-color=\"" + ((netPrice>=0)?'success':'danger') + "\">" +
              "<div class=\"kpi-header\"><div class=\"kpi-label\">Netï¼ˆå¤–â†’å†… âˆ’ å†…â†’å¤–ï¼‰</div><div class=\"kpi-icon\">âš–ï¸</div></div>" +
              "<div class=\"kpi-value\">" + yen(netPrice) + "</div>" +
              "<div class=\"kpi-sub\">INFLOW âˆ’ OUTFLOW</div>" +
            "</div>" +
            "<div class=\"kpi-card\" data-color=\"info\">" +
              "<div class=\"kpi-header\"><div class=\"kpi-label\">INFLOWï¼ˆå¤–â†’å†…ï¼‰</div><div class=\"kpi-icon\">â¬…ï¸</div></div>" +
              "<div class=\"kpi-value\">" + yen(inflowPrice) + "</div>" +
              "<div class=\"kpi-sub\">Så¤–â†’Så†…</div>" +
            "</div>" +
            "<div class=\"kpi-card\" data-color=\"warning\">" +
              "<div class=\"kpi-header\"><div class=\"kpi-label\">OUTFLOWï¼ˆå†…â†’å¤–ï¼‰</div><div class=\"kpi-icon\">â¡ï¸</div></div>" +
              "<div class=\"kpi-value\">" + yen(outflowPrice) + "</div>" +
              "<div class=\"kpi-sub\">Så†…â†’Så¤–</div>" +
            "</div>" +
            "<div class=\"kpi-card\" data-color=\"neutral\">" +
              "<div class=\"kpi-header\"><div class=\"kpi-label\">INTERNALï¼ˆå†…â†’å†…ï¼‰</div><div class=\"kpi-icon\">ğŸ”</div></div>" +
              "<div class=\"kpi-value\">" + yen(internalPrice) + "</div>" +
              "<div class=\"kpi-sub\">Så†…â†’Så†…</div>" +
            "</div>" +
            "<div class=\"kpi-card\" data-color=\"neutral\">" +
              "<div class=\"kpi-header\"><div class=\"kpi-label\">å‚è€ƒï¼šOUTSIDEï¼ˆå¤–â†’å¤–ï¼‰</div><div class=\"kpi-icon\">ğŸŒ</div></div>" +
              "<div class=\"kpi-value\">" + yen(outsidePrice) + "</div>" +
              "<div class=\"kpi-sub\">Så¤–â†’Så¤–</div>" +
            "</div>" +
          "</div>" +
        "</div>" +
        "<div class=\"empty-state\" style=\"margin-top:14px;\"><div class=\"empty-icon\">ğŸ”</div><h3>åº—é–“ç§»å‹•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3><p>ã€Œåº—é–“å…¥ã€ã€Œåº—é–“å‡ºã€ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã€Œéƒ¨é–€å…¥ã€ã€Œéƒ¨é–€å‡ºã€ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã¨ãƒ•ãƒ­ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p></div>"
      );
      return;
    }

    normalizeTransferDetailsForAllStores();

    const data = result[currentStore];
    const storeSet = getSelectedStoreSet();
    const storeSetLabel = storeSet.size ? Array.from(storeSet).sort().map(s=>((esc(s)) + ":" + (esc(storeName(s))))).join(' / ') : '(æœªé¸æŠ)';

    const rows = buildRows(data, storeSet);
    const edges = aggregateEdges(rows);

    // summary
    const sumByClass = {INFLOW:{cost:0,price:0,count:0}, OUTFLOW:{cost:0,price:0,count:0}, INTERNAL:{cost:0,price:0,count:0}, OUTSIDE:{cost:0,price:0,count:0}};
    rows.forEach(r=>{
      const b = sumByClass[r.class] || (sumByClass[r.class]={cost:0,price:0,count:0});
      b.cost += r.cost; b.price += r.price; b.count += 1;
    });
    const netPrice = (sumByClass.INFLOW.price - sumByClass.OUTFLOW.price);

    const controls = ("\n      <div class=\"card\" style=\"margin-bottom:16px;\">\n        <div class=\"card-header\">\n          <div>\n            <div class=\"card-title\">ğŸ” åº—é–“ç§»å‹•ãƒ•ãƒ­ãƒ¼ï¼ˆå°‚ç”¨ãƒ“ãƒ¥ãƒ¼ï¼‰</div>\n            <div class=\"card-subtitle\">é¸æŠåº—èˆ–é›†åˆ S ã«å¯¾ã—ã¦ã€Så†…â†’Så†… / Så¤–â†’Så†… / Så†…â†’Så¤– ã‚’åŒºåˆ†ã—ã¦è¡¨ç¤ºã—ã¾ã™ï¼ˆç›¸æ®ºã—ã¾ã›ã‚“ï¼‰ã€‚</div>\n          </div>\n        </div>\n        <div class=\"kpi-grid\" style=\"margin-top:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));\">\n          <div class=\"kpi-card\" data-color=\"info\">\n            <div class=\"kpi-header\"><div class=\"kpi-label\">é¸æŠç¯„å›²ï¼ˆSï¼‰</div><div class=\"kpi-icon\">ğŸ¬</div></div>\n            <div class=\"kpi-value\">" + (storeSet.size) + "åº—èˆ—</div>\n            <div class=\"kpi-sub\" style=\"line-height:1.35;word-break:break-word;\">" + (storeSetLabel) + "</div>\n          </div>\n          <div class=\"kpi-card\" data-color=\"" + ((netPrice>=0)?'success':'danger') + "\">\n            <div class=\"kpi-header\"><div class=\"kpi-label\">Netï¼ˆå¤–â†’å†… âˆ’ å†…â†’å¤–ï¼‰</div><div class=\"kpi-icon\">âš–ï¸</div></div>\n            <div class=\"kpi-value\">" + (yen(netPrice)) + "</div>\n            <div class=\"kpi-sub\">å£²ä¾¡ãƒ™ãƒ¼ã‚¹</div>\n          </div>\n          <div class=\"kpi-card\" data-color=\"success\">\n            <div class=\"kpi-header\"><div class=\"kpi-label\">INFLOWï¼ˆå¤–â†’å†…ï¼‰</div><div class=\"kpi-icon\">â¬…ï¸</div></div>\n            <div class=\"kpi-value\">" + (yen(sumByClass.INFLOW.price)) + "</div>\n            <div class=\"kpi-sub\">" + (sumByClass.INFLOW.count) + " ä»¶</div>\n          </div>\n          <div class=\"kpi-card\" data-color=\"warning\">\n            <div class=\"kpi-header\"><div class=\"kpi-label\">OUTFLOWï¼ˆå†…â†’å¤–ï¼‰</div><div class=\"kpi-icon\">â¡ï¸</div></div>\n            <div class=\"kpi-value\">" + (yen(sumByClass.OUTFLOW.price)) + "</div>\n            <div class=\"kpi-sub\">" + (sumByClass.OUTFLOW.count) + " ä»¶</div>\n          </div>\n          <div class=\"kpi-card\" data-color=\"purple\">\n            <div class=\"kpi-header\"><div class=\"kpi-label\">INTERNALï¼ˆå†…â†’å†…ï¼‰</div><div class=\"kpi-icon\">ğŸ”</div></div>\n            <div class=\"kpi-value\">" + (yen(sumByClass.INTERNAL.price)) + "</div>\n            <div class=\"kpi-sub\">" + (sumByClass.INTERNAL.count) + " ä»¶</div>\n          </div>\n          <div class=\"kpi-card\" data-color=\"cyan\">\n            <div class=\"kpi-header\"><div class=\"kpi-label\">å‚è€ƒï¼šOUTSIDEï¼ˆå¤–â†’å¤–ï¼‰</div><div class=\"kpi-icon\">ğŸŒ«ï¸</div></div>\n            <div class=\"kpi-value\">" + (yen(sumByClass.OUTSIDE.price)) + "</div>\n            <div class=\"kpi-sub\">" + (sumByClass.OUTSIDE.count) + " ä»¶</div>\n          </div>\n        </div>\n      </div>\n    ");

    const edgeRowsHtml = edges.slice(0, 200).map(e=>{
      const from = ((esc(e.from)) + "<div class=\"small\">" + (esc(storeName(e.from))) + "</div>");
      const to   = ((esc(e.to)) + "<div class=\"small\">" + (esc(storeName(e.to))) + "</div>");
      const clsBadge = e.class==='INFLOW' ? 'â¬…ï¸ å¤–â†’å†…' : e.class==='OUTFLOW' ? 'â¡ï¸ å†…â†’å¤–' : e.class==='INTERNAL' ? 'ğŸ” å†…â†’å†…' : 'ğŸŒ« å¤–â†’å¤–';
      return ("<tr>\n        <td>" + (esc(e.kind)) + "</td>\n        <td><span class=\"badge\">" + (clsBadge) + "</span></td>\n        <td>" + (from) + "</td>\n        <td style=\"text-align:center;\">\u2192</td>\n        <td>" + (to) + "</td>\n        <td style=\"text-align:right;\">" + (yen(e.cost)) + "</td>\n        <td style=\"text-align:right;\">" + (yen(e.price)) + "</td>\n        <td style=\"text-align:right;\">" + (e.count) + "</td>\n      </tr>");
    }).join('');

    const detailRowsHtml = rows.sort((a,b)=>Math.abs(b.price)-Math.abs(a.price)).slice(0, 400).map(r=>{
      const clsBadge = r.class==='INFLOW' ? 'â¬…ï¸ å¤–â†’å†…' : r.class==='OUTFLOW' ? 'â¡ï¸ å†…â†’å¤–' : r.class==='INTERNAL' ? 'ğŸ” å†…â†’å†…' : 'ğŸŒ« å¤–â†’å¤–';
      return ("<tr>\n        <td>" + (r.day||'') + "</td>\n        <td>" + (esc(r.kind)) + " " + (esc(r.side)) + "</td>\n        <td><span class=\"badge\">" + (clsBadge) + "</span></td>\n        <td>" + (esc(r.from)) + "<div class=\"small\">" + (esc(storeName(r.from))) + "</div></td>\n        <td>" + (esc(r.to)) + "<div class=\"small\">" + (esc(storeName(r.to))) + "</div></td>\n        <td style=\"text-align:right;\">" + (yen(r.cost)) + "</td>\n        <td style=\"text-align:right;\">" + (yen(r.price)) + "</td>\n        <td>" + (esc(r.bumonCode||'')) + "</td>\n      </tr>");
    }).join('');

    host.innerHTML = ("\n      " + (controls) + "\n      <div class=\"card\" style=\"margin-bottom:16px;\">\n        <div class=\"card-header\">\n          <div>\n            <div class=\"card-title\">\u30da\u30a2\u5225\u96c6\u8a08\uff08from \u2192 to\uff09</div>\n            <div class=\"card-subtitle\">\u4e0a\u4f4d200\u4ef6\u3002\u5165/\u51fa\u30d5\u30a1\u30a4\u30eb\u53cc\u65b9\u3092\u8aad\u307f\u8fbc\u3093\u3067\u3044\u308b\u5834\u5408\u3001\u540c\u4e00\u79fb\u52d5\u304c\u5225\u8a18\u9332\u3068\u3057\u3066\u4e21\u65b9\u306b\u5b58\u5728\u3057\u3046\u308b\u305f\u3081\u3001\u5fc5\u8981\u306b\u5fdc\u3058\u3066\u7a81\u5408\u30ed\u30b8\u30c3\u30af\u3092\u5f8c\u3067\u8ffd\u52a0\u3067\u304d\u307e\u3059\u3002</div>\n          </div>\n        </div>\n        <div class=\"table-wrap\">\n          <table class=\"data-table\">\n            <thead>\n              <tr>\n                <th>\u7a2e\u5225</th>\n                <th>\u533a\u5206</th>\n                <th>From</th>\n                <th></th>\n                <th>To</th>\n                <th style=\"text-align:right;\">\u539f\u4fa1</th>\n                <th style=\"text-align:right;\">\u58f2\u4fa1</th>\n                <th style=\"text-align:right;\">\u4ef6\u6570</th>\n              </tr>\n            </thead>\n            <tbody>" + (edgeRowsHtml || '<tr><td colspan="8" style="text-align:center;opacity:.7;padding:16px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>') + "</tbody>\n          </table>\n        </div>\n      </div>\n\n      <div class=\"card\">\n        <div class=\"card-header\">\n          <div>\n            <div class=\"card-title\">\u660e\u7d30\uff08\u4e0a\u4f4d400\u4ef6 / \u58f2\u4fa1\u964d\u9806\uff09</div>\n            <div class=\"card-subtitle\">\u65e5\u4ed8\u30fb\u7a2e\u5225\u30fbFrom/To\u30fb\u91d1\u984d\u3092\u305d\u306e\u307e\u307e\u8868\u793a\u3057\u307e\u3059\uff08\u76f8\u6bba\u3057\u307e\u305b\u3093\uff09\u3002</div>\n          </div>\n        </div>\n        <div class=\"table-wrap\">\n          <table class=\"data-table\">\n            <thead>\n              <tr>\n                <th>\u65e5</th>\n                <th>\u7a2e\u5225</th>\n                <th>\u533a\u5206</th>\n                <th>From</th>\n                <th>To</th>\n                <th style=\"text-align:right;\">\u539f\u4fa1</th>\n                <th style=\"text-align:right;\">\u58f2\u4fa1</th>\n                <th>\u90e8\u9580</th>\n              </tr>\n            </thead>\n            <tbody>" + (detailRowsHtml || '<tr><td colspan="8" style="text-align:center;opacity:.7;padding:16px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>') + "</tbody>\n          </table>\n        </div>\n      </div>\n    ");
  }

  // ---------- hook render ----------
  const _prevRender = render;
  render = function(){
    // keep the existing wrapper behavior (ensureAllAggregateV19 etc.) inside _prevRender
    if(currentView==='flow'){
      try{
        // Make sure tab exists and is active
        ensureFlowTab();
        if(typeof transferFlowRenderer==='function') transferFlowRenderer();
        return;
      }catch(e){
        // fall back
      }
    }
    return _prevRender ? _prevRender.apply(this, arguments) : undefined;
  };


  // expose through local symbol only
  transferFlowRenderer = renderTransferFlowView;
})();
</script>

</body>
</html>
