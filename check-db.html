<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB ãƒ‡ãƒ¼ã‚¿ç¢ºèª</title>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #00d9ff;
        }
        .store {
            background: #16213e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00d9ff;
        }
        .store-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .record-count {
            color: #00d9ff;
            font-size: 0.9em;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .error {
            color: #ff6b6b;
            padding: 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            color: #51cf66;
            padding: 10px;
            background: rgba(81, 207, 102, 0.1);
            border-radius: 6px;
            margin: 10px 0;
        }
        pre {
            background: #0f0f1e;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ IndexedDB ãƒ‡ãƒ¼ã‚¿ç¢ºèª</h1>
        <button onclick="checkDatabase()">ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯</button>
        <button onclick="showSampleData()">ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚’ã‚¯ãƒªã‚¢</button>

        <div id="results"></div>
    </div>

    <script>
        const DB_NAME = 'shiire_araki_db';
        const STORES = ['shiire', 'uriage', 'baihen', 'consumables', 'tenkan_in', 'tenkan_out', 'sanchoku', 'hana', 'budget', 'settings'];

        async function checkDatabase() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="success">â³ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªä¸­...</div>';

            try {
                // IndexedDBã‚’é–‹ã
                const db = await openDatabase();

                let html = '<h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±</h2>';
                html += `<div class="success">âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ "${DB_NAME}" (ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${db.version}) ã«æ¥ç¶šã—ã¾ã—ãŸ</div>`;

                let totalRecords = 0;
                let storesWithData = 0;

                // å„ã‚¹ãƒˆã‚¢ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
                for (const storeName of STORES) {
                    try {
                        const count = await getRecordCount(db, storeName);
                        totalRecords += count;

                        if (count > 0) {
                            storesWithData++;
                            html += `<div class="store">`;
                            html += `<div class="store-name">ğŸ“ ${storeName}</div>`;
                            html += `<div class="record-count">ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${count.toLocaleString()}</div>`;
                            html += `</div>`;
                        }
                    } catch (err) {
                        console.error(`Error checking ${storeName}:`, err);
                    }
                }

                html += `<div class="success">`;
                html += `<strong>åˆè¨ˆ:</strong> ${storesWithData}/${STORES.length} ã‚¹ãƒˆã‚¢ã«ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š<br>`;
                html += `<strong>ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:</strong> ${totalRecords.toLocaleString()}`;
                html += `</div>`;

                if (totalRecords === 0) {
                    html += `<div class="error">`;
                    html += `âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>`;
                    html += `Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚`;
                    html += `</div>`;
                }

                results.innerHTML = html;
                db.close();
            } catch (error) {
                results.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                console.error('Database check error:', error);
            }
        }

        async function showSampleData() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="success">â³ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>';

            try {
                const db = await openDatabase();
                let html = '<h2>ğŸ“¦ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ (å„ã‚¹ãƒˆã‚¢ã‹ã‚‰æœ€å¤§3ä»¶)</h2>';

                for (const storeName of STORES) {
                    try {
                        const samples = await getSampleRecords(db, storeName, 3);

                        if (samples.length > 0) {
                            html += `<div class="store">`;
                            html += `<div class="store-name">ğŸ“ ${storeName}</div>`;
                            html += `<pre>${JSON.stringify(samples, null, 2)}</pre>`;
                            html += `</div>`;
                        }
                    } catch (err) {
                        console.error(`Error getting samples from ${storeName}:`, err);
                    }
                }

                results.innerHTML = html;
                db.close();
            } catch (error) {
                results.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                console.error('Sample data error:', error);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
                request.onblocked = () => reject(new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™'));
            });
        }

        function getRecordCount(db, storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.count();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                } catch (err) {
                    // ã‚¹ãƒˆã‚¢ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                    resolve(0);
                }
            });
        }

        function getSampleRecords(db, storeName, limit = 3) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction(storeName, 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.openCursor();

                    const results = [];
                    let count = 0;

                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor && count < limit) {
                            results.push(cursor.value);
                            count++;
                            cursor.continue();
                        } else {
                            resolve(results);
                        }
                    };

                    request.onerror = () => reject(request.error);
                } catch (err) {
                    resolve([]);
                }
            });
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            setTimeout(checkDatabase, 500);
        });
    </script>
</body>
</html>
