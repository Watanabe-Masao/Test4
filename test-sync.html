<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæœŸæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ - Week 2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .test-section h3 {
            color: #495057;
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .mode-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ åŒæœŸæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
            <p>SyncManager ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å‹•ä½œç¢ºèª - Week 2 Implementation</p>
        </div>

        <div class="content">
            <!-- Import Test -->
            <div class="test-section">
                <h2>ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ</h2>
                <p style="margin-bottom: 15px; color: #6c757d;">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™</p>

                <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</h3>
                <button class="btn" onclick="testImportWithDialog(10)">10ä»¶ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰</button>
                <button class="btn" onclick="testImportDirect(50)">50ä»¶ã‚’ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button class="btn btn-success" onclick="testImportLarge(100)">100ä»¶ã‚’ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>

                <h3>ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</h3>
                <button class="btn" onclick="testMergeMode('smart')">ã‚¹ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸</button>
                <button class="btn" onclick="testMergeMode('replace')">å®Œå…¨ç½®æ›</button>
                <button class="btn" onclick="testMergeMode('append')">è¿½åŠ ã®ã¿</button>
                <button class="btn" onclick="testMergeMode('skip')">ã‚¹ã‚­ãƒƒãƒ—</button>

                <div id="import-output" class="output"></div>
            </div>

            <!-- Diff Detection Test -->
            <div class="test-section">
                <h2>ğŸ” å·®åˆ†æ¤œå‡ºãƒ†ã‚¹ãƒˆ</h2>
                <p style="margin-bottom: 15px; color: #6c757d;">æ–°è¦ã€æ›´æ–°ã€å¤‰æ›´ãªã—ã‚’æ¤œå‡ºã—ã¾ã™</p>

                <button class="btn" onclick="testDiffDetection()">å·®åˆ†æ¤œå‡ºã‚’å®Ÿè¡Œ</button>
                <button class="btn btn-success" onclick="testDiffWithUpdates()">æ›´æ–°ã‚’å«ã‚€å·®åˆ†æ¤œå‡º</button>

                <div id="diff-output" class="output"></div>
            </div>

            <!-- Export Test -->
            <div class="test-section">
                <h2>ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ</h2>
                <p style="margin-bottom: 15px; color: #6c757d;">IndexedDBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™</p>

                <button class="btn" onclick="testExport()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="btn" onclick="testExportWithFilter()">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>

                <div id="export-output" class="output"></div>
            </div>

            <!-- Sync Status -->
            <div class="test-section">
                <h2>ğŸ“Š åŒæœŸçŠ¶æ…‹</h2>
                <button class="btn" onclick="showSyncStatus()">åŒæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º</button>
                <button class="btn btn-warning" onclick="clearSyncStatus()">åŒæœŸçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢</button>

                <div id="status-output" class="output"></div>
            </div>

            <!-- Console Output -->
            <div class="test-section">
                <h2>ğŸ“ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
                <button class="btn" onclick="clearConsole()">ã‚¯ãƒªã‚¢</button>
                <div id="console-output" class="output"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initDatabase } from './js/services/database/index.js';
        import { syncManager, MERGE_MODE } from './js/services/database/syncManager.js';
        import { DataRepository } from './js/services/database/repository.js';
        import { importDialog } from './js/ui/importDialog.js';

        // Console interceptor
        const originalLog = console.log;
        const originalError = console.error;

        function appendToConsole(message, type = 'log') {
            const consoleOutput = document.getElementById('console-output');
            const color = type === 'error' ? '#f48771' : '#d4d4d4';
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = message;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToConsole('âŒ ' + args.join(' '), 'error');
        };

        // Generate sample data
        function generateSampleData(count = 10) {
            const data = [];
            const startDate = new Date('2024-01-01');

            for (let i = 0; i < count; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + Math.floor(i / 3));

                data.push({
                    date: date.getTime(),
                    store: `0${(i % 3) + 1}`,
                    supplier: `${7470000 + (i % 10)}`,
                    supplierName: `ä»•å…¥å…ˆ${(i % 10) + 1}`,
                    category: 'market',
                    cost: Math.floor(Math.random() * 100000) + 10000,
                    amount: Math.floor(Math.random() * 100) + 1
                });
            }

            return data;
        }

        // Test: Import with dialog
        window.testImportWithDialog = async function(count) {
            const output = document.getElementById('import-output');
            output.textContent = '';
            console.log(`ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰: ${count}ä»¶\n`);

            try {
                const data = generateSampleData(count);
                console.log(`ç”Ÿæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿: ${data.length}ä»¶`);

                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                importDialog.show(
                    'shiire',
                    data,
                    (mode) => {
                        console.log(`âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ãƒ¢ãƒ¼ãƒ‰=${mode}`);
                        const result = syncManager.getLastSync('shiire');
                        console.log(JSON.stringify(result, null, 2));
                    },
                    () => {
                        console.log('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                    }
                );
            } catch (error) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Direct import
        window.testImportDirect = async function(count) {
            const output = document.getElementById('import-output');
            output.textContent = '';
            console.log(`ğŸ“¥ ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ: ${count}ä»¶\n`);

            try {
                const data = generateSampleData(count);
                const result = await syncManager.importData('shiire', data, MERGE_MODE.SMART);

                console.log('âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:');
                console.log(JSON.stringify(result, null, 2));
            } catch (error) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Large import
        window.testImportLarge = async function(count) {
            const output = document.getElementById('import-output');
            output.textContent = '';
            console.log(`ğŸ“¥ å¤§é‡ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ: ${count}ä»¶\n`);

            try {
                const data = generateSampleData(count);

                const startTime = performance.now();
                const result = await syncManager.importData(
                    'shiire',
                    data,
                    MERGE_MODE.SMART,
                    (current, total) => {
                        if (current % 10 === 0 || current === total) {
                            console.log(`é€²æ—: ${current}/${total}`);
                        }
                    }
                );
                const duration = performance.now() - startTime;

                console.log(`\nâœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ${duration.toFixed(2)}ms`);
                console.log(JSON.stringify(result, null, 2));
            } catch (error) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Merge mode
        window.testMergeMode = async function(mode) {
            const output = document.getElementById('import-output');
            output.textContent = '';
            console.log(`ğŸ”„ ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ: ${mode}\n`);

            try {
                const data = generateSampleData(20);
                const result = await syncManager.importData('shiire', data, mode);

                console.log('âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:');
                console.log(JSON.stringify(result, null, 2));
            } catch (error) {
                console.error('ãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Diff detection
        window.testDiffDetection = async function() {
            const output = document.getElementById('diff-output');
            output.textContent = '';
            console.log('ğŸ” å·®åˆ†æ¤œå‡ºãƒ†ã‚¹ãƒˆ\n');

            try {
                const data = generateSampleData(15);
                const diff = await syncManager.detectDiff('shiire', data);

                console.log('âœ… å·®åˆ†æ¤œå‡ºå®Œäº†:');
                console.log(JSON.stringify(diff, null, 2));
            } catch (error) {
                console.error('å·®åˆ†æ¤œå‡ºãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Diff with updates
        window.testDiffWithUpdates = async function() {
            const output = document.getElementById('diff-output');
            output.textContent = '';
            console.log('ğŸ” æ›´æ–°ã‚’å«ã‚€å·®åˆ†æ¤œå‡ºãƒ†ã‚¹ãƒˆ\n');

            try {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const repo = new DataRepository('shiire');
                const existing = await repo.getAll();

                if (existing.length === 0) {
                    console.log('âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã€ä¸€éƒ¨ã¯æ–°è¦
                const data = existing.slice(0, 5).map(record => ({
                    ...record,
                    cost: record.cost + 1000 // é‡‘é¡ã‚’å¤‰æ›´
                }));

                // æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                data.push(...generateSampleData(5));

                const diff = await syncManager.detectDiff('shiire', data);

                console.log('âœ… å·®åˆ†æ¤œå‡ºå®Œäº†:');
                console.log(`æ–°è¦è¿½åŠ : ${diff.toAdd.length}ä»¶`);
                console.log(`æ›´æ–°: ${diff.toUpdate.length}ä»¶`);
                console.log(`å¤‰æ›´ãªã—: ${diff.unchanged.length}ä»¶`);
                console.log(`è¡çª: ${diff.conflicts.length}ä»¶`);
            } catch (error) {
                console.error('å·®åˆ†æ¤œå‡ºãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Export
        window.testExport = async function() {
            const output = document.getElementById('export-output');
            output.textContent = '';
            console.log('ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\n');

            try {
                const data = await syncManager.exportData('shiire');
                console.log(`âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: ${data.length}ä»¶`);
                console.log(JSON.stringify(data.slice(0, 3), null, 2));
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Test: Export with filter
        window.testExportWithFilter = async function() {
            const output = document.getElementById('export-output');
            output.textContent = '';
            console.log('ğŸ“¤ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\n');

            try {
                const data = await syncManager.exportData('shiire', {
                    filter: { store: '01' }
                });
                console.log(`âœ… ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: ${data.length}ä»¶ï¼ˆåº—èˆ—01ã®ã¿ï¼‰`);
                console.log(JSON.stringify(data.slice(0, 3), null, 2));
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Show sync status
        window.showSyncStatus = function() {
            const output = document.getElementById('status-output');
            output.textContent = '';
            console.log('ğŸ“Š åŒæœŸçŠ¶æ…‹\n');

            const status = syncManager.getAllSyncStatus();
            console.log(JSON.stringify(status, null, 2));
        };

        // Clear sync status
        window.clearSyncStatus = function() {
            const output = document.getElementById('status-output');
            output.textContent = '';
            console.log('ğŸ—‘ï¸ åŒæœŸçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢\n');

            syncManager.clearSyncStatus();
            console.log('âœ… ã‚¯ãƒªã‚¢å®Œäº†');
        };

        // Clear console
        window.clearConsole = function() {
            document.getElementById('console-output').textContent = '';
        };

        // Initialize
        async function init() {
            try {
                console.log('ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ä¸­...');
                await initDatabase();
                console.log('âœ… æº–å‚™å®Œäº†\n');
            } catch (error) {
                console.error('åˆæœŸåŒ–å¤±æ•—:', error);
            }
        }

        init();
    </script>
</body>
</html>
