# ファイルインポートガイド

仕入粗利管理アプリケーションにデータを取り込むためのガイドです。
対応ファイル形式、データ種別、自動判定ルール、各種フォーマットについて説明します。

---

## 1. 概要

### インポート方法

データのインポートには2つの方法があります。

- **ドラッグ&ドロップ**: ファイルをアプリケーション画面にドラッグ&ドロップ（複数ファイル同時対応）
- **ファイル選択**: UploadCard のファイル選択ボタンからファイルを選択

### 対応ファイル形式

| 形式 | 拡張子 | 説明 |
|------|--------|------|
| Excel | `.xlsx` | SheetJS (xlsx) ライブラリで解析 |
| CSV | `.csv` | テキストベースのカンマ区切りファイル |

### 自動判定

ファイルをインポートすると、**FileTypeDetector** がファイル名とヘッダー行の内容から自動的にデータ種別を判定します（16ルール定義）。判定できない場合はエラーが表示されます。UploadCard から種別を指定してインポートすることも可能です。

### バッチインポート

複数ファイルを同時にドロップした場合、順番に処理されます。進捗バー（ImportProgressBar）で処理状況を確認できます。日付を含むファイルから対象年月が自動検出され、後続ファイルの処理にも即座に反映されます。

---

## 2. 対応データ種別 (15種)

| # | データ種別 | キー名 | 必須/任意 | 説明 |
|---|-----------|--------|----------|------|
| 1 | 仕入データ | `purchase` | **必須** | 取引先別・店舗別・日別の原価/売価データ |
| 2 | 売上データ | `sales` | **必須** | 店舗別・日別の販売金額・客数 |
| 3 | 売変データ | `discount` | 任意 | 店舗別・日別の値引・割引額 |
| 4 | 売上売変統合 | `salesDiscount` | 任意 | 売上+売変+客数の統合ファイル（売上・売変を一括取込） |
| 5 | 初期設定 | `initialSettings` | 任意 | 店舗別の期首在庫・期末在庫・月間粗利額予算 |
| 6 | 予算 | `budget` | 任意 | 店舗別・日別の売上予算金額 |
| 7 | 消耗品 | `consumables` | 任意 | 消耗品費（勘定コード 81257 のみ抽出） |
| 8 | 店間入 | `interStoreIn` | 任意 | 他店舗からの入荷（店間移動・部門間移動を自動区分） |
| 9 | 店間出 | `interStoreOut` | 任意 | 他店舗への出荷（原価・売価は負値として記録） |
| 10 | 花 | `flowers` | 任意 | 花売上データ（売価 x 0.80 = 原価として計算） |
| 11 | 産直 | `directProduce` | 任意 | 産直売上データ（売価 x 0.85 = 原価として計算） |
| 12 | 時間帯別売上 | `categoryTimeSales` | 任意 | 分類（部門/ライン/クラス）x 時間帯別の数量・金額 |
| 13 | 前年時間帯別 | `prevYearCategoryTimeSales` | 任意 | 前年の分類別時間帯売上（前年比分析用） |
| 14 | 前年売上売変 | `prevYearSalesDiscount` | 任意 | 前年の売上+売変（前年比分析用、翌月先頭6日分も取込可能） |
| 15 | 部門KPI | `departmentKpi` | 任意 | 部門別の粗利率・売上・在庫等のKPI一覧 |

> **注意**: 仕入データと売上データは粗利計算の基本データであり、必ずインポートしてください。その他のデータは分析の精度向上のために推奨されます。

---

## 3. ファイル種別自動判定ルール

FileTypeDetector は以下の順序でファイル種別を判定します。

### 判定優先順位

```
1. 特殊ファイル名パターン（正規表現）
2. ファイル名キーワードマッチ
3. ファイル名プレフィックス番号
4. ヘッダー行パターンマッチ
```

### 特殊ファイル名パターン

| パターン | 判定結果 | 例 |
|---------|---------|-----|
| `^9\.分類別` / `^9\..*時間帯` | 前年分類別時間帯売上 | `9.分類別時間帯売上250202.csv` |
| `^8\.分類別` / `^8\..*時間帯` | 分類別時間帯売上 | `8.分類別時間帯売上260201.csv` |
| `^\d{2}消耗` | 消耗品 | `01消耗品_260130.xls` |

### ファイル名キーワードマッチ

ファイル名に以下のキーワードが含まれている場合、対応するデータ種別と判定されます。判定は上から順に行われ、最初にマッチしたルールが採用されます。

| キーワード | 判定結果 | 優先順位の注意 |
|-----------|---------|-------------|
| `花`, `hana` | 花 | ヘッダーが産直と同一のため先に判定 |
| `産直`, `sanchoku` | 産直 | ヘッダーが花と同一のため先に判定 |
| `仕入`, `shiire` | 仕入 | - |
| `売上予算`, `予算`, `budget` | 予算 | 「売上予算」を含むため売上より先に判定 |
| `前年売上売変客数`, `前年売上売変`, `前年売上`, `prev_uriage` | 前年売上売変 | 「前年」キーワードで売上売変と区別 |
| `売上売変客数`, `売上売変`, `uriage_baihen`, `uriageBaihen` | 売上売変統合 | - |
| `前年分類別時間帯売上`, `前年時間帯売上` | 前年分類別時間帯売上 | - |
| `分類別時間帯売上`, `時間帯売上` | 分類別時間帯売上 | - |
| `売上`, `uriage` | 売上 | 他の「売上」を含む種別の後に判定 |
| `売変`, `baihen` | 売変 | - |
| `初期`, `設定`, `setting` | 初期設定 | - |
| `店間入`, `入庫` | 店間入 | - |
| `店間出`, `出庫` | 店間出 | - |
| `消耗`, `consumable` | 消耗品 | - |
| `部門別`, `部門KPI`, `dept_kpi`, `departmentKpi` | 部門KPI | - |

### プレフィックス番号（フォールバック）

キーワードで判定できない場合、ファイル名先頭のプレフィックス番号で判定します。

| プレフィックス | データ種別 |
|--------------|----------|
| `0_` | 予算 |
| `1_` | 売上売変統合 |
| `2_` | 仕入 |
| `3_` | 花 |
| `4_` | 産直 |
| `5_` | 店間入 |
| `6_` | 店間出 |
| `7_` | 初期設定 |
| `8_` | 消耗品 |
| `9_` | 部門KPI |
| `998_` | 前年売上売変 |

### ヘッダー行パターンマッチ

ファイル名で判定できない場合、先頭3行のセル内容に以下のキーワードが含まれるかを検査します。

| ヘッダーキーワード | 判定結果 |
|-----------------|---------|
| `取引先コード`, `原価金額`, `売価金額` | 仕入 |
| `売上予算`, `予算` | 予算 |
| `取引時間`, `【ライン】`, `【クラス】` | 分類別時間帯売上 |
| `販売金額`, `売上` | 売上 |
| `売変合計`, `値引` | 売変 |
| `期首`, `期末` | 初期設定 |
| `店コードIN`, `店舗コードIN` | 店間入 |
| `店コードOUT`, `店舗コードOUT` | 店間出 |
| `粗利率予算`, `値入`, `機首在庫` | 部門KPI |
| `販売金額` | 花 / 産直 (ファイル名で区別) |

### 判定結果

判定結果には信頼度（confidence）が付与されます。

| confidence | 説明 |
|-----------|------|
| `filename` | ファイル名で判定 (高信頼度) |
| `header` | ヘッダー行で判定 (中信頼度) |
| `none` | 判定不能 |

---

## 4. 各データ種別のファイルフォーマット詳細

### 4.1 仕入データ (purchase)

取引先別・店舗別の日別原価/売価データです。

```
行0: [空, 空, 空, "NNNNNNN:取引先名", 空, "NNNNNNN:取引先名", ...]  (2列ペア)
行1: [空, 空, 空, "NNNN:店舗名", 空, "NNNN:店舗名", ...]          (2列ペア)
行2: (空行)
行3: (空行)
行4+: [日付, 空, 空, 原価金額, 売価金額, 原価金額, 売価金額, ...]  (データ行)
```

- **Col0**: 日付
- **Col3以降**: 原価金額・売価金額の2列ペア（取引先 x 店舗の組み合わせ）
- 取引先コードは7桁数値（例: `0000123`）
- 店舗コードは4桁数値（例: `0001`）、先頭ゼロは内部的に除去（`1`）

### 4.2 売上データ (sales)

店舗別の日別販売金額データです。

```
行0: [空, 空, 空, "NNNN:店舗名", (空...), "NNNN:店舗名", ...]  (2列/3列ペア)
行1: (サブヘッダー)
行2: (ヘッダー)
行3+: [日付, 空, 空, 販売金額, (客数), ...]  (データ行)
```

- **Col0**: 日付
- **Col3以降**: 販売金額（+ 任意で客数）の2列または3列ペア
- ストライド（列ペア幅）は自動検出（マージセル対応）
- 対象月のデータのみ抽出（月フィルタリング）

### 4.3 売変データ (discount)

店舗別の日別値引・割引データです。

```
行0: [空, 空, 空, "NNNN:店舗名", (空...), "NNNN:店舗名", ...]
行1: (サブヘッダー: 販売金額, 売変, [客数])
行2+: [日付, 空, 空, 販売金額, 売変金額, [客数], ...]  (データ行)
```

- **Col0**: 日付
- **Col3以降**: 販売金額・売変金額（+ 任意で客数）の2列または3列ペア
- ストライドは自動検出（2列ペア or 3列ペア）

### 4.4 売上売変統合 (salesDiscount)

売上と売変を1つのファイルにまとめた統合形式です。フォーマットは売変データと同一です。
インポート時に売上データと売変データの両方が同時に構築されます。

### 4.5 初期設定 (initialSettings)

店舗別の期首/期末在庫と月間粗利額予算の設定データです。

```
行0: [ヘッダー: 店舗コード, 期首在庫, 期末在庫, 月間粗利額予算]
行1+: [店舗コード, 期首在庫, 期末在庫, 粗利額予算]
```

- **Col0**: 店舗コード
- **Col1**: 期首在庫金額（空欄可: null として処理）
- **Col2**: 期末在庫金額（空欄可: null として処理）
- **Col3**: 月間粗利額予算（0以下は「未設定」扱い）

### 4.6 予算 (budget)

店舗別・日別の売上予算データです（フラット形式）。

```
行0: [ヘッダー: 店舗コード, 日付, 予算金額]
行1+: [店舗コード, 日付, 予算金額]
```

- **Col0**: 店舗コード（例: `0001`）
- **Col1**: 日付（Excel シリアル値または文字列形式）
- **Col2**: 予算金額（0以下はスキップ）
- 月間合計は日別予算の合算から自動算出

### 4.7 消耗品 (consumables)

消耗品費データです。勘定コード `81257` の行のみ抽出されます。

```
行0: [ヘッダー]
行1+: [勘定コード, 品目コード, 品目名, 数量, 原価, 日付]
```

- **Col0**: 勘定コード（`81257` のみ処理対象）
- **Col1**: 品目コード
- **Col2**: 品目名
- **Col3**: 数量
- **Col4**: 原価金額
- **Col5**: 日付
- **店舗判定**: ファイル名先頭2桁が店舗コード（例: `01消耗品_260130.xls` → 店舗 `1`）
- 複数ファイルはマージ（追加モード）で処理

### 4.8 店間入 (interStoreIn)

他店舗からの入荷データです。

```
行0: [ヘッダー]
行1+: [入庫先店舗コード, 日付, 出庫元店舗コード, 原価, 売価]
```

- **Col0**: 入庫先店舗コード（TO）
- **Col1**: 日付
- **Col2**: 出庫元店舗コード（FROM）
- **Col3**: 原価金額（絶対値として記録）
- **Col4**: 売価金額（絶対値として記録）
- 入庫先 = 出庫元 の場合は**部門間移動**として自動区分

### 4.9 店間出 (interStoreOut)

他店舗への出荷データです。

```
行0: [ヘッダー]
行1+: [日付, 出庫元店舗コード, 入庫先店舗コード(IN), 部門コード(IN/無視), 原価, 売価]
```

- **Col0**: 日付
- **Col1**: 出庫元店舗コード（FROM）
- **Col2**: 入庫先店舗コード（TO）
- **Col3**: 部門コード（無視）
- **Col4**: 原価金額（**負値**として記録）
- **Col5**: 売価金額（**負値**として記録）
- 出庫元 = 入庫先 の場合は**部門間移動**として自動区分

### 4.10 花 (flowers)

花売上データです。売価のみ記録されており、原価は掛け率から算出されます。

```
行0: [空, 空, 空, "NNNN:店舗名", 空, "NNNN:店舗名", ...]  (2列ペア)
行1-2: (空行)
行3+: [日付, 空, 空, 売価金額, 空, 売価金額, ...]
```

- **Col0**: 日付
- **Col3以降**: 売価金額（2列ペア）
- **原価計算**: `原価 = Math.round(売価 x 掛け率)` (デフォルト掛け率: **0.80**)
- 掛け率はアプリケーション設定 (`flowerCostRate`) で変更可能

### 4.11 産直 (directProduce)

産直売上データです。花と同一のフォーマットですが、掛け率が異なります。

- **原価計算**: `原価 = Math.round(売価 x 掛け率)` (デフォルト掛け率: **0.85**)
- 掛け率はアプリケーション設定 (`directProduceCostRate`) で変更可能

> **注意**: 花と産直はヘッダー構造が同一のため、ファイル名で先に判定します。ファイル名に「花」または「産直」が含まれている必要があります。

### 4.12 分類別時間帯売上 (categoryTimeSales)

カテゴリ（部門/ライン/クラス）ごとの時間帯別数量・金額データです。

```
行0: [空x5, "【取引時間】", 空, "9:00", 空, "10:00", 空, ...]
行1: [空x5, "数量", "金額", "数量", "金額", ...]
行2: ["【期間】", "【店舗】", "【部門】", "【ライン】", "【クラス】", "数量", "金額", ...]
行3+: [日付, "NNNN:店舗名", "NNNNNN:部門名", "NNNNNN:ライン名", "NNNNNN:クラス名", 数量, 金額, ...]
```

- **Col0**: 日付（日本語形式: `2026年02月01日(日)`）
- **Col1**: 店舗（`NNNN:店舗名` 形式）
- **Col2**: 部門（コード:名称 形式、例: `000061:果物`）
- **Col3**: ライン（コード:名称 形式、例: `000601:柑橘`）
- **Col4**: クラス（コード:名称 形式、例: `601010:温州みかん`）
- **Col5以降**: 合計 + 時間帯別の (数量, 金額) ペア
- 複数ファイルはマージ（追加モード）で処理

### 4.13 前年分類別時間帯売上 (prevYearCategoryTimeSales)

前年の分類別時間帯売上データです。フォーマットは分類別時間帯売上と同一です。
前年比分析に使用されます。翌月先頭6日分も取り込み可能（同曜日オフセットで月末がはみ出す場合に備える）。

### 4.14 前年売上売変 (prevYearSalesDiscount)

前年の売上・売変データです。フォーマットは売上売変統合と同一です。
前年比分析に使用されます。翌月先頭6日分も取り込み可能。

> **注意**: 前年データの年月で当年の `targetYear` / `targetMonth` は上書きされません。

### 4.15 部門KPI (departmentKpi)

部門別のKPI一覧データです。

```
行0: [ヘッダー: 部門, (部門名), 粗利率予算, 粗利率実績, 予算差異, 値入, 売変, 売上予算, 売上実績, 差異, 達成率, 機首在庫, 期末在庫, 最終粗利着地, 最終売上着地]
行1+: [部門コード, (部門名), 粗利率予算, 粗利率実績, ...]
```

- **Col0**: 部門コード（数値のみ。数値でない行はスキップ）
- **Col1**: 部門名（文字列の場合。数値の場合は名称なしとして処理）
- **Col2以降**: 各KPI値
- パーセント値は自動的に小数に変換（例: `22.20` → `0.2220`）
- 複数ファイルはマージ（後勝ち: 同一部門コードは上書き）で処理

---

## 5. 日付パーサー

ファイル内の日付は多様な形式で記録されている可能性があります。日付パーサー（`dateParser.ts`）は以下のすべての形式に対応しています。

### 対応フォーマット

| 形式 | 例 | 説明 |
|------|-----|------|
| Excel シリアル値 | `45338` | Excel の内部日付表現（数値型） |
| 日本語形式 | `2026年2月15日` | 曜日付きも対応: `2026年2月15日(土)` |
| 和暦漢字形式 | `令和8年2月15日` | 令和のみ対応 |
| 和暦ドット形式 | `R8.2.15` | 全角 `Ｒ` にも対応 |
| ISO 形式 | `2026-02-15` | ハイフン区切り |
| スラッシュ形式 | `2026/02/15`, `2026/2/15` | ゼロ埋めなしも対応 |
| 短縮年スラッシュ形式 | `26/02/15` | 00-49 → 2000年代、50-99 → 1900年代 |
| ドット形式 | `2026.02.15`, `2026.2.15` | ピリオド区切り |
| 短縮年ドット形式 | `26.02.15` | 2桁年のドット区切り |
| MM/DD 形式 | `2/15` | 年はコンテキストから推定 |
| Date オブジェクト | - | そのまま返却 |

### 年月自動検出

日付を含むファイル（売上、売変、売上売変統合、分類別時間帯売上）では、データ行の日付列から対象年月が自動検出されます。最初にパースに成功した日付の年月が使用されます。

検出された年月は後続ファイルの処理にも即座に反映されるため、最初に日付を含むファイルをインポートすれば、以降のファイルは自動的に同じ年月で処理されます。

---

## 6. バリデーション

ファイルインポート後、データの整合性チェックが実行されます。結果は3段階のレベルで表示されます。

### ERROR（エラー）

インポートを続行できない致命的な問題です。

| メッセージ | 原因 | 対処 |
|-----------|------|------|
| 仕入データが読み込まれていません | 仕入ファイル未インポート | 仕入データファイルをインポートしてください |
| 売上データが読み込まれていません | 売上ファイル未インポート | 売上データファイルをインポートしてください |
| ファイルが空です | 空のファイルがインポートされた | ファイルの内容を確認してください |
| ファイルの種別を判定できませんでした | ファイル名・ヘッダーから種別判定不能 | ファイル名を修正するか、種別を指定してインポートしてください |

### WARNING（警告）

データの正確性に影響する可能性がある問題です。

| メッセージ | 原因 | 対処 |
|-----------|------|------|
| 店舗が検出されませんでした (0店舗) | ヘッダー行の店舗コード解析に失敗 | ファイルのヘッダー形式を確認してください |
| 在庫設定が登録されていません | 初期設定ファイル未インポート | 初期設定ファイルをインポートしてください |

### INFO（情報）

より正確な分析のための推奨事項です。

| メッセージ | 説明 |
|-----------|------|
| 予算データを読み込むと予実分析が可能になります | 予算ファイルの追加インポートを推奨 |
| 売変データを読み込むと値引分析が可能になります | 売変ファイルの追加インポートを推奨 |

### ValidationModal

バリデーション結果はモーダルダイアログ（ValidationModal）で表示されます。エラーがある場合は赤色、警告は黄色、情報は青色のアイコンで表示されます。詳細情報は折りたたみ表示で確認可能です。

---

## 7. データ永続化

### IndexedDB

インポートしたデータは **IndexedDB** に自動保存されます。ブラウザを閉じてもデータは保持されます。

| 項目 | 値 |
|------|-----|
| データベース名 | `shiire-arari-db` |
| バージョン | 1 |
| オブジェクトストア | `monthlyData` (データ本体), `metadata` (メタ情報) |

### 保存単位

データは**年月単位**で保存されます。保存キーの形式は `YYYY-MM_dataType` です。

```
例:
2026-02_purchase    → 2026年2月の仕入データ
2026-02_sales       → 2026年2月の売上データ
2026-02_stores      → 2026年2月の店舗マスタ
```

### 保存タイミング

- ファイルインポート完了時に自動保存
- 単一トランザクションで原子的に全データを書き込み（途中失敗時はロールバック）
- メタデータ（`lastSession`）に最終保存の年月・日時を記録

### データ復元

アプリケーション起動時、前回のセッションデータを復元できます。

- **RestoreDataModal**: 前回保存データの復元確認ダイアログ
- メタデータの `lastSession` から最終保存年月を取得
- 復元するとインポート済みの全データが再読み込みされる

### 差分検出 (DiffConfirmModal)

既に保存されているデータに対して新しいファイルをインポートした場合、差分検出が行われます。

| 変更種別 | 説明 | ユーザー操作 |
|---------|------|------------|
| 新規挿入 | 既存に値がなく、新規に値がある | **自動承認** |
| 値変更 | 既存に値があり、新規に異なる値がある | **確認が必要** |
| 値削除 | 既存に値があり、新規に値がない | **確認が必要** |

DiffConfirmModal では変更内容が一覧表示され、ユーザーが承認/拒否を選択できます。

### ストレージ管理

管理ページ（Admin > StorageManagementTab）で以下の操作が可能です。

- 保存済み年月の一覧表示
- データ種別ごとのレコード数サマリー確認
- 特定年月のデータ削除
- 全データの一括削除

---

## 8. インポートのベストプラクティス

### 推奨インポート順序

1. **仕入データ** (`purchase`) - 店舗・取引先マスタの基礎データ
2. **売上データ** (`sales`) または **売上売変統合** (`salesDiscount`) - 年月自動検出
3. **予算** (`budget`) - 予実分析に必要
4. **初期設定** (`initialSettings`) - 在庫・粗利予算設定
5. その他のデータ - 必要に応じて追加

### ファイル名の推奨命名規則

ファイル名に日本語のデータ種別名を含めることで、自動判定の精度が向上します。

```
例:
仕入_202602.xlsx
売上売変客数_202602.xlsx
売上予算_202602.xlsx
初期設定_202602.xlsx
01消耗品_260130.xlsx
花_202602.xlsx
産直_202602.xlsx
```

プレフィックス番号方式も利用可能です。

```
例:
0_売上予算.xlsx
1_売上売変.xlsx
2_仕入.xlsx
3_花.xlsx
4_産直.xlsx
```

### 複数ファイル同時インポート

ドラッグ&ドロップで複数ファイルを同時にインポートできます。ファイルは順番に処理され、日付を含むファイルから自動検出された年月が後続ファイルにも適用されます。
