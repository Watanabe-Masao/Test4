<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB ãƒ†ã‚¹ãƒˆ - ä»•å…¥ç²—åˆ©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .test-section h2 {
            color: #667eea;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-section h3 {
            color: #495057;
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output:empty:before {
            content: 'ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
            color: #6c757d;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.ready {
            background: #d4edda;
            color: #155724;
        }

        .status.running {
            background: #fff3cd;
            color: #856404;
            animation: pulse 1.5s infinite;
        }

        .status.success {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }

        .info-card .label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .progress {
            background: #e9ecef;
            border-radius: 4px;
            height: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª IndexedDB ãƒ†ã‚¹ãƒˆ</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª - Week 1 Implementation</p>
        </div>

        <div class="content">
            <!-- Status Section -->
            <div class="test-section">
                <h2>
                    ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹
                    <span id="db-status" class="status ready">æº–å‚™å®Œäº†</span>
                </h2>
                <div class="info-grid" id="db-info">
                    <div class="info-card">
                        <div class="label">æ¥ç¶šçŠ¶æ…‹</div>
                        <div class="value" id="connection-status">-</div>
                    </div>
                    <div class="info-card">
                        <div class="label">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
                        <div class="value" id="db-name">-</div>
                    </div>
                    <div class="info-card">
                        <div class="label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                        <div class="value" id="db-version">-</div>
                    </div>
                    <div class="info-card">
                        <div class="label">ã‚¹ãƒˆã‚¢æ•°</div>
                        <div class="value" id="store-count">-</div>
                    </div>
                </div>
                <button class="btn btn-info" onclick="checkDatabaseStatus()">ğŸ”„ çŠ¶æ…‹ã‚’æ›´æ–°</button>
            </div>

            <!-- Basic Tests -->
            <div class="test-section">
                <h2>ğŸ§ª åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
                <p style="margin-bottom: 15px; color: #6c757d;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®CRUDæ“ä½œã¨ã‚¯ã‚¨ãƒªæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼ˆç´„5ç§’ï¼‰</p>
                <button class="btn" onclick="runBasicTests()">â–¶ï¸ åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="btn btn-success" onclick="runQuickTest()">âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
                <div id="basic-output" class="output"></div>
            </div>

            <!-- Performance Tests -->
            <div class="test-section">
                <h2>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
                <p style="margin-bottom: 15px; color: #6c757d;">å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿ãƒ»èª­ã¿è¾¼ã¿é€Ÿåº¦ã‚’æ¸¬å®šã—ã¾ã™</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-info" onclick="runPerformanceTest(100)">100ä»¶</button>
                    <button class="btn btn-info" onclick="runPerformanceTest(1000)">1,000ä»¶</button>
                    <button class="btn btn-info" onclick="runPerformanceTest(5000)">5,000ä»¶</button>
                    <button class="btn btn-info" onclick="runPerformanceTest(10000)">10,000ä»¶</button>
                </div>
                <div id="performance-progress" class="progress" style="display: none; margin-top: 15px;">
                    <div id="performance-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="performance-output" class="output"></div>
            </div>

            <!-- Data Management -->
            <div class="test-section">
                <h2>ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <h3>ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</h3>
                <button class="btn btn-success" onclick="insertSampleData(10)">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ  (10ä»¶)</button>
                <button class="btn btn-success" onclick="insertSampleData(100)">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ  (100ä»¶)</button>

                <h3>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ</h3>
                <button class="btn btn-info" onclick="showDatabaseInfo()">ğŸ“Š è©³ç´°æƒ…å ±è¡¨ç¤º</button>
                <button class="btn btn-info" onclick="showStorageInfo()">ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±</button>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                <button class="btn btn-danger" onclick="deleteDatabase()">âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤</button>

                <div id="management-output" class="output"></div>
            </div>

            <!-- Console Output -->
            <div class="test-section">
                <h2>ğŸ“ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
                <button class="btn" onclick="clearConsole()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
                <div id="console-output" class="output"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initDatabase, getDatabase, showDatabaseInfo } from './js/services/database/index.js';
        import { DatabaseTest, PerformanceTest } from './js/services/database/test.js';
        import { DataRepository } from './js/services/database/repository.js';
        import { DATA_TYPE_MAP } from './js/services/database/schema.js';

        // Global state
        let isInitialized = false;
        let testRunning = false;

        // Console output interceptor
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function appendToConsole(message, type = 'log') {
            const consoleOutput = document.getElementById('console-output');
            const color = type === 'error' ? '#f48771' : type === 'warn' ? '#dcdcaa' : '#d4d4d4';
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = message;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            appendToConsole(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            appendToConsole('âŒ ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            appendToConsole('âš ï¸ ' + args.join(' '), 'warn');
        };

        // Initialize database on load
        async function init() {
            try {
                console.log('ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ä¸­...');
                await initDatabase();
                isInitialized = true;
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å®Œäº†');
                await checkDatabaseStatus();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–å¤±æ•—:', error);
                updateStatus('error');
            }
        }

        // Check database status
        async function checkDatabaseStatus() {
            const db = getDatabase();
            const statusEl = document.getElementById('connection-status');
            const dbNameEl = document.getElementById('db-name');
            const dbVersionEl = document.getElementById('db-version');
            const storeCountEl = document.getElementById('store-count');

            if (db.isConnected()) {
                const info = await db.getInfo();
                statusEl.textContent = 'âœ… æ¥ç¶šä¸­';
                statusEl.style.color = '#28a745';
                dbNameEl.textContent = info.name;
                dbVersionEl.textContent = `v${info.version}`;
                storeCountEl.textContent = info.stores.length;
            } else {
                statusEl.textContent = 'âŒ æœªæ¥ç¶š';
                statusEl.style.color = '#dc3545';
            }
        }

        // Update status badge
        function updateStatus(status) {
            const badge = document.getElementById('db-status');
            badge.className = `status ${status}`;
            badge.textContent = {
                ready: 'æº–å‚™å®Œäº†',
                running: 'å®Ÿè¡Œä¸­...',
                success: 'å®Œäº†',
                error: 'ã‚¨ãƒ©ãƒ¼'
            }[status];
        }

        // Run basic tests
        window.runBasicTests = async function() {
            if (testRunning) {
                alert('ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã§ã™');
                return;
            }

            const output = document.getElementById('basic-output');
            output.textContent = '';
            updateStatus('running');
            testRunning = true;

            try {
                const test = new DatabaseTest();
                await test.runAll();
                updateStatus('success');
            } catch (error) {
                console.error('ãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
                updateStatus('error');
            } finally {
                testRunning = false;
            }
        };

        // Run quick test
        window.runQuickTest = async function() {
            const output = document.getElementById('basic-output');
            output.textContent = '';
            console.log('âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹...\n');

            try {
                const repo = new DataRepository(DATA_TYPE_MAP.shiire);

                // Add
                const id = await repo.add({
                    date: Date.now(),
                    store: '01',
                    supplier: 'ãƒ†ã‚¹ãƒˆä»•å…¥å…ˆ',
                    cost: 50000
                });
                console.log(`âœ… ãƒ‡ãƒ¼ã‚¿è¿½åŠ : ID=${id}`);

                // Get
                const data = await repo.get(id);
                console.log(`âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—: ${JSON.stringify(data, null, 2)}`);

                // Update
                await repo.update(id, { cost: 75000 });
                console.log(`âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°: cost=75000`);

                // Delete
                await repo.delete(id);
                console.log(`âœ… ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†`);

                console.log('\nğŸ‰ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸ!');
            } catch (error) {
                console.error('ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            }
        };

        // Run performance test
        window.runPerformanceTest = async function(count) {
            const output = document.getElementById('performance-output');
            const progressEl = document.getElementById('performance-progress');
            const barEl = document.getElementById('performance-bar');

            output.textContent = '';
            progressEl.style.display = 'block';
            barEl.style.width = '0%';

            console.log(`âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: ${count.toLocaleString()}ä»¶\n`);

            try {
                const test = new PerformanceTest();

                // Insert test
                barEl.style.width = '33%';
                const insertResult = await test.testBulkInsertPerformance(count);

                // Query test
                barEl.style.width = '66%';
                const queryResult = await test.testQueryPerformance();

                barEl.style.width = '100%';

                console.log('\nğŸ“Š çµæœã‚µãƒãƒªãƒ¼:');
                console.log(`  æŒ¿å…¥: ${insertResult.count.toLocaleString()}ä»¶ / ${insertResult.duration}ms`);
                console.log(`  å¹³å‡: ${insertResult.perRecord}ms/ä»¶`);
                console.log(`  æ¤œç´¢: ${queryResult.count}ä»¶ / ${queryResult.duration}ms`);

                setTimeout(() => {
                    progressEl.style.display = 'none';
                }, 2000);
            } catch (error) {
                console.error('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
                progressEl.style.display = 'none';
            }
        };

        // Insert sample data
        window.insertSampleData = async function(count) {
            const output = document.getElementById('management-output');
            output.textContent = '';
            console.log(`ğŸ“¦ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ : ${count}ä»¶\n`);

            try {
                const repo = new DataRepository(DATA_TYPE_MAP.shiire);
                const data = [];
                const startDate = new Date();

                for (let i = 0; i < count; i++) {
                    data.push({
                        date: startDate.getTime() + (i * 86400000),
                        store: `0${(i % 3) + 1}`,
                        supplier: `ä»•å…¥å…ˆ${(i % 10) + 1}`,
                        category: 'market',
                        cost: Math.floor(Math.random() * 100000) + 10000,
                        amount: Math.floor(Math.random() * 100) + 1
                    });
                }

                const ids = await repo.addBulk(data);
                console.log(`âœ… ${ids.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                await checkDatabaseStatus();
            } catch (error) {
                console.error('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ å¤±æ•—:', error);
            }
        };

        // Show database info
        window.showDatabaseInfo = async function() {
            const output = document.getElementById('management-output');
            output.textContent = '';
            console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°æƒ…å ±\n');

            try {
                await showDatabaseInfo();
            } catch (error) {
                console.error('æƒ…å ±å–å¾—å¤±æ•—:', error);
            }
        };

        // Show storage info
        window.showStorageInfo = async function() {
            const output = document.getElementById('management-output');
            output.textContent = '';
            console.log('ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±\n');

            try {
                const db = getDatabase();
                const storage = await db.getStorageEstimate();

                if (storage) {
                    console.log(`ä½¿ç”¨é‡: ${storage.usageMB} MB`);
                    console.log(`åˆ¶é™: ${storage.quotaMB} MB`);
                    console.log(`ä½¿ç”¨ç‡: ${storage.usagePercent}%`);
                } else {
                    console.log('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±å–å¾—å¤±æ•—:', error);
            }
        };

        // Clear all data
        window.clearAllData = async function() {
            if (!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }

            const output = document.getElementById('management-output');
            output.textContent = '';
            console.log('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ä¸­...\n');

            try {
                const db = getDatabase();
                await db.clearAll();
                console.log('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                await checkDatabaseStatus();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å¤±æ•—:', error);
            }
        };

        // Delete database
        window.deleteDatabase = async function() {
            if (!confirm('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            const output = document.getElementById('management-output');
            output.textContent = '';
            console.log('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤ä¸­...\n');

            try {
                const { Database } = await import('./js/services/database/db.js');
                await Database.delete();
                console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                console.log('â„¹ï¸ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');

                setTimeout(() => {
                    location.reload();
                }, 2000);
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤å¤±æ•—:', error);
            }
        };

        // Clear console
        window.clearConsole = function() {
            document.getElementById('console-output').textContent = '';
        };

        window.checkDatabaseStatus = checkDatabaseStatus;

        // Initialize on page load
        init();
    </script>
</body>
</html>
